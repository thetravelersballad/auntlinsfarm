<html>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
<head>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href='https://fonts.googleapis.com/css?family=Lato:400,700' rel='stylesheet' type='text/css'>
<link href="https://fonts.googleapis.com/css2?family=Fondamento:ital@0;1&family=Forum&family=Oregano:ital@0;1&display=auto" rel="stylesheet">
<style>

body{
	font-family: 'Lato', sans-serif;
	font-weight: 400;
	-webkit-touch-callout: none; /* iOS Safari */
	-webkit-user-select: none; /* Safari */
	-khtml-user-select: none; /* Konqueror HTML */
	-moz-user-select: none; /* Old versions of Firefox */
	-ms-user-select: none; /* Internet Explorer/Edge */
	user-select: none;
	font-size:1.2vw;
}

button {
	border-radius: 10px;
	border-style: solid;
	border-width: thin;
	background-color: white;
	cursor: pointer;
	margin: 2px;
	padding: 5px;
	text-align: center;
	font-size: 1.2vw;
}

button:hover {
	background-color: black;
	color:white;
}

button:disabled {
	pointer-events: none;
}

h1 {
	font-display: block;
	font-family: "Oregano", cursive;
	font-weight: 400;
	font-style: normal;
}

.hidden {
	display:none;
}

#container {
	float:left; 
	width:70%;
	padding-bottom:50px;
}

.game_title {
	width: 99%;
	text-align: center;
	position: absolute;
	top: 40%;
	-ms-transform: translateY(-40%);
	transform: translateY(-40%);
	font-size:40px;
}

.notification {
	padding: 5px;
	border-bottom:solid;
	margin-bottom:10px;
	text-align: center;
}

#display_last {
	color:rgba(0,0,0,0.3);
}

#sidePanel {
	float:left; 
	width:25%; 
	padding-left:20px;
}

#artwork {
	padding-top: 10px;
}

img {
	max-width:70%;
	position: absolute;
}

table, td {
	border: 1px solid black;
	border-collapse: collapse;
}

td {
	width: 100px;
	height: 100px;
	text-align: center;
	vertical-align: middle;
}

progress {
	height: 8px;
    background: white;
}

progress::-webkit-progress-bar {
    background: transparent;
}

progress::-webkit-progress-value {
    border-radius: 10px;
    background: currentColor;
}

progress::-moz-progress-bar {
    border-radius: 10px;
    background: currentColor;
}

#lord_of_demons, #imp_demon, #hero, #monk_qin {
	float: left;
	width: 50%;
}

#lod_display, #imp_display, #my_display, #my_status, #qin_display, #qin_status {
	height: 5%;
}


#target {
	margin: 30px;
}

.circle1 { /*center = (98,93), radius = 102*/
	height: 200px;
	width: 200px;
	border-radius: 50%;
	border-style: solid;
	position: relative;
}

.circle2 { /*radius = 62*/
	width: 120px;
	height: 120px;
	margin: 0 auto;
	position: relative;
	border-radius: 50%;
	border-style: solid;
	top:40px;
}

.circle3 { /*radius = 27*/
	height: 50px;
	width: 50px;
	border-radius: 50%;
	border-style: solid;
	position: relative;
	margin: 0 auto;
	top:35px;
}

</style>
</head>
<body>
	<embed src="" loop="true" hidden="true" autostart="false">
	</embed>
	<div id="game_title" class="game_title"></div>
	<div id="container">
		<div id="display_persist">
		</div>
		<div id="display_last">
		</div>
		<div id="display">
		</div>
		<div id="actions">
		</div>
		<div id="artwork">
		</div>
	</div>
	<div id="sidePanel" class="hidden">
		<div id="date"></div>
		<div id="time"></div><br>
		Stamina
		<div id="progress_bar"><progress class="stamina" value="100" max="100"></progress><div id="hp">Healthiness: 100%</div></div>
		<div id="phoenix_egg"></div>
		<div id="travel_companion"></div>
		<br>
		<div id="select_inventory">Inventory <button id='select_inventory_button' onclick="select_inventory(1)">ALL</button></div>
		<div id="money"></div>
		<div id="inventory"></div>
		<br>
		<div id="collapse_equipped">Equipped <button onclick="collapse_equipped()">VISIBLE</button></div>
		<div id="equipped">
			<div id="e_hand"></div>
			<div id="e_hat"></div>
			<div id="e_body"></div>
			<div id="e_necklace"></div>
			<div id="e_belt"></div>
			<div id="e_shoes"></div>
		</div>
		<br>
		<div id="select_skills">Skills <button id='select_skills_button' onclick="select_skills(1)">ALL</button></div>
		<div id="skills"></div>
		<br>
		<div id="collapse_settings">Settings <button onclick="collapse_settings()">VISIBLE</button></div>
		<div id="settings">
			<div id="music">Music: <button onclick="stop_music()">ON</button></div>
			<div id="notify">Notification: <button onclick="notifications_off()">ON</button></div>
			<div id="history">History: <button onclick="history_off()">ON</button></div>
			<button onclick="location.reload()">QUIT</button>
		</div>
	</div>

</body>
<script>
	landing_page();

	//basic variables
	var game_saved;
	var name;
	var money;
	var inventory_map;
	var equipped_items;
	var skills_active;
	var skills_passive;
	var current_day;
	var time;
	var time_of_day;
	var current_loc;
	var weather;
	var stamina;
	var health_max;
	var total_health;
	var health_color;
	var sleep_quality;
	var exhaustion;
	var artwork_url;
	var alerts;
	var day_alert;
	var noon_alert;
	var night_alert;
	var stamina_alert;
	var dismiss_alert;
	
	//farm
	var plots;
	var plot_status;
	var harvest_day;
	var field_grown;
	var rocks;
	var logs;
	
	//items
	var wardrobe_index;
	var items;
	var items_cap;
	var costs;
	var official_cap;
	var silk_fan;
	var	silk_sash;
	var	silk_robe;
	var	hemp_tunic;
	var bronze_sword_available;
	var bronze_sword;
	var steel_sword;
	var wooden_staff;
	var leather_tunic_available;
	var leather_tunic;
	var chainmail;
	var baos_available;
	var baos;
	var baos_price;
	var peony_available;
	var peony;
	var pickaxe_available;
	var axe_available;
	var lantern_available;
	var crane_painting_available;
	var blanket_available;
	var sandals_available;
	var straw_sandals;
	var goji;
	var goji_seed_available;
	var goji_seed_supply;
	var goji_seed;
	var mountainyam;
	var mountainyam_seed_available;
	var mountainyam_seed_supply;
	var mountainyam_seed_unlock;
	var mountainyam_seed;
	var ginseng;
	var ginseng_seed_available;
	var ginseng_seed_supply;
	var ginseng_seed_unlock;
	var ginseng_seed;
	var sell_goji;
	var sell_mountainyam;
	var sell_ginseng;
	var sell_kindling;
	var sell_coal;
	var sell_iron;
	var total_sale;
	var nightingale_painting_available;
	var wall_painting;
	var study_painting;
	var lost;
	var feather;
	var feather_color;
	var seen_stove;
	var kindling;
	var iron;
	var safe_mushroom;
	var poisonous_mushroom;
	var invincible;
	var medallion;

	//misc
	var waterfall;
	var spider_count;
	var spider_hp;
	var in_bookshop;

	//character traits
	var knowledge;
	var charm;
	var courtesy;
	var curiosity;
	var humility;
	var honesty;
	var religious;
	var charitable;
	var discipline;
	var fallen;
	var books_read;
	var treasure;
	var taxes;
	var well_dressed;
	var training;
	var debtor;
	var bankrupt;
	var rocksmash;
	var rocksmash_active;
	var foraging;
	var animalaffinity;
	var fed_turtle;
	var greenthumb;
	var peace;
	
	//date trackers
	var previous_day;
	var gao_appointment;
	var invest_day;
	var loan_day;
	var party_day;
	var upgrade_day;
	var upgrading;
	var time_travel_day;
	var demons_defeated_day;
	
	//romance
	var anli_date;
	var anli_friendship;
	var anli_rock;
	var anli_respect;
	var lifen_date;
	var lifen_friendship;
	var lifen_nightingale;
	var lifen_respect;
	var accuse_lifen;
	var sparred_with_lifen;
	var match_balance;
	var lifen_energy;
	var lifen_location;
	
	//relics
	var flute_broken;
	var amulet;
	var silver_dagger;
	var silver_dagger_cursed;
	var sculpture_broken;
	var sculpture_available;
	var seen_notice;
	var seen_sculpture;
	var take_sculpture;
	var met_nephew;
	var relic_count;
	var peach;
	var theft_solved;
	var tour_in_session;
	var completed_tour;
	
	//endgame
	var time_portal;
	var traveled_to_past;
	var future_present;
	var game_finished;
	var imp_doors;
	var time_left;
	var chose_left_door;
	var chose_right_door;
	var fight_imp;
	var dispel_illusion;
	var clue;

	//boss fight
	var lod_flying;
	var lod_immune;
	var lod_attacking;
	var lod_attacking_qin;
	var imp_casting;
	var imp_immune;
	var imp_attacking;
	var imp_attacking_qin;
	var imp_spell_disrupt;
	var imp_defeated;
	var qin_defeated;
	var qin_fallen;
	var battle_over;
	
	//epilogue
	var egg;
	var leather_boots;
	var scallion_crepes;
	var firestick;
	var mooncakes;
	var companion;
	var companion_name;
	var companion_health;
	var companion_status;
	var companion_color;
	var wager_amount;
	var arrows;
	var shi_amount;
	var shi_playing;
	var	jun_amount;
	var jun_playing;
	
	//preload art
	var anlierhu_art = new Image();
	anlierhu_art.src = "anli_erhu.png";
	var anli_art = new Image();
	anli_art.src = "anli.png";
	var aunt_art = new Image();
	aunt_art.src = "aunt.png";
	var baigujing_art = new Image();
	baigujing_art.src = "baigujing.png";
	var bigbad_art = new Image();
	bigbad_art.src = "big_bad.png";
	var birthday_art = new Image();
	birthday_art.src = "birthday.png";
	var bookkeeper_art = new Image();
	bookkeeper_art.src = "bookkeeper.png";
	var bulletin_art = new Image();
	bulletin_art.src = "bulletin.png";
	var butler_art = new Image();
	butler_art.src = "butler.png";
	var chang_art = new Image();
	chang_art.src = "chang.png";
	var constable_art = new Image();
	constable_art.src = "constable.png";
	var ending_art = new Image();
	ending_art.src = "ending.png";
	var fallenmonk_art = new Image();
	fallenmonk_art.src = "fallen_monk.png";
	var fan_art = new Image();
	fan_art.src = "fan.png";
	var fanentrance_art = new Image();
	fanentrance_art.src = "fan_entrance.png"
	var fight_art = new Image();
	fight_art.src = "fight.png";
	var gao_art = new Image();
	gao_art.src = "gao.png";
	var imp_art = new Image();
	imp_art.src = "imp.png";
	var incense_art = new Image();
	incense_art.src = "incense.png";
	var lifen_art = new Image();
	lifen_art.src = "lifen.png";
	var lifen2_art = new Image();
	lifen2_art.src = "lifen2.png";
	var mamawolf_art = new Image();
	mamawolf_art.src = "mama_wolf.png";
	var masteryang_art = new Image();
	masteryang_art.src = "master_yang.png";
	var ming_art = new Image();
	ming_art.src = "ming.png";
	var monkqin_art = new Image();
	monkqin_art.src = "monk_qin.png";
	var opening_art = new Image();
	opening_art.src = "opening.png";
	var peachtree_art = new Image();
	peachtree_art.src = "peach_tree.png";
	var amberamulet_art = new Image();
	amberamulet_art.src = "amberamulet.png";
	var bambooflute_art = new Image();
	bambooflute_art.src = "bambooflute.png";
	var jadesculpture_art = new Image();
	jadesculpture_art.src = "jadesculpture.png";
	var silverdagger_art = new Image();
	silverdagger_art.src = "silverdagger.png";
	var portal_art = new Image();
	portal_art.src = "portal.png";
	var puppies_art = new Image();
	puppies_art.src = "puppies.png";
	var spider_art = new Image();
	spider_art.src = "spider.png";
	var tea_art = new Image();
	tea_art.src = "tea.png";
	var thug_art = new Image();
	thug_art.src = "thug.png";
	var treasure_art = new Image();
	treasure_art.src = "treasure.png";
	var waterfall_art = new Image();
	waterfall_art.src = "waterfall.png";
	var wolf_art = new Image();
	wolf_art.src = "wolf.png";
	
	//background music
	var soundfile;
	var background_music;
	var music;

	function change_music(new_music){
		if (soundfile != new_music) {
			soundfile = new_music;
			background_music.pause();
			background_music.src = new_music;
			if(music) {
				background_music.play();
			}
		} else {
			return;
		}
	}
	
	function play_music() {
		background_music.play();
		$("#music").html("Music: <button onclick='stop_music()'>ON</button>");
		music = 1;
	}
	
	function stop_music() {
		background_music.pause();
		$("#music").html("Music: <button onclick='play_music()'>OFF</button>");
		music = 0;
	}
	
	function notifications_on() {
		alerts = 1;
		$("#notify").html("Notification: <button onclick='notifications_off()'>ON</button>");
	}
	
	function notifications_off() {
		alerts = 0;
		$("#notify").html("Notification: <button onclick='notifications_on()'>OFF</button>");
	}
	
	function history_on() {
		$(display_last).show();
		$("#history").html("History: <button onclick='history_off()'>ON</button>");
	}
	
	function history_off() {
		$(display_last).hide();
		$("#history").html("History: <button onclick='history_on()'>OFF</button>");
	}
	
	function select_inventory(text) {
		if(text == 0) {
			$("#inventory").children().show();
			$("#select_inventory").html("Inventory <button id='select_inventory_button' onclick='select_inventory(1)'>ALL</button>");
		} else if(text == 1) {
			$("#inventory").children().hide();
			$(".e_item").show();
			$("#select_inventory").html("Inventory <button id='select_inventory_button' onclick='select_inventory(2)'>EQUIPMENT</button>");
		} else if(text == 2) {
			$(".e_item").hide();
			$(".f_item").show();
			$("#select_inventory").html("Inventory <button id='select_inventory_button' onclick='select_inventory(3)'>FOOD</button>");
		}else if(text == 3) {
			$(".q_item").hide();
			$(".r_item").show();
			$("#select_inventory").html("Inventory <button id='select_inventory_button' onclick='select_inventory(4)'>RELATIONSHIP</button>");
		}else if(text == 4) {
			$(".f_item").hide();
			$(".q_item").show();
			$("#select_inventory").html("Inventory <button id='select_inventory_button' onclick='select_inventory(5)'>STORY</button>");
		}else if(text == 5) {
			$(".r_item").hide();
			$(".t_item").show();
			$("#select_inventory").html("Inventory <button id='select_inventory_button' onclick='select_inventory(6)'>TOOLS</button>");
		}else if(text == 6) {
			$(".t_item").hide();
			$("#select_inventory").html("Inventory <button id='select_inventory_button' onclick='select_inventory(0)'>HIDDEN</button>");
		}
	}
	
	function collapse_equipped() {
		$("#equipped").hide();
		$("#collapse_equipped").html("Equipped <button onclick='show_equipped()'>HIDDEN</button>");
	}
	
	function show_equipped() {
		$("#equipped").show();
		$("#collapse_equipped").html("Equipped <button onclick='collapse_equipped()'>VISIBLE</button>");
	}
	
	function select_skills(text) {
		if(text == 0) {
			$("#skills").children().show();
			$("#select_skills").html("Skills <button id='select_skills_button' onclick='select_skills(1)'>ALL</button>");
		} else if(text == 1) {
			$("#skills").children().hide();
			$(".active_skill").show();
			$("#select_skills").html("Skills <button id='select_skills_button' onclick='select_skills(2)'>ACTIVE</button>");
		} else if(text == 2) {
			$(".active_skill").hide();
			$(".passive_skill").show();
			$("#select_skills").html("Skills <button id='select_skills_button' onclick='select_skills(3)'>PASSIVE</button>");
		} else if (text == 3) {
			$(".passive_skill").hide();
			$("#select_skills").html("Skills <button id='select_skills_button' onclick='select_skills(0)'>HIDDEN</button>");
		}
	}
	
	function collapse_settings() {
		$("#settings").hide();
		$("#collapse_settings").html("Settings <button onclick='show_settings()'>HIDDEN</button>");
	}
	
	function show_settings() {
		$("#settings").show();
		$("#collapse_settings").html("Settings <button onclick='collapse_settings()'>VISIBLE</button>");
	}

	function new_game() {

		//basic variables
		name = "Traveler";
		money = 30;
		inventory_map = new Map([
			["hemptunic_item e_item","Hemp Tunic <button id='hemptunic_button' onclick='equip(0)'>Equip</button>"]
		]);
		equipped_items = "<div id='e_hand'></div><div id='e_hat'></div><div id='e_body'><div id='body_equipped'>Hemp Tunic</div></div><div id='e_necklace'></div><div id='e_belt'></div><div id='e_shoes'></div>";
		skills_active = [];
		skills_passive = [];
		current_day = 1;
		time = 8;
		time_of_day = 0; //0 = morning; 1 = afternoon; 2 = night
		current_loc = "Aunt Lin's farm";
		weather = ["sunny","sunny","mild"];
		stamina = 100;
		health_max = 100;
		total_health = 100;
		health_color = "dodgerblue";
		$(".stamina").css("color", health_color);
		sleep_quality = 3;
		exhaustion = 0;
		artwork_url = "";
		alerts = 1;
		day_alert = 1;
		noon_alert = 0;
		night_alert = 0;
		stamina_alert = 0;
		dismiss_alert = 1;
		soundfile = "farm.mp3";
		background_music = new Audio(soundfile);
		background_music.loop = true;
		background_music.play();
		music = 1;
		
		//farm
		plots = ["Rock", "Log", "Rock", "Log"];
		plot_status = ["", "", "", ""];
		harvest_day = [987654321987654321, 987654321987654321, 987654321987654321, 987654321987654321];
		field_grown = [0, 0, 0, 0];
		rocks = 2;
		logs = 2;
		
		//items
		wardrobe_index = 2;
		items = ['"Take a look at this stylish silk hand fan," Mr. Chang says, "An elegant accessory that is sure to draw attention at fancy parties!', '"Feel the softness of this elegant silk sash," Mr. Chang says, "A perfect complement to any outfit!', '"Admire this graceful silk robe woven in the traditional <i>Hanfu</i>-style," Mr. Chang says, "The definitive fashion for both wealthy aristocrats and powerful martial artists!'];
		items_cap = ["Silk Fan", "Silk Sash", "Silk Robe"];
		costs = [80, 100, 120];
		official_cap = 0;
		silk_fan = 0;
		silk_sash = 0;
		silk_robe = 0;
		hemp_tunic = 1;
		bronze_sword_available = 1;
		bronze_sword = 0;
		steel_sword = 0;
		wooden_staff = 0;
		leather_tunic_available = 1;
		leather_tunic = 0;
		chainmail = 0;
		baos_available = 1;
		baos = 0;
		baos_price = 6;
		peony_available = 1;
		pickaxe_available = 1;
		axe_available = 1;
		lantern_available = 0;
		crane_painting_available = 1;
		blanket_available = 1;
		sandals_available = 1;
		straw_sandals = 0;
		goji = 0;
		goji_seed_available = 1;
		goji_seed_supply = 3; //can buy up to 4
		goji_seed = 0;
		mountainyam = 0;
		mountainyam_seed_available = 1;
		mountainyam_seed_supply = 3; //can buy up to 4
		mountainyam_seed_unlock = 0;
		mountainyam_seed = 0;
		ginseng = 0;
		ginseng_seed_available = 1;
		ginseng_seed_supply = 1; //can buy up to 2
		ginseng_seed_unlock = 0;
		ginseng_seed = 0;
		nightingale_painting_available = 0;
		wall_painting = 1; //0 = none; 1 = nightingale; 2 = crane 
		study_painting = 0; //0 = no painting; 1 = nightingale; 2 = crane
		lost = 0;
		feather = 0;
		feather_color = "Red";
		seen_stove = 0;
		kindling = 0;
		iron = 0;
		safe_mushroom = 0;
		poisonous_mushroom = 0;
		invincible = 0;
		medallion = 0;

		//misc
		waterfall = 0;
		spider_count = 3;
		spider_hp = 0;
		in_bookshop = 0;

		//character traits
		knowledge = 0;
		charm = 0;
		courtesy = 0;
		curiosity = [0,0,0,0,0,0,0,0,0,0,0];
		humility = 0;
		honesty = 1;
		religious = 0;
		charitable = 0;
		discipline = 1;
		fallen = 0;
		books_read = [0,0,0,0,0,0,0,0,0];
		treasure = 1;
		taxes = 0;
		well_dressed = 0;
		training = 0;
		debtor = 0;
		bankrupt = 0;
		rocksmash = 0;
		rocksmash_active = 0;
		foraging = 0;
		animalaffinity = 0;
		fed_turtle = 0;
		greenthumb = 0;
		peace = 0;
		
		//date trackers
		previous_day = 0;
		gao_appointment = 0;
		invest_day = 0;
		loan_day = 0
		party_day = 0;
		upgrade_day = 0;
		upgrading = 0;
		time_travel_day = 0;
		demons_defeated_day = 0;
		
		//romance
		anli_date = 0;
		anli_friendship = 0;
		anli_rock = 0;;
		anli_respect = 0;
		lifen_date = 0;
		lifen_friendship = 0;
		lifen_nightingale = 0;
		lifen_respect = 0;
		accuse_lifen = 0;
		sparred_with_lifen = 0;
		match_balance = 0.6; //lower = advantage, higher = disadvantage
		lifen_energy = 5;
		lifen_location = 0; //0 = Mr. Fan (default); 1 = Li-fen
		
		//relics
		flute_broken = 0;
		amulet = 0;
		silver_dagger = 0;
		silver_dagger_cursed = 0;
		sculpture_broken = 0;
		sculpture_available = 1;
		seen_notice = 0;
		seen_sculpture = 0;
		take_sculpture = 0;
		met_nephew = 0;
		relic_count = 0;
		peach = 0;
		theft_solved = 0;
		tour_in_session = 0;
		completed_tour = 0;
		
		//endgame
		time_portal = 0;
		traveled_to_past = 0;
		future_present = 0;
		game_finished = 0;
		imp_doors = 0;
		chose_left_door = 0; //an-li
		chose_right_door = 0; //Li-fen
		fight_imp = 0;
		dispel_illusion = 0;
		clue = 0;

		//boss fight
		lod_flying = 0;
		lod_immune = 0;
		lod_attacking = 0;
		lod_attacking_qin = 0;
		imp_casting = 0;
		imp_immune = 0;
		imp_attacking = 0;
		imp_attacking_qin = 0;
		imp_spell_disrupt = 0;
		imp_defeated = 0;
		qin_defeated = 0;
		qin_fallen = 0;
		battle_over = 0;
		
		//epilogue
		egg = 0;
		leather_boots = 0;
		scallion_crepes = 0;
		firestick = 0;
		mooncakes = [0,0,0,0,0] //red, yellow, blue, white, black
		companion = 0;
		companion_name = 'Chestnut Mare';
		companion_health = 10;
		companion_status = 0;
		companion_color = 'brown';
		shi_amount = 18;
		shi_playing = 1;
		jun_amount = 10;
		jun_playing = 1;
	}

	function load_game() {

		//basic variables
		name = JSON.parse(localStorage.getItem("name"));
		money = JSON.parse(localStorage.getItem("money"));
		inventory_map = new Map(JSON.parse(localStorage.getItem("inventory_map")));
		equipped_items = JSON.parse(localStorage.getItem("equipped_items"));
		skills_active = JSON.parse(localStorage.getItem("skills_active"));
		skills_passive = JSON.parse(localStorage.getItem("skills_passive"));
		current_day = JSON.parse(localStorage.getItem("current_day"));
		time = JSON.parse(localStorage.getItem("time"));
		time_of_day = JSON.parse(localStorage.getItem("time_of_day"));
		current_loc = "Aunt Lin's farm";
		weather = JSON.parse(localStorage.getItem("weather"));
		stamina = JSON.parse(localStorage.getItem("stamina"));
		health_max = JSON.parse(localStorage.getItem("health_max"));
		total_health = JSON.parse(localStorage.getItem("total_health"));
		health_color = JSON.parse(localStorage.getItem("health_color"));
		sleep_quality = JSON.parse(localStorage.getItem("sleep_quality"));
		exhaustion = JSON.parse(localStorage.getItem("exhaustion"));
		artwork_url = JSON.parse(localStorage.getItem("artwork_url"));
		alerts = 1;
		day_alert = 1;
		noon_alert = 0;
		night_alert = 0;
		stamina_alert = 0;
		dismiss_alert = 1;
		soundfile = JSON.parse(localStorage.getItem("soundfile"));
		
		//farm
		plots = JSON.parse(localStorage.getItem("plots"));
		plot_status = JSON.parse(localStorage.getItem("plot_status"));
		harvest_day = JSON.parse(localStorage.getItem("harvest_day"));
		field_grown = JSON.parse(localStorage.getItem("field_grown"));
		rocks = JSON.parse(localStorage.getItem("rocks"));
		logs = JSON.parse(localStorage.getItem("logs"));
		
		//items
		wardrobe_index = JSON.parse(localStorage.getItem("wardrobe_index"));
		items = JSON.parse(localStorage.getItem("items"));
		items_cap = JSON.parse(localStorage.getItem("items_cap"));
		costs = JSON.parse(localStorage.getItem("costs"));
		official_cap = JSON.parse(localStorage.getItem("official_cap"));
		silk_fan = JSON.parse(localStorage.getItem("silk_fan"));
		silk_sash = JSON.parse(localStorage.getItem("silk_sash"));
		silk_robe = JSON.parse(localStorage.getItem("silk_robe"));
		hemp_tunic = JSON.parse(localStorage.getItem("hemp_tunic"));
		bronze_sword_available = JSON.parse(localStorage.getItem("bronze_sword_available"));
		bronze_sword = JSON.parse(localStorage.getItem("bronze_sword"));
		steel_sword = JSON.parse(localStorage.getItem("steel_sword"));
		wooden_staff = JSON.parse(localStorage.getItem("wooden_staff"));
		leather_tunic_available = JSON.parse(localStorage.getItem("leather_tunic_available"));
		leather_tunic = JSON.parse(localStorage.getItem("leather_tunic"));
		chainmail = JSON.parse(localStorage.getItem("chainmail"));
		baos_available = JSON.parse(localStorage.getItem("baos_available"));
		baos = JSON.parse(localStorage.getItem("baos"));
		baos_price = JSON.parse(localStorage.getItem("baos_price"));
		peony_available = JSON.parse(localStorage.getItem("peony_available"));
		pickaxe_available = JSON.parse(localStorage.getItem("pickaxe_available"));
		axe_available = JSON.parse(localStorage.getItem("axe_available"));
		lantern_available = JSON.parse(localStorage.getItem("lantern_available"));
		crane_painting_available = JSON.parse(localStorage.getItem("crane_painting_available"));
		blanket_available = JSON.parse(localStorage.getItem("blanket_available"));
		sandals_available = JSON.parse(localStorage.getItem("sandals_available"));
		straw_sandals = JSON.parse(localStorage.getItem("straw_sandals"));
		goji = JSON.parse(localStorage.getItem("goji"));
		goji_seed_available = JSON.parse(localStorage.getItem("goji_seed_available"));
		goji_seed_supply = JSON.parse(localStorage.getItem("goji_seed_supply"));
		goji_seed = JSON.parse(localStorage.getItem("goji_seed"));
		mountainyam = JSON.parse(localStorage.getItem("mountainyam"));
		mountainyam_seed_available = JSON.parse(localStorage.getItem("mountainyam_seed_available"));
		mountainyam_seed_supply = JSON.parse(localStorage.getItem("mountainyam_seed_supply"));
		mountainyam_seed_unlock = JSON.parse(localStorage.getItem("mountainyam_seed_unlock"));
		mountainyam_seed = JSON.parse(localStorage.getItem("mountainyam_seed"));
		ginseng = JSON.parse(localStorage.getItem("ginseng"));
		ginseng_seed_available = JSON.parse(localStorage.getItem("ginseng_seed_available"));
		ginseng_seed_supply = JSON.parse(localStorage.getItem("ginseng_seed_supply"));
		ginseng_seed_unlock = JSON.parse(localStorage.getItem("ginseng_seed_unlock"));
		ginseng_seed = JSON.parse(localStorage.getItem("ginseng_seed"));
		nightingale_painting_available = JSON.parse(localStorage.getItem("nightingale_painting_available"));
		wall_painting = JSON.parse(localStorage.getItem("wall_painting"));
		study_painting = JSON.parse(localStorage.getItem("study_painting"));
		lost = JSON.parse(localStorage.getItem("lost"));
		feather = JSON.parse(localStorage.getItem("feather"));
		feather_color = JSON.parse(localStorage.getItem("feather_color"));
		seen_stove = JSON.parse(localStorage.getItem("seen_stove"));
		kindling = JSON.parse(localStorage.getItem("kindling"));
		iron = JSON.parse(localStorage.getItem("iron"));
		safe_mushroom = JSON.parse(localStorage.getItem("safe_mushroom"));
		poisonous_mushroom = JSON.parse(localStorage.getItem("poisonous_mushroom"));
		invincible = JSON.parse(localStorage.getItem("invincible"));
		medallion = JSON.parse(localStorage.getItem("medallion"));

		//misc
		waterfall = JSON.parse(localStorage.getItem("waterfall"));
		spider_count = JSON.parse(localStorage.getItem("spider_count"));
		spider_hp = 0;
		in_bookshop = 0;

		//character traits
		knowledge = JSON.parse(localStorage.getItem("knowledge"));
		charm = JSON.parse(localStorage.getItem("charm"));
		courtesy = JSON.parse(localStorage.getItem("courtesy"));
		curiosity = JSON.parse(localStorage.getItem("curiosity"));
		humility = JSON.parse(localStorage.getItem("humility"));
		honesty = JSON.parse(localStorage.getItem("honesty"));
		religious = JSON.parse(localStorage.getItem("religious"));
		charitable = JSON.parse(localStorage.getItem("charitable"));
		discipline = JSON.parse(localStorage.getItem("discipline"));
		fallen = JSON.parse(localStorage.getItem("fallen"));
		books_read = JSON.parse(localStorage.getItem("books_read"));
		treasure = JSON.parse(localStorage.getItem("treasure"));
		taxes = JSON.parse(localStorage.getItem("taxes"));
		well_dressed = JSON.parse(localStorage.getItem("well_dressed"));
		training = JSON.parse(localStorage.getItem("training"));
		debtor = JSON.parse(localStorage.getItem("debtor"));
		bankrupt = JSON.parse(localStorage.getItem("bankrupt"));
		rocksmash = JSON.parse(localStorage.getItem("rocksmash"));
		rocksmash_active = 0;
		foraging = JSON.parse(localStorage.getItem("foraging"));
		animalaffinity = JSON.parse(localStorage.getItem("animalaffinity"));
		fed_turtle = JSON.parse(localStorage.getItem("fed_turtle"));
		greenthumb = JSON.parse(localStorage.getItem("greenthumb"));
		peace = JSON.parse(localStorage.getItem("peace"));
		
		//date trackers
		previous_day = JSON.parse(localStorage.getItem("previous_day"));
		gao_appointment = JSON.parse(localStorage.getItem("gao_appointment"));
		invest_day = JSON.parse(localStorage.getItem("invest_day"));
		loan_day = JSON.parse(localStorage.getItem("loan_day"));
		party_day = JSON.parse(localStorage.getItem("party_day"));
		upgrade_day = JSON.parse(localStorage.getItem("upgrade_day"));
		upgrading = JSON.parse(localStorage.getItem("upgrading"));
		time_travel_day = JSON.parse(localStorage.getItem("time_travel_day"));
		demons_defeated_day = JSON.parse(localStorage.getItem("demons_defeated_day"));
		
		//romance
		anli_date = JSON.parse(localStorage.getItem("anli_date"));
		anli_friendship = JSON.parse(localStorage.getItem("anli_friendship"));
		anli_rock = JSON.parse(localStorage.getItem("anli_rock"));
		anli_respect = JSON.parse(localStorage.getItem("anli_respect"));
		lifen_date = JSON.parse(localStorage.getItem("lifen_date"));
		lifen_friendship = JSON.parse(localStorage.getItem("lifen_friendship"));
		lifen_nightingale = JSON.parse(localStorage.getItem("lifen_nightingale"));
		lifen_respect = JSON.parse(localStorage.getItem("lifen_respect"));
		accuse_lifen = JSON.parse(localStorage.getItem("accuse_lifen"));
		sparred_with_lifen = JSON.parse(localStorage.getItem("sparred_with_lifen"));
		match_balance = JSON.parse(localStorage.getItem("match_balance"));
		lifen_energy = JSON.parse(localStorage.getItem("lifen_energy"));
		lifen_location = JSON.parse(localStorage.getItem("lifen_location"));
		
		//relics
		flute_broken = JSON.parse(localStorage.getItem("flute_broken"));
		amulet = JSON.parse(localStorage.getItem("amulet"));
		silver_dagger = JSON.parse(localStorage.getItem("silver_dagger"));
		silver_dagger_cursed = JSON.parse(localStorage.getItem("silver_dagger_cursed"));
		sculpture_broken = JSON.parse(localStorage.getItem("sculpture_broken"));
		sculpture_available = JSON.parse(localStorage.getItem("sculpture_available"));
		seen_notice = JSON.parse(localStorage.getItem("seen_notice"));
		seen_sculpture = JSON.parse(localStorage.getItem("seen_sculpture"));
		take_sculpture = JSON.parse(localStorage.getItem("take_sculpture"));
		met_nephew = JSON.parse(localStorage.getItem("met_nephew"));
		relic_count = JSON.parse(localStorage.getItem("relic_count"));
		peach = JSON.parse(localStorage.getItem("peach"));
		theft_solved = JSON.parse(localStorage.getItem("theft_solved"));
		tour_in_session = JSON.parse(localStorage.getItem("tour_in_session"));
		completed_tour = JSON.parse(localStorage.getItem("completed_tour"));
		
		//endgame
		time_portal = JSON.parse(localStorage.getItem("time_portal"));
		traveled_to_past = JSON.parse(localStorage.getItem("traveled_to_past"));
		future_present = JSON.parse(localStorage.getItem("future_present"));
		game_finished = JSON.parse(localStorage.getItem("game_finished"));
		imp_doors = JSON.parse(localStorage.getItem("imp_doors"));
		chose_left_door = JSON.parse(localStorage.getItem("chose_left_door"));
		chose_right_door = JSON.parse(localStorage.getItem("chose_right_door"));
		fight_imp = JSON.parse(localStorage.getItem("fight_imp"));
		dispel_illusion = JSON.parse(localStorage.getItem("dispel_illusion"));
		clue = JSON.parse(localStorage.getItem("clue"));

		//boss fight
		qin_fallen = JSON.parse(localStorage.getItem("qin_fallen"));

		//epilogue
		egg = JSON.parse(localStorage.getItem("egg"));
		leather_boots  = JSON.parse(localStorage.getItem("leather_boots"));
		scallion_crepes = JSON.parse(localStorage.getItem("scallion_crepes"));
		firestick = JSON.parse(localStorage.getItem("firestick"));
		mooncakes = JSON.parse(localStorage.getItem("mooncakes"));
		companion = JSON.parse(localStorage.getItem("companion"));
		companion_name = JSON.parse(localStorage.getItem("companion_name"));
		companion_health = JSON.parse(localStorage.getItem("companion_health"));
		companion_status = JSON.parse(localStorage.getItem("companion_status"));
		companion_color = JSON.parse(localStorage.getItem("companion_color"));
		shi_amount = JSON.parse(localStorage.getItem("shi_amount"));
		shi_playing = JSON.parse(localStorage.getItem("shi_playing"));
		jun_amount = JSON.parse(localStorage.getItem("jun_amount"));
		jun_playing = JSON.parse(localStorage.getItem("jun_playing"));
	}

	function landing_page() {
		reset_display();
		$(game_title).attr("class","game_title");
		$(game_title).show();
		game_saved = JSON.parse(localStorage.getItem("game_saved"));
		game_finished = JSON.parse(localStorage.getItem("game_finished"));
		if(game_saved) {
			if(game_finished == 2) {
				$(game_title).html("<h1>The TRAVELER's BALLAD</h1><button onclick='continue_game()'>Return to Imperial Road</button><br><button onclick='game_start()'>Start Over</button>");
			} else {
				$(game_title).html("<h1>The TRAVELER's BALLAD</h1><button onclick='continue_game()'>Return to Aunt Lin's Farm</button><br><button onclick='game_start()'>Start Over</button>");
			}
		} else {
			$(game_title).html("<h1>The TRAVELER's BALLAD</h1><button onclick='game_start()'>Travel to Aunt Lin's Farm</button><br>");
		}
		$(container).hide();
		$(sidePanel).hide();
	}

	function game_start() {
		$(container).show();
		reset_display();
		$(sidePanel).show();
		$(game_title).html('');
		$(game_title).attr("class","notification");
		$(game_title).hide();
		new_game();
		$(display).html('Upon arriving at Aunt Lin&#39;s farm, I find two gentlemen standing outside the cottage. They approach me and bow.<br>"Greetings," the man on the right says, "I am Constable Long. With me is the venerable Elder Song. May we have the honor of knowing your name?"<br><br>');
		$(actions).html('<input type="text" id="my_name" placeholder="Traveler"></input> <button onclick="request_name()">Give Name</button>');
		$("#sidePanel").show();
		$("#time").html("Morning (<i>"+weather[0]+"</i>)");
		$("#date").html("Day "+current_day+"<br>"+current_loc);
		updateInventory(inventory_map);
		$("#hemptunic_button").attr('disabled','disabled');
		$("#equipped").html(equipped_items);
		$("#skills").html("None");
		$("#money").html(money+'g');
		$(artwork).html(opening_art);
	}

	function continue_game() {
		$(container).show();
		reset_display();
		$(sidePanel).show();
		load_game();
		$(game_title).html('');
		$(game_title).attr("class","notification");
		$(game_title).hide();
		background_music = new Audio(soundfile);
		background_music.loop = true;
		music = 1;
		$("#sidePanel").show();
		$(".stamina").val(stamina);
		$(".stamina").css("color", health_color);
		if(invincible > 0) {
			$("#hp").html("Healthiness: <strong>9000%+!</strong>");
		} else {
			$("#hp").html("Healthiness: "+health_max+"%");
		}
		$('.stamina').attr('max', total_health);
		if(egg){
			$("#phoenix_egg").html('<br>Phoenix Egg<br><progress id="egg_bar" value="5" max="5"></progress><div id="egg_hatch">Hatched: 1%</div>');
			$("#egg_bar").css("color", "red");
		}
		if(companion) {
			$("#travel_companion").html('<br>'+companion_name+'<br><progress id="companion_bar" value="'+companion_health+'" max="10"></progress><div id="companion_attribute"></div>');
			$("#companion_bar").css("color", companion_color);
			updateCompanionAttribute();
		}
		updateInventory(inventory_map);
		$("#equipped").html(equipped_items);
		var s = skills_active.concat(skills_passive);
		if(s.length){
			$("#skills").html(skills_active.concat(skills_passive));
		} else {
			$("#skills").html("None");
		}
		$("#use_rocksmash").attr('disabled','disabled');
		$("#money").html(money+'g');
		if(game_finished == 2) {
			$(settings).append('<br><button onclick="support()">SUPPORT</button><br><div id="contact"><button onclick="contact()">CONTACT</button></div>');
			updateLocation("Soldier Camp");
			time = 9;
			$("#time").html("<strong>Night</strong> (<i>windy</i>)");
			campsite2();
		} else {
			updateLocation("Aunt Lin's farm");
			$("#time").html("Morning (<i>"+weather[0]+"</i>)");
			$("#use_forage").attr('disabled','disabled');
			return_to_farm();
		}
		$("#date").html("Day "+current_day+"<br>"+current_loc);
	}

	function save_game() {
		game_saved = 1;
		localStorage.setItem("game_saved", JSON.stringify(game_saved));
		localStorage.setItem("name", JSON.stringify(name));
		localStorage.setItem("money", JSON.stringify(money));
		localStorage.setItem("inventory_map",JSON.stringify(Array.from(inventory_map.entries())));
		localStorage.setItem("equipped_items", JSON.stringify(equipped_items));
		localStorage.setItem("skills_active", JSON.stringify(skills_active));
		localStorage.setItem("skills_passive", JSON.stringify(skills_passive));
		localStorage.setItem("current_day", JSON.stringify(current_day));
		localStorage.setItem("time", JSON.stringify(time));
		localStorage.setItem("time_of_day", JSON.stringify(time_of_day));
		localStorage.setItem("current_loc", JSON.stringify(current_loc));
		localStorage.setItem("weather", JSON.stringify(weather));
		localStorage.setItem("stamina", JSON.stringify(stamina));
		localStorage.setItem("health_max", JSON.stringify(health_max));
		localStorage.setItem("total_health", JSON.stringify(total_health));
		localStorage.setItem("health_color", JSON.stringify(health_color));
		localStorage.setItem("sleep_quality", JSON.stringify(sleep_quality));
		localStorage.setItem("exhaustion", JSON.stringify(exhaustion));
		localStorage.setItem("artwork_url", JSON.stringify(artwork_url));
		localStorage.setItem("soundfile", JSON.stringify(soundfile));
		localStorage.setItem("plots", JSON.stringify(plots));
		localStorage.setItem("plot_status", JSON.stringify(plot_status));
		localStorage.setItem("harvest_day", JSON.stringify(harvest_day));
		localStorage.setItem("field_grown", JSON.stringify(field_grown));
		localStorage.setItem("rocks", JSON.stringify(rocks));
		localStorage.setItem("logs", JSON.stringify(logs));
		localStorage.setItem("wardrobe_index", JSON.stringify(wardrobe_index));
		localStorage.setItem("items", JSON.stringify(items));
		localStorage.setItem("items_cap", JSON.stringify(items_cap));
		localStorage.setItem("official_cap", JSON.stringify(official_cap));
		localStorage.setItem("costs", JSON.stringify(costs));
		localStorage.setItem("silk_fan", JSON.stringify(silk_fan));
		localStorage.setItem("silk_sash", JSON.stringify(silk_sash));
		localStorage.setItem("silk_robe", JSON.stringify(silk_robe));
		localStorage.setItem("hemp_tunic", JSON.stringify(hemp_tunic));
		localStorage.setItem("bronze_sword_available", JSON.stringify(bronze_sword_available));
		localStorage.setItem("bronze_sword", JSON.stringify(bronze_sword));
		localStorage.setItem("steel_sword", JSON.stringify(steel_sword));
		localStorage.setItem("wooden_staff", JSON.stringify(wooden_staff));
		localStorage.setItem("leather_tunic_available", JSON.stringify(leather_tunic_available));
		localStorage.setItem("leather_tunic", JSON.stringify(leather_tunic));
		localStorage.setItem("chainmail", JSON.stringify(chainmail));
		localStorage.setItem("baos_available", JSON.stringify(baos_available));
		localStorage.setItem("baos", JSON.stringify(baos));
		localStorage.setItem("baos_price", JSON.stringify(baos_price));
		localStorage.setItem("peony_available", JSON.stringify(peony_available));
		localStorage.setItem("pickaxe_available", JSON.stringify(pickaxe_available));
		localStorage.setItem("axe_available", JSON.stringify(axe_available));
		localStorage.setItem("lantern_available", JSON.stringify(lantern_available));
		localStorage.setItem("crane_painting_available", JSON.stringify(crane_painting_available));
		localStorage.setItem("blanket_available", JSON.stringify(blanket_available));
		localStorage.setItem("sandals_available", JSON.stringify(sandals_available));
		localStorage.setItem("straw_sandals", JSON.stringify(straw_sandals));
		localStorage.setItem("goji", JSON.stringify(goji));
		localStorage.setItem("goji_seed_available", JSON.stringify(goji_seed_available));
		localStorage.setItem("goji_seed_supply", JSON.stringify(goji_seed_supply));
		localStorage.setItem("goji_seed", JSON.stringify(goji_seed));
		localStorage.setItem("mountainyam", JSON.stringify(mountainyam));
		localStorage.setItem("mountainyam_seed_available", JSON.stringify(mountainyam_seed_available));
		localStorage.setItem("mountainyam_seed_supply", JSON.stringify(mountainyam_seed_supply));
		localStorage.setItem("mountainyam_seed_unlock", JSON.stringify(mountainyam_seed_unlock));
		localStorage.setItem("mountainyam_seed", JSON.stringify(mountainyam_seed));
		localStorage.setItem("ginseng", JSON.stringify(ginseng));
		localStorage.setItem("ginseng_seed_available", JSON.stringify(ginseng_seed_available));
		localStorage.setItem("ginseng_seed_supply", JSON.stringify(ginseng_seed_supply));
		localStorage.setItem("ginseng_seed_unlock", JSON.stringify(ginseng_seed_unlock));
		localStorage.setItem("ginseng_seed", JSON.stringify(ginseng_seed));
		localStorage.setItem("nightingale_painting_available", JSON.stringify(nightingale_painting_available));
		localStorage.setItem("wall_painting", JSON.stringify(wall_painting));
		localStorage.setItem("study_painting", JSON.stringify(study_painting));
		localStorage.setItem("lost", JSON.stringify(lost));
		localStorage.setItem("feather", JSON.stringify(feather));
		localStorage.setItem("feather_color", JSON.stringify(feather_color));
		localStorage.setItem("seen_stove", JSON.stringify(seen_stove));
		localStorage.setItem("kindling", JSON.stringify(kindling));
		localStorage.setItem("iron", JSON.stringify(iron));
		localStorage.setItem("safe_mushroom", JSON.stringify(safe_mushroom));
		localStorage.setItem("poisonous_mushroom", JSON.stringify(poisonous_mushroom));
		localStorage.setItem("invincible", JSON.stringify(invincible));
		localStorage.setItem("medallion", JSON.stringify(medallion));
		localStorage.setItem("waterfall", JSON.stringify(waterfall));
		localStorage.setItem("spider_count", JSON.stringify(spider_count));
		localStorage.setItem("knowledge", JSON.stringify(knowledge));
		localStorage.setItem("charm", JSON.stringify(charm));
		localStorage.setItem("courtesy", JSON.stringify(courtesy));
		localStorage.setItem("curiosity", JSON.stringify(curiosity));
		localStorage.setItem("humility", JSON.stringify(humility));
		localStorage.setItem("honesty", JSON.stringify(honesty));
		localStorage.setItem("religious", JSON.stringify(religious));
		localStorage.setItem("charitable", JSON.stringify(charitable));
		localStorage.setItem("discipline", JSON.stringify(discipline));
		localStorage.setItem("fallen", JSON.stringify(fallen));
		localStorage.setItem("books_read", JSON.stringify(books_read));
		localStorage.setItem("treasure", JSON.stringify(treasure));
		localStorage.setItem("taxes", JSON.stringify(taxes));
		localStorage.setItem("well_dressed", JSON.stringify(well_dressed));
		localStorage.setItem("training", JSON.stringify(training));
		localStorage.setItem("debtor", JSON.stringify(debtor));
		localStorage.setItem("bankrupt", JSON.stringify(bankrupt));
		localStorage.setItem("rocksmash", JSON.stringify(rocksmash));
		localStorage.setItem("foraging", JSON.stringify(foraging));
		localStorage.setItem("animalaffinity", JSON.stringify(animalaffinity));
		localStorage.setItem("fed_turtle", JSON.stringify(fed_turtle));
		localStorage.setItem("greenthumb", JSON.stringify(greenthumb));
		localStorage.setItem("peace", JSON.stringify(peace));
		localStorage.setItem("previous_day", JSON.stringify(previous_day));
		localStorage.setItem("gao_appointment", JSON.stringify(gao_appointment));
		localStorage.setItem("invest_day", JSON.stringify(invest_day));
		localStorage.setItem("loan_day", JSON.stringify(loan_day));
		localStorage.setItem("party_day", JSON.stringify(party_day));
		localStorage.setItem("upgrade_day", JSON.stringify(upgrade_day));
		localStorage.setItem("upgrading", JSON.stringify(upgrading));
		localStorage.setItem("time_travel_day", JSON.stringify(time_travel_day));
		localStorage.setItem("demons_defeated_day", JSON.stringify(demons_defeated_day));
		localStorage.setItem("anli_date", JSON.stringify(anli_date));
		localStorage.setItem("anli_friendship", JSON.stringify(anli_friendship));
		localStorage.setItem("anli_rock", JSON.stringify(anli_rock));
		localStorage.setItem("anli_respect", JSON.stringify(anli_respect));
		localStorage.setItem("lifen_date", JSON.stringify(lifen_date));
		localStorage.setItem("lifen_friendship", JSON.stringify(lifen_friendship));
		localStorage.setItem("lifen_nightingale", JSON.stringify(lifen_nightingale));
		localStorage.setItem("lifen_respect", JSON.stringify(lifen_respect));
		localStorage.setItem("accuse_lifen", JSON.stringify(accuse_lifen));
		localStorage.setItem("sparred_with_lifen", JSON.stringify(sparred_with_lifen));
		localStorage.setItem("match_balance", JSON.stringify(match_balance));
		localStorage.setItem("lifen_energy", JSON.stringify(lifen_energy));
		localStorage.setItem("lifen_location", JSON.stringify(lifen_location));
		localStorage.setItem("flute_broken", JSON.stringify(flute_broken));
		localStorage.setItem("amulet", JSON.stringify(amulet));
		localStorage.setItem("silver_dagger", JSON.stringify(silver_dagger));
		localStorage.setItem("silver_dagger_cursed", JSON.stringify(silver_dagger_cursed));
		localStorage.setItem("sculpture_broken", JSON.stringify(sculpture_broken));
		localStorage.setItem("sculpture_available", JSON.stringify(sculpture_available));
		localStorage.setItem("seen_notice", JSON.stringify(seen_notice));
		localStorage.setItem("seen_sculpture", JSON.stringify(seen_sculpture));
		localStorage.setItem("take_sculpture", JSON.stringify(take_sculpture));
		localStorage.setItem("met_nephew", JSON.stringify(met_nephew));
		localStorage.setItem("relic_count", JSON.stringify(relic_count));
		localStorage.setItem("peach", JSON.stringify(peach));
		localStorage.setItem("theft_solved", JSON.stringify(theft_solved));
		localStorage.setItem("tour_in_session", JSON.stringify(tour_in_session));
		localStorage.setItem("completed_tour", JSON.stringify(completed_tour));
		localStorage.setItem("time_portal", JSON.stringify(time_portal));
		localStorage.setItem("traveled_to_past", JSON.stringify(traveled_to_past));
		localStorage.setItem("future_present", JSON.stringify(future_present));
		localStorage.setItem("game_finished", JSON.stringify(game_finished));
		localStorage.setItem("imp_doors", JSON.stringify(imp_doors));
		localStorage.setItem("chose_left_door", JSON.stringify(chose_left_door));
		localStorage.setItem("chose_right_door", JSON.stringify(chose_right_door));
		localStorage.setItem("fight_imp", JSON.stringify(fight_imp));
		localStorage.setItem("dispel_illusion", JSON.stringify(dispel_illusion));
		localStorage.setItem("clue", JSON.stringify(clue));
		localStorage.setItem("qin_fallen", JSON.stringify(qin_fallen));
		localStorage.setItem("egg", JSON.stringify(egg));
		localStorage.setItem("leather_boots", JSON.stringify(leather_boots));
		localStorage.setItem("scallion_crepes", JSON.stringify(scallion_crepes));
		localStorage.setItem("firestick", JSON.stringify(firestick));
		localStorage.setItem("mooncakes", JSON.stringify(mooncakes));
		localStorage.setItem("companion", JSON.stringify(companion));
		localStorage.setItem("companion_name", JSON.stringify(companion_name));
		localStorage.setItem("companion_health", JSON.stringify(companion_health));
		localStorage.setItem("companion_status", JSON.stringify(companion_status));
		localStorage.setItem("companion_color", JSON.stringify(companion_color));
		localStorage.setItem("shi_amount", JSON.stringify(shi_amount));
		localStorage.setItem("shi_playing", JSON.stringify(shi_playing));
		localStorage.setItem("jun_amount", JSON.stringify(jun_amount));
		localStorage.setItem("jun_playing", JSON.stringify(jun_playing));
	}
	
	function addToInventory(key,value) {
		inventory_map.set(key,value);
		var sorted_inventory = new Map([...inventory_map].sort());
		inventory_map = sorted_inventory;
		updateInventory(sorted_inventory);
	}
	
	function updateInventory(map){
		$("#inventory").html("");
		for (var [key, value] of map) {
			$("#inventory").append("<div class='"+key+"'>"+value+"</div>");
		}
		var s = $("#select_inventory_button").html();
		if(s == "EQUIPMENT"){
			$("#inventory").children().hide();
			$(".e_item").show();
		}else if(s == "FOOD") {
			$("#inventory").children().hide();
			$(".f_item").show();
		}else if(s == "QUEST") {
			$("#inventory").children().hide();
			$(".q_item").show();
		}else if(s == "RELATIONSHIP") {
			$("#inventory").children().hide();
			$(".r_item").show();
		}else if(s == "TOOLS") {
			$("#inventory").children().hide();
			$(".t_item").show();
		}else if(s == "SHOW ALL") {
			$("#inventory").children().hide();
		}
		if(amulet){
			$("#amberamulet_button").attr('disabled','disabled');
		}
		if(medallion){
			$("#medallion_button").attr('disabled','disabled');
		}
		if(silk_sash){
			$("#silksash_button").attr('disabled','disabled');
		}
		if(silk_robe){
			$("#silkrobe_button").attr('disabled','disabled');
		}
		if(leather_tunic){
			$("#leathertunic_button").attr('disabled','disabled');
		}
		if(chainmail){
			$("#chainmail_button").attr('disabled','disabled');
		}
		if(straw_sandals){
			$("#strawsandals_button").attr('disabled','disabled');
		}
		if(silk_fan){
			$("#silkfan_button").attr('disabled','disabled');
		}
		if(bronze_sword){
			$("#bronzesword_button").attr('disabled','disabled');
		}
		if(steel_sword){
			$("#steelsword_button").attr('disabled','disabled');
		}
		if(silver_dagger){
			$("#silverdagger_button").attr('disabled','disabled');
		}
		if(wooden_staff){
			$("#woodenstaff_button").attr('disabled','disabled');
		}
		if(hemp_tunic){
			$("#hemptunic_button").attr('disabled','disabled');
		}
	}
	
	function equip(text){
		switch(text) {
			case 1: //civil official hat
				$("#e_hat").html("<div id='hat_equipped'>Civil Official Hat <button onclick='unequip(1)'>Unequip</button></div>");
				$("#civilhat_button").attr('disabled','disabled');
		    break;
			case 2: //amber amulet
				$("#e_necklace").html("<div id='necklace_equipped'>Amber Amulet <button onclick='unequip(2)'>Unequip</button></div>");
				amulet = 1;
				$("#amberamulet_button").attr('disabled','disabled');
				medallion = 0;
				$("#medallion_button").removeAttr('disabled');
		    break;
			case 3: //silk sash
				$("#e_belt").html("<div id='belt_equipped'>Silk Sash <button onclick='unequip(3)'>Unequip</button></div>");
				silk_sash = 1;
				$("#silksash_button").attr('disabled','disabled');
			break;
			case 4: //silk robe
				$("#e_body").html("<div id='body_equipped'>Silk Robe <button onclick='unequip(4)'>Unequip</button></div>");
				silk_robe = 1;
				$("#silkrobe_button").attr('disabled','disabled');
				hemp_tunic = 0;
				$("#hemptunic_button").attr('disabled','disabled');
				leather_tunic = 0;
				$("#leathertunic_button").removeAttr('disabled');
				chainmail = 0;
				$("#chainmail_button").removeAttr('disabled');
			break;
			case 5: //leather tunic
				$("#e_body").html("<div id='body_equipped'>Leather Tunic <button onclick='unequip(5)'>Unequip</button></div>");
				leather_tunic = 1;
				$("#leathertunic_button").attr('disabled','disabled');
				silk_robe = 0;
				$("#silkrobe_button").removeAttr('disabled');
				hemp_tunic = 0;
				$("#hemptunic_button").removeAttr('disabled');
			break;
			case 6: //chainmail
				$("#e_body").html("<div id='body_equipped'>Chainmail Tunic <button onclick='unequip(6)'>Unequip</button></div>");
				chainmail = 1;
				$("#chainmail_button").attr('disabled','disabled');
				silk_robe = 0;
				$("#silkrobe_button").removeAttr('disabled');
				hemp_tunic = 0;
				$("#hemptunic_button").removeAttr('disabled');
		    break;
			case 7: //straw sandals
				$("#e_shoes").html("<div id='shoes_equipped'>Straw Sandals <button onclick='unequip(7)'>Unequip</button></div>");
				straw_sandals = 1;
				$("#strawsandals_button").attr('disabled','disabled');
		    break;
			case 8: //silk fan (can't unequip during endgame)
				if(future_present && (soundfile == "fight.mp3")){
					$("#e_hand").html("<div id='hand_equipped'>Silk Fan</div>");
				} else {
					$("#e_hand").html("<div id='hand_equipped'>Silk Fan <button onclick='unequip(8)'>Unequip</button></div>");
				}
				silk_fan = 1;
				$("#silkfan_button").attr('disabled','disabled');
				wooden_staff = 0;
				$("#woodenstaff_button").removeAttr('disabled');
				bronze_sword = 0;
				$("#bronzesword_button").removeAttr('disabled');
				steel_sword = 0;
				$("#steelsword_button").removeAttr('disabled');
				silver_dagger = 0;
				$("#silverdagger_button").removeAttr('disabled');
			break;
			case 9: //bronze sword (can't unequip during endgame)
				if(future_present && (soundfile == "fight.mp3")){
					$("#e_hand").html("<div id='hand_equipped'>Bronze Sword</div>");
				} else {
					$("#e_hand").html("<div id='hand_equipped'>Bronze Sword <button onclick='unequip(9)'>Unequip</button></div>");
				}
				bronze_sword = 1;
				$("#bronzesword_button").attr('disabled','disabled');
				silk_fan = 0;
				$("#silkfan_button").removeAttr('disabled');
				wooden_staff = 0;
				$("#woodenstaff_button").removeAttr('disabled');
				silver_dagger = 0;
				$("#silverdagger_button").removeAttr('disabled');
				$("#yell").html("<button onclick='attack_spider()'>Attack</button><br><button onclick='scare()'>Yell</button>");
			break;
			case 10: //steel sword (can't unequip during endgame)
				$("#steelsword_button").attr('disabled','disabled');
				if(future_present && (soundfile == "fight.mp3")){
					$("#e_hand").html("<div id='hand_equipped'>Steel Sword</div>");
				} else {
					$("#e_hand").html("<div id='hand_equipped'>Steel Sword <button onclick='unequip(10)'>Unequip</button></div>");
				}
				silk_fan = 1;
				$("#silkfan_button").removeAttr('disabled');
				wooden_staff = 0;
				$("#woodenstaff_button").removeAttr('disabled');
				steel_sword = 1;
				$("#steelsword_button").attr('disabled','disabled');
				silver_dagger = 0;
				$("#silverdagger_button").removeAttr('disabled');
				$("#yell").html("<button onclick='attack_spider()'>Attack</button><br><button onclick='scare()'>Yell</button>");
			break;
			case 11: //silver dagger (can't unequip during endgame)
				$("#silverdagger_button").attr('disabled','disabled');
				if(future_present && (soundfile == "fight.mp3")){
					$("#e_hand").html("<div id='hand_equipped'>Silver Dagger</div>");
				} else {
					$("#e_hand").html("<div id='hand_equipped'>Silver Dagger <button onclick='unequip(11)'>Unequip</button></div>");
				}
				silk_fan = 1;
				$("#silkfan_button").removeAttr('disabled');
				wooden_staff = 0;
				$("#woodenstaff_button").removeAttr('disabled');
				bronze_sword = 0;
				$("#bronzesword_button").removeAttr('disabled');
				steel_sword = 0;
				$("#steelsword_button").removeAttr('disabled');
				silver_dagger = 1;
				$("#silverdagger_button").attr('disabled','disabled');
				$("#yell").html("<button onclick='attack_spider()'>Attack</button><br><button onclick='scare()'>Yell</button>");
		    break;
			case 12: //wooden staff (can't unequip during endgame)
				$("#woodenstaff_button").attr('disabled','disabled');
				if(future_present && (soundfile == "fight.mp3")){
					$("#e_hand").html("<div id='hand_equipped'>Wooden Staff</div>");
				} else {
					$("#e_hand").html("<div id='hand_equipped'>Wooden Staff <button onclick='unequip(12)'>Unequip</button></div>");
				}
				silk_fan = 0;
				$("#silkfan_button").removeAttr('disabled');
				wooden_staff = 1;
				$("#woodenstaff_button").attr('disabled','disabled');
				bronze_sword = 0;
				$("#bronzesword_button").removeAttr('disabled');
				steel_sword = 0;
				$("#steelsword_button").removeAttr('disabled');
				silver_dagger = 0;
				$("#silverdagger_button").removeAttr('disabled');
				$("#yell").html("<button onclick='attack_spider()'>Attack</button><br><button onclick='scare()'>Yell</button>");
		    break;
			case 13:
				$("#e_necklace").html("<div id='necklace_equipped'>Platinum Medallion <button onclick='unequip(13)'>Unequip</button></div>");
				medallion = 1;
				$("#medallion_button").attr('disabled','disabled');
				amulet = 0;
				$("#amberamulet_button").removeAttr('disabled');
			break;
			case 14:
				$("#e_shoes").html("<div id='shoes_equipped'>Leather Boots <button onclick='unequip(14)'>Unequip</button></div>");
				leather_boots = 1;
				$("#leatherboots_button").attr('disabled','disabled');
				straw_sandals = 1;
				$("#strawsandals_button").removeAttr('disabled');
			break;
			default: //hemp tunic
				$("#hemptunic_button").attr('disabled','disabled');
				$("#e_body").html("<div id='body_equipped'>Hemp Tunic</div>");
				hemp_tunic = 1;
				$("#hemptunic_button").attr('disabled','disabled');
				silk_robe = 0;
				$("#silkrobe_button").removeAttr('disabled');
				leather_tunic = 0;
				$("#leathertunic_button").removeAttr('disabled');
				chainmail = 0;
				$("#chainmail_button").removeAttr('disabled');
		}
		equipped_items = $("#equipped").html();
	}
	
	function unequip(text){
		switch(text) {
			case 1: //civil official hat
				$("#e_hat").html("");
				$("#civilhat_button").removeAttr('disabled');
		    break;
			case 2: //amber amulet
				$("#e_necklace").html("");
				$("#amberamulet_button").removeAttr('disabled');
				amulet = 0;
		    break;
			case 3: //silk sash
				$("#e_belt").html("");
				$("#silksash_button").removeAttr('disabled');
			break;
			case 4: //silk robe
				equip(0);
			break;
			case 5: //leather tunic
				equip(0);
			break;
			case 6: //chainmail
				equip(0);
		    break;
			case 7: //straw sandals
				$("#e_shoes").html("");
				$("#strawsandals_button").removeAttr('disabled');
				straw_sandals = 0;
		    break;
			case 8: //silk fan
				$("#e_hand").html("");
				$("#silkfan_button").removeAttr('disabled');
			break;
			case 9: //bronze sword
				$("#e_hand").html("");
				$("#bronzesword_button").removeAttr('disabled');
				bronze_sword = 0;
			break;
			case 10: //steel sword
				$("#e_hand").html("");
				$("#steelsword_button").removeAttr('disabled');
				steel_sword = 0;
			break;
			case 11: //silver dagger
				$("#e_hand").html("");
				$("#silverdagger_button").removeAttr('disabled');
				silver_dagger = 0;
			break;
			case 12: //wooden staff
				$("#e_hand").html("");
				$("#woodenstaff_button").removeAttr('disabled');
				wooden_staff = 0;
			break;
			case 13: //medallion of honor
				$("#e_necklace").html("");
				$("#medallion_button").removeAttr('disabled');
				medallion = 0;
			break;
			default: //unequip all weapons
				$("#e_hand").html("");
				$("#silkfan_button").removeAttr('disabled');
				$("#bronzesword_button").removeAttr('disabled');
				bronze_sword = 0;
				$("#steelsword_button").removeAttr('disabled');
				steel_sword = 0;
				$("#silverdagger_button").removeAttr('disabled');
				silver_dagger = 0;
				$("#woodenstaff_button").removeAttr('disabled');
				wooden_staff = 0;
		}
		equipped_items = $("#equipped").html();
	}
	
	function addSkill(s,text){ //text = 1 is active skill
		$("#skills").html("");
		if(text == 1) {
			skills_active.push(s);
			skills_active.sort();
		} else {
			skills_passive.push(s);
			skills_passive.sort();
		}
		for (var i = 0; i < skills_active.length; i++) {
			$("#skills").append(skills_active[i]);
		}
		for (var i = 0; i < skills_passive.length; i++) {
			$("#skills").append(skills_passive[i]);
		}
		var s = $("#select_skills_button").html();
		if(s == "ACTIVE") {
			$("#skills").children().hide();
			$(".active_skill").show();
		}else if (s == "PASSIVE") {
			$("#skills").children().hide();
			$(".passive_skill").show();
		} else if (s == "HIDDEN") {
			$("#skills").children.hide();
		}
		$("#use_forage").attr('disabled','disabled');
		$("#use_rocksmash").attr('disabled','disabled');
	}

	function updateTime(text) {
		if(traveled_to_past) {
			time_of_day = 1;
			$("#time").html("Afternoon (<i>sunny</i>)");
			return;
		}
		if (leather_boots && (text >= .25)) {
			text -= .25;
		}
		//accepts time in hours, do not increment 24 or more hours
		time += text;
		var hour = Math.floor(time);
		var minutes = time - Math.floor(time);

		if (future_present && !game_finished) {
			time_of_day = 3;
		} else {
			if (time >= 25) {
				current_day += 1;
				time = 1 + minutes;
				updateWeather();
			}
			if (time >= 8 && time < 12) {
				time_of_day = 0;
			} else if (time >= 12 && time < 18) {
				time_of_day = 1;
			} else {
				time_of_day = 2;
			} 
		}

		switch(time_of_day) {
		  case 1:
		    $("#time").html("Afternoon (<i>"+weather[1]+"</i>)");
			if(alerts && !noon_alert){
				day_alert = 0;
				noon_alert = 1;
				night_alert = 0;
				dismiss_alert = 1;
				$(game_title).show();
				$(game_title).html('It is now afternoon. <button id="notice_time" onclick="dismiss()">Dismiss (10)</button>');
				notice_timer = 9;
				auto_dismiss();
			}
		    break;
		  case 2:
		    $("#time").html("<strong>Night</strong> (<i>"+weather[2]+"</i>)");
			if(alerts && !night_alert){
				day_alert = 0;
				noon_alert = 0;
				night_alert = 1;
				day_alert = 0;
				dismiss_alert = 1;
				$(game_title).show();
				$(game_title).html('It is now night. <button id="notice_time" onclick="dismiss()">Dismiss (10)</button>');
				notice_timer = 9;
				auto_dismiss();
			}
		    break;
		  default:
			if (future_present && !game_finished) {
				$("#time").html("Morning (<i>ominous</i>)");
			} else {
				$("#time").html("Morning (<i>"+weather[0]+"</i>)");
				if(alerts && !day_alert){
					day_alert = 1;
					noon_alert = 0;
					night_alert = 0;
					dismiss_alert = 1;
					$(game_title).show();
					$(game_title).html('It is now morning. <button id="notice_time" onclick="dismiss()">Dismiss (10)</button>');
					notice_timer = 9;
					auto_dismiss();
				}
			}
		}
		$("#date").html("Day "+current_day+"<br>"+current_loc);
	}
	
	function updateWeather(){
		var weather_chance = Math.random();
		var m;
		if(weather_chance > .4){
			m = "sunny";
		} else {
			m = "partly sunny";
		}
		var a = "sunny";
		var n;
		if(weather_chance > .3){
			n = "mild";
		} else {
			n = "breezy";
		}
		weather = [m,a,n];
	}
	
	function updateLocation(text) {
		current_loc = text;
		$("#date").html("Day "+current_day+"<br>"+current_loc);
	}

	function updateStamina(text) {
		if(straw_sandals){
			text += .5;
		}
		if(invincible > 0) {
			invincible += text;
			text = 0;
			health_color = "green";
			$("#hp").html("Healthiness: <strong>9000%+!</strong>");
		} else {
			if(alerts && (health_color == "green")) {
				$(game_title).show();
				dismiss_alert = 1;
				$(game_title).html('The effects from the Red Mushroom have worn off. <button id="notice_time" onclick="dismiss()">Dismiss (10)</button>');
				notice_timer = 9;
				auto_dismiss();
			}
			if(health_max > 100) {
				health_color = "orange";
			} else {
				health_color = "dodgerblue";
			}
			$("#hp").html("Healthiness: "+health_max+"%");
		}
		$(".stamina").css("color", health_color);
		var currentStamina = $(".stamina").val();
		var newStamina = currentStamina + text;
		if(newStamina <= 20 && alerts && !stamina_alert){
			$(game_title).show();
			dismiss_alert = 1;
			$(game_title).html('My stamina is low! <button id="notice_time" onclick="dismiss()">Dismiss (10)</button><br><button onclick="rest()">Go Home and Sleep</button>');
			notice_timer = 9;
			auto_dismiss();
			stamina_alert = 1;
		}
		if(!exhaustion && (newStamina <= 0)) {
			if(future_present && !game_finished) {
				fallen += 1;
				$(".stamina").val(0);
				$(game_title).show();
				dismiss_alert = 0;
				if(fallen == 1) {
					$(game_title).html('I collapse from weariness in my fight against the demons... With great effort, I manage to rise. I must not give up yet...<br><strong>Fallen 1 time.</strong> <button onclick="dismiss()">Dismiss</button>');
				} else {
					$(game_title).html('I collapse from weariness in my fight against the demons... With great effort, I manage to rise. I must not give up yet...<br><strong>Fallen '+fallen+' times.</strong> <button onclick="dismiss()">Dismiss</button>');
				}
				$(".stamina").val(health_max);
				return true;
			}
			$(".stamina").val(0);
			exhaustion = 1;
			if(health_max > 50) {
				health_max -= 10;
				$("#hp").html("Healthiness: "+health_max+"%");
			}
			if(health_max > 100) {
				health_color = "orange";
			} else {
				health_color = "dodgerblue";
			}
			$(".stamina").css("color", health_color);
			$(game_title).show();
			dismiss_alert = 0;
			$(game_title).html('<strong>I have fainted from exhaustion! My overall health declines...</strong><br>I should keep an eye on my stamina. <strong>Better go home and rest.</strong>');
			$(display_persist).css("opacity","50%");
			$(display).css("opacity","50%");
			$(actions).html('<button onclick="rest()">Return to Aunt Lin&#39;s Farm</button>');
			$(artwork).empty();
			$(".eat").attr('disabled','disabled');
			$("#use_forage").attr('disabled','disabled');
			$("#use_rocksmash").attr('disabled','disabled');
			discipline = 0;
			return true;
		}
		if(newStamina > health_max){
			newStamina = health_max;
		}
		$(".stamina").val(newStamina);
		return false;
	}
	
	function dismiss() {
		$(".notification").hide();
	}
	
	var notice_timer;
	var auto_dismiss_timeout;
	function auto_dismiss() {
		var dismiss_countdown = setInterval(function(){
  			if(notice_timer <= 0){
    			clearInterval(dismiss_countdown);
    			if(dismiss_alert) {
    				dismiss();
    			}
  			} else {
    			$("#notice_time").html("Dismiss ("+notice_timer+")");
  			}
  			notice_timer -= 1;
		}, 1000);
	}

	//intro
	
	function request_name() {
		name = $("#my_name").val() || "Traveler";
		var previous = $(display).html();
		$(display_last).html(previous);
		$(display).html('The honor is mine, I say, bowing in return. I am called '+name+'.<br>');
		$(display).append('"Ah, '+name+'!" Elder Song exclaims, "That&#39;s right! Your Aunt Lin mentioned that you would be visiting." He smiles. "I dare say <i>mentioned</i> is an understatement. Ever since she received the news of your trip, she has not stopped singing your praise to the folks around here. By now, we all have the high expectations of Lin Mei-hua&#39;s favorite relative. I gather she has not seen you in many years and misses you greatly. We are pleased to welcome you to Pleasant Weather Hamlet!"<br><br>');
		$(actions).html("<button onclick='request_name_c1()'>Continue</button>");
	}
	
	function request_name_c1() {
		var previous = $(display).html();
		$(display_last).html(previous);
		$(display).html('Thank you, I say.<br>Elder Song&#39;s voice grows somber. "You have traveled a long way and must be eager to greet your aunt. Unfortunately, I am afraid that I have bad news. For you see, at present your Aunt Lin is not here on her farm."<br><br>');
		$(actions).html("<button onclick='intro1()'>Where is Aunt Lin?</button><br>");
	}

	function intro1() {
		var previous = $(display).html();
		$(display_last).html(previous);
		$(display).html("Where has she gone? I ask.<br>");
		$(display).append('Constable Long clears his throat. "She is missing," he says, tracing his thumb and pointer finger from the top of horseshoe-shaped mustache down to the ends. "Your aunt was last seen approximately two days ago. The folks from our small hamlet who said they saw her around that time told me that she appeared to be in good health and high spirits, as she was eagerly anticipating your arrival. However at some point in the past two days, she has mysteriously disappeared."<br><br>');
		$(actions).html("<button onclick='intro1_c1()'>Disappeared?</button><br>");
		$(actions).append("<button onclick='intro2()'>Thank you for letting me know.</button>");
	}
	
	function intro1_c1() {
		var previous = $(display).html();
		$(display_last).html(previous);
		$(display).html('Perhaps she left the hamlet?<br>');
		$(display).append('The Constable shakes his head. "No. Since Pleasant Weather Hamlet is situated at the base of a mountain, there is only one path in or out," he says. "It is the same one that you came by to get here from the Imperial Road, a trek that as you know requires several days to make in either direction. So if your aunt departed the hamlet in the last two days, you would have undoubtedly encountered her on your way in. My fear is that she went into the nearby woods... Given the tricky nature of that forest...and the stories lately surrounding it... Well...I hope my suspicions are wrong."<br><br>');
		$(actions).html("<button onclick='intro1_c2()'>Tell me about the woods.</button><br>");
		$(actions).append("<button onclick='intro2()'>Thank you for letting me know.</button>");
		curiosity[0] = 1;
	}
	
	function intro1_c2() {
		var previous = $(display).html();
		$(display_last).html(previous);
		$(display).html('What stories are told about the woods? I ask.<br>Constable Long hesitates, giving Elder Song a quick glance. He lowers his voice. "I don&#39;t mean to alarm you...but as of late, a growing number of folks have reported hearing strange howls from deep within the forest. What&#39;s more, several of these folks have shared similar accounts with me, claiming that they saw large, glowing eyes watching them from among the trees as they were passing by. As a result, people around here are starting to believe that the woods have become possessed by spirits&mdash;"<br><br>');
		$(actions).html("<button onclick='intro1_c3()'>Continue</button>");
	}
	
	function intro1_c3() {
		var previous = $(display).html();
		$(display_last).html(previous);
		$(display).html('"Bah!" Elder Song scoffs. "Rumors and superstition! '+name+', I assure you that, despite the simple-mindedness of some of the folks around here, your aunt has not been whisked away by wild spirits. I, Elder Song, have lived my whole life in Pleasant Weather Hamlet, and have heard all manners of tales told about our woods&mdash;none has ever proven to be true. These stories are as fanciful as the idea of rain in our idyllic hamlet! Still, the good Constable is right in pointing out that our woods can be perplexing to navigate, unless one has the appropriate knowledge... In any event, he will be conducting a thorough search of the woods to see if he can find any signs of your aunt. However, knowing the sufficient type of person Mei-hua is, even if she did go into the woods, I cannot imagine that she would have found much trouble her."<br><br>');
		$(actions).html("<button onclick='intro1_c4()'>Continue</button>");
	}
	
	function intro1_c4() {
		var previous = $(display).html();
		$(display_last).html(previous);
		$(display).html('That&#39;s reassuring, I say.<br>"Yes..." Elder Song says. He takes a moment to sigh. "Forgive me, I am old and tire easily these days. But before I take my leave, I want to tell you not to worry too much about your Aunt Lin. Now that you have arrived, I am certain it is only a matter of time before the two of you are reunited. After all: <i>Fate brings together those from even a thousand <i>li</i> apart.</i> For now, I suggest you watch over her farm until she returns." <br><br>');
		$(actions).html("<button onclick='intro1_c5()'>Continue</button>");
	}
	
	function intro1_c5() {
		var previous = $(display).html();
		$(display_last).html(previous);
		$(display).html('Well," Elder Song says, "Look at me still prattling on! You must be weary from your travels. We will let you rest. Come by my residence later, and we can talk more over some freshly steeped tea."<br>Constable Long adds, "I will let you know if I find any leads during my investigation."<br><br>');
		$(display).append('I bow deeply. My thanks to you both.<br>');
		$(display).append('The two gentlemen bow in return and depart, leaving me to tend to Aunt Lin&#39;s farm.<br><br>');
		$(actions).html("<button onclick='return_to_farm()'>Explore Aunt Lin's Farm</button><br>");
		$(actions).append("<button onclick='hamlet()'>Visit Pleasant Weather Hamlet</button>");
	}

	function intro2() {
		var previous = $(display).html();
		$(display_last).html(previous);
		$(display).html('I appreciate the information you have shared with me, I say. I am sure my aunt will turn up soon.<br>');
		$(display).append('Elder Song nods in agreement. "You must be weary from your long travels," he says. "We will let you rest. Come by my residence later, and we can talk more over some freshly steeped tea."<br>Constable Long adds, "I will let you know if I find any leads during my investigation."<br><br>');
		$(display).append('I bow deeply. My thanks to you both.<br>');
		$(display).append("The two gentlemen bow and depart, leaving me to tend to Aunt Lin's farm.<br><br>");
		$(actions).html("<button onclick='return_to_farm()'>Explore Aunt Lin's Farm</button><br>");
		$(actions).append("<button onclick='hamlet()'>Visit Pleasant Weather Hamlet</button>");
		courtesy += 1;
	}
	
	function reset_display(){
		$(display_persist).html('');
		$(display_last).html('');
		$(display).html('');
	}


	//Aunt Lin's Farm

	function field() {
		var collapse = updateStamina(-1.5);
		if(collapse){
			return;
		}
		updateTime(.25);
		reset_display();
		$(display_persist).html("The field is small, but the soil appears to be fertile.<br><br>");
		$(display_persist).append("<table id='fieldPlots'></table><br>");
		$(actions).html('');
		var harvestReady = check_field_has_grown();
		update_field();
		if(rocks > 0) {
			$(actions).append("<div id='clear_rocks'><button onclick='clear_rocks()'>Clear Rock</button></div>");
			$("#use_rocksmash").removeAttr('disabled');
		}
		if(logs > 0) {
			$(actions).append("<div id='clear_logs'><button onclick='clear_logs()'>Clear Log</button></div>");
		}
		if (harvestReady) {
			$(actions).append("<div id='harvest'><button onclick='harvest()'>Harvest Field</button></div>");
		}
		if(goji_seed > 0) {
			$(actions).append("<div id='plantS'><button onclick='plant_field(1)'>Plant Goji Berry Seed</button></div>");
		}
		if (mountainyam_seed > 0) {
			$(actions).append("<div id='plantC'><button onclick='plant_field(2)'>Plant Mountain Yam Tuber</button></div>");
		}
		if (ginseng_seed > 0) {
			$(actions).append("<div id='plantG'><button onclick='plant_field(3)'>Plant Ginseng Root</button></div>");
		}
		var fieldNotFull = check_field_has_space();
		if(!fieldNotFull) {
			$("#plantS").hide();
			$("#plantC").hide();
			$("#plantG").hide();
		}
		$(actions).append("<button onclick='return_to_farm()'>Return to Aunt's Lin Farm</button>");
	}

	function update_field() {
		$("#fieldPlots").html('<tr><td>'+plots[0]+'<br>'+plot_status[0]+'</td><td>'+plots[1]+'<br>'+plot_status[1]+'</td></tr><tr><td>'+plots[2]+'<br>'+plot_status[2]+'</td><td>'+plots[3]+'<br>'+plot_status[3]+'</td></tr><br>');
	}

	function remove_from_field(text, count, force) {
		var i;
		var harvest_count = 0;
		for (i = 0; i < plots.length; i++) {
			if(plots[i] == text) {
		  		if (field_grown[i] || force) {
			  		plots[i] = '';
			  		plot_status[i] = '';
			  		harvest_day[i] = 987654321987654321;
			  		field_grown[i] = 0;
				  	harvest_count += 1;
				  	count -= 1;
				  	if (count == 0) {
				  		return harvest_count;
			  		}
		  		}	
			}
		}
		return harvest_count;
	}

	function check_field_has_space() {
		var i;
		for (i = 0; i < plots.length; i++) {
		  if(plots[i] == '') {
		  	return 1;
		  }
		}
		return 0;
	}

	function plant_field(text) {
		var plant;
		var grow_time;
		if (text == 1) {
			var collapse = updateStamina(-5);
			if(collapse){
				return;
			}
			updateTime(1);
			plant = "Goji Berry";
			grow_time = 2;
			goji_seed -= 1;
			if(goji_seed == 0) {
				$(".goji_item").remove();
				inventory_map.delete("goji_item");
				$("#plantS").remove();
			} else {
				$(".goji_item").html("Goji Berry Seed ("+goji_seed+"x)");
				inventory_map.set("goji_item","Goji Berry Seed ("+goji_seed+"x)");
			}
		} else if (text == 2) {
			var collapse = updateStamina(-10);
			if(collapse){
				return;
			}
			updateTime(1.5);
			plant = "Mountain Yam";
			grow_time = 3;
			mountainyam_seed -= 1;
			if(mountainyam_seed == 0) {
				$(".mountainyam_item").remove();
				inventory_map.delete("mountainyam_item");
				$("#plantC").remove();
			} else {
				$(".mountainyam_item").html("Mountain Yam Tuber ("+mountainyam_seed+"x)");
				inventory_map.set("mountainyam_item","Mountain Yam Tuber ("+mountainyam_seed+"x)");
			}
		} else {
			var collapse = updateStamina(-15);
			if(collapse){
				return;
			}
			updateTime(2);
			plant = "Ginseng";
			grow_time = 4;
			ginseng_seed -= 1;
			if(ginseng_seed == 0) {
				$(".ginseng_item").remove();
				inventory_map.delete("ginseng_item");
				$("#plantG").remove();
			} else {
				$(".ginseng_item").html("Ginseng Root ("+ginseng_seed+"x)");
				inventory_map.set("ginseng_item","Ginseng Root ("+ginseng_seed+"x)");
			}
		}
		var previous = $(display).html();
		$(display_last).html(previous);
		var i;
		for (i = 0; i < plots.length; i++) {
		  if(plots[i] == '') {
			plots[i] = plant;
			plot_status[i] = "(growing)";
			$(display).html("Planted "+plant+"!<br><br>");
			harvest_day[i] = current_day+grow_time;
			update_field();
			var fieldNotFull = check_field_has_space();
			if(!fieldNotFull) {
				$("#plantS").hide();
				$("#plantC").hide();
				$("#plantG").hide();
			}
			return;
		  }
		}
	}

	function check_field_has_grown() {
		var toReturn = 0;
		var i;
		for (i = 0; i < harvest_day.length; i++) {
		  if(current_day >= harvest_day[i]) {
		  	toReturn = 1;
		  	field_grown[i] = 1;
		  	plot_status[i] = "(grown)";
		  }
		}
		return toReturn;
	}

	function harvest() {
		var collapse = updateStamina(-20);
		if(collapse){
			return;
		}
		var previous = $(display).html();
		$(display_last).html(previous);
		updateTime(2);
		var s = remove_from_field("Goji Berry",4,0);
		var c = remove_from_field("Mountain Yam",4,0);
		var g = remove_from_field("Ginseng",4,0);
		
		$(display).html('');
		if (s) {
			$(display).append("<strong>Harvested Goji Berry ("+s*3+"x)! Harvested new Goji Berry Seed ("+s+"x)!</strong><br><br>");
			goji += s*3;
			if($(".goji_box").length) {
				$(".goji_box").html("Goji Berry ("+goji+"x) <button class='eat' onclick='eat_food(1,5)'>Eat</button>");
				inventory_map.set("goji_box f_item","Goji Berry ("+goji+"x) <button class='eat' onclick='eat_food(1,5)'>Eat</button>");
			} else {
				addToInventory("goji_box f_item","Goji Berry ("+goji+"x) <button class='eat' onclick='eat_food(1,5)'>Eat</button>");
			}
			goji_seed += s;
			if(goji_seed >= 2) {
				goji_seed_available = 0;
			}
			if($(".goji_item").length) {
				$(".goji_item").html("Goji Berry Seed ("+goji_seed+"x)");
				inventory_map.set("goji_item","Goji Berry Seed ("+goji_seed+"x)");
			} else {
				addToInventory("goji_item","Goji Berry Seed ("+goji_seed+"x)");
			}
		}
		if (c) {
			$(display).append("<strong>Harvested Mountain Yam ("+c*2+"x)! Harvested new Mountain Yam Tuber ("+c+"x)!</strong><br><br>");
			mountainyam = c*2;
			if($(".mountainyam_box").length) {
				$(".mountainyam_box").html("Mountain Yam ("+mountainyam+"x) <button class='eat' onclick='eat_food(2,15)'>Eat</button>");
				inventory_map.set("mountainyam_box f_item","Mountain Yam ("+mountainyam+"x) <button class='eat' onclick='eat_food(2,15)'>Eat</button>");
			} else {
				addToInventory("mountainyam_box f_item","Mountain Yam ("+mountainyam+"x) <button class='eat' onclick='eat_food(2,15)'>Eat</button>");
			}
			mountainyam_seed += c;
			if(mountainyam_seed >= 4) {
				mountainyam_seed_available = 0;
			}
			if($(".mountainyam_item").length) {
				$(".mountainyam_item").html("Mountain Yam Tuber ("+mountainyam_seed+"x)");
				inventory_map.set("mountainyam_item","Mountain Yam Tuber ("+mountainyam_seed+"x)");
			} else {
				addToInventory("mountainyam_item","Mountain Yam Tuber ("+mountainyam_seed+"x)");
			}
		}
		if (g) {
			greenthumb = 1;
			$(display).append("<strong>Harvested Ginseng ("+g+"x)! Harvested new Ginseng Root ("+g+"x)!</strong><br><br>");
			ginseng = g;
			if($(".ginseng_box").length) {
				$(".ginseng_box").html("Ginseng ("+ginseng+"x) <button class='eat' onclick='eat_food(3,50)'>Eat</button>");
				inventory_map.set("ginseng_box f_item","Ginseng ("+ginseng+"x) <button class='eat' onclick='eat_food(3,50)'>Eat</button>");
			} else {
				addToInventory("ginseng_box f_item","Ginseng ("+ginseng+"x) <button class='eat' onclick='eat_food(3,50)'>Eat</button>");
			}
			ginseng_seed += g;
			if(ginseng_seed >= 2) {
				ginseng_seed_available = 0;
			}
			if($(".ginseng_item").length) {
				$(".ginseng_item").html("Ginseng Root ("+ginseng_seed+"x)");
				inventory_map.set("ginseng_item","Ginseng Root ("+ginseng_seed+"x)");
			} else {
				addToInventory("ginseng_item","Ginseng Root ("+ginseng_seed+"x)");
			}
		}
		$("#harvest").remove();
		update_field();
		$(actions).html("");
		if(rocks > 0) {
			$(actions).append("<div id='clear_rocks'><button onclick='clear_rocks()'>Clear Rock</button></div>");
		}
		if(logs > 0) {
			$(actions).append("<div id='clear_logs'><button onclick='clear_logs()'>Clear Log</button></div>");
		}
		if(goji_seed > 0) {
			$(actions).append("<div id='plantS'><button onclick='plant_field(1)'>Plant Goji Berry Seed</button></div>");
		}
		if (mountainyam_seed > 0) {
			$(actions).append("<div id='plantC'><button onclick='plant_field(2)'>Plant Mountain Yam Tuber</button></div>");
		}
		if (ginseng_seed > 0) {
			$(actions).append("<div id='plantG'><button onclick='plant_field(3)'>Plant Ginseng Root</button></div>");
		}
		$(actions).append("<button onclick='return_to_farm()'>Return to Aunt's Lin Farm</button>");
	}

	function clear_rocks() {
		if (rocksmash_active) {
			var collapse = updateStamina(-10);
			if(collapse){
				return;
			}
			updateTime(.5);
			var previous = $(display).html();
			$(display_last).html(previous);
			$(display).html("I smash a rock with my bare fist! Whoa, what a rush of adrenaline! ");
			rocks -= 1;
			if (!inventory_map.get("key_item q_item")) {
				$(display).append("<strong>I find a key!</strong> I wonder what it's for... ");
				addToInventory("key_item q_item","Key");
			}
			$(display).append("<br><br>I can plant on this plot of land now.<br><br>");
			if (rocks == 0) {
				$("#clear_rocks").remove();
			}
			remove_from_field('Rock',1,1);
			update_field();
			$("#plantS").show();
			$("#plantC").show();
			$("#plantG").show();
		} else if(inventory_map.get("bronzepickaxe_item t_item") || inventory_map.get("steelpickaxe_item t_item t_item")) {
			var collapse;
			if(inventory_map.get("bronzepickaxe_item t_item")){
				collapse = updateStamina(-15);
			} else {
				collapse = updateStamina(-5);
			}
			if(collapse){
				return;
			}
			updateTime(1);
			var previous = $(display).html();
			$(display_last).html(previous);
			$(display).html("I break a rock with my pickaxe... ");
			if (!inventory_map.get("key_item q_item")) {
				$(display).append("<strong>I find a key!</strong> I wonder what it's for...");
				addToInventory("key_item q_item","Key");
			}
			else if(!inventory_map.get("coal_item")) {
				$(display).append("<strong>I uncover coal while mining the rock!</strong>");
				addToInventory("coal_item","Coal (1x)");
			}
			$(display).append("<br><br>I can plant on this plot of land now.<br><br>");
			rocks -= 1;
			if (rocks == 0) {
				$("#clear_rocks").remove();
			}
			remove_from_field('Rock',1,1);
			update_field();
			$("#plantS").show();
			$("#plantC").show();
			$("#plantG").show();
		} else {
			var collapse = updateStamina(-5);
			if(collapse){
				return;
			}
			updateTime(.25);
			var previous = $(display).html();
			$(display_last).html(previous);
			$(display).html("I try to push the large rock... It doesn't move. Better use a tool.<br><br>");
			$("#clear_rocks").remove();
		}
	}

	function clear_logs() {
		if(inventory_map.get("bronzeaxe_item t_item") || inventory_map.get("steelaxe_item t_item t_item")) {
			var collapse;
			if(inventory_map.get("bronzeaxe_item t_item")){
				collapse = updateStamina(-20);
			} else {
				collapse = updateStamina(-10);
			}
			if(collapse){
				return;
			}
			updateTime(1);
			var previous = $(display).html();
			$(display_last).html(previous);
			$(display).html("I chop a log with my axe... <strong>I acquire kindling!</strong><br><br>");
			if (!feather) {
				var c = ["Red","Yellow","Blue","White","Black"];
				var r = Math.floor(Math.random()*5);
				feather_color = c[r];
				var feather_lowercase = feather_color.toLowerCase();
				$(display).append("<strong>I find a "+feather_lowercase+" feather inside the log! </strong>Hmm, I wonder what kind of bird has this kind of feather...<br><br>");
				feather = 1;
				addToInventory(feather_lowercase+"feather_item q_item",feather_color+" Feather");
			} 
			$(display).append("I can plant on this plot of land now.<br><br>");
			logs -= 1;
			kindling += 1;
			addToInventory("kindling_item","Kindling ("+kindling+"x)");
			if (logs == 0) {
				$("#clear_logs").remove();
			}
			remove_from_field('Log',1,1);
			update_field();
			$("#plantS").show();
			$("#plantC").show();
			$("#plantG").show();
		} else {
			var collapse = updateStamina(-5);
			if(collapse){
				return;
			}
			updateTime(.25);
			var previous = $(display).html();
			$(display_last).html(previous);
			$(display).html("I try to lift the heavy log... It won't budge. Better use a tool.<br><br>");
			$("#clear_logs").remove();
		}
	}


	function cottage() {
		if(future_present && !game_finished) {
			$(".eat").removeAttr('disabled');
			$(artwork).empty();
			reset_display();
			updateLocation("Aunt Lin's cottage");
			change_music("cottage.mp3");
			$(display_persist).html('As Aunt Lin and I climb out of the cellar, there comes a knock at the door...<br><br>');
			$(actions).html("<button onclick='ask_name()'>Who&#39;s there?</button><br>");
			$(actions).append("<button onclick='answer_door()'>Answer Door</button>");
		} else if(traveled_to_past) {
			$(".eat").removeAttr('disabled');
			$(artwork).empty();
			reset_display();
			updateLocation("Aunt Lin's cottage");
			change_music("cottage.mp3");
			$(display_persist).html('I emerge from the cellar.<br>Aunt Lin looks up from the table where she is writing and blinks in surprise. "'+name+'? Is that really <i>you</i>? Heaven, these old eyes of mine must be playing tricks on me...I wasn&#39;t expecting you for another two days!" Aunt Lin gives me a stern look. "And why is it that you are climbing out of my cellar like that? My goodnesss dear, just look at the dust on your clothes!"<br><br>');
			$(display_persist).append('I quickly tell Aunt Lin everything that has happened...<br><br>');
			$(actions).html("<button onclick='cottage_c1()'>Continue</button>");
		} else {
			var collapse = updateStamina(-1.5);
			if(collapse){
				return;
			}
			updateTime(.25);
			updateLocation("Aunt Lin's cottage");
			change_music("cottage.mp3");
			reset_display();
			$(".eat").removeAttr('disabled');
			$(artwork).empty();
			$(display_persist).html("The cottage is rustic but well-decorated. It fits a bed, a table, and a stove. ");
			if(wall_painting == 1) {
				$(display_persist).append("A painting of a nightingale hangs on the wall by the window.");
			} else if (wall_painting == 2) {
				$(display_persist).append("A painting of a crane hangs on the wall by the window.");
			} else if (!wall_painting) {
				$(display_persist).append("The walls are bare except for the window.");
			}
			$(display_persist).append("<br><br>");
			$(actions).html("");
			if (game_finished) {
				if (seen_stove && !egg) {
					if(time_of_day !=0) {
						$(display_persist).append("<strong>Aunt Lin stands by the stove.</strong><br><br>");
						$(actions).append("<div id='approach_auntlin'><button onclick='approach_auntlin()'>Approach Aunt Lin</button></div>");
					} else {
						$(display_persist).append("Aunt Lin sits at the table.<br><br>");
						$(actions).append("<div id='talk_to_auntlin'><button onclick='talk_to_auntlin()'>Talk to Aunt Lin</button></div>");
						$(artwork).html(aunt_art);
					}
				} else if (time_of_day == 2){
					$(display_persist).append("Aunt Lin has gone to sleep on a cot on the floor, insisting that I take the bed.<br><br>");					
				} else {
					$(display_persist).append("Aunt Lin sits at the table.<br><br>");
					$(actions).append("<div id='talk_to_auntlin'><button onclick='talk_to_auntlin()'>Talk to Aunt Lin</button></div>");
					$(artwork).html(aunt_art);
				}				
			} 
			$(actions).append("<button onclick='inspect_bed()'>Inspect Bed</button><br>");
			$(actions).append("<button onclick='inspect_table()'>Inspect Table</button><br>");
			$(actions).append("<button onclick='inspect_stove()'>Inspect Stove</button><br>");
			$(actions).append("<div id='wall'></div>");
			if(wall_painting) {
				$("#wall").append("<div id='take_painting'><button onclick='take_painting()'>Take Painting</button></div>");
			}
			if (inventory_map.get("nightingale_item") || inventory_map.get("crane_item")) {
				$("#wall").append("<div id='hang_painting'><button onclick='hang_painting()'>Hang Painting</button></div>"); 
			}
			$(actions).append("<br><button onclick='return_to_farm()'>Go Back Outside</button>");
		}
	}
	
	function cottage_c1() {
		var previous = $(display).html();
		$(display_last).html(previous);
		$(display).html('Once I finish my story, Aunt Lin pulls me into a tight hug. "My sweet child," she says, "To think you went through all that trouble just to find me. Thank you, dear. I am so glad to see you safe and well."<br><br>');
		$(display).append('I have a lot questions, I say. Aunt Lin smiles gently. "I will help answer what I can," she says.<br><br>');
		$(actions).html("<div id='question_1'><button onclick='questions(1)'>Is this the past?</button></div>");
		$(actions).append("<div id='question_2'><button onclick='questions(2)'>Tell me about the gateway.</button></div>");
		$(actions).append("<div id='question_3'><button onclick='questions(3)'>Am I dreaming?</button></div>");
		$(actions).append("<div id='question_4'><button onclick='questions(4)'>You&#39;re not missing?</button></div>");
	}

	function talk_to_auntlin() {
		var collapse = updateStamina(-1.5);
		if(collapse){
			return;
		}
		updateTime(.25);
		var previous = $(display).html();
		$(display_last).html(previous);
		if (egg) {
			$(display).html('"Hello dear," Aunt Lin says with a gentle smile. "Have you been making preparations to depart Pleasant Weather Hamlet? You should set out for Uncle Meng&#39;s Ranch soon. It is a great distance from here."<br><br>');
			$(actions).html("<div id='ask_about_meng'><button onclick='ask_about_meng()'>Tell me about Great-Uncle Meng.</button></div>");
			$(actions).append("<div id='end_conversation'><button onclick='end_conversation()'>End Conversation</button></div>");
		} else {
			$(display).html('"Hello dear," Aunt Lin says with a gentle smile. "Keeping busy?"<br><br>');
			$(actions).html("<div id='ask_about_gateway'><button onclick='ask_about_gateway()'>Tell me about the gateway.</button></div>");
			$(actions).append("<div id='ask_about_day'><button onclick='ask_about_day()'>Any plans today?</button></div>");
			$(actions).append("<div id='end_conversation'><button onclick='end_conversation()'>End Conversation</button></div>");
		}
	}
	
	function approach_auntlin() {
		var collapse = updateStamina(-1.5);
		if(collapse){
			return;
		}
		updateTime(.25);
		var previous = $(display).html();
		$(display_last).html(previous);
		$(display).html('I walk where Aunt Lin is peering at something inside the clay pot on the stove. What are you doing? I ask.<br>');
		$(display).append('Aunt Lin gestures for me to look inside the clay pot. A small red egg lies in a nest at the bottom of the pot. On the surface of the red egg, I see a very faint crack. "It is beginning to hatch," Aunt Lin says, in a voice full of wonder. <br><br>');
		$(actions).html("<button onclick='ask_about_egg_c1()'>Where did the egg come from?</button>");
	}
	
	function ask_about_egg_c1() {
		var collapse = updateStamina(-1.5);
		if(collapse){
			return;
		}
		updateTime(.25);
		var previous = $(display).html();
		$(display_last).html(previous);
		$(display).html('Where did you find this egg? I ask.<br>"The night I received your letter letting me know that you were visiting," Aunt Lin says, still looking intently at the red egg, "I had a fantastic dream. In my dream, I saw through the window of the cottage, a beautiful, multi-colored bird fly over the open field and land in a tall tree outside. It&#39;s plumage contained all five of the Fundamental Colors: red, yellow, blue, white, and black, each representing one of the Five Elements and Five Constant Virtues. I am certain it was a <i>fenghuang</i>, a magnificent phoenix. I rushed out of the cottage just in time to see the mythical bird open its brilliant wings and take off. In the morning when I woke, I immediately went outside, but the field was back to how it was before, covered in rocks and fallen logs. Still, I felt content simply to have had the privilege of seeing a <i>fenghuang</i>, even if it was only in a dream. As I turned to walk back to the cottage, however, I froze. On top of one the fallen logs was a bird&#39;s nest with a brilliant red egg peeking out of it. There was no doubt in my mind that the egg was left by the <i>fenghuang</i> I saw in my dream. I quickly carried the nest inside and placed it in the clay pot, thinking that it might help to keep the egg protected and warm. But as it turns out, egg is able to create it&#39;s own heat!"<br><br>');
		$(actions).html("<button onclick='ask_about_egg_c2()'>Incredible!</button>");		
	}
	
	function ask_about_egg_c2() {
		var collapse = updateStamina(-1.5);
		if(collapse){
			return;
		}
		updateTime(.25);
		var previous = $(display).html();
		$(display_last).html(previous);
		$(display).html('What an amazing egg! I say. Aunt Lin smiles fondly at me. She reaches over and affectionately pinches my cheek. "'+name+'," she says in a serious voice, "My dear, I&#39;m afraid our time together is coming to an end. It saddens me to have to send you away, but I have a very important task to ask of you. Now that the egg is hatching, you must bring it to your Great-Uncle Meng&#39;s ranch as quickly as possible. Meng&#39;s Ranch is just outside the Capitol City. Uncle Meng is my mother&#39;s older brother as well as a renowned zoologist and expert on mythological creatures. The hatchling the comes out of this egg will be at its most vulnerable when it is first born...and Uncle Meng is the only person I know who has the knowledge and skill to care for such a rare and precious creature, so it is critical that you deliver the egg to him before the it hatches. I will write him a letter to inform him of your journey. Until the egg is in your great-uncle&#39;s care, you must make sure to keep it safe. It would disastrous if a phoenix egg were to fall into the wrong hands..." Aunt Lin carefully hands me the clay pot with the red egg. <strong>Obtained Phoenix Egg!</strong><br><br>');
		egg = 1;
		$("#phoenix_egg").html('<br>Phoenix Egg<br><progress id="egg_bar" value="5" max="5"></progress><div id="egg_hatch">Hatched: 1%</div>');
		$("#egg_bar").css("color", "red");
		$(actions).html("<div id='ask_about_meng'><button onclick='ask_about_meng()'>Tell me about Great-Uncle Meng.</button></div>");
		$(actions).append("<button onclick='end_conversation()'>End Conversation</button>");
	}

	function ask_about_meng() {
		var collapse = updateStamina(-1.5);
		if(collapse){
			return;
		}
		updateTime(.25);
		var previous = $(display).html();
		$(display_last).html(previous);
		$(display).html('Can you tell me more about Great-Uncle Meng? I ask.<br>Aunt Lin nods. "Of course dear," she says, "When I was a young girl, my mother told me many stories about her talented older brother. But one story in particular I will always remember, and it is an important one for you to know as well... As a young man, Uncle Meng decided to go to the Capitol City, seeking to make a name for himself there. His natural affinity for animals, especially exotic and even magical creatures, quickly earned him great fame. One day, he received a letter from the Imperial Palace&mdash;the Emperor, who desired to see a <i>qilin</i>, had heard about Uncle Meng&#39;s skills and sought consultation... Upon reading the letter, Uncle Meng immediately set out for the Imperial Palace, bringing with him his trained peacock."<br><br>');
		$("#ask_about_meng").html("<button onclick='ask_about_meng_c1()'>Continue</button>");
	}
	
	function ask_about_meng_c1() {
		var collapse = updateStamina(-1.5);
		if(collapse){
			return;
		}
		updateTime(.25);
		var previous = $(display).html();
		$(display_last).html(previous);
		$(display).html('"But when Uncle Meng arrived at the Imperial Palace," Aunt Lin says, "he was told by an Imperial Servant that the Emperor was busy and would not see him for another eight days. As the Imperial Servant led Uncle Meng to his assigned room, they saw Princess Qi, the Emperor&#39;s Seventh Daughter, and her Imperial Maids walking towards them from the opposite direction. Uncle Meng and servant quickly bowed, but all of a sudden, the peacock flew up into and towards Princess Qi! Uncle Meng, the servant, and all the maids were all too shocked to react, but fortunately Princess Qi calmly caught the bird, which promptly settled in her arms and remained still. There was a long silence as everyone looked aghast at the Princess. Uncle Meng bowed deeply and began to utter an apology when he heard the Princess burst out in laughter. In that very instant, he realized that he was madly in love with Princess Qi."<br><br>');
		$("#ask_about_meng").html("<button onclick='ask_about_meng_c2()'>What happened next?</button>");
	}
	
	function ask_about_meng_c2() {
		var collapse = updateStamina(-1.5);
		if(collapse){
			return;
		}
		updateTime(.25);
		var previous = $(display).html();
		$(display_last).html(previous);
		$(display).html('Go on, I say eagerly.<br>Aunt Lin sighs before continuing, "After that fleeting incident, Uncle Meng made up his mind to court the Princess, even though he was a commoner. Princess Qi enjoyed taking strolls in the Imperial Palace Garden, attended by maids, which gave Uncle Meng the perfect opportunity to talk to her. Over the next seven days, as the two got to know one another, a catastrophic thing happened&mdashPrincess Qi began to develop feelings toward Uncle Meng."<br><br>');
		$("#ask_about_meng").html("<button onclick='ask_about_meng_c3()'>Catastrophic?</button>");
	}
	
	function ask_about_meng_c3() {
		var collapse = updateStamina(-1.5);
		if(collapse){
			return;
		}
		updateTime(.25);
		var previous = $(display).html();
		$(display_last).html(previous);
		$(display).html('And that was bad because Great-Uncle Meng was a commoner? I ask Aunt Lin.<br>Aunt Lin nods. "Not only that, but unbeknowst to both of them, during those seven days, the Emperor had betrothed Princess Qi to a foreign prince from the Si Kindom as part of a broader deal between the kingdoms. When the Princess found out about the bethrothal, she demanded that the Emperor rescind it but it was too late...so Uncle Meng and Princess Qi decided they would flee the Imperial Palace together. They met up one night and snuck out of the gates, but they didn&#39;t get very far before the Imperial Guards caught them and brought them back to face the Emperor&#39;s judgement. Initially, the Emperor was furious, but he had also had a soft spot for his youngest daughter. After much pleading from her, the Emperor decided he would spare Uncle Meng&#39;s life... That very night, a <i>qilin</i> appeared in the Emperor&#39;s dream. The Emperor was so happy that when he woke up the next day, he immediately summoned Uncle Meng. It is said that the two of them talked for hours and the Emperor agreed to allow Princess Qi to marry Uncle Meng."<br><br>');
		$("#ask_about_meng").html("<button onclick='ask_about_meng_c4()'>And they lived happily ever after?</button>");
		
	}
	
	function ask_about_meng_c4() {
		var collapse = updateStamina(-1.5);
		if(collapse){
			return;
		}
		updateTime(.25);
		var previous = $(display).html();
		$(display_last).html(previous);
		$(display).html('But the Emperor must have changed his mind again, I say.<br>"Very astute," Aunt Lin tells me. "As Fate would have it, earning the Emperor&#39;s favor proved to be a double-edged sword. The other palace advisors looked down on Uncle Meng because of his status and were simultaneously also envious of him, so when they heard the Emperor was willing to allow him to marry a Princess, they began to conspire against him. They secretly informed the Si Kingdom that the Emperor was going to renege on the original deal and suggested that the Si Kingdom should threaten war. Then they whispered to the Emperor that if he wasn&#39;t going to execute Uncle Meng, he needed to at least exile him in order to prevent a war, and more importantly, to save face... Hearing this, the Emperor had no choice but to banish my uncle, but to his advisors&#39; great dismay, he decreed that the banishment extended only as far as the walls of the Capitol City and even granted Uncle Meng a plot of land right outside the city walls, along with a generous sum of money, as payment for his services in making the elusive <i>qilin</i> appear. Your great-uncle has lived alone on that land ever since, turning it into a ranch where he raises various birds and horses. I hear that his horses are often purchased by nobles to compete in the annual Diamond Race.<br><br>');
		$("#ask_about_meng").html("<div id='ask_about_princess'><button onclick='ask_about_princess()'>What happened to Princess Qi?</button></div><div id='ask_about_race'><button onclick='ask_about_race()'>Diamond Race?</button></div><div id='ask_about_letter'><button onclick='ask_about_letter()'>Have you written to Great-Uncle Meng?</button></div>");
	}

	function ask_about_race() {
		var collapse = updateStamina(-1.5);
		if(collapse){
			return;
		}
		updateTime(.25);
		var previous = $(display).html();
		$(display_last).html(previous);
		$(display).html('Tell me about the Diamond Race.<br>"It is a world famous sporting event held each year in the Capitol City right after the Mid-Autumn Festival. People arrive from across the Four Kingdoms to witness the best horses and jockeys compete. Even the Emperor and other Royal Families attend the race. The grand prize is a diamond-studded medallion awarded to the owner of the fastest horse. The jockey who rides the horse receives a sum of money as well, but it is the medallion that is worth a small fortune, enough to buy an entire estate. Horses purchased from Meng&#39;s Ranch have taken first several times, which is why the Ranch is famous among horseracing enthusiasts.<br><br>');
		$("#ask_about_race").remove();
	}

	function ask_about_princess() {
		var collapse = updateStamina(-1.5);
		if(collapse){
			return;
		}
		updateTime(.25);
		var previous = $(display).html();
		$(display_last).html(previous);
		$(display).html('Did Great-Uncle Meng ever see Princess Qi again? I ask.<br>Aunt Lin says, "No, I don&#39;t believe he did. After Uncle Meng&#39;s was exiled, Princess Qi could not be found at the Imperial Palace. A few people think she ran away, but most believe she was sent to the Si Kingdom to marry the foreign prince..."<<br><br>');
		$("#ask_about_princess").remove();
	}
	
	function ask_about_letter(){
		var collapse = updateStamina(-1.5);
		if(collapse){
			return;
		}
		updateTime(.25);
		var previous = $(display).html();
		$(display_last).html(previous);
		$(display).html('What did you tell Great-Uncle Meng in your letter, I ask Aunt Lin.<br> "I wrote that you are going to visit his ranch and that he should expect to receive...a gift. This way, if the letter happens to be intercepted, there is less risk to you while you are traveling on the Imperial Road where bandits and outlaws are likely to attack. I should also caution you... Even though I informed Uncle Meng of your arrival, don&#39;t be too surprised if he does not act very welcoming towards you when you first meet him... Be kind to him. He is an old man now and has carried a broken heart for so many years now that it has made him bitter and...unpleasant, but he is still a very talented person with a good heart... If you can revive his old spirit, I am certain he will warm up to you."<br><br>');
		$("#ask_about_letter").remove();
	}

	function ask_about_gateway() {
		var collapse = updateStamina(-1.5);
		if(collapse){
			return;
		}
		updateTime(.25);
		var previous = $(display).html();
		$(display_last).html(previous);
		$(display).html('Why do you have a magical gateway in the cellar?<br>');
		$(display).append('"I wish I knew the answer to that myself," Aunt Lin says. "I found the gateway already in the cellar when I first moved on the farm...although I am almost positive the cellar was empty when I toured the property. Anyways, come to think of it, the couple whom I bought the farm from were rather eccentric. They talked in a formal sort of a way, speaking to each other in a dialetic that I have never heard before or since...and they wore vintage clothes, the sort that was in fashion over a century ago!"<br><br>');
		$("#ask_about_gateway").remove();
	}

	function ask_about_day() {
		var collapse = updateStamina(-1.5);
		if(collapse){
			return;
		}
		updateTime(.25);
		var previous = $(display).html();
		$(display_last).html(previous);
		$(display).html('Any plans for today?<br>');
		$(display).append('"Oh, this and that," Aunt Lin says. "I think I might go down to the tailor shop to see if Mr. Chang has received any new outfits that I can try on..." Aunt Lin&#39;s cheeks appear especially rosy today.<br><br>');
		$("#ask_about_day").remove();
	}

	function end_conversation() {
		$(actions).html("");
		if (game_finished) {
			$(actions).append("<div id='talk_to_auntlin'><button onclick='talk_to_auntlin()'>Talk to Aunt Lin</button></div>"); 
		}
		$(actions).append("<button onclick='inspect_bed()'>Inspect Bed</button><br>");
		$(actions).append("<button onclick='inspect_table()'>Inspect Table</button><br>");
		$(actions).append("<button onclick='inspect_stove()'>Inspect Stove</button><br>");
		$(actions).append("<div id='wall'></div>");
		if(wall_painting) {
			$("#wall").append("<div id='take_painting'><button onclick='take_painting()'>Take Painting</button></div>");
		}
		if (inventory_map.get("nightingale_item") || inventory_map.get("crane_item")) {
			$("#wall").append("<div id='hang_painting'><button onclick='hang_painting()'>Hang Painting</button></div>"); 
		}
		$(actions).append("<br><button onclick='return_to_farm()'>Go Back Outside</button>");	
	}

	function answer_door() {
		change_music("forest.mp3");
		var previous = $(display).html();
		$(display_last).html(previous);
		$(display).html('I open the door to find Mr. Chang standing outside. He appears to be out of breath.<br><br>');
		$(display).append('Mr. Chang looks stunned to see Aunt Lin. "Mei-hua?" he exclaims. "You-you&#39;re back? When did you&mdash; Where&mdash;"<br>');
		$(display).append('"Just now, old friend," Aunt Lin says, giving him a gentle smile. Mr. Chang takes a sudden interest in his feet, which he shuffles nervously. His ordinarily stern expression softens.<br><br>');
		$(display).append('"Is everything okay, Ge-fei?" Aunt Lin asks. She holds up a hand. "First, catch your breath. A man your age should know better than to overexert himself like this! Just look at the state you are in! Heaven, did you run here? What could possibly be so important to bring you here in the middle of the night?"<br><br>');
		$(actions).html("<button onclick='answer_door_c1()'>Continue</button>");
	}
	
	function answer_door_c1() {
		var previous = $(display).html();
		$(display_last).html(previous);
		$(display).html('Mr Chang looks up at us and says in a rush, "But you see, Mei-hua, that&#39;s exactly the problem! It&#39;s <i>not</i> night time. Look!" Mr. Chang says, pointing to a spot in the dark sky where a glowing red disk burns like the inside of a fiery cauldron. "But don&#39;t stare for too long! Believe it or not, that is the sun!"<br><br>');
		$(actions).html("<button onclick='answer_door_c2()'>Continue</button>");
	}
	
	function answer_door_c2() {
		var previous = $(display).html();
		$(display_last).html(previous);
		$(display).html('Mr. Chang catches his breath as we stare at him in shock. "Let me explain," he says, "About an hour ago, I was working in my shop when suddenly I heard a loud noise, a thunderous CRACK that felt like someone had struck a large gong directly behind my head. In an instant, I became disoriented and could barely stand upright. As I stumbled outside for fresh air, I saw An-li and Ms. Ming also coming out of their stores from down the street, looking just as dazed as I felt. The moment we saw each other, we knew that something very wrong was going on. A large shadow suddenly fell over us, causing us to look up. When we did, we saw that the sky above us was rapidly growing dark... Our first thought was that an eclipse was happening, but then we realized that, in fact, the exact opposite phenomenon was occurring&mdash;you see, while the sun continued to shine overhead, redder than I have ever seen it, the sky was rapidly losing all of its color and turning pitch black!"<br><br>');
		$(actions).html("<button onclick='answer_door_c3()'>Continue</button>");
	}
	
	function answer_door_c3() {
		var previous = $(display).html();
		$(display_last).html(previous);
		$(display).html('Mr. Chang trembles as he finishes speaking. Aunt Lin reaches out and gently places a hand on his shoulder. "I&#39;m fine, I&#39;m fine," Mr. Chang says. He covers her hand with his, briefly. Then turning to me, he says, "Master Yang sent me to come find you. Quickly, we must go to the Sacred Peach Garden where Master Yang has gathered the entire hamlet. Everyone is waiting there.<br><br>');
		$(actions).html("<div id='ask_chang'><button onclick='ask_chang()'>Why?</button></div>");
		$(actions).append("<button onclick='endgame()'>Let's go.</button>");
	}

	function ask_name() {
		var previous = $(display).html();
		$(display_last).html(previous);
		$(display).html('Who is it? I call out.<br>"It&#39;s Chang Ge-fei!" comes the response.<br><br>');
		$(actions).html("<button onclick='answer_door()'>Open Door</button>");
	}

	function ask_chang() {
		var previous = $(display).html();
		$(display_last).html(previous);
		$(display).html("How come everyone is at the Sacred Peach Garden?<br>");
		$(display).append('"Because of the demons!" Mr. Chang says. "Apparently, there was a Demon Portal inside the Temple that somehow permitted several demons to escape from their realm to ours." Mr Chang shakes his head. "All this time, had I known I was living near such a thing, I would have moved away from Pleasant Weather Hamlet years ago!"<br><br>');
		$("#ask_chang").html("<button onclick='ask_chang2()'>Tell me about the demons.</button>");
	}

	function ask_chang2() {
		var previous = $(display).html();
		$(display_last).html(previous);
		$(display).html("Did you see the demons yourself?<br>");
		$(display).append('"No," Mr. Chang says, shaking his head. "I only heard about them from Master Yang. Earlier, as I was standing outside in total shock while the sky turned steadily black, Master Yang suddenly appeared in front of me. I was startled to see him, but even more startled by the look on his face. I have never seen a more fearsome expression before. Honestly, it terrified me more than what was going on in the sky. <br><br>&quot;Mr. Chang!&quot; Master Yang called to me in a booming voice. &quot;Demons have escaped into our realm through the Demon Portal inside the Peach Garden Temple. You must go to Lin Mei-Hua&#39;s farm and tell the two of them what has happened. Then bring them to the Peach Garden Temple at once. I will gather everyone inside the Sacred Peach Garden, the only safe place from the demons. We will wait there for you. <i>Go now, and with haste!</i>&quot; I didn&#39;t dare question Master Yang and ran here as fast as my old legs would carry me. I wasn&#39;t even sure who I was supposed to be looking for until I found the two of you."<br><br>');
		$("#ask_chang").remove();
	}

	function endgame() {
		updateLocation("Peach Garden Temple");
		change_music("cave.mp3");
		reset_display();
		$(display_persist).html("Mr. Chang, Aunt Lin, and I rush to the Peach Garden Temple...<br><br>");
		$(display_persist).append('The temple is eerily quiet as we enter. Mr. Chang open the door to the Sacred Peach Garden and waves us in.<br><br>');
		$(actions).html("<button onclick='endgame_c1()'>Enter Sacred Peach Garden</button>");
	}
	
	function endgame_c1() {
		$(display_persist).append('As soon as we enter, a crowd of heads turns in our direction.<br>"Xiao Lin?" Ms. Ming cries out. "Lin Mei-hua!" Several other voices echo her cry of surprise. Scanning the crowd, I spot Constable Long, Elder Song, Mr. and Mrs. Fan, Mr. Gao, Bookkeeper Tan...<br><br>');
		$(display_persist).append('"Master Yang is by the Sacred Peach Tree," Mr. Chang tells me. "Please go to him now."<br><br>');
		$(actions).html("<div id='talk_chang'><button onclick='talk_chang()'>Talk to Mr. Chang</button></div>");
		$(actions).append("<div id='talk_lin'><button onclick='talk_lin()'>Talk to Aunt Lin</button></div>");
		$(actions).append("<div id='talk_ming'><button onclick='talk_ming()'>Talk to Ms. Ming</button></div>");
		$(actions).append("<div id='talk_long'><button onclick='talk_long()'>Talk to Constable Long</button></div>");
		$(actions).append("<div id='talk_song'><button onclick='talk_song()'>Talk to Elder Song</button></div>");
		$(actions).append("<div id='talk_mrfan'><button onclick='talk_mrfan()'>Talk to Mr. Fan</button></div>");
		$(actions).append("<div id='talk_mrsfan'><button onclick='talk_mrsfan()'>Talk to Mrs. Fan</button></div>");
		$(actions).append("<div id='talk_mrgao'><button onclick='talk_mrgao()'>Talk to Mr. Gao</button></div>");
		$(actions).append("<div id='talk_tan'><button onclick='talk_tan()'>Talk to Bookkeeper Tan</button></div>");
		$(actions).append("<div id='talk_yang'><button onclick='talk_yang()'>Go to Master Yang</button></div>");
	}

	function talk_chang() {
		var previous = $(display).html();
		$(display_last).html(previous);
		$(display).html('I approach Mr. Chang.<br>');
		$(display).append('"Don&#39;t stand here talking to me!" Mr. Chang says. "Please go speak with Master Yang!"<br><br>');
		$("#talk_chang").remove();
	}

	function talk_lin() {
		var previous = $(display).html();
		$(display_last).html(previous);
		$(display).html('I approach Aunt Lin. Will you be okay here? I ask.<br>');
		$(display).append('"Don&#39;t worry about me, dear," Aunt Lin says, giving me a warm smile. "Go on now, we&#39;re all depending on you."<br><br>');
		$("#talk_lin").remove();
	}

	function talk_ming() {
		var previous = $(display).html();
		$(display_last).html(previous);
		$(display).html('I approach Ms. Ming.<br>');
		$(display).append('"Terrible! Oh, it is simply terrible!" Ms. Ming cries.<br><br>');
		$("#talk_ming").html("<button onclick='talk_ming_c1()'>Question Ms. Ming</button>");
	}
	
	function talk_ming_c1() {
		var previous = $(display).html();
		$(display_last).html(previous);
		$(display).html('What happened? I ask.<br>');
		$(display).append('"It&#39;s An-li! He ran inside to help the monks fight the demons and hasn&#39;t returned!"<br><br>');
		$("#talk_ming").remove();
	}

	function talk_long() {
		var previous = $(display).html();
		$(display_last).html(previous);
		$(display).html('I approach Constable Long.<br>');
		$(display).append('"Of course, I <i>want</i> to go inside and help the monks," Constable Long says nervously, "But it is also my duty to stay behind and protect the folks here."<br><br>');
		$("#talk_long").remove();
	}

	function talk_song() {
		var previous = $(display).html();
		$(display_last).html(previous);
		$(display).html('I approach Elder Song.<br>');
		$(display).append('"I am glad to see that you found your aunt!" Elder Song says. "I always knew you would! And what a turn of events for our simple hamlet! Monk Qin and his brothers and sisters are inside the temple right now dealing with those pesky demons. I have full confidence that they will soon send those demons packing back to whatever miserable place they crawled out of. We are fortunate that the yin energy of a few demons pales in comparison to great yang energy of the Sacred Peach Tree, which keeps them at bay. Even a Lord of Demons cannot harm us under the protection of the Sacred Peach Tree! <br><br>');
		$("#talk_song").remove();
	}

	function talk_mrfan() {
		var previous = $(display).html();
		$(display_last).html(previous);
		$(display).html('I approach Mr. Fan.<br>');
		$(display).append('He has his arms around Mrs. Fan as she sobs into his chest.<br><br>');
		$("#talk_mrfan").html("<button onclick='talk_mrfan_c1()'>Question Mr. Fan</button>");
	}
	
	function talk_mrfan_c1() {
		var previous = $(display).html();
		$(display_last).html(previous);
		$(display).html('What happened? I ask.<br>');
		$(display).append('Mr. Fan&#39;s voice quivers in anger. "The demons...it happened so fast. We were inside paying our respects at the altar when a small, winged creature with extremely long arms popped up in front of us... I-it snapped its finger and made our daughter Li-fen vanish right before our eyes!" He shakes a clenched fist. "If I had my spear with me, I would go in right now and teach the creature a lesson! Please, I beseech you, you must go rescue her! Save our daughter and bring her back from wherever the demons took her!"<br><br>');
		$("#talk_mrfan").remove();
	}

	function talk_mrsfan() {
		var previous = $(display).html();
		$(display_last).html(previous);
		$(display).html('I approach Mrs. Fan.<br>');
		$(display).append('She is too distraught to talk right now.<br><br>');
		$("#talk_mrsfan").remove();
	}

	function talk_mrgao() {
		var previous = $(display).html();
		$(display_last).html(previous);
		$(display).html('I approach Mr. Gao.<br>');
		$(display).append('"Unbelievable," Mr. Gao says, shaking his head. "A demon outbreak? This will not be good for business."<br><br>');
		$("#talk_mrgao").remove();	
	}

	function talk_tan() {
		var previous = $(display).html();
		$(display_last).html(previous);
		$(display).html('I approach Bookkeeper Tan.<br>');
		$(display).append('"Many years ago, when I was an apprentice bookkeeper," Bookkeeper Tan says, "I came across an old scroll that held an ancient prophesy. It foretold of the day when a red sun would burn in a black sky, as demons descend upon the Mortal Realm. The prophesy claimed that on that apocalyptic day, a heroic traveler would face the demons and fulfill a prewritten destiny..."<br><br>');
		$("#talk_tan").html("<button onclick='talk_tan_c1()'>Question Bookkeeper Tan</button>");	
	}
	
	function talk_tan_c1() {
		var previous = $(display).html();
		$(display_last).html(previous);
		$(display).html('Does the prophesy reveal whether the traveler succeeds? I ask.<br>');
		$(display).append('"Well&mdash;no, I don&#39;t recall it specifically mentioning that," Bookkeeper Tan admits, "But you know, prophesies tend to be rather vague when it comes to the details." She gives me a sympathetic look. "I&#39;m sure everything will work out in the end. At least, I do hope so..."<br><br>');
		$("#talk_tan").remove();
	}

	function talk_yang() {
		reset_display();
		$(display_persist).html('I approach the spot under the Sacred Peach Tree where Master Yang stands with his head lowered, a wooden staff held loosely in his left hand. He appears to be in deep meditation.<br><br>');
		$(actions).html("<button onclick='talk_yang1()'>Talk to Master Yang</button></div>");
	}
	
	function talk_yang1() {
		var previous = $(display).html();
		$(display_last).html(previous);
		$(display).html('Master Yang, I say quietly.<br>Master Yang&#39;s eyes fly open. "Ah sorry, I seemed to have dozed off there!" he says. "Welcome back, my friend. I see you have succeeded in your quest to find your Aunt Lin. Well done! By traveling to the past and bringing your aunt back to the present, you have fulfilled the destiny laid out for you. Time flows again as an unbroken circle&mdash;the past and the future tied together by choices you made of your own free will. To put it in another way, although your story has always been prewritten, the journey you took has been entirely of your own making."<br><br>');
		$(actions).html("<button onclick='talk_yang1_c1()'>Continue</button></div>");
	}
	
	function talk_yang1_c1() {
		var previous = $(display).html();
		$(display_last).html(previous);
		$(display).html('"However," Master Yang continues, "While you have completed your destiny, I am afraid destiny is not yet done with you! For in traveling through a rift in Time, you have upset the harmonious balance of spirit energy that has always been carefully maintained between the Mortal and Demon Realms. Certainly, this is a consequence you would not have known about, so don&#39;t beat yourself up about it... And yet, the responsibility now falls on you to deal with the demons that have been unleashed into Pleasant Weather Hamlet. I suppose just like many of  the other visitors we get here, these demons simply couldn&#39;t resist the chance to see whether the weather here is truly as nice as it claimed to be, haw-haw!"<br><br>');
		$(actions).html("<button onclick='talk_yang2()'>I'm confused.</button></div>");
	}

	function talk_yang2() {
		var previous = $(display).html();
		$(display_last).html(previous);
		$(display).html('I don&#39;t understand, I say.<br>Master Yang nods patiently. "Let me try to explain. '+(current_day+2)+' days ago, on the very day that your Aunt Lin disappeared, the monks sensed a sudden disturbance in spirit energy. Can you guess what caused it? You see, traveling through a rift in Time creates ripples in spirit energy that can be picked up by those trained to be attuned to such things. The particular disturbance '+(current_day+2)+' days ago was due to you and your aunt traveling through the gateway and returning from the past to the present. Upon detecting the disturbance, the monks immediately went to the Great Spirit Hall to check on the two portals inside&mdash;those being the Spirit and Demon Portals. There, they discovered that the seal to the Demon Portal was slowly weakening..."<br><br>');
		$(actions).html("<button onclick='talk_yang3()'>Continue</button>");
	}
	
	function talk_yang3() {
		var previous = $(display).html();
		$(display_last).html(previous);
		$(display).html('"Over the following two days and nights," Master Yang continues, "the monks remained in the Great Spirit Hall chanting an incantation to mend the seal guarding the Demon Portal. Such a spell, however, requires further maintenance, so the monks returned daily to the Great Spirit Hall to the keep the spell going until the seal was fully restored. However, before the monks were able to complete the spell, the Time Portal was activated a second time. Yes, I can tell from your expression that you see where I am going with this. This second disturbed was caused when you traveled from the present to the past. In order to activate the Time Portal initially, you had to offer up a relic, a vessel that stores tremendous yang spirit energy from the Mortal Realm. Once a relic is broken, the raw spirit energy captured within it is no longer remains bound to a physical object and therefore becomes untethered from the Mortal Realm. The raw spirit energy can then be manipulated by forces beyond our world...which is what happened, as the demons in the Demon Realm was able to use it somehow to destroy the seal that had bound the Demon Portal for centuries. Now we must contend with the dire consequences!"<br><br>"Of course, by <i>we</i>," Master Yang adds cheerfully, "I mean you!"<br><br>');
		$(actions).html("<button onclick='talk_yang4()'>Any suggestions</button>");
	}
	
	function talk_yang4() {
		var previous = $(display).html();
		$(display_last).html(previous);
		$(display).html('What must I do? I ask."<br>');
		$(display).append('"Nothing too complicated. Simply go into the Temple and defeat the demons," Master Yang says, matter of factly. ');
		if(inventory_map.get("bronzesword_item e_item") || inventory_map.get("steelsword_item e_item") || inventory_map.get("silverdagger_item e_item q_item")) {
			$(display).append('"Good luck!"<br><br>');
		} else {
			$(display).append('"But wait! You can&#39t go in there like that. Have you no weapon? Here take this staff that one of the monks left me. I have no use for it in a fight..." <strong>Obtained Wooden Staff!</strong><br><br>');
			addToInventory("woodenstaff_item e_item","Wooden Staff <button id='woodenstaff_button' onclick='equip(12)'>Equip</button>");
			equip(12);
		}
		$(actions).html("<button onclick='finale()'>Enter Peach Garden Temple</button></div>");
	}

	function finale() {
		updateLocation("Peach Garden Temple");
		updateStamina(-1.5);
		change_music("fight.mp3");
		reset_display();
		if(bronze_sword) {
			equip(9);
		} else if(steel_sword) {
			equip(10);
		} else if(silver_dagger) {
			equip(11);
		}
		$(display_persist).html('I enter the Peach Garden Temple. The temple is empty and quiet. No signs of any demons yet...<br><br>');
		$(actions).html("<button onclick='level_one()'>Examine Altar</button><br>");
	}

	function level_one() {
		updateStamina(-1.5);
		var previous = $(display).html();
		$(display_last).html(previous);
		$(display).html('I approach the altar. A small demon leaps out in front of me! Its impish face resembles a monkey but it has wings and unnaturally long, spindly arms. It grins, revealing rows of sharp teeth... The Imp floats into the air and raises its arms, casting a spell that makes two shimmering portals appear.<br><br>');
		$(actions).html("<div id='left_door'><button onclick='left_door()'>Look Through Left Portal</button></div>");
		$(actions).append("<div id='right_door'><button onclick='right_door()'>Look Through Right Portal</button></div>");
		$(artwork).html(imp_art);
	}

	function charge_imp() {
		updateStamina(-5);
		fight_imp = 1;
		var previous = $(display).html();
		$(display_last).html(previous);
		$(display).html('I rush forward to attack the Imp.<br>With a grin, the Imp snaps its fingers. Both portals disappear. The Imp snaps its fingers a second time, and a sudden gust of wind throws me backwards. The Imp runs away...<br><br>');
		$("#timebar").remove();
		$(actions).html("<button onclick='level_two()'>Continue Upstairs</button>");
	}

	function play_flute() {
		updateStamina(-1.5);
		dispel_illusion = 1;
		chose_left_door = 1;
		chose_right_door = 1;
		var previous = $(display).html();
		$(display_last).html(previous);
		$(display).html("Recalling An-li's words that flute music dispels illusions, I begin to play the bamboo flute. The Imp clutches its head in pain. It screeches and bares its teeth, before turning around and running away. The two, shimmery portal continues to hover in the air. The images inside them flickers...<br><br>");
		$(actions).html("<div id='left_door'><button onclick='left_door()'>Look Through Left Portal</button></div>");
		$(actions).append("<div id='right_door'><button onclick='right_door()'>Look Through Right Portal</button></div>");
		$(actions).append("<button onclick='level_two()'>Continue Upstairs</button>");

	}

	function left_door() {
		updateStamina(-1.5);
		var previous = $(display).html();
		$(display_last).html(previous);
		if(dispel_illusion) {
			$(display).html('I peer through the left portal: An-li lies asleep on the floor. In the background I see the warm, glow of a blacksmith forge...<br><br>');
			$("#left_door").remove();
			return;
		}
		$(display).html('I look through the left portal: a vast, arid desert. In the distance, an individual appears to be drowning in quicksand... Looking more closely, I see that it&#39;s An-li!<br><br>');
		$("#left_door").remove();
		imp_doors += 1;
		if (imp_doors >= 2) {
			$(actions).html("<button onclick='save_anli()'>Save An-li</button><br>");
			$(actions).append("<button onclick='save_lifen()'>Save Li-fen</button><br>");
			$(actions).append("<div id='charge_imp'><button onclick='charge_imp()'>Attack Imp</button></div>");
			if (inventory_map.get("bambooflute_item q_item") && !flute_broken) {
				$(actions).append("<div id='play_flute'><button onclick='play_flute()'>Play Flute</button></div>");
			}
			$(display).append("<div id='timebar'></div>");
			time_left = 5;
			if (time_left>0) {
				setTimeout(function () {decrement_timer2();}, 100);
			}
		}
	}

	function right_door() {
		updateStamina(-1.5);
		var previous = $(display).html();
		$(display_last).html(previous);
		if(dispel_illusion) {
			$(display).html('I peer through the right portal: Li-fen lies asleep in a garden. In the background I see a lotus pond with a few turtles lazily swimming around...<br><br>');
			$("#right_door").remove();
			return;
		}
		$(display).html('I look through the right portal: a wintry, desolate field. In the distance, an individual appears to be freezing in a snowstorm... Looking more closely, I see that it&#39;s Li-fen!<br><br>');
		$("#right_door").remove();
		imp_doors += 1;
		if (imp_doors >= 2) {
			$(actions).html("<button onclick='save_anli()'>Save An-li</button><br>");
			$(actions).append("<button onclick='save_lifen()'>Save Li-fen</button><br>");
			$(actions).append("<div id='charge_imp'><button onclick='charge_imp()'>Attack Imp</button></div>");
			if (inventory_map.get("bambooflute_item q_item") && !flute_broken) {
				$(actions).append("<div id='play_flute'><button onclick='play_flute()'>Play Flute</button></div>");
			}
			$(display).append("<div id='timebar'></div>");
			time_left = 5;
			if (time_left>0) {
				setTimeout(function () {decrement_timer2();}, 100);
			} 
		}

	}

	function decrement_timer2() {
		if (chose_left_door || chose_right_door || fight_imp || dispel_illusion) {
			return;
		}
		if (time_left>0) {
			time_left -= .1;
			$("#timebar").html('Time left to make a choice: <progress value="'+time_left+'" max="5"></progress><br><br>');
			setTimeout(function () {decrement_timer2();}, 100);
		} else {
			var previous = $(display).html();
			$(display_last).html(previous);
			$(display).html('I take too long to make my choice. Both portals disappear. The Imp cackles at me, before running away.<br><br>');
			$(actions).html("<button onclick='level_two()'>Continue</button>");
		}
	}

	function save_anli() {
		updateStamina(-1.5);
		updateLocation("mysterious desert");
		reset_display();
		$(display_persist).html('I dash through the left portal as the Imp cackles in delight. ');
		chose_left_door = 1;
		$(display_persist).append('I am transported to a hot desert. Sand stretches as far as the eye can see. There is no one in sight...<br><br>');
		$(actions).html("<button onclick='travel_desert()'>Traverse Desert</button>");
		$(artwork).empty();
	}

	function save_lifen() {
		updateStamina(-1.5);
		updateLocation("mysterious tundra");
		reset_display();
		$(display_persist).html('I dash through the right portal as the Imp cackles in delight. ');
		chose_right_door = 1;
		$(display_persist).append('I am transported to a bleak tundra. Snow stretches as far as the eye can see. There is no one in sight...<br><br>');
		$(actions).html("<button onclick='travel_tundra()'>Traverse Tundra</button>");
		$(artwork).empty();
	}

	function desert() {
		updateStamina(-1.5);
		updateLocation("mysterious desert");
		var previous = $(display).html();
		$(display_last).html(previous);
		$(display).html('I am transported to a hot desert. Sand stretches as far as the eye can see. There is no one in sight...<br><br>');
		$(actions).html("<button onclick='travel_desert()'>Traverse Desert</button>");
	}

	function travel_desert() {
		var previous = $(display).html();
		$(display_last).html(previous);
		$(display).html('I travel across the vast desert... My stamina wanes...');
		if (straw_sandals) {
			$(display).append('<strong>but at least my straw sandals keep my feet from blistering...</strong>');	
		}
		$(display).append(' After what feels like hours, I come across a shimmering door in the middle of the desert. ');
		if(straw_sandals) {
			updateStamina(-20);
		} else {
			updateStamina(-30);
		}
		if(chose_left_door) {
			$(display).append('Opening the door reveals a portal to a fiery wasteland...<br><br>');
			$(actions).html("<button onclick='wasteland()'>Go Through Portal</button>");
		} else if (chose_right_door) {
			$(display).append('Opening the door reveals a portal to the altar of Peach Garden Temple...<br><br>');
			$(actions).html("<button onclick='beat_level_one()'>Go Through Portal</button>");
		}
	}

	function wasteland() {
		updateStamina(-1.5);
		updateLocation("mysterious wasteland");
		var previous = $(display).html();
		$(display_last).html(previous);
		$(display).html('I am transported to a smoky wasteland. Ash stretches as far as the eye can see. Every so often, the ground spits up hot steam. There is no one in sight...<br><br>');
		$(actions).html("<button onclick='travel_wasteland()'>Traverse Wasteland</button>");
	}

	function travel_wasteland() {
		var previous = $(display).html();
		$(display_last).html(previous);
		$(display).html('I travel across the vast wasteland... My stamina wanes... After what feels like hours, I come across a shimmering door in the middle of the wasteland. ');
		updateStamina(-30);
		if (chose_left_door) {
			$(display).append('Opening the door reveals a wintry tundra...<br><br>');
			$(actions).html("<button onclick='tundra()'>Go Through Door</button>");
		} else if (chose_right_door) {
			$(display).append('Opening the door reveals a hot desert...<br><br>');
			$(actions).html("<button onclick='desert()'>Go Through Door</button>");
		}
	}

	function tundra() {
		updateStamina(-1.5);
		updateLocation("mysterious tundra");
		var previous = $(display).html();
		$(display_last).html(previous);
		$(display).html('I am transported to a bleak tundra. Snow stretches as far as the eye can see. The air cracks from the cold. There is no one in sight...<br><br>');
		$(actions).html("<button onclick='travel_tundra()'>Traverse Tundra</button>");
	}

	function travel_tundra() {
		var previous = $(display).html();
		$(display_last).html(previous);
		$(display).html('I travel across the vast tundra... My stamina wanes...');
		if(inventory_map.get("cottonblanket_item")) {
			$(display).append('<strong>but at least my cotton blanket keep me from freezing...</strong>');
		}	
		$(display).append(' After what feels like hours, I come across a shimmering door in the middle of the tundra. ');
		if(inventory_map.get("cottonblanket_item")) {
			updateStamina(-20);
		} else {
			updateStamina(-30);
		}
		if(chose_right_door) {
			$(display).append('Opening the door reveals a portal to a fiery wasteland...<br><br>');
			$(actions).html("<button onclick='wasteland()'>Go Through Portal</button>");
		} else if (chose_left_door) {
			$(display).append('Opening the door reveals a portal to the altar of Peach Garden Temple...<br><br>');
			$(actions).html("<button onclick='beat_level_one()'>Go Through Portal</button>");
		}
	}

	function beat_level_one() {
		updateStamina(-1.5);
		updateLocation("Peach Garden Temple");
		var previous = $(display).html();
		$(display_last).html(previous);
		$(display).html('I return to the altar of the Peach Garden Temple. The Imp is nowhere to be seen... The two shimmery portal are still suspended in the air...');
		if(chose_right_door) {
			$(display).append('but the left portal has become opaque...<br><br>');
			$(actions).html("<div id='right_door'><button onclick='right_door()'>Look Through Right Portal</button></div>");
			dispel_illusion = 1;
		} else if(chose_left_door) {
			$(display).append('but the right portal has become opaque...<br><br>');
			$(actions).html("<div id='left_door'><button onclick='left_door()'>Look Through Left Portal</button></div>");
			dispel_illusion = 1;
		}
		$(actions).append("<button onclick='level_two()'>Continue Upstairs</button>");
	}

	function level_two() {
		updateStamina(-1.5);
		reset_display();
		if(completed_tour) {
			$(display_persist).html('I head past the altar and up the stairs to the hallway leading to the monks&#39; quarters. As I walk down the narrow corrider, a wall of fire rises in front of me. Unnatural flames run down the walls on both sides of me, encircling me... Through the flickering flames, I catch a glimpse of a skeletal creature made of ghostly white bones...<br><br>');
		} else {
			$(display_persist).html('I head past the altar and up the stairs to a long hallway with a series of rooms on each side. As I walk down the narrow corrider, a wall of fire rises in front of me. Unnatural flames run down the walls on both sides of me, encircling me... Through the flickering flames, I catch a glimpse of a skeletal creature made of ghostly white bones...<br><br>');
		}
		$(display_persist).append('The raspy voice of the Skeletal Demon calls out to me, "I am sought after by many, each with their own desires and expectations of what I can give them. The rich and powerful open their homes up to me as willingly as the common folks do, but few remember my visit after I depart. When the sun is up, I can be a pleasant companion, but at night, I terrify my victims. Tell me... What am I?<br><br>');
		$(actions).html("<button onclick='flames()'>Pass Through Flames</button>");
		$(actions).append("<div id='riddle'><input type='text' id='my_guess' placeholder='demon'></input><button onclick='riddle()'>Answer Riddle</button></div>");
		$(artwork).html(baigujing_art);
		if (inventory_map.get("bambooflute_item q_item") && !flute_broken) {
			$(actions).append("<div id='play_flute_l2'><button onclick='play_flute_l2()'>Play Flute</button></div>");
		}
	}

	function play_flute_l2() {
		updateStamina(-1.5);
		var previous = $(display).html();
		$(display_last).html(previous);
		$(display).html("I play the bamboo flute. The fire remains. It must not be an illusion.<br><br>");
		$("#play_flute_l2").remove();
	}

	function flames() {
		var previous = $(display).html();
		$(display_last).html(previous);
		if (amulet) {
			updateStamina(-1.5);
			$(display).html("Recalling Li-fen's words that the Amber Amulet protects against unnatural danger, I pass through the flames, unharmed.<br><br>");
			$(display).append('"How interesting..." the Skeletal Demon rasps. The fire around me disappears. "Now... You must die!" The Skeletal Demon rushes towards me!<br><br>');
			$(actions).html("<button onclick='attack_skeleton()'>Attack</button><br>");
			$('.lantern_item').html("Lantern <button style='color:red;' onclick='throw_lantern()'><strong>Throw</strong></button>");
		} else {
			$(display).html('I approach the fire. The wall of flames becomes hotter and singes me. Ouch!<br><br>');
			updateStamina(-10);
		}
	}

	function riddle() {
		updateStamina(-1.5);
		var previous = $(display).html();
		$(display_last).html(previous);
		var guess = $("#my_guess").val() || "demon";
		$(display).html('You are a '+guess+', I answer.<br><br>');
		if ((guess == "dream") || (guess == "dreams") || (guess == "Dream") || (guess == "Dreams")) {
			$(display).append('"The fire vanishes completely. "Very good..." the Skeletal Demon rasps. "Now... You must die!" The Skeletal Demon rushes towards me!<br><br>');
			$(actions).html("<button onclick='attack_skeleton()'>Attack</button><br>");
			$('.lantern_item').html("Lantern <button style='color:red;' onclick='throw_lantern()'><strong>Throw</strong></button>");
		} else {
			clue += 1;
			$(display).append('"Wrong!" The Skeletal Demon rasps and laughs. The circle of fire closes in...');
			if(amulet) {
				$(display).append('but the Amber Amulet protects me from being harmed by the flames!<br><br>');
			} else {
				$(display).append(' A tendril of flame burns me!<br><br>');
				if(leather_tunic) {
				updateStamina(-30);
				} else if (chainmail) {
					updateStamina(-15);
				} else {
					updateStamina(-45);
				}
			}
			if (clue == 1) {
				$(display).append("The flickering flames seem to spell 'D'...<br><br>");
			} else if (clue == 2) {
				$(display).append("The flickering flames seem to spell 'R'...<br><br>");
			} else if (clue == 3) {
				$(display).append("The flickering flames seem to spell 'E'...<br><br>");
			} else if (clue == 4) {
				$(display).append("The flickering flames seem to spell 'A'...<br><br>");
			} else {
				$(display).append("The flickering flames seem to spell 'M'...<br><br>");
			}
		}
	}

	function attack_skeleton() {
		var previous = $(display).html();
		$(display_last).html(previous);
		$(display).html("I attack the Skeletal Demon! Its skeletal body collapses to the ground... As I turn to go, the bones begin to rapidly reassemble... The Skeletal Demon rises and attacks again!<br><br>");
		$('.lantern_item').html("Lantern <button style='color:red;border-color:red;' onclick='throw_lantern()'>Throw</button>");
		updateStamina(-10);
		$(actions).html("<button onclick='attack_skeleton_c1()'>Attack</button><br>");
	}
	function attack_skeleton_c1() {
		var previous = $(display).html();
		$(display_last).html(previous);
		$(display).html("I attack the Skeletal Demon! Its skeletal body collapses to the ground... As I turn to go, the bones begin to rapidly reassemble... <strong>My attacks seems to ineffective...</strong> The Skeletal Demon rises and attacks again!<br><br>");
		updateStamina(-10);
		$(actions).html("<button onclick='attack_skeleton_c1()'>Attack</button><br>");
	}

	function throw_lantern() {
		updateStamina(-1.5);
		var previous = $(display).html();
		$(display_last).html(previous);
		$(display).html("<strong>I throw my lantern at the Skeletal Demon!</strong> The lantern bursts into purple flames as it collides with the demon&#39;s skeletal body. A foul smell fills the air as the Skeletal Demon incinerates into a pile of dust!<br><br>");
		$(".lantern_item").remove();
		inventory_map.delete("lantern_item t_item");
		lantern_available = 1;
		$(actions).html("<button onclick='level_three()'>Continue to Inner Sanctum</button>");
	}

	function level_three() {
		updateStamina(-1.5);
		reset_display();
		$(display_persist).html("I move on to the Temple's Inner Sanctum. A monk lies slumped on the floor just outside the large doors of the Great Spirit Hall.<br><br>");
		$(actions).html("<div id='help_monk'><button onclick='help_monk()'>Help the Monk</button></div>");
		$(actions).append("<button onclick='final_boss()'>Enter Great Spirit Hall</button>");
		$(artwork).html(help_monk);
	}

	function help_monk() {
		updateStamina(-1.5);
		var previous = $(display).html();
		$(display_last).html(previous);
		$(display).html('I kneel next to the monk. The monk raises her head and says weakly, "Lord of... Demons inside... Has... Defeated... All elders. Please... Some food... Can spare..."<br>');
		$(actions).html("");
		if ((goji > 0) || (mountainyam > 0) || (ginseng > 0) || (baos > 0)) {
			$(display).append("<br>");
			$(actions).html("<div id='give_food'><button onclick='give_food()'>Give Food</button></div>");
		} else {
			$(display).append("I'm sorry, I don't have anything to give you, I say.<br>");
			$(display).append('The monk nods. "Go..." she says. "Must send... Demons... Back."<br><br>');
		}
		$(actions).append("<button onclick='final_boss()'>Enter Great Spirit Hall</button>");
		$(artwork).html(fallenmonk_art);
	}

	function give_food() {
		updateStamina(-1.5);
		charitable = 1;
		if(ginseng > 0) {
			eat_food(3,0);
		} else if (baos > 0) {
			eat_food(0,0);
		} else if (mountainyam > 0) {
			eat_food(2,0);
		} else if (goji > 0) {
			eat_food(1,0);
		}
		var previous = $(display).html();
		$(display_last).html(previous);
		$(display).html('<strong>I give the monk a portion of my food.</strong> "Thank... you..." she says. She closes her eyes and rests.<br><br>');
		$(actions).html("<button onclick='final_boss()'>Enter Great Spirit Hall</button>");
	}

	function final_boss() {
		updateStamina(-1.5);
		updateLocation("Great Spirit Hall");
		reset_display();
		$(display_persist).html('I enter the Great Spirit Hall.<br>');
		$(display_persist).append('Without my lantern, the large room is nearly in full darkness, illuminated only by a pale glow coming from the Spirit Portal. In the center of the Great Spirit Hall are two shadowy figures standing over something on the ground. As I approach, the figures turn towards me. I see that the figures are An-li and Li-fen  standing over the prostrate form of Monk Qin!<br><br>');
		$(display_persist).append('Li-fen runs over. "I&#39;m so glad you&#39;re here," she says, "Thanks to your efforts, An-li and I were able to escape from the demons, but Monk Qin has been gravely wounded... Please help us." Li-fen leads me over to where An-li is tending to Monk Qin. An-li smiles at me as I approach.<br><br>');
		$(actions).html("<button onclick='question_imposters(2)'>Talk to Li-fen</button><br>");
		$(actions).append("<button onclick='question_imposters(1)'>Talk to An-li</button><br>");
		$(actions).append("<button onclick='help_qin()'>Help Monk Qin</button><br>");
		$(artwork).empty();
		if (inventory_map.get("bambooflute_item q_item") && !flute_broken) {
			$(actions).append("<br><button onclick='play_flute_l3()'>Play Flute</button>");
		}
	}

	function help_qin() {
		updateStamina(-1.5);
		var previous = $(display).html();
		$(display_last).html(previous);
		$(display).html('I kneel next to where Monk Qin lies on the ground and put a hand to his chest. Monk Qin grabs my arm. "No." He says, weakly, "It&#39;s a trap!" Jumping to my feet, I turn around to see that both An-li and Li-fen have vanished. Standing in their place are two demons: a small one with wings and long arms&mdash;which I recognize as the Imp&mdash;and a large demon, nearly ten feet tall with six horns on its head, a forked tail, and a giant set of wings coming out of its back.<br><br>"The Lord of Demons," Monk Qin says, rising to his feet, "We must send It and Its underling back to the Demon Realm..."<br><br>');
		$(actions).html("<button onclick='final_fight()'>Fight the Lord of Demons and the Imp</button>");
	}
	
	function question_imposters(text) {
		updateStamina(-1.5);
		var previous = $(display).html();
		$(display_last).html(previous);
		if (text == 1){
			if (inventory_map.get("bambooflute_item q_item") && !flute_broken) {
				$(display).html('How can I help, I ask An-li.<br>');
				$(display).append('"Quickly, do you still have the bamboo flute I gave you?" An-li asks. I hand over the Bamboo Flute. An-li grins. <strong>He snaps the flute in half and throws it on the floor!</strong> What are you doing! I exclaim, picking up the pieces.<br><br>');
				flute_broken = 1;
				inventory_map.delete("bambooflute_item q_item");
				addToInventory("bambooflute_item q_item","Bamboo Flute (<i>relic</i>, <strong>broken</strong>)");
			} else {
				$(display).append('Something&#39;s not right, I say to An-li.<br>');
			}
		} else if (text == 2) {
			if (amulet) {
				$(display).html('How can I help, I ask Li-fen.<br>');
				$(display).append('"Quickly, do you still have the amber amulet I gave you?" Li-li asks. I hand over the Amber Amulet. Li-fen grins. <strong>She smashes the amulet onto the floor where it shatters in half!</strong> What are you doing! I exclaim, picking up the pieces.<br><br>');
				inventory_map.delete("amberamulet_item e_item q_item");
				addToInventory("amberamulet_item q_item","Amber Amulet (<i>relic</i>, <strong>broken</strong>)");
				unequip(2);
			} else {
				$(display).append('Something&#39;s not right, I say to Li-fen.<br>');
			}
		}
		$(display).append('An-li and Li-fen look at each other, smiling. In a flash, the two imposters transform back into their demon forms: a small one with wings and long arms&mdash;which I recognize as the Imp&mdash;and a large one, nearly ten feet tall with six horns on its head, a forked tail, and a giant set of wings coming out of its back.<br><br>"That&#39;s a Lord of Demons," Monk Qin says, rising to his feet, "We must send It and Its underling back to the Demon Realm..."<br><br>');
		$(actions).html("<button onclick='final_fight()'>Fight Lord of Demons and Imp</button>");
	}

	function play_flute_l3() {
		updateStamina(-1.5);
		var previous = $(display).html();
		$(display_last).html(previous);
		$(display).html('I take out the bamboo flute and begin to play.<br>');
		$(display).append('An-li and Li-fen grimace in pain. In a flash, the two imposters transform back into their demon forms: a small demon with wings and long arms&mdash;which I recognize as the Imp&mdash;and a large demon, nearly ten feet tall with six horns on its head, a forked tail, and a giant set of wings coming out of its back.<br><br>"That&#39;s the Lord of Demons," Monk Qin says, rising to his feet, "We must send It and Its underling back to the Demon Realm...<br><br>');
		$(actions).html("<button onclick='final_fight()'>Fight Lord of Demons and Imp</button>");
	}

	function final_fight() {
		reset_display();
		$(display).html("<div id='boss_fight_display'></div><br>");
		$("#boss_fight_display").append("<div id='lord_of_demons'><div id='lod_status'>Lord of Demons (flying)</div><progress id='lod_hp' value='100' max='100'></progress><br><div id='lod_display'></div></div></div>");
		$("#boss_fight_display").append("<div id='imp_demon'><div id='imp_status'>Imp Demon (vanished)</div><progress id='imp_hp' value='10' max='10'></progress><br><div id='imp_display'></div><br><br>");
		var currentStamina = $(".stamina").val();
		$("#boss_fight_display").append("<div id='hero'>"+name+"<br><progress class='stamina' value='"+currentStamina+"' max='"+total_health+"'></progress><div id='my_display'></div><div id='my_status'></div></div>");
		$(".stamina").css("color", health_color);
		$("#boss_fight_display").append("<div id='monk_qin'>Monk Qin<br><progress id='qin_hp' value='40' max='100'></progress><div id='qin_display'></div><div id='qin_status'></div></div>");
		$(actions).html("<button id='attack_lod' onclick='attack_lod()'>Attack Lord of Demons</button>");
		$(actions).append("<button id='attack_imp' onclick='attack_imp()'>Attack Imp Demon</button><br>");
		$(actions).append("<button id='defend_demons' onclick='defend_demons()'>Defend</button>");
		$(actions).append("<button id='guard_qin' onclick='guard_qin()'>Guard Monk Qin</button>");
		if(inventory_map.get("bambooflute_item q_item") && !flute_broken) {
			$(actions).append("<button id='play_flute_final' onclick='play_flute_final()'>Play Flute</button>");
		}
		lod_fly();
		qin_attacks_lod();
		imp_disappear();
	}

	function update_lod(text) {
		var val = $("#lod_hp").val();
		val += text;
		if(val <= 0) {
			battle_over = 1;
			beat_lod();
		}
		$("#lod_hp").val(val);
	}

	function update_imp(text) {
		var val = $("#imp_hp").val();
		val += text;
		if (val <= 0) {
			imp_defeated = 1;
			$("#imp_status").html("Imp (defeated)");
			$("#imp_display").html("The Imp vanishes...");
		}
		$("#imp_hp").val(val);
	}

	function update_qin(text) {
		var val = $("#qin_hp").val();
		val += text;
		if (val <= 5) {
			qin_defeated = 1;
			$("#qin_display").html("Monk Qin has fallen and can longer fight anymore...");
			$("#qin_status").html("");
			qin_fallen = 1;
			$("#qin_hp").val(2);
			return;
		}
		$("#qin_hp").val(val);
	}

	function disable_buttons() {
		$("#attack_lod").attr('disabled','disabled');
		$("#attack_imp").attr('disabled','disabled');
		$("#defend_demons").attr('disabled','disabled');
		$("#guard_qin").attr('disabled','disabled');
		$("#play_flute_final").attr('disabled','disabled');
	}

	function enable_buttons() {
		$("#attack_lod").removeAttr('disabled');
		$("#attack_imp").removeAttr('disabled');
		$("#defend_demons").removeAttr('disabled');
		$("#guard_qin").removeAttr('disabled');
		$("#play_flute_final").removeAttr('disabled');
	}
	
	function attack_lod() {
		playing_flute = 0;
		$("#attack_lod").attr('disabled','disabled');
		setTimeout(function () {$("#attack_lod").removeAttr('disabled');}, 500);
		if(lod_immune) {
			if(lod_flying) {
				$("#my_display").html("I cannot reach the Lord of Demons right now!<br><br>");
			} else {
				$("#my_display").html("The Lord of Demons is invulnerable right now!<br><br>");
			}
		} else {
			$("#my_display").html("I hit the Lord of Demons!<br><br>");
			if(wooden_staff) {
				update_lod(-2);
			}else if (bronze_sword) {
				update_lod(-5)
			}else if (steel_sword) {
				update_lod(-10);
			}
		}
	}

	function attack_imp() {
		if(imp_defeated) {
			return;
		}
		playing_flute = 0;
		$("#attack_imp").attr('disabled','disabled');
		setTimeout(function () {$("#attack_imp").removeAttr('disabled');}, 500);
		if(imp_immune) {
			$("#my_display").html("I miss the Imp!<br><br>");
		} else {
			$("#my_display").html("I hit the Imp!<br><br>");
			imp_spell_disrupt = 1;
			update_imp(-1);
		}
	}

	function defend_demons() {
		playing_flute = 0;
		lod_attacking = 0;
		imp_attacking = 0;
		$("#defend_demons").attr('disabled','disabled');
		setTimeout(function () {$("#defend_demons").removeAttr('disabled');}, 500);
		$("#my_display").html("I defend...<br><br>");
	}

	function guard_qin() {
		if(qin_defeated) {
			return;
		}
		playing_flute = 0;
		lod_attacking_qin = 0;
		imp_attacking_qin = 0;
		$("#guard_qin").attr('disabled','disabled');
		setTimeout(function () {$("#guard_qin").removeAttr('disabled');}, 500);
		$("#my_display").html("I defend Monk Qin...<br><br>");
	}

	function play_flute_final() {
		playing_flute = 1;
		imp_spell_disrupt = 1;
		imp_attacking = 0;
		imp_attacking_qin = 0;
		$("#my_display").html("I play the Bamboo Flute...<br><br>");
		$("#play_flute_final").attr('disabled','disabled');
		setTimeout(function () {$("#play_flute_final").removeAttr('disabled');}, 500);
	}


	function lod_fly() {
		if(battle_over) {
			return;
		}
		lod_flying = 1;
		lod_immune = 1;
		$("#lod_status").html("Lord of Demons (flying)");
		var landing = Math.random();
		$("#lod_display").html("The Lord of Demons flies into the air.<br><br>");
		if(landing > .5) {
			setTimeout(function () {lod_hover_long();}, 1000);
		} else {
			setTimeout(function () {lod_hover();}, 1000);
		}
	}

	function lod_hover() {
		if(battle_over) {
			return;
		}
		lod_immune = 1;
		$("#lod_display").html("The Lord of Demons hovers in the air.");
		var fireballs = Math.random();
		if(fireballs > 0.5) {
			setTimeout(function () {lod_fireball();}, 2000);
		} else {
			setTimeout(function () {lod_land();}, 3000);
		}
	}

	function lod_hover_long() {
		if(battle_over) {
			return;
		}
		lod_immune = 1;
		$("#lod_display").html("The Lord of Demons hovers in the air.");
		setTimeout(function () {lod_land();}, 5000);
	}

	function lod_land() {
		if(battle_over) {
			return;
		}
		lod_flying = 0;
		lod_immune = 0;
		$("#lod_status").html("Lord of Demons");
		var attack_chance = Math.random();
		$("#lod_display").html("The Lord of Demons descends.<br><br>");
		if(attack_chance > .2) {
			setTimeout(function () {lod_attack();}, 2000);
		} else {
			setTimeout(function () {lod_fly();}, 2000);
		}
	}

	function lod_attack() {
		if(battle_over) {
			return;
		}
		lod_immune = 1;
		var lod_target = Math.random();
		if((lod_target > .5) && !qin_defeated) {
			$("#lod_display").html("The Lord of Demons is about to attack Monk Qin!<br><br>");
			lod_attacking_qin = 1;
			setTimeout(function () {check_lod_hit_qin();}, 1500);
		} else {
			$("#lod_display").html("The Lord of Demons is about to attack me!<br><br>");
			lod_attacking = 1;
			setTimeout(function () {check_lod_hit_hero();}, 1500);
		}
	}

	function lod_fireball() {
		if(battle_over) {
			return;
		}
		lod_immune = 1;
		$("#lod_display").html("The Lord of Demons is about to shoot a fireblast at me!<br><br>");
		lod_attacking = 1;
		setTimeout(function () {check_lod_hit_hero();}, 2000);
	}

	function check_lod_hit_hero() {
		if(battle_over) {
			return;
		}
		if(lod_attacking) {
			lod_attacking = 0;
			if(lod_flying) {
				if(amulet){
					$("#my_status").html("The Amber Amulet absorbs most of the fireblast!<br>");
					updateStamina(-10);
				}
				else {
					if(leather_tunic) {
						updateStamina(-40);
					} else if (chainmail) {
						updateStamina(-20);
					} else {
						updateStamina(-60);
					} 
					$("#my_status").html("I am hurt by the fireblast!<br>");
				}
				lod_hover();
			} else {
				if(leather_tunic) {
					updateStamina(-20);
				} else if (chainmail) {
					updateStamina(-10);
				} else {
					updateStamina(-30);
				}
				$("#my_status").html("I get hit by the Lord of Demon!<br>");
				lod_fly();
			}
		} else {
			if(lod_flying) {
				lod_hover();
				$("#my_status").html("I dodge the fireblast!<br>");
			} else {
				lod_fly();
				$("#my_status").html("I defend against the Lord of Demon!<br>");
			}
		} 
	}

	function check_lod_hit_qin() {
		if(battle_over) {
			return;
		}
		if (lod_attacking_qin) {
			lod_attacking_qin = 0;
			$("#qin_status").html("Monk Qin is attacked by the Lord of Demons!<br><br>");
			update_qin(-10);
		} else {
			$("#qin_status").html("I defend Monk Qin against the Lord of Demons!<br><br>");
		}
		lod_fly();
	}

	function imp_disappear() {
		if(imp_defeated || battle_over) {
			return;
		}
		imp_immune = 1;
		$("#imp_display").html("The Imp has vanished in a puff of smoke!<br><br>");
		$("#imp_status").html("Imp Demon (invisible)");
		setTimeout(function () {imp_reappear();}, 3000);
	}

	function imp_reappear() {
		if(imp_defeated || battle_over) {
			return;
		}
		imp_immune = 0;
		$("#imp_status").html("Imp Demon");
		$("#imp_display").html("The Imp reappears!<br><br>");
		var imp_attack_chance = Math.random();
		if (imp_attack_chance > .3) {
			setTimeout(function () {imp_attack();}, 2000);
		} else {
			setTimeout(function () {imp_spell();}, 2000);
		}

	}

	function imp_attack() {
		if(imp_defeated || battle_over) {
			return;
		}
		imp_immune = 1;
		var imp_target = Math.random();
		if ((imp_target > .5) && !qin_defeated) {
			imp_attacking_qin = 1;
			$("#imp_display").html("The Imp is about to attack Monk Qin!<br><br>");
			setTimeout(function () {check_imp_hit_qin();}, 2000);
		} else {
			$("#imp_display").html("The Imp is about to attack me!<br><br>");
			imp_attacking = 1;
			setTimeout(function () {check_imp_hit_hero();}, 2000);
		}
	}

	function check_imp_hit_qin() {
		if(battle_over) {
			return;
		}
		if (imp_attacking_qin) {
			imp_attacking_qin = 0;
			$("#qin_status").html("Monk Qin is attacked by the Imp!<br><br>");
			update_qin(-5);
		} else {
			if(playing_flute) {
				$("#imp_display").html("The Imp is distracted by the flute music!<br><br>");
			} else {
				$("#qin_status").html("I defend Monk Qin against the Imp!<br><br>");
			}
		}
		setTimeout(function () {imp_disappear();}, 1000);
	}

	function check_imp_hit_hero() {
		if(battle_over) {
			return;
		}
		if (imp_attacking) {
			imp_attacking = 0;
			$("#my_status").html("I get hit by the Imp!<br>");
			if(leather_tunic) {
				updateStamina(-10);
			} else if (chainmail) {
				updateStamina(-5);
			} else {
				updateStamina(-15);
			}
		} else {
			if(playing_flute) {
				$("#imp_display").html("The Imp is distracted by the flute music!<br><br>");
			} else {
				$("#my_status").html("I defend against the Imp!<br>");
			}
		}
		setTimeout(function () {imp_disappear();}, 1000);
	}

	function imp_spell() {
		if(imp_defeated || battle_over) {
			return;
		}
		imp_immune = 0;
		imp_spell_disrupt = 0;
		$("#imp_display").html("The Imp is casting a spell!<br><br>");
		setTimeout(function () {check_spell_hit();}, 1500);
	}

	function check_spell_hit() {
		if(battle_over) {
			return;
		}
		if(imp_spell_disrupt) {
			if(playing_flute) {
				$("#imp_display").html("The Imp is distracted by the flute music!<br><br>");
			} else {
				$("#imp_display").html("The spell fails...<br><br>");
			}
		} else {
			$("#my_display").html("The Imp binds me with its spell! I cannot move!<br><br>");
			disable_buttons();
			setTimeout(function () {enable_buttons();}, 2000);
		}
		setTimeout(function () {imp_disappear();}, 1500);
	}

	function qin_attacks_lod() {
		if(qin_defeated || battle_over) {
			return;
		}
		if(lod_immune) {
			$("#qin_display").html("Monk Qin is waiting to attack....<br><br>");
			$("#qin_status").html("");
		} else {
			$("#qin_display").html("Monk Qin attacks the Lord of Demons!<br><br>");
			update_lod(-2);
		}
		setTimeout(function () {qin_attacks_lod();}, 1500);
	}

	function beat_lod() {
		reset_display();
		$(display_persist).html('"Now!" Monk Qin yells. "Summon forth all of the yang spirit energy that makes up your character and finish off the Lord of Demon!<br><br>');
		$(actions).html("<button onclick='strike_lod(1)'>Strike the Lord of Demons!</button>");
		if (silver_dagger) {
			$(actions).append("<button onclick='strike_lod(2)'>Strike the Lord of Demons with the Silver Dagger!</button>");
		}
		$(artwork).html(fight_art);
	}

	function strike_lod(text) {
		var previous = $(display).html();
		$(display_last).html(previous);
		var weapon = "";
		if (wooden_staff) {
			weapon = "Wooden Staff";
		} else {
			if (bronze_sword) {
				weapon = "Bronze Sword";
			} else {
				weapon = "Steel Sword";
			}
		}
		if (text == 1) {
			$(display).html('I strike the final blow against the Lord of Demon with my '+weapon+'!<br><br>');
			$(display).append('The Lord of Demons laughs. It speaks for the first time in a voice that echoes inside my mind. <strong>"You may have defeated me today, but the only thing a true Demon Lord fears is silver! Do not think this is over between us... <i>'+name+'!</i> Yes... I know your name and have marked you... Remember my words, I shall return again!"</strong> Saying this, the Lord of Demon transforms into a swirling disk of yin energy that shrinks smaller and smaller until disappears...<br><br>');
			$(display).append('Monk Qin stands beside me. "It&#39;s over," he says, "for the time being..." He puts a hand on my shoulder. "You did well my friend. Thank you."</strong><br><br>');
		} else {
			$(display).html('I strike the final blow against the Lord of Demon with the Silver Dagger!<br><br>');
			$(display).append('The Lord of Demons opens its mouth in surprise. It speaks for the first time in a voice that echoes inside my mind. <strong>"How did you know... My only weakness...  Silver...</strong><br><br>');
			$(display).append('Monk Qin begins to chant a spell...');
			$(display).append('"No!" The Lord of Demons screams as ropes of yang energy emit from the hilt of the Silver Dagger, pulling the Lord of Demon into the dagger...<br><br>');
			$(display).append('The Silver Dagger clatters as it falls to the floor. The Lord of Demons is nowhere in sight. "It&#39;s over," Monk Qin says, with a heavy sigh. He picks up the Silver Dagger and carefully hands it to me. "As the one who defeated a Lord of Demons, I am afraid you must bear the duty of ensuring that this dagger does not fall into the the wrong hands." Monk Qin says, placing the dagger in my hands. It feels cold to the touch... <strong>Obtained Silver Dagger.</strong><br>');
			$(display).append('Monk Qin puts a hand on my shoulder. "You did well, my friend. Thank you for your help and courage in saving our hamlet."<br><br>');
			$(".silverdagger_item").html("Silver Dagger (<i>relic</i>, <strong>cursed</strong>)");
			inventory_map.set("silverdagger_item e_item q_item","Silver Dagger (<i>relic</i>, <strong>cursed</strong>)");
			silver_dagger_cursed = 1;
		}
		$(actions).html("<button onclick='conclusion()'>Continue</button>");
	}

	function conclusion() {
		$(game_title).hide();
		updateLocation("Pleasant Weather Hamlet");
		change_music("village.mp3");
		reset_display();
		$(display_persist).html('A few days after I defeated the Lord of Demons, a celebration is held in my honor. While most of the residents of Pleasant Weather Hamlet attend the celebration, I cannot help but notice a few missing faces...<br><br><strong>Elder Song presents me with a Platinum Medallion!</strong> "In honor of your heroic deeds, I hereby declare you to be the <i>yingxiong</i> of Pleasant Weather Hamlet!" he says. I bow deeply to the people of hamlet, as they applaud and cheer.<br><br>Master Yang approaches me after the celebration ends. "What a fantastic occasion that was!" he says, "Thank you for saving the hamlet! Please come visit me at my herbalist shop when you have some time later."<br><br>Aunt Lin and I return to the farm...<br><br>');
		addToInventory("platinummedallion_item e_item","Platinum Medallion (<i>token of honor</i>) <button id='medallion_button' onclick='equip(13)'>Equip</button>");
		$(".stamina").val(health_max);
		demons_defeated_day = current_day;
		current_day += 2;
		time = 11;
		game_finished = 1;
		updateTime(0);
		$("#date").html("Day "+current_day);
		$(actions).html("<button onclick='return_to_farm()'>Continue</button>");
		$(artwork).html(ending_art);
		$("#e_hand").html("");
	}


	function questions(text) {
		var previous = $(display).html();
		$(display_last).html(previous);
		if (text == 1) {
			$(display).html('Am I in the past?<br>');
			$(display).append('"That seems like the logical explanation, dear. Of course for me, this is simply the present..."<br><br>');
			$("#question_1").remove();
		} else if (text == 2) {
			$(display).html('Why is there a magical gateway in your cellar?<br>');
			$(display).append('"I wish I knew that myself. It was already there the day I moved onto the farm, although I&#39;m positive the cellar was empty when I toured the property," Aunt Lin says. "Come to think of it, the couple who I bought the farm from did seem rather odd. They spoke to each other in a formal sort of a way, talking in a dialetic that I never heard before, and they wore vintage clothes that was the fashion a century ago!"<br><br>');
			$("#question_2").html("<button onclick='questions2()'>Have you traveled through the gateway?</button>");
		} else if (text == 3) {
			$(display).html('Could this all be a dream?<br>');
			$(display).append('Aunt Lin pats my hand. "I&#39;m afraid I can&#39;t answer that for you, dear. They say that Zhuang Zhou famously faced the same dilemma after waking from a dream that he was a butterfly. So I suppose it is conceivable that everything happening to you so far has been a figment of your imagination while you&#39;ve been asleep..." Seeing my concerned look, Aunt Lin reaches over and pinches my cheek.<br><br>Ow! I yelp. "Well, I should say that settles the matter," Aunt Lin says, with a laugh.<br><br>');
			$("#question_3").remove();
		} else if (text == 4) {
			$(display).html("How come everyone thinks you're missing? I ask.<br>");
			$(display).append('Aunt Lin shakes her head in puzzlement. "I really don&#39;t know..."<br><br>');
			$("#question_4").html("<button onclick='questions4()'>Any plans for today?</button>");
		}
	}

	function questions2() {
		var previous = $(display).html();
		$(display_last).html(previous);
		$(display).html('Have you traveled through the gateway?<br>');
		$(display).append('"No, I haven&#39;t. For some time now, I have been going down to Bookkeeper Tan&#39;s to do research on how the gateway works. From various old texts, I pieced together that the gateway could be activating by using a powerful relic...but I had absolutely no idea where to find one. Plus, the other day, I accidentally dropped the key to the cellar somewhere out in the fields...<br><br>');
		$("#question_2").remove();
	}

	function questions4() {
		var previous = $(display).html();
		$(display_last).html(previous);
		$(display).html('Anything out of the ordinary happening today? I ask.<br>');
		$(display).append('"Not that I know of," Aunt Lin says. "I was just about to finish writing this letter to the Fan Family to accept their kind invitation to Li-fen&#39;s birthday celebration. And then I was going to go down to the Market to buy some seeds..."<br><br>Aunt Lin closes her eyes in thought. "Not much ever happens in Pleasant Weather Hamlet. It&#39;s a peaceful place. Dull but safe. I can&#39;t imagine that anyone around here would have caused my disappearance..." She opens her eyes suddenly. "That&#39;s it!" Aunt Lin exclaims. "You&#39;re not from Pleasant Weather Hamlet, after all. So it must be because of you somehow! And that means I need to&mdash;"<br><br>');
		$(actions).html("<button onclick='questions4_c1()'>Continue</button>");
	}
	
	function questions4_c1() {
		var previous = $(display).html();
		$(display_last).html(previous);
		$(display).html('Just then, we hear a voice calling from outside. Aunt Lin rushes to the window. "It&#39;s Jiang," she says in confusion, "The Fan Family servant. Why is he here?" She turns to me. "Tell me '+name+', is the Time Portal still active? Come on, we need to go down to the cellar so that I can through the gateway with you. Otherwise, if we are discovered here, it could end up creating a branching timeline that prevents you from returning to the same future you arrived from!" As Aunt Lin starts to heads down the cellar, there comes a knock at the door...<br><br>');
		$(actions).html("<button onclick='return_to_future()'>Follow Aunt Lin</button>");
	}

	function return_to_future() {
		reset_display();
		$(display_persist).html('I follow Aunt Lin down into the cellar.<br><br>');
		$(display_persist).append('"The Spirit Ball eagerly floats towards us, but somehow Aunt Lin manages to coax it back into the gateway. "Quickly, dear," she tells me. "Speak the incantation now." I say the words and to my surprise, the ball of energy expands once again into the form of a portal. Aunt Lin takes my hand. "Ready?" she asks, with a smile. I nod. Together, we step into the Time Portal as the marble gateway begins to tremble, making a loud rumbling noise...<br><br>');
		$(actions).html("<button onclick='cellar()'>Continue</button>");
		$(artwork).html(portal_art);
		traveled_to_past = 0;
	}

	function take_painting() {
		updateTime(.25);
		var previous = $(display).html();
		$(display_last).html(previous);
		if (wall_painting == 0) {
			return;
		} else if (wall_painting == 1) {
			$(display).html("I take the painting off the wall. <strong>Obtained Nightingale Painting!</strong><br><br>");
			addToInventory("nightingale_item","Nightingale Painting");
		} else if (wall_painting == 2) {
			$(display).html("I take the painting off the wall. <strong>Obtained Crane Painting!</strong><br><br>");
			addToInventory("crane_item","Crane Painting");
		}
		wall_painting = 0;
		$("#wall").html("");
		$("#wall").append("<div id='hang_painting'><button onclick='hang_painting()'>Hang Painting</button></div>");
	}

	function hang_painting() {
		updateTime(.25);
		var previous = $(display).html();
		$(display_last).html(previous);
		if (inventory_map.get("nightingale_item")) {
			take_painting();
			$(".nightingale_item").remove();
			inventory_map.delete("nightingale_item");
			wall_painting = 1;
			$(display).html("I hang the Nightingale Painting on the wall. <strong>Lost Nightingale Painting.</strong><br><br>");
		} else if (inventory_map.get("crane_item")) {
			take_painting();
			$(".crane_item").remove();
			inventory_map.delete("crane_item");
			wall_painting = 2;
			$(display).html("I hang the Crane Painting on the wall. <strong>Lost Crane Painting.</strong><br><br>");
		}
		if (!inventory_map.get("nightingale_item") && !inventory_map.get("crane_item")) {
			$("#wall").html("");
		}
		$("#wall").append("<div id='take_painting'><button onclick='take_painting()'>Take Painting</button></div>");
	}

	function inspect_bed() {
		updateTime(.25);
		var previous = $(display).html();
		$(display_last).html(previous);
		$(display).html("The bed is large and comfortable. It looks like it can be moved.<br><br>");
		$(actions).html("<button onclick='move_bed()'>Move Bed</button><br>");
		if (time_of_day == 0) {
			$(actions).append("<button onclick='nap()'>Take a Nap</button><br>");
		}
		$(actions).append("<button onclick='rest()'>Go to Sleep</button><br>");
		$(actions).append("<button onclick='cottage()'>Done Inspecting</button>");
	}

	function move_bed() {
		updateTime(.25);
		var previous = $(display).html();
		$(display_last).html(previous);
		$(display).html("I move the bed. There is a trapdoor beneath it.<br><br>");
		$(actions).html("<div id='trapdoor'><button onclick='open_trapdoor()'>Open Trapdoor</button></div>");
		$(actions).append("<button onclick='cottage()'>Done Inspecting</button>");
	}

	function nap() {
		var previous = $(display).html();
		$(display_last).html(previous);
		$(display).html("I feel tired this morning... Perhaps I should take a nap?<br><br>");
		$(actions).html("<button onclick='nap2()'>Nap</button><br>");
		$(actions).append("<button onclick='inspect_bed()'>Stay Awake</button>");
	}

	function nap2() {
		var previous = $(display).html();
		$(display_last).html(previous);
		$(display).html("I snooze through the morning. Ah, I feel so refreshed!<br><br>");
		$(actions).html("<button onclick='cottage()'>Continue</button>");
		updateStamina(4*sleep_quality);
		time = 12;
		updateTime(0);
	}

	function rest() {
		$(display_persist).css("opacity","");
		$(display).css("opacity","");
		updateLocation("Aunt Lin's cottage");
		change_music("cottage.mp3");
		$(".notification").hide();
		reset_display();
		$(display_persist).html("Going to sleep will recover some of my stamina and health, but I won't wake until tomorrow morning. Should I sleep now? <br><br><strong>The game will save when I sleep.</strong><br><br>");
		$(actions).html("<button onclick='sleep()'>Yes, I'm tired.</button><br>");
		$(artwork).empty();
		var currentStamina = $(".stamina").val();
		if(currentStamina > 0) {
			$(actions).append("<button onclick='inspect_bed()'>No, sleep is overrated.</button>");
		}
	}

	function sleep() {
		reset_display();
		if(taxes == 1) {
			taxes = 2;
		}
		if (inventory_map.get("portalspell_item q_item")) {
			$(display_persist).html("My sleep is uneasy, filled with foreboding dreams... I recover some stamina. ");
		} else {
			$(display_persist).html("I sleep a dreamless sleep. I recover some stamina. ");
		}
		if (health_max <= (total_health - 2)) {
			health_max += 2;
			$("#hp").html("Healthiness: "+health_max+"%");
			$(display_persist).append("My overall health improves a bit.");
		}
		$(display_persist).append("<br><br><strong>The game has been saved.</strong><br><br>")
		$(actions).html("<button onclick='cottage()'>Continue</button>");
		var time_remaining;
		var recovery;
		if (time < 8) {
			//after midnight i.e new day
			time_remaining = 8 - time;
			recovery = time_remaining;
		} else {
			//before midnight i.e. current day
			time_remaining = 24 - time;
			recovery = time_remaining + 8;
			current_day += 1;
			updateWeather();
		}
		updateStamina(recovery*sleep_quality);
		var currentStamina = $(".stamina").val();
		stamina = currentStamina;
		if (currentStamina < 40) {
			$(".stamina").val(40);
			stamina = 40;
		}
		time = 8;
		$("#time").html("Morning (<i>"+weather[0]+"</i>)");
		$("#date").html("Day "+current_day+"<br>"+current_loc);
		exhaustion = 0;
		stamina_alert = 0;
		day_alert = 1;
		noon_alert = 0;
		night_alert = 0;
		save_game();
	}
	
	function open_trapdoor() {
		updateTime(.25);
		var previous = $(display).html();
		$(display_last).html(previous);
		if (!inventory_map.get("key_item q_item")) {
			$(display).html("It is locked.<br><br>");
		} else {
			$(display).html("I unlock the trapdoor with the Key. A flight of stairs leads down into a dark cellar.<br><br>");
			$(actions).prepend("<button onclick='cellar()'>Enter Cellar</button><br>");
		}
		$('#trapdoor').remove();
	}

	function cellar() {
		if(future_present) {
			updateTime(.25);
			change_music("cave.mp3");
			reset_display();		
			$(artwork).empty();
			$(display_persist).html("The cellar is dark and musty. I light the lantern.<br><br>A pile of rubble lies in the center of the cellar.<br><br>");
			$(actions).html("");
		} else if (current_day == -2) {
			reset_display();
			$(artwork).empty();
			change_music("cave.mp3");
			future_present = 1;
			current_day = time_travel_day;
			$("#date").html("Day "+current_day);
			time = 8;
			updateTime(0);
			$(display_persist).html("Aunt Lin and I step out of the Time Portal. Behind us, the portal shrinks back into a ball of energy. The Spirit Ball bobs once in our direction before vanishing in a bright burst of colors. A sudden rumbling shakes the entire cellar... The marble gateway collapses into a large pile of rubble!<br><br>");
			$(actions).html("");
		} else if(traveled_to_past) {
			change_music("cave.mp3");
			time_travel_day = current_day;
			current_day = -2;
			$("#date").html("Day "+current_day);
			$("#time").html("Morning (<i>sunny</i>)");
			$(".stamina").val(health_max);
			reset_display();
			$(display_persist).html("I open my eyes. The cellar swirls with brilliant patterns of light emitting from the activated Time Portal.<br><br>");
			$(actions).html("<div id='enter_portal'><button onclick='enter_portal()'>Enter Time Portal</button></div>");
		} else if (time_portal) {
			change_music("cave.mp3");
			reset_display();
			$(display_persist).html("The cellar swirls with brilliant patterns of light emitting from the activated Time Portal.<br><br>");
			$(actions).html("<button onclick='enter_portal()'>Enter Time Portal</button><br>");
		} else if(!inventory_map.get("lantern_item t_item")) {
			updateTime(.25);
			change_music("cave.mp3");
			reset_display();
			$(display_persist).html('The cellar is dark and musty. In the center of the room is a large structure covered in shadows. It feels to be made of some kind of smooth stone. Placing my hand on the structure in the dark, I am reminded of the parable about the blind men and the elephant." <strong>Better go find some light.</strong><br><br>');
			$(actions).html("");
		} else if(inventory_map.get("portalspell_item q_item")) {
			updateTime(.25);
			change_music("cave.mp3");
			reset_display();
			$(display_persist).html("The cellar is dark and musty. I light the lantern.<br><br>In the center of the room stands a large gateway made entirely of marble. The gateway is big enough for a person to pass through. There are strange glyphs carved into its sides...<br><br>");
			$(actions).html("<div id='incantation'><button onclick='incantation()'>Speak Incantation</button></div>");
		} else if (inventory_map.get("gatewayscroll_item q_item")) {
			updateTime(.25);
			change_music("cave.mp3");
			reset_display();
			$(display_persist).html("The cellar is dark and musty. I light the lantern.<br><br>In the center of the room stands a large gateway made entirely of marble. The gateway is big enough for a person to pass through. There are strange glyphs carved into its sides... I should work on getting the Gateway Scroll translated.<br><br>");
			$(actions).html("");
		} else {
			updateTime(.25);
			change_music("cave.mp3");
			reset_display();
			$(display_persist).html("The cellar is dark and musty. I light the lantern.<br><br>In the center of the room stands a large gateway made entirely of marble. The gateway is big enough for a person to pass through. There are strange glyphs carved into its sides...<br><br>");
			$(actions).html("<button onclick='cellar_c1()'>Look Around</button><br>");
		}
		$(actions).append("<button onclick='cottage()'>Leave Cellar</button><br>");
	}
	
	function cellar_c1() {
		updateTime(.25);
		var previous = $(display).html();
		$(display_last).html(previous);
		$(display).html("I walk through the gateway. In a corner of the cellar, I find an open chest containing a scroll upon which someone has drawn a rough sketch of the marble gateway and transcribed the strange glyphs... I pocket the scroll. <strong>Obtained Gateway Scroll!</strong> Perhaps someone in the hamlet would understand the meaning of these glyphs...<br><br>");
		addToInventory("gatewayscroll_item q_item","Gateway Scroll");
		$(actions).html("<button onclick='cottage()'>Leave Cellar</button>");
	}

	function incantation() {
		var previous = $(display).html();
		$(display_last).html(previous);
		$(display).html("I recite the incantation for the Portal Spell: <i>Damen dai wo dao xinzhong kewang de shijian!</i><br><br>");
		$(display).append("Nothing happens... Master Yang's words echoes in my mind. Right, I need to offer a relic as a power source.<br><br>"); 
		$(actions).html("");
		if (inventory_map.get("amberamulet_item e_item q_item")) {
			$(actions).append("<div id='offer_relic'><button onclick='offer_relic(2)'>Offer Amber Amulet</button></div>");
		}
		if (inventory_map.get("bambooflute_item q_item")) {
			$(actions).append("<div id='offer_relic'><button onclick='offer_relic(3)'>Offer Bamboo Flute</button></div>");
		}
		if (inventory_map.get("jadesculpture_item q_item")) {
			$(actions).append("<div id='offer_relic'><button onclick='offer_relic(4)'>Offer Jade Peach Tree</button></div>");
		}
		if (inventory_map.get("silverdagger_item e_item q_item")) {
			$(actions).append("<div id='offer_relic'><button onclick='offer_relic(1)'>Offer Silver Dagger</button></div>");
		}
		$(actions).append("<button onclick='cottage()'>Leave Cellar</button><br>");
	}

	function offer_relic(text) {
		var previous = $(display).html();
		$(display_last).html(previous);
		$(display).html('');
		if(text == 1) {
			$(display).append("Should I offer the Silver Dagger as a power source? <strong>I should think carefully about this decision!</strong><br><br>");
			$(actions).html("<button onclick='offer_relic2(1)'>Confirm</button><br>");
			$(artwork).html(amberamulet_art);
		} else if(text == 2) {
			$(display).append("Should I offer the Amber Amulet as a power source? <strong>I should think carefully about this decision!</strong><br><br>");
			$(actions).html("<button onclick='offer_relic2(2)'>Confirm</button><br>");
			$(artwork).html(silverdagger_art);
		} else if(text == 3) {
			$(display).append("Should I offer the Bamboo Flute as a power source? <strong>I should think carefully about this decision!</strong><br><br>");
			$(actions).html("<button onclick='offer_relic2(3)'>Confirm</button><br>");
			$(artwork).html(bambooflute_art);
		} else if(text == 4) {
			$(display).append("Should I offer the Jade Peach Tree as a power source? <strong>I should think carefully about this decision!</strong><br><br>");
			$(actions).html("<button onclick='offer_relic2(4)'>Confirm</button><br>");
			$(artwork).html(jadesculpture_art);
		}
		if(relic_count > 1) {
			$(actions).append("<button onclick='different_relic()'>Choose Another Relic</button><br>");
		}
		$(actions).append("<button onclick='cottage()'>Leave Cellar</button><br>");
	}

	function different_relic() {
		$(actions).html("");
		if (inventory_map.get("amberamulet_item e_item q_item")) {
			$(actions).append("<div id='offer_relic'><button onclick='offer_relic(2)'>Offer Amber Amulet</button></div>");
		}
		if (inventory_map.get("bambooflute_item q_item")) {
			$(actions).append("<div id='offer_relic'><button onclick='offer_relic(3)'>Offer Bamboo Flute</button></div>");
		}
		if (inventory_map.get("jadesculpture_item q_item")) {
			$(actions).append("<div id='offer_relic'><button onclick='offer_relic(4)'>Offer Jade Peach Tree</button></div>");
		}
		if (inventory_map.get("silverdagger_item e_item q_item")) {
			$(actions).append("<div id='offer_relic'><button onclick='offer_relic(1)'>Offer Silver Dagger</button></div>");
		}
		$(actions).append("<button onclick='cottage()'>Leave Cellar</button><br>");
	}

	function offer_relic2(text) {
		var previous = $(display).html();
		$(display_last).html(previous);
		time_portal = 1;
		if(text == 1) {
			$(display).html("I speak the incantation while holding the Silver Dagger. <strong>The Silver Dagger shatters in my hand!</strong><br><br>Swirling ribbons of spirit energy begin to burst forth from the broken halves of the Silver Dagger. The energy collects in the center of the cellar, slowly forming into a ball. The Spirit Ball bounces curiously around the cellar as if having a mind of its own, before drifting into the gateway's hollow middle where it stretches into a portal filled with beautiful patterns of colors, shimmering like butterfly wings... <strong>The Time Portal has been activated!</strong><br><br>");
			if(silver_dagger) {
				unequip(11);
			}
			inventory_map.delete("silverdagger_item e_item q_item");
			addToInventory("silverdagger_item q_item","Silver Dagger (<i>relic</i>, <strong>broken</strong>)");
		} else if(text == 2) {
			$(display).html("I speak the incantation while holding the Amber Amulet. <strong>The Amber Amulet shatters in my hand!</strong><br><br>Swirling ribbons of spirit energy begin to burst forth from the broken halves of the Amber Amulet. The energy collects in the center of the cellar, slowly forming into a ball. The Spirit Ball bounces curiously around the cellar, as if having a mind of its own, before drifting into the gateway's hollow middle where it stretches into a portal filled with beautiful patterns of colors, shimmering like butterfly wings... <strong>The Time Portal is activated!</strong><br><br>");
			unequip(2);
			inventory_map.delete("amberamulet_item e_item q_item");
			addToInventory("amberamulet_item q_item","Amber Amulet (<i>relic</i>, <strong>broken</strong>)");
		} else if(text == 3) {
			$(display).html("I speak the incantation while holding the Bamboo Flute. <strong>The Bamboo Flute shatters in my hand!</strong><br><br>Swirling ribbons of spirit energy begin to burst forth from the broken halves of the Bamboo Flute. The energy collects in the center of the cellar, slowly forming into a ball. The Spirit Ball bounces curiously around the cellar, as if having a mind of its own, before drifting into the gateway's hollow middle where it stretches into a portal filled with beautiful patterns of colors, shimmering like butterfly wings... <strong>The Time Portal is activated!</strong><br><br>");
			flute_broken = 1;
			inventory_map.delete("bambooflute_item q_item");
			addToInventory("bambooflute_item q_item","Bamboo Flute (<i>relic</i>, <strong>broken</strong>)");
		} else if(text == 4) {
			$(display).html("I speak the incantation while holding the Jade Peach Tree. <strong>The Jade Peach Tree shatters in my hand!</strong><br><br>Swirling ribbons of spirit energy begin to burst forth from the broken halves of the Jade Peach Tree. The energy collects in the center of the cellar, slowly forming into a ball. The Spirit Ball bounces curiously around the cellar, as if having a mind of its own, before drifting into the gateway's hollow middle where it stretches into a portal filled with beautiful patterns of colors, shimmering like butterfly wings... <strong>The Time Portal is activated!</strong><br><br>");
			sculpture_broken = 1;
			inventory_map.delete("jadesculpture_item q_item");
			addToInventory("jadesculpture_item q_item","Jade Peach Tree (<i>relic</i>, <strong>broken</strong>)");
		}
		$(actions).html("<button onclick='enter_portal()'>Enter Time Portal</button><br>");
		$(actions).append("<button onclick='cottage()'>Leave Cellar</button><br>");
		$(artwork).html(portal_art);
	}

	function enter_portal() {
		if(traveled_to_past) {
			var previous = $(display).html();
			$(display_last).html(previous);
			$(display).html('As I approach the Time Portal, the portal suddenly shrinks, collapsing back into a ball of energy. The Spirit Ball dances merrily away... I take a step backwards, and the Spirit Ball floats playfully towards the gateway, as if inviting me to resume a game of tag...<br><br>');
			$("#enter_portal").remove();
		} else {
			reset_display();
			$(display_persist).html("<strong>Before entering the Time Portal, I should make sure that I have everything I need for whatever destination awaits me.</strong> Is there anything else I still need to do?<br><br>");
			$(actions).html("<button onclick='enter_portal2()'>Enter Time Portal</button><br>");
			$(actions).append("<button onclick='cottage()'>Leave Cellar</button><br>");
		}
	}

	function enter_portal2() {
		reset_display();
		$(display_persist).html("I step into the Time Portal. Dancing patterns of light engulf me, spinning faster and faster. My vision begins to blur... In the distance, I hear a faint chanting that grows louder and more persistent. All of a sudden, the chanting stops. There is a moment of silence...followed by a thunderous noise&mdash;a deafening <strong><i>CRACK!</i></strong><br><br>The world becomes still...<br><br>");
		$(actions).html("<button onclick='cellar()'>Continue</button><br>");
		traveled_to_past = 1;
	}

	function inspect_table() {
		updateTime(.25);
		var previous = $(display).html();
		$(display_last).html(previous);
		$(display).html("There is a letter and a receipt on the table. ");
		if (!inventory_map.get("lantern_item t_item")) {
			$(display).append("A lantern sits beside the papers on the table.<br><br>");
		} else {
			$(display).append("<br><br>");
		}
		$(actions).html("<div id='read_letter'><button onclick='read_letter()'>Read Letter</button></div>");
		$(actions).append("<div id='read_receipt'><button onclick='read_receipt()'>Read Receipt</button></div>");
		if (!inventory_map.get("lantern_item t_item") && !game_finished) {
			$(actions).append("<div id='take_lantern'><button onclick='take_lantern()'>Take Lantern</button></div>");
		}
		$(actions).append("<button onclick='cottage()'>Done Inspecting</button>");
	}

	function take_lantern() {
		updateTime(.25);
		var previous = $(display).html();
		$(display_last).html(previous);
		$(display).html("<strong>Obtained a Lantern!</strong><br><br>");
		addToInventory("lantern_item t_item","Lantern");
		$("#take_lantern").remove();
	}

	function read_letter() {
		updateTime(1);
		var previous = $(display).html();
		$(display_last).html(previous);
		$(display).html('The letter reads: "Dear Mr. and Mrs. Fan&mdash;Thank you kindly for inviting me to Li-fen&#39;s twentieth birthday celebration. I am delighted to accept your invitation. I cannot wait to see her reaction to my birthday gift for her. I am certain she will be very pleased. Your friend, Lin Mei-hua." The letter is dated '+(current_day+2)+' days ago.<br><br>');
		$("#read_letter").remove();
	}

	function read_receipt() {
		updateTime(1);
		var previous = $(display).html();
		$(display_last).html(previous);
		$(display).html("The receipt is from Chang's Tailor and Fine Attire Shop for a qipao costing 80g.<br><br>");
		$("#read_receipt").remove();
	}

	function inspect_stove() {
		updateTime(.25);
		var previous = $(display).html();
		$(display_last).html(previous);
		$(display).html("A simple clay stove. There is a small clay pot on the stove. Heat rises from the clay pot.<br><br>");
		$(actions).html("<div id='look_inside'><button onclick='look_inside_pot()'>Look Inside Clay Pot</button></div>");
		$(actions).append("<button onclick='cottage()'>Done Inspecting</button>");
	}
	
	function look_inside_pot() {
		updateTime(.25);
		var previous = $(display).html();
		$(display_last).html(previous);
		$(display).html("I peer inside the clay pot. At the bottom lies a small nest of twigs with a bright red egg at the center. The heat appears to be coming from the red egg! How peculiar!<br><br>");
		seen_stove = 1;
		$("#look_inside").remove();
	}

	function return_to_farm() {
		updateLocation("Aunt Lin's farm");
		change_music("farm.mp3");
		reset_display();
		$(display_persist).html("Aunt Lin's farm consists of a field and a cottage.<br><br>");
		$(actions).html('<button onclick="field()">Visit Field</button><br>');
		$(actions).append('<button onclick="cottage()">Visit Cottage</button><br><br>');
		$(actions).append('<button onclick="hamlet()">Visit Pleasant Weather Hamlet</button>');
		if(egg){
			$(actions).append("<br><button onclick='leave_hamlet()'>Travel to Imperial Road</button>");
		}
		$(artwork).empty();
		$("#plantS").hide();
		$("#plantC").hide();
		$("#plantG").hide();
		$("#use_rocksmash").attr('disabled','disabled');
	}

	//Pleasant Weather Hamlet

	function hamlet() {
		var collapse = updateStamina(-1.5);
		if(collapse){
			return;
		}
		updateTime(.5);
		reset_display();
		$("#use_forage").attr('disabled','disabled');
		talked_to_yang = 0;
		if ((taxes == 2) && !theft_solved) {
			taxes = 0;
			$(display_persist).html('A young man stops me outside of Aunt Lin&#39;s farm. He wears a <i>futou</i>, civil official headwear, that loosely fits his head.<br><br>"Greetings," he says. "It has come to my attention that you recently discovered a cache of stolen assets from Crane Cloud Mountains, known to be the secret hideout for the notorious Bandit Chief Jin. Is this true?"<br><br>');
			$(actions).html("<button onclick='tax_collector(1)'>Yes.</button><br>");
			$(actions).append("<button onclick='tax_collector(2)'>Who's asking?</button>");
			$(artwork).html(thug_art);
		} else {
			updateLocation("Pleasant Weather Hamlet");
			change_music("village.mp3");
			in_bookshop = 0;
			$(display_persist).html("Pleasant Weather Hamlet, nestled at the foot of the Crane Cloud Mountains, is made up of a few local shops and residences.<br><br>");
			$(actions).html("<button onclick='tailorshop()'>Visit Chang's Tailor and Fine Attire Shop</button><br>");
			$(actions).append("<button onclick='blacksmith()'>Visit Blacksmith</button><br>");
			$(actions).append("<button onclick='market()'>Visit Ming's Market</button><br>");
			$(actions).append("<button onclick='herbalist()'>Visit Herbalist Shop</button><br>");
			$(actions).append("<button onclick='bookshop()'>Visit Bookstore</button><br>");
			$(actions).append("<button onclick='constable()'>Visit Constable's Office</button><br>");
			$(actions).append("<button onclick='elder_song()'>Visit Song Family Residence</button><br>");
			$(actions).append("<button onclick='gao()'>Visit Gao Family Residence</button><br>");
			$(actions).append("<button onclick='fan()'>Visit Fan Family Residence</button><br>");
			$(actions).append("<button onclick='temple()'>Visit Peach Garden Temple</button><br>");
			$(actions).append("<br><button onclick='return_to_farm()'>Return to Aunt Lin's Farm</button>");
			if(inventory_map.get("wolfsbane_item")) {
				$(actions).append("<br><button onclick='waterfall_base()'>Head into Howling Woods</button>");
			} else {
				$(actions).append("<br><button onclick='woods()'>Head into Howling Woods</button>");
			}
			$(artwork).empty();
		}
	}
	
	
	//epilogue
	function leave_hamlet() {
		reset_display();
		$(display_persist).html("<strong>Once I leave Aunt Lin's farm, I may not have the chance to visit again for some time. Am I ready to say farewell?</strong><br><br>");
		$(actions).html("<button onclick='leave_hamlet_c1()'>Yes.</button><br>");
		$(actions).append("<button onclick='return_to_farm()'>Not yet.</button><br>");
	}
	
	function leave_hamlet_c1() {
		reset_display();
		current_day += 1;
		time = 8;
		updateTime(0);
		$("#time").html("Morning (<i>sunny</i>)");
		updateStamina(200);
		var text;
		var text2;
		var a;
		var l;
		if(anli_friendship && anli_rock && lifen_friendship && lifen_nightingale) {
			text = ", with An-li and Li-fen a distance behind her";
			text2 = " as An-li and Li-fen finally catch up with her, both out of breath.."
			a = 1;
			l = 1;
		}
		else if (anli_friendship && anli_rock) {
			text = ", with An-li a distance behind her";
			text2 = " as an exhausted-looking An-li finally catches up with her..";
			a = 1;
		}
		else if (lifen_friendship && lifen_nightingale) {
			text = ", with Li-fen a distance behind her";
			text2 = " as an exhausted-looking Li-fen finally finally catches up with her..";
			l = 1;
		} else {
			text = "";
			text2 = "";
		}
		$(display_persist).html('Upon waking on the morning of my departure, I make my bed while Aunt Lin prepares a large breakfast of congee with pickled vegetables, deep-fried dough, and sweet soymilk. Aunt Lin refills my bowl again and again, insisting that I eat as much as I can. Only once she is satisfied that I can no longer have another bite does she agree it is time to head out. The sun shines brightly overhead as we leave the cottage and walk past the field, towards the rugged path that will eventually take me to the Imperial Road. Suddenly, we hear a voice calling out to us.<br><br>"Wait, Mei-Hua! '+name+'! Don&#39;t leave yet!"<br>Aunt Lin and I turn to see Ms. Ming heading spiritedly walking towards us from the direction of Pleasant Weather Hamlet'+text+'.<br><br>');
		$(display).html('Ms. Ming shakes a finger at me once she reaches us. "You thought you could slip away without even a good-bye? Tsk, not even for the <i>yingxiong</i> of Pleasant Weather Hamlet will I allow that," she says giving me a wink'+text2+'.<br><br>');
		$(actions).html("<div id='total_farewell'></div>");
		$("#total_farewell").append("<div id='ming_gift'><button onclick='farewell_gifts(2)'>Say Farewell to Ms. Ming</button></div>");
		if(a){
			$("#total_farewell").append("<div id='anli_gift'><button onclick='farewell_gifts(3)'>Say Farewell to An-li</button></div>");
		}
		if(l){
			$("#total_farewell").append("<div id='lifen_gift'><button onclick='farewell_gifts(4)'>Say Farewell to Li-fen</button></div>");
		}
		$("#total_farewell").append("<div id='aunt_gift'><button onclick='farewell_gifts(1)'>Say Farewell to Aunt Lin</button></div>");
	}
	
	function farewell_gifts(text) {
		var previous = $(display).html();
		$(display_last).html(previous);
		if (text == 1){
			$(display).html('Are you sure you don&#39;t want to come along? I ask Aunt Lin. We can go see the Capitol City together.<br>Aunt Lin smiles gently and hugs me. "Yes, dear. I&#39;m sure. I still intend to visit the Capitol City one day, just not right now. I need to tend to the farm and... Well, ever since the demon attack, I realized that there are some matters I need to settle with Mr. Chang first. It is time the old fool stops steps up...." Aunt Lin says, suddenly looks embarrassed.<br><br>"Speaking of Mr. Chang," she says, "He asked me to give you these. He made them himself." <strong>Obtained Leather Boots! Wearing these will help me get around faster!</strong><br><br>"These items are from me," Aunt Lin continues, "They&#39;re not much, but they should help for the long journey ahead." <strong>Obtained 50g, Scallion Crepe (6x), and Firestick from Aunt Lin! I can start campfires with the Firestick.</strong><br><br>I bow deeply to Aunt Lin. Mr. Chang is very fortunate, I say. Please give him my gratitude!<br>Aunt Lin gives me a hug and a beaming smile. "I am so proud of you, dear! Be careful on the Imperial Road," she says. "And remember to take good care of the Phoenix Egg. I&#39;m really glad you visited me!" Aunt Lin says, wiping a tear away.<br><br>');
			$("#aunt_gift").remove();
			money += 50;
			$("#money").html(money+"g");
			addToInventory("leatherboots_item e_item","Leather Boots <button id='leatherboots_button' onclick='equip(14)'>Equip</button>");
			scallion_crepes = 6;
			addToInventory("scallioncrepes_box f_item","Scallion Crepes (6x) <button class='eat' onclick='eat_food(6,75)'>Eat</button>");
			addToInventory("firestick_item t_item","Firestick");
			firestick = 1;
			$(actions).append("<button onclick='travel_to_imperialroads()'>Travel to Imperial Road</button>");
		} else if (text == 2){
			$(display).html('Please take good care of yourself, I say to Ms. Ming.<br>Ms. Ming gives me a grin. "Right back at you! I hear you are going on adventure&mdash;no doubt some outlandish quest that your aunt tasked you with... If only I was a decade younger, I would have tagged along myself! Oh well. Here," Ms. Ming says, handing me small bundle in a tied-up quilt, "By the time you reach the Capitol City, it should almost be time for the Mid-Autumn Festival. Don&#39;t eat these until then," she instructs. "They should keep for a while." <strong>Obtained Red Bean Mooncake, Golden Yolk Mooncake, Blue Pea Flower Mooncake, White Lotus Mooncake, and Black Sesame Mooncake!</strong><br>I bow deeply to Ms. Ming. Thank you for your generosity, I say.<br><br>');
			$("#ming_gift").remove();
			addToInventory("whitemooncake_item","White Lotus Mooncake");
			addToInventory("redmooncake_item","Red Bean Mooncake");
			addToInventory("bluemooncake_item","Blue Pea Flower Mooncake");
			addToInventory("blackmooncake_item","Black Sesame Mooncake");
			addToInventory("yellowmooncake_item","Golden Pineapple Mooncake");
			mooncakes = [1,1,1,1,1];
		} else if (text == 3){
			$(display).html('It&#39;s good see you, I say to An-li.<br>An-li smiles. "I&#39;m glad Ms. Ming mentioned that you were departing. I wanted to speak to you before you left." An-li hands me the Shiny Rock. "I visited Bookkeeper Tan&#39;s store to see if she had any petralogical texts that could tell us what kind of rock this is. We searched through a number of old scrolls before finding a legend about a general who undefeatable in combat because his armor was crafted from a star that fell from Heaven. The description of the material that used to craft the general&#39;s armor matches the qualities of the Shiny Rock. However, according to the scroll, the armor was extremely difficult to forge... It would certainly be beyond my abilities," An-li says, humbly. "However, I hear there is a Master Armorer in the Capitol City. If you bring the Shiny Rock to her, she should be able to craft something out of it. There is not enough material here for a weapon or armor, but perhaps a ring of some sort..." <strong>An-li hands me the Shiny Rock!</strong><br><br>');
			if((anli_date == 2) && (chose_left_door || dispel_illusion)) {
				$("#anli_gift").html("<button onclick='embrace_anli()'>Embrace An-li</button>");
			} else {
				$(display).append(' An-li bows. "I hope you have a safe journey," he says, "Please write to me about your adventures!"<br><br>');
				$("#anli_gift").remove();
			}
			addToInventory("shinyrock_item","Shiny Rock");
		} else if (text == 4) {
			$(display).html('I&#39;m happy you came, I say to Li-fen.<br>Li-fen smiles. "Of course! I heard from Auntie Ming that you were leaving us, so I raced here to see you. I want to ask you a favor. Will you deliver the Nightingale Painting to Dressmaker Yi in the Capitol City? She is a family friend and the best clothesmaker alive, no offense to Mr. Chang. Just ask any fashionably dressed person you see in the City where they bought their outfit from, and they will quickly point you to her store. I always like to visit her store when my family goes to the City. The wedding gowns and suits she has on display are especially stunning... Anyways, the reason I want you to deliver the Nightingale Painting to her is recently, she founded a small art museum that has since became very popular. Ms. Yi donate all proceeds from it to charity. Isn&#39;t she amazing? I would love for the Nightingale Painting to be showcased in her museum so that it can be appreciated by more people than just me. When you bring her the painting, tell her is a gift from me. I am sure she will be grateful. She is very well-connected and can certainly help you out while you are in the Capitol City!" <strong>Li-fen hands me the Nightingale Painting!</strong><br><br>');
			if((lifen_date == 2) && (chose_right_door || dispel_illusion)) {
				$("#lifen_gift").html("<button onclick='embrace_lifen()'>Embrace Li-fen</button>");
			} else {
				$(display).append('Li-fen bows. "Be careful on the road, okay?" she says, "You&#39;ll write to me from time to time, won&#39;t you?" she says.<br><br>');
				$("#lifen_gift").remove();
			}
			addToInventory("nightingale_item","Nightingale Painting");
			if(!crane_painting_available && wall_painting !=2 && !inventory_map.get("crane_item")) {
				study_painting = 2;
			} else {
				study_painting = 0;
			}
		}
	}
	
	function embrace_anli() {
		var previous = $(display).html();
		$(display_last).html(previous);
		$(display).html('I step forward to embrace An-li.<br>"Oh, I want you to give you this as well," An-li says. He hands me a small lacquered box. Inside is a beautifully-carved ivory comb. <strong>Obtained Ivory Comb!</strong><br>"Ever since you saved me from the demons, I haven&#39t stopped thinking of you. This comb is a symbol of my devotion to you," An-li says, shyly. "Please hold onto it until you can come back and see me again." <strong>An-li has confessed his feelings for me!</strong><br><br>');
		$(display).append('An-li hugs me. "I hope you have a safe journey," he says, "Please write to me about your adventures!"<br><br>');
		addToInventory("ivorycomb_item r_item","Ivory Comb (<i>token of love</i>)");
		$("#anli_gift").remove();
	}
	
	function embrace_lifen() {
		var previous = $(display).html();
		$(display_last).html(previous);
		$(display).html('"I step forward to embrace Li-fen...<br>"Oh, there is something else I want to you to have," Li-fen says. She hands me a small lacquered box. Inside is a beautifully-carved ivory hairpin. <strong>Obtained Ivory Hairpin!</strong> "I have been thinking about you a lot since you rescued me from the demons. This hairpin is a symbol of my devotion to you. You should hold onto it until you are able to come see me again," she says with sincerity. <strong>Li-fen has confessed her feelings for me!</strong><br><br>');
		$(display).append('Li-fen hugs me. "Be careful on the road, okay?" she says, "You&#39;ll write to me from time to time, won&#39;t you?" she says.<br><br>');
		addToInventory("ivoryhairpin_item r_item","Ivory Hairpin (<i>token of love</i>)");
		$("#lifen_gift").remove();
	}
	
	function travel_to_imperialroads() {
		var previous = $(display).html();
		$(display_last).html(previous);
		var text = "";
		if(anli_friendship && anli_rock && lifen_friendship && lifen_nightingale) {
			text = ", An-li, Li-fen ";
		}
		else if (anli_friendship && anli_rock) {
			text = ", An-li ";
		}
		else if (lifen_friendship && lifen_nightingale) {
			text = ", Li-fen ";
		}
		$(display).html('I wave goodbye to Ms. Ming'+text+' and Aunt Lin. Until Fate brings us together again, farewell! I say. "Good luck on your journey!" they call and wave as I start down the path towards the Imperial Road.<br><br>');
		$(actions).html("<button onclick='path_to_imperialroads()'>Continue</button>");
	}
	
	function path_to_imperialroads() {
		change_music("forest.mp3");
		reset_display();
		$("#time").html("Morning (<i>cloudy</i>)");
		updateLocation("Path to Imperial Road");
		$(display_persist).html('The path to the Imperial Road is rocky and uneven. Overhead, the sky is cloudy. I have a long walk ahead of me...<br><br>');
		$(actions).html("<button onclick='imperialroads()'>Continue</button>");
	}
	
	var robbed = 0;
	
	function imperialroads() {
		reset_display();
		current_day += 3;
		time = 8;
		updateTime(0);
		$("#time").html("Morning (<i><strong>raining</strong></i>)");
		updateStamina(-75);
		updateLocation("Imperial Road");
		$(display_persist).html('Several days later, I make it on to the Imperial Road. I pause to marvel at the tamped earth beneath my feet, stretching ten thousand <i>li</i> across the kingdom like a spine to connect the Capitol City in the north to the Southern Seaport. Overhead, the sky is covered in gray clouds. The scent of petrichor hangs in the air. It begins to rain...<br><br>');
		$(display).html('A merchant wagon rumbles past me along the Imperial Road. "Whoa," the merchant says, tugging on the reins of his horse to bring the wagon to a stop. The rain streams down the merchant&#39;s conical, straw hat. "Heading north, friend?" the merchant calls to me. "Need a ride?"<br><br>');
		$(actions).html("<button onclick='merchant(1)'>Yes please.</button><br>");
		$(actions).append("<button onclick='merchant(2)'>No thanks.</button>");
	}
		
	function merchant(text) {
		var previous = $(display).html();
		$(display_last).html(previous);
		if (text == 1) {
			$(display).html('Yes, I appreciate it, I say.<br>"Hop in the back!" the merchant says. I climb into the back of the empty wagon and take shelter under its wooden roof, glad to be out of the rain. We continue along the Imperial Road.<br><br>');
			$(actions).html("<button onclick='ride_with_merchant()'>Continue</button>");
		} else {
			$(display).html('No, I don&#39t mind the weather, I say.<br>');
			if (inventory_map.get("bambooflute_item q_item") && !flute_broken) {
				$(display).append('The merchant eyes the Bamboo Flute peeking out of my pack. "Suit yourself then," the merchant says and rides off."<br><br>');
				$(actions).html("<button onclick='soldiers(1)'>Continue Along Imperial Road</button>");
			} else {
				$(display).append('The merchant grins and then claps loudly. The raindrops around us suddenly become frozen in the air. I cannot move my body. The merchant claps again, and a gust of wind swirls around me...an invisible force pulls my weapons and coins into the merchant&#39;s wagon! The merchant smiles impishly again, revealing sharp teeth, before riding off. The frozen raindrops resume their descent... <strong>Lost </strong>');
				if(inventory_map.get("silverdagger_item e_item q_item")){
					unequip(11);
					inventory_map.delete("silverdagger_item e_item q_item");
					$(".silverdagger_item").remove();
					$(display).append('<strong>Silver Dagger, </strong>');
				}
				if(inventory_map.get("bronzesword_item e_item")){
					unequip(9);
					inventory_map.delete("bronzesword_item e_item");
					$(".bronzesword_item").remove();
					$(display).append('<strong>Bronze Sword, </strong>');
				}
				if(inventory_map.get("steelsword_item e_item")){
					unequip(10);
					inventory_map.delete("steelsword_item e_item");
					$(".bronzesword_item").remove();
					$(display).append('<strong>Steel Sword, </strong>');
				}
				if(inventory_map.get("woodenstaff_item e_item")){
					unequip(12);
					inventory_map.delete("woodenstaff_item e_item")
					$(".bronzesword_item").remove();
					$(display).append('Wooden Staff, </strong>');
				}
				var lost_money = (money-5);
				money = 5;
				$("#money").html(money+'g');
				$(display).append('<strong>and '+lost_money+'g!</strong><br><br>');
				$(display).append('Fortunately, the Phoenix Egg remains unharmed...<br><br>');
				$(actions).html("<button onclick='soldiers(1)'>Continue Along Imperial Road</button>");
				robbed = 1;
			}
		}
	}
	
	function ride_with_merchant() {
		var previous = $(display).html();
		$(display_last).html(previous);
		updateTime(1);
		$("#time").html("Morning (<i><strong>raining</strong></i>)");
		updateStamina(25);
		$(display).html('In the back of the merchant wagon, I feel a sudden lethargy as the soothing sound of rain drumming on wooden roof and the rocking motion of the wagon begin to lull me to sleep. Soon, I doze off... Moments later, I am jolted awake by the sound of a horse galloping away. The wagon has stopped...<br><br>');
		$(actions).html("<button onclick='ride_with_merchant_c1()'>Continue</button>");
	}
	
	function ride_with_merchant_c1() {
		var previous = $(display).html();
		$(display_last).html(previous);
		$(display).html('Hello? I call out, but there is no answer. The merchant and the horse pulling the wagon are both gone...along with my weapons and money! <strong>Lost </strong>');
		if(inventory_map.get("silverdagger_item e_item q_item")){
			unequip(11);
			inventory_map.delete("silverdagger_item e_item q_item");
			$(".silverdagger_item").remove();
			$(display).append('<strong>Silver Dagger, </strong>');
		}
		if(inventory_map.get("bronzesword_item e_item")){
			unequip(9);
			inventory_map.delete("bronzesword_item e_item");
			$(".bronzesword_item").remove();
			$(display).append('<strong>Bronze Sword, </strong>');
		}
		if(inventory_map.get("steelsword_item e_item")){
			unequip(10);
			inventory_map.delete("steelsword_item e_item");
			$(".bronzesword_item").remove();
			$(display).append('<strong>Steel Sword, </strong>');
		}
		if(inventory_map.get("woodenstaff_item e_item")){
			unequip(12);
			inventory_map.delete("woodenstaff_item e_item")
			$(".bronzesword_item").remove();
			$(display).append('Wooden Staff, </strong>');
		}
		var lost_money = (money-5);
		money = 5;
		$("#money").html(money+'g');
		$(display).append('<strong>and '+lost_money+'g!</strong><br><br>');
		$(display).append('Fortunately, the Phoenix Egg remains unharmed...<br><br>');
		$(actions).html("<button onclick='soldiers(2)'>Continue</button>");
		robbed = 1;
	}
	
	function soldiers(text) {
		reset_display();
		updateTime(4);
		$("#time").html("Afternoon (<i><strong>raining</strong></i>)");
		updateStamina(-20);
		if(text == 1) {
			$(display_persist).html('I continue walking along the Imperial Road, drenched by the rain... Several hours later, I hear the sound of horses galloping from behind me. Four soldiers on horseback ride up along the Imperial Road, but some reason, there are five horses with them...<br><br>The Captain of the group, a man with a thick, rain-soaked beard, steers his horse beside me.<br><br>');
			$(display).html('"You there!" he shouts through the rain. "Have you seen a merchant wagon come by? My soldiers and I are chasing a supernatural creature that has the ability to make people vanish. It has been terrorizing the local villages. This morning, there was another attack, but when my company showed up, the creature snapped its finger and made one of my soldiers disappear right before our eyes... Then it snatched a villager&#39;s straw hat and an unattended merchant wagon and rode off!" The Captain studies me for a moment. "Hm, judging by the look on your face, it appears you have information to share," he says.<br><br>');
		} else {
			$(display_persist).html('I continue walking along the Imperial Road, drenched by the rain... Several hours later, I hear the sound of horses galloping from behind me. Four soldiers on horseback ride up along the Imperial Road. For some reason, there are five horses with them... The Captain of the group, a man with a thick, rain-soaked beard, steers his horse beside me. "You there!" he shouts through the rain. "Have you seen a merchant on horseback pass by? My soldiers and I are chasing a supernatural creature that has the ability to make people vanish. It has been terrorizing the local villages. This morning, there was another attack, but when my company showed up, the creature snapped its finger and made one of my soldiers disappear right before our eyes... Then it snatched a villager&#39;s straw hat and an unattended merchant wagon and rode off! We came across the deserted merchant wagon a while ago, but saw no sign of the creature or the horse hitched to the wagon." The Captain studies me for a moment. "Hm, judging by the look on your face, it appears you have information to share," he says.<br><br>');
		}
		$(actions).html("<button onclick='soldiers_c1()'>Inform Captain about the Imp</button>");
	}
	
	function soldiers_c1(){
		var previous = $(display).html();
		$(display_last).html(previous);
		updateStamina(-1.5);
		if(robbed > 0){
			$(display).html('I tell the Captain about the Imp disguised as the merchant who robbed me.<br>');
		} else {
			$(display).html('I tell the Captain about the Imp disguised as the merchant I encountered.<br>');
		}
		$(display).append('"So you have a history with this creature," the Captain says. "Very well, you will come with us to the Capitol City and report what you told me to the General." He holds up a hand as I start to speak. "There is no choice here," he says, "But don&#39;t worry, I am sure the General will reward you for your troubles." He waves to one of his soldiers. "Lieutenant Ma, bring over the mare," he says.<br><br>Turning back to me, the Captain says, "Forgive me, I am not the most well-mannered person. My name is Captain Jin, the second son of Magistrate Jin and an officer of the Imperial Army of His Exalted Highness, may he live ten thousand years. What is your name?" the Captain asks.<br>I am called '+name+', I say. Captain Jin gives me a curt nod.<br><br>');
		$(actions).html("<button onclick='soldiers_c2()'>Continue</button>");
	}
	
	function soldiers_c2() {
		var previous = $(display).html();
		$(display_last).html(previous);
		$(display).html('Lieutenant Ma brings over a handsome chestnut mare. She rubs the horse&#39;s neck gently before handing the reins to me. "You know how to ride?" she asks me. "She&#39;s a gentle one so all you have to do is manage to stay on. She&#39;s your responsibility now," Lieutenant Ma says, "She means a lot to her previous owner, so you better treat her well, got it?" <strong>The Chestnut Mare has become my travel companion!</strong><br><br>Captain Jin signals to the other two soldiers. "Let us be on our way then," he says, "We still have a lot of ground to cover."<br><br>');
		companion = 1;
		$("#travel_companion").html('<br>'+companion_name+'<br><progress id="companion_bar" value="'+companion_health+'" max="10"></progress><div id="companion_attribute">Relationship: Neutral</div>');
		$("#companion_bar").css("color", companion_color);
		$(actions).html("<button onclick='campsite()'>Continue</button>");
	}
	
	function campsite() {
		change_music("cave.mp3");
		if(game_finished == 2) {
			updateLocation("Soldier Camp");
			time = 9;
			$("#time").html("<strong>Night</strong> (<i>windy</i>)");
			campsite2();
		} else {
			updateLocation("Soldier Camp");
			reset_display();
			$("#time").html("<strong>Night</strong> (<i>windy</i>)");
			$(display_persist).html('We ride the rest of the day along the empty Imperial Road, as rain pours down... The rain lets up just before nightfall, summoning a cold wind to take its place. Captain Jin signals for us to make camp by the side of the Imperial Road so that we may dry off. The soldiers quickly get to work, first tending to their horses and then gathering kindling to start a fire...<br><br>Overhead, the nearly full moon shines brightly in the night sky.<br><br>');
			$(actions).html("<button onclick='captain()'>Talk to Captain Jin</button><br>");
			$(actions).append("<button onclick='lieutenant()'>Talk to Lieutenant Ma</button><br>");
			$(actions).append("<button onclick='corporal()'>Talk to Soldiers</button><br>");
			$(actions).append("<button onclick='care_horse()'>Attend to Horse</button><br>");
			$(actions).append("<button onclick='setup_camp()'>Set Up Camp</button>");
			$("#companion_bar").val(3);
		}
		$("#use_forage").removeAttr('disabled');
	}
	
	function campsite2() {
		reset_display();
		$(display_persist).html('A soldier camp on the side of the Imperial Road... The air is cold from the wind, despite the small campfire. Overhead, the nearly full moon shines brightly in the night sky.<br><br>');
		$(actions).html("<button onclick='captain()'>Talk to Captain Jin</button><br>");
		$(actions).append("<button onclick='lieutenant()'>Talk to Lieutenant Ma</button><br>");
		$(actions).append("<button onclick='corporal()'>Talk to Soldiers</button><br>");
		$(actions).append("<button onclick='care_horse()'>Attend to Horse</button><br>");
		$(actions).append("<button onclick='setup_camp()'>Set Up Camp</button>");
		$(artwork).empty();
	}
	
	function captain(){
		reset_display();
		$(display_persist).html('I walk over to where Captain Jin is grooming his gray stallion.<br><br>');
		$(actions).html("<div id='ask_captain1'><button onclick='ask_captain(1)'>Ask about Capitol City</button></div>");
		$(actions).append("<div id='ask_captain2'><button onclick='ask_captain(2)'>Ask about Meng's Ranch</button></div>");
		$(actions).append("<div id='ask_captain3'><button onclick='ask_captain(3)'>Ask about Imp</button></div>");
		if(waterfall) {
			$(actions).append("<div id='ask_captain4'><button onclick='ask_captain(4)'>Tell me about yourself.</button></div>");
		}
		$(actions).append("<button onclick='campsite2()'>End Conversation</button>");
	}
	
	function ask_captain(text) {
		var previous = $(display).html();
		$(display_last).html(previous);
		if(text == 1){
			$(display).html('What&#39;s the Capitol City like? I ask Captain Jin.<br>Captain Jin merely grunts as he grooms his horse. "No different than any other metropolis in the Four Kingdoms... The City itself is magnificent in its own right certainly, rich in art and culture and buzzing with commercial activity at all hours. But it would be wise not to let the City&#39;s glamour make you forget that the Capitol City is the seat of power of the mighty San Kingdom, and therefore it&#39;s true function will always be political. Beneath the City&#39;s urbane facade is a dark labyrinth of secrets and hidden agenda. People go to the Capitol City to see their dreams compete with those of other dreamers, under the ideal that the strongest dream will be the one that flourishes in the market... But what they don&#39;t realize is that everyone&#39;s dreams are manipulated and controlled by the influence of the Triangle..."<br><br>');
			$("#ask_captain1").html("<button onclick='ask_captain1_c1()>The Triangle?<button>");
		} else if (text == 2) {
			var previous = $(display).html();
			$(display_last).html(previous);
			$(display).html('Have you heard of Meng&#39;s Ranch? I ask Captain Jin.<br>"Of course," Captain Jin says, in a mildly suprised tone. "Meng&#39;s Ranch is famous."<br><br>');
			$("#ask_captain2").html("<button onclick='ask_captain2_c1()>Have you met Great-Uncle Meng?<button>");
		} else if (text == 3) {
			var previous = $(display).html();
			$(display_last).html(previous);
			$(display).html('Tell me about your encounter with Imp, I say.<br>Captain Jin takes a break from grooming his horse. "The General sent us on a mission to tail a known member of the Azure Dragon Sect. We followed the agent to a remote village, but by the time we got there, the villagers confirmed that there was a person matching the agent&#39;s description who arrived a few days ago, but since then she had been magically whisked away by a terrifying demon. We didn&#39;t believe the villagers at first but then a farmer arrived from a neighboring village claiming that his village had just been attacked by the same creature. From then on, we started chasing after the creature, but we were always one step behind, until this morning... I take it as my personal failure that the Imp was able to capture Private Zhu. I must do everything I can to make it right or Lieutenant Ma will never forgive me," Captain Jin says, clenching a fist.<br><br>');
			$("#ask_captain3").html("<button onclick='ask_captain3_c1()>Azure Dragon Sect?<button>");
		} else if (text == 4) {
			var previous = $(display).html();
			$(display_last).html(previous);
			$(display).html('Your surname Jin... I have heard of it before, I say.<br>Captain Jin seems unsurprised. "You have heard of Bandit Chief Jin, perhaps?" he says as he continues to groom his horse, "He was my great-grandfather...the first patriarch of the Jin clan (he had a different surname at birth, but he changed it later) and a villain who hid his stolen treasure all over the Four Kingdoms. In his lifetime, he had many sons all of whom grew up penniless. My grandfather was ridiculed his whole for being one of the sons of Bandit Chief Jin, and my father worked hard to become a magistrate because of how much he despised my grandfather&#39;s legacy and the disgrace that his own father suffered as a result of it. I may share the Jin bloodline, but I refuse to carry the shame of my great-grandfather&#39;s misdeeds around like an anvil&mdash;my reputation as a Jin will be forged by <i>my</i> choices," Captain Jin says with a fierce look.<br><br>');
			$("#ask_captain4").remove();
		}
	}
	
	function ask_captain1_c1() {
		var previous = $(display).html();
		$(display_last).html(previous);
		$(display).html('What is the Triangle? I ask Captain Jin.<br>Captain Jin turns and looks at me briefly before returning his attention to his horse. "Most people think the Capitol City, and by extension the rest of the kingdom, is solely ruled by the Emperor, may he live ten thousand years...but the truth, blasphemous as it may be, is that the Emperor only rules over the nobility and commoners. Within the kingdom there are many other people who do not fall neatly into one of these categories, such as holy monks or the outlaws of the <i>jianghu</i>... Even within the Capitol City itself, there are those who answer to an authority that is not Imperial. The Emperor is only of one of the three point of the Triangle. The other two are the Azure Dragon Sect, which hold dominion over its vast network of agents and spies, and the Beggar King, who in his own way governs over the City&#39;s vagrants, pickpockets, and any other rogues deemed by the Imperial Guards as non law-abiding citizens. Anyways, none of this is important right now so I&#39;m not going to waste my breath going into details... If you spend enough time in the Capitol City, you will come into contact with all three point of the Triangle sooner or later," Captain Jin says, matter of factly.<br><br>');
		$("#ask_captain1").remove();
	}
	
	function ask_captain2_c1() {
		var previous = $(display).html();
		$(display_last).html(previous);
		$(display).html('The ranch is owned by my great-uncle, I tell Captain Jin.<br>One of Captain Jin&#39;s eyebrows lift. "Indeed?" Captain Jin says. He becomes thoughtful. "I have only met <i>Lao</i> Meng once, decades ago as a child visiting the Imperial Palace with my father. He was entertaining a royal audience made up of the Dowager Queen and a few of the Princesses by showing off a peacock that he had trained to do tricks. After the performance, my father approached him and they had a brief conversation, mostly about horses. Even though the conversation was short, I remember how impressed my father was by his deep knowledge. Not too long after, we heard the shocking news that the Emperor had decreed his banishment. In all these years, I still haven&#39;t met someone who knows as much about horses as your great-uncle. I heard one of the horses from his ranch took first again the Diamond Race last year," Captain Jin says. "Once we have made our report to the General, perhaps I will bring Mercury to the Ranch," Captain Jin says, patting his gray horse, "He&#39;s getting up in age now so I need to monitor his health closely. From what I hear from the other soldiers, your great-uncle is better at diagnosing ailments than even the most learned horse physicians of the Imperial Army."<br><br>');
		$("#ask_captain2").remove();
	}
	
	function ask_captain3_c1() {
		var previous = $(display).html();
		$(display_last).html(previous);
		$(display).html('What is the Azure Dragon Sect? I ask Captain Jin.<br>"It is a secret society that operates in the shadows of the Capitol City," Captain Jin says grimly. "its members are divided into seven groups or Houses that are said to make up the mythical dragon: Horn, Neck, Claw, Scale, Heart, Tail, and Beard. Each House specializes in a different form of martial arts...and a different set of unsavory skills for carrying out the Sect&#39;s intrigues. The mythical Azure Dragon is a symbol of strength, prosperity, and protection, which is why the Sect leaders chose the Sect after It, claiming that the Sect&#39;s actions provide the same for the people, but the fact of the matter is&mdash;the Azure Dragon Sect is a corrupt and power-hungry organization that seeks as its only purpose, the overthrow of the Emperor! Members of the Azure Dragon Sect attempt to carry out that odious goal by plotting violence and civil unrest, but when their schemes backfire, the result is always that the common folks end up getting hurt," Captain Jin says in disgust.<br><br>');
		$("#ask_captain2").remove();
	}
	
	var fired = 0;
	var left = 0;
	var top = 0;
	
	function lieutenant() {
		reset_display();
		$(display_persist).html('I walk over to a distant field where Lieutenant Ma has pinned a wooden target to a tree and is practicing her archery.<br><br>');
		$(display).html('Lieutenant Ma draws her shortbow back... "Little brother Zhu," I hear her whisper as the wind carries her words to me, "I am sorry I wasn&#39;t able to protect you from that creature today...but I promise, when next I see that creature again..." Lietunant Ma releases the bowstring. The steel-tipped arrow soars through the air and thuds dead-center in the wooden target!<br><br>Lieutenant Ma sees me watching her. "Care for some target practice?" she asks.<br><br>');
		$(actions).html("<button onclick='archery()'>Practice Archery</button><br>");
		$(actions).append("<div id='ask_lieutenant1'><button onclick='ask_lieutenant(1)'>Tell me about your brother.</button></div>");
		$(actions).append("<div id='ask_lieutenant2'><button onclick='ask_lieutenant(2)'>Tell me about the Captain.</button></div>");
		$(actions).append("<button onclick='campsite2()'>End Conversation</button>");
	}
	
	function ask_lieutenant(text) {
		var previous = $(display).html();
		$(display_last).html(previous);
		if(text == 1){
			$(display).html('I&#39;m sorry about your brother, I say.<br>Lieutenant Ma gives me a grateful nod. "He&#39;s five years younger than me so I have always been protective of him. We grew up as orphans in the Capitol City... I&#39;m better with a bow, but he&#39;s a fearsome fighter with his Crescent Moon Spade. The Imp knew it wouldn&#39;t have stood a chance against my brother so it magicked him away first... I should have shot the Imp. Why wasn&#39;t I quicker on the draw!"<br>It&#39;s okay, I say. I&#39;ll find the Imp and help bring your brother back.<br>"Thank you," Lieutenant Ma says. "I won&#39;t rest until my brother is by my side again." The moonlight reflects the determination in her eyes.<br><br>');
			$("#ask_lieutenant1").remove();
		} else {
			$(display).html('How do you like working for Captain Jin? I ask.<br>"Serving under the Captain has allowed my brother and I to escape a life of poverty, and the Captain has personally saved my life in battle more than once. I owe him everything. I do not know a better man," Lieutenant Ma says in a passionate voice.<br><br>');
			$("#ask_lieutenant2").remove();
		}
	}
	
	function archery() {
		reset_display();
		$(display_persist).html("Lieutenant Ma lends me her Shortbow and retrieves 5 Steel Arrows from the target.<br><br>");
		addToInventory("steelarrows_item","Steel Arrows (5x)");
		unequip(0);
		$("#e_hand").html("Shortbow");
		arrows = 5;
		wind_direction = "left";
		wind_speed = "breeze";
		$(actions).html("<div id='target' class='circle1'><div class='circle2'><div class='circle3'></div></div></div>");
		$(actions).append("<div id='wind'>There is a breeze blowing from my left.</div><br>");
		$(actions).append("Aim Shortbow <input id='aim_bow' type='range' min='0' max='204' value='102'></input><br>");
		$(actions).append("<div id='draw_power'>Draw Power: 0%</div><br><div id='draw_bow'><button onclick='draw_bow()'>Draw Shortbow</button></div>");
		$(actions).append("<button onclick='campsite2()'>Leave</button>");
		setTimeout(function () {wind_change();}, 1000);
	}
	
	function wind_change() {
		var w = Math.random();
		if (w > .5) {
			if(wind_speed == "breeze") {
				wind_speed = "gust";
				$("#wind").html("The wind picks up... There is a "+wind_speed+" blowing from my "+wind_direction+".");
			} else {
				wind_speed = "breeze";
				$("#wind").html("The wind dies down... There is a "+wind_speed+" blowing from my "+wind_direction+".");
			}
		} else {
			if(wind_direction == "right") {
				wind_direction = "left";
			} else {
				wind_direction = "right";
			}
			$("#wind").html("The wind changes direction... There is a "+wind_speed+" blowing from my "+wind_direction+".");
		} 
		setTimeout(function () {wind_change();}, 10000*w);
	}
	
	function draw_bow() {
		dpow = 0;
		if (dpow<110) {
			setTimeout(function () {decrement_timer_archery();}, 25);
		} 
		$("#draw_bow").html("<button onclick='fire_bow()'>Fire Shortbow</button>");
	}
	
	function fire_bow(){
		var aim = parseInt($("#aim_bow").val());
		if(wind_direction == "left"){
			if(wind_speed == "breeze"){
				aim += 25;
			} else {
				aim += 50;
			}
		} else {
			if(wind_speed == "breeze"){
				aim -= 25;
			} else {
				aim -= 50;
			}
		}
		target(aim,229-(dpow*1.5));
	}
	
	function decrement_timer_archery() {
		if (fired) {
			fired = 0;
			return;
		}
		if (dpow<110) {
			dpow += 1;
			$("#draw_power").html('Draw Power: '+dpow+'%');
			setTimeout(function () {decrement_timer_archery();}, 25);
		} else {
			var previous = $(display).html();
			$(display_last).html(previous);
			$(display).html('I let loose, unable to keep the bow drawn any longer. The arrow flies wildly, completely missing the target...</strong> "Watch it!" Lietunenant Ma says sharply.<br><br>');
			arrows -= 1;
			if(arrows) {
				inventory_map.set("steelarrows_item","Steel Arrows ("+arrows+"x)");
				$(".steelarrows_item").html("Steel Arrows ("+arrows+"x)");
				$("#draw_bow").html("<button onclick='draw_bow()'>Draw Shortbow</button>");
			} else {
				inventory_map.delete("steelarrows_item");
				$(".steelarrows_item").remove();
				$("e_hand").html('');
				$("#draw_bow").html("<button onclick='archery()'>Keep Practicing</button>");
			}
		}
	}
	
	function leave_archery() {
		$("#e_hand").html('');
		inventory_map.delete("steelarrows_item");
		$(".steelarrows_item").remove();
		campsite2();
	}
	
	function target(x,y) {
		var previous = $(display).html();
		$(display_last).html(previous);
		$(display).html('I fire the bow. The arrow arcs toward the target...');
		if(Math.pow((x-98),2)+Math.pow((y-93),2) <= 8649) {
			$("#target").append("<div style='position:absolute;left:"+x+"px;top:"+y+"px;'>x</div>");
			$(display).append('<strong>and hits!</strong> ');
			if(Math.pow((x-98),2)+Math.pow((y-93),2) <= 729) {
				$(display).append('"Impressive shot!" Lieutenant Ma says.');
			} else if (Math.pow((x-98),2)+Math.pow((y-93),2) <= 3844) {
				$(display).append('"Good form," Lieutenant Ma says.');
			} else {
				$(display).append('"Not bad," Lieutenant Ma says.');
			}
		} else {
			var v = Math.random();
			if(v > .5) {
				$(display).append('and misses... "Hmm," Lieutenant Ma says. "Try lowering your elbow."');
			} else {
				$(display).append('and misses... "Hmm," Lieutenant Ma says. "Try relaxing your shoulder."');
			}
		}
		$(display).append('<br><br>');
		fired = 1;
		arrows -= 1;
		if(arrows) {
			inventory_map.set("steelarrows_item","Steel Arrows ("+arrows+"x)");
			$(".steelarrows_item").html("Steel Arrows ("+arrows+"x)");
			$("#draw_bow").html("<button onclick='draw_bow()'>Draw Shortbow</button>");
		} else {
			inventory_map.delete("steelarrows_item");
			$(".steelarrows_item").remove();
			$("e_hand").html('');
			$("#draw_bow").html("<button onclick='archery()'>Keep Practicing</button>");
		}
	}
	
	var wager_amount = 0;
	
	function corporal() {
		reset_display();
		$(actions).html("");
		if(shi_playing || jun_playing) {
			$(display_persist).html('I walk over to a spot where the two soldiers are crouched on the ground, playing a game that involves throwing wooden tiles.<br><br>');
			$(display_persist).append('Both soldiers rise and salute me as I approach. "I am Corporal Shi," says the older of two soldiers, "And that&#39;s Cadet Jun. Care to join us in a friendly game of chance?"<br><br>');
			$(actions).append("<div id='wager'><button onclick='wager()'>What is this game?</button></div>");
			$(actions).append("<button onclick='gamble()'>Sure, I&#39;m in.</button><br>");
		} else if (money == 0){
			$(display).html('I walk over to a spot where Corporal Shi and Cadet Jun are lounging on the ground. A stack of coins lies next to them.<br><br>');
		} else {
			$(display).html('I walk over to a spot where Corporal Shi and Cadet Jun are lounging on the ground, commiserating over their lack of wealth.<br><br>');
		}
		$(actions).append("<div id='ask_soldiers'><button onclick='ask_soldiers()'>Tell me about Captain Jin.</button></div>");
		$(actions).append("<button onclick='campsite2()'>Leave</button>");
	}
	
	function ask_soldiers() {
		var previous = $(display).html();
		$(display_last).html(previous);
		$(display).html('How do you like working for Captain Jin, I ask.<br>"He&#39;s decent enough as a superior," Corporal Shi says, "But the life of a soldier demands too much... I&#39;m just doing this job until I earn enough wages to marry my sweetheart Mi-mi. She works an apprentice to a baker in the Capitol City and makes the most heavenly <i>nian gao</i>!"<br><br>Cadet Jun adds, "Captain Jin is very intimidating! But that&#39;s why I chose to follow him. I want to learn to become more fearsome!"<br><br>');
		$("#ask_soldiers").remove();
	}
	
	function wager() {
		var previous = $(display).html();
		$(display_last).html(previous);
		$(display).html('How do you play? I ask the soldiers.<br>"Oh it&#39;s very simple," Cadet Jun says in an eager voice, offering me five wooden tiles. "Each tile has a  black-colored side and a white-colored side. We first wager and then throw at the same time. Whoever has more black-color tiles showing than the other players wins the match! If there is a tie for first, then everyone throws again."<br><br>');
		$("#wager").remove();
	}
	
	function gamble() {
		var previous = $(display).html();
		$(display_last).html(previous);
		$(display).html("<div id='my_money'>My money: "+money+"g.</div><div id='shi_money'>Corporal Shi&#39;s money: "+shi_amount+"g.</div><div id='jun_money'>Cadet Jun&#39;s money: "+jun_amount+"g.</div><br>");
		$(display).append("<div id='wager'>Wager: "+wager_amount+"g <button id='plus_w' onclick='plus_w()'>Increase</button><button id='minus_w' onclick='minus_w()'>Decrease</button></div><br><div id='wager_results'></div>");
		$("#minus_w").attr('disabled','disabled');
		$(actions).html("<button id='throw_tiles' onclick='throw_tiles()'>Throw Tiles</button><br>");
		$("#throw_tiles").attr('disabled','disabled');
		$(actions).append("<button onclick='campsite2()'>Leave</button>");
	}
	
	function plus_w() {
		var max;
		if(shi_playing && jun_playing) {
			max = Math.min(money, shi_amount, jun_amount);
		} else if(shi_playing) {
			max = Math.min(money, shi_amount);
		} else if (jun_playing) {
			max = Math.min(money, jun_amount);
		}
		if(wager_amount < max) {
			wager_amount += 1;
			$("#wager").html("Wager: "+wager_amount+"g <button id='plus_w' onclick='plus_w()'>Increase</button><button id='minus_w' onclick='minus_w()'>Decrease</button>");
			$("#throw_tiles").removeAttr('disabled');
		}
		if(wager_amount >= max) {
			$("#plus_w").attr('disabled','disabled');
		}
		$("#minus_w").removeAttr('disabled');
	}
	
	function minus_w() {
		if(wager_amount > 0) {
			wager_amount -= 1;
			$("#wager").html("Wager: "+wager_amount+"g <button id='plus_w' onclick='plus_w()'>Increase</button><button id='minus_w' onclick='minus_w()'>Decrease</button>");
		}
		if(wager_amount <= 0) {
			$("#minus_w").attr('disabled','disabled');
			$("#throw_tiles").attr('disabled','disabled');
		}
		$("#plus_w").removeAttr('disabled');
	}
	
	function throw_tiles() {
		var my_blocks = '';
		var my_count = 0;
		var shi_blocks = '';
		var shi_count;
		if(shi_playing) {
			shi_count = 0;
		} else {
			shi_count = -1;
		}
		var jun_blocks = '';
		var jun_count;
		if(jun_playing) {
			jun_count = 0;
		} else {
			jun_count = -1;
		}
		for (var i = 0; i<5; i++) {
			if(shi_playing) {
				var s = Math.random();
				if(s < 0.5){
					shi_blocks += '&#9670;';
					shi_count += 1;
				} else {
					shi_blocks += '&#9671;';
				}
			}
			if(jun_playing) {
				var j = Math.random();
				if(j < 0.5){
					jun_blocks += '&#9670;';
					jun_count += 1;
				} else {
					jun_blocks += '&#9671;';
				}
			}
			var m = Math.random();
			if(m < 0.5){
				my_blocks += '&#9670;';
				my_count += 1;
			} else {
				my_blocks += '&#9671;';
			}
		}
		if(shi_playing && jun_playing) {
			$("#wager_results").html('I throw the tiles at the same time as Corporal Shi and Cadet Jun.<br><br>My tiles: '+my_blocks+'<br>')
			$("#wager_results").append('Corporal Shi&#39;s tiles: '+shi_blocks+'<br>');
			$("#wager_results").append('Cadet Jun&#39;s tiles: '+jun_blocks+'<br>');
		} else if(shi_playing){
			$("#wager_results").html('I throw the tiles at the same time as Corporal Shi.<br><br>My tiles: '+my_blocks+'<br>')
			$("#wager_results").append('Corporal Shi&#39;s tiles: '+shi_blocks+'<br>');
		} else if(jun_playing){
			$("#wager_results").html('I throw the tiles at the same time as Cadet Jun.<br><br>My tiles: '+my_blocks+'<br>')
			$("#wager_results").append('Cadet Jun&#39;s tiles: '+jun_blocks+'<br>');
		}
		$("#wager_results").append('<br>');
		console.log(my_count+';'+shi_count+';'+jun_count);
		if(shi_playing && jun_playing) {
			if(my_count > shi_count) {
				if(my_count > jun_count) {
					$("#wager_results").append('<strong>I win the match! Received '+wager_amount*2+'g!</strong><br><br>');
					money += (wager_amount*2);
					shi_amount -= wager_amount; 
					jun_amount -= wager_amount;
				} else if (my_count == jun_count) {
					$("#wager_results").append('<strong>"Tie match!" Corporal Shi shouts, "Throw again!"</strong><br><br>');
				} else {
					$("#wager_results").append('<strong>Cadet Jun wins the match! Lost '+wager_amount+'g!</strong><br><br>');
					money -= wager_amount;
					shi_amount -= wager_amount; 
					jun_amount += wager_amount;
				}
			} else if (my_count == shi_count) {
				if(my_count < jun_count) {
					$("#wager_results").append('<strong>Cadet Jun wins the match! Lost '+wager_amount+'g!</strong><br><br>');
					money -= wager_amount;
					shi_amount -= wager_amount; 
					jun_amount += wager_amount;
				} else {
					$("#wager_results").append('<strong>"Tie match!" Corporal Shi shouts, "Throw again!"</strong><br><br>');
				}
			} else {
				if(shi_count == jun_count) {
					$("#wager_results").append('<strong>"Tie match!" Corporal Shi shouts, "Throw again!"</strong><br><br>');
				} else if (shi_count > jun_count) {
					$("#wager_results").append('<strong>Corporal Shi wins the match! Lost '+wager_amount+'g</strong><br><br>');
					money -= wager_amount;
					shi_amount += wager_amount; 
					jun_amount -= wager_amount;
				} else {
					$("#wager_results").append('<strong>Cadet Jun wins the match! Lost '+wager_amount+'g</strong><br><br>');
					money -= wager_amount;
					shi_amount -= wager_amount; 
					jun_amount += wager_amount;
				}
			}
		} else if (shi_playing) {
			if(my_count > shi_count) {
					$("#wager_results").append('<strong>I win the match! Received '+wager_amount+'g!</strong><br><br>');
					money += (wager_amount*2);
					shi_amount -= wager_amount; 
			} else if (my_count == shi_count) {
				$("#wager_results").append('<strong>"Tie match!" Corporal Shi shouts, "Throw again!"</strong><br><br>');
			} else {
				$("#wager_results").append('<strong>Corporal Shi wins the match! Lost '+wager_amount+'g!</strong><br><br>');
				money -= wager_amount;
				shi_amount += wager_amount; 
			}
		} else if (jun_playing) {
			if(my_count > jun_count) {
					$("#wager_results").append('<strong>I win the match! Received '+wager_amount+'g!</strong><br><br>');
					money += (wager_amount*2);
					jun_amount -= wager_amount; 
			} else if (my_count == jun_count) {
				$("#wager_results").append('<strong>"Tie match!" Cadet Jun shouts, "Throw again!"</strong><br><br>');
			} else {
				$("#wager_results").append('<strong>Cadet Jun wins the match! Lost '+wager_amount+'g!</strong><br><br>');
				money -= wager_amount;
				jun_amount += wager_amount;
			}
		} 
		$("#money").html(money+'g');
		$("#my_money").html("My money: "+money+"g.");
		$("#shi_money").html("Corporal Shi&#39;s money: "+shi_amount+"g.");
		$("#jun_money").html("Cadet Jun&#39;s money: "+jun_amount+"g.");
		wager_amount = 0;
		$("#wager").html("Wager: "+wager_amount+"g <button id='plus_w' onclick='plus_w()'>Increase</button><button id='minus_w' onclick='minus_w()'>Decrease</button>");
		$("#minus_w").attr('disabled','disabled');
		$("#throw_tiles").attr('disabled','disabled');
		if(money <= 0) {
			$("#wager_results").append('<strong>I have lost all my money!</strong><br><br>');
			$(actions).html("<button onclick='campsite2()'>Leave</button>");
		}
		if(jun_amount <= 0 && jun_playing) {
			$("#wager_results").append('"My wages for the month is gone now," Cadet Jun says, "I wish I could keep playing though!" Cadet Jun bows out of the game.<br><br>');
			jun_playing = 0;
			if(!shi_playing){
				$(actions).html("<button onclick='campsite2()'>Leave</button>");
			}
		}
		if(shi_amount <= 5 && shi_playing) {
			$("#wager_results").append('"Enough losing for one night!" Corporal Shi says, "At this rate, I will never save up enough money to marry my sweetheart Mi-mi!" Corporal Shi bows out of the game.<br><br>');
			shi_playing = 0;
			if(!jun_playing){
				$(actions).html("<button onclick='campsite2()'>Leave</button>");
			}
		}
	}
	
	function care_horse() {
		reset_display();
		var h;
		if(companion_status > 5) {
			h = 'The Chestnut Mare whinnies in excitement.';
		} else if (companion_status < 0) {
			h = 'The Chestnut Mare turns away.';
		} else {
			h = 'The Chestnut Mare gazes at me quietly.';
		}
		$(display_persist).html('I walk over to where the Chestnut Mare is tied to a small tree. '+h+'.<br><br>');
		$(actions).html("<div id='pat_horse'><button onclick='pat_horse()'>Pat Horse</button></div>");
		if(inventory_map.get("goji_box f_item") || inventory_map.get("mountainyam_box f_item") || inventory_map.get("ginseng_box f_item") || inventory_map.get("steamedbaos_box f_item") || inventory_map.get("scallioncrepes_box f_item")){
			$(actions).append("<div id='feed_horse'><button onclick='feed_horse()'>Feed Horse</button></div>");
		}
		$(actions).append("<button onclick='campsite2()'>Leave</button>");
	}
	
	function updateCompanionAttribute(){
		if (companion_status > 5) {
			$("#companion_attribute").html("Relationship: Friendly");
		} else if (companion_status >= 0){
			$("#companion_attribute").html("Relationship: Neutral");
		} else if (companion_status < 0){
			$("#companion_attribute").html("Relationship: Distant");
		}
	}
	
	function pat_horse(){
		var previous = $(display).html();
		$(display_last).html(previous);
		$(display).html('I lightly pat the Chestnut Mare. Good girl, I say in a gentle voice. The Chestnut Mare nickers in appreciation.<br><br>');
		companion_status += 1;
		updateCompanionAttribute();
		$("#pat_horse").remove();
	}
	
	function feed_horse() {
		$("#feed_horse").html("");
		if(inventory_map.get("goji_box f_item")) {
			$("#feed_horse").append("<button onclick='feed(1)'>Offer Goji Berry</button><br>");
		}
		if(inventory_map.get("mountainyam_box f_item")) {
			$("#feed_horse").append("<button onclick='feed(2)'>Offer Mountain Yam</button><br>");
		}
		if(inventory_map.get("ginseng_box f_item")){
			$("#feed_horse").append("<button onclick='feed(3)'>Offer Ginseng</button><br>");
		}
		if(inventory_map.get("steamedbaos_box f_item")) {
			$("#feed_horse").append("<div class='badfood'><button onclick='feed(4)'>Offer Steamed Bun</button></div>");
		}
		if(inventory_map.get("scallioncrepes_box f_item")){
			$("#feed_horse").append("<div class='badfood'><button onclick='feed(5)'>Offer Scallion Crepe</button></div>");
		}
	}
	
	function feed(text){
		var previous = $(display).html();
		$(display_last).html(previous);
		var horse_stamina = $("#companion_bar").val();
		if(text == 1) {
			$(display).html('<strong>I feed a Goji Berry to the Chestnut Mare.</strong> The Chestnut Mare licks my fingers eagerly, asking for more food.</strong><br><br>');
			companion_status += 1;
			horse_stamina += .5;
			$("#companion_bar").val(horse_stamina);
			eat_food(1,0);
		} else if (text == 2) {
			$(display).html('<strong>I feed a Mountain Yam to the Chestnut Mare.</strong> The Chestnut Mare munches happily.</strong><br><br>');
			companion_status += 1;
			horse_stamina += 2;
			eat_food(2,0);
		} else if (text == 3) {
			$(display).html('<strong>I feed a Ginseng to the Chestnut Mare.</strong> The Chestnut Mare gives a satisfied neigh.<strong><br><br>');
			companion_status += 1;
			horse_stamina += 5;
			eat_food(3,0);
		} else {
			companion_status -= 1;
			$(display).html('"You shouldn&#39;t feed that to a horse!" Captain Jin shouts at me from a distance. "It&#39s bad for them!" The Chestnut Mare gives a disapproving snort.<br><br>');
			$(".badfood").remove();
		}
		if(horse_stamina < 10) {
			$("#companion_bar").val(horse_stamina);
		} else {
			$("#companion_bar").val(10);
		}
		updateCompanionAttribute();
		feed_horse();
	}
	
	function setup_camp() {
		var previous = $(display).html();
		$(display_last).html(previous);
		$(display).html('The campfire started by the soldiers have died down. I use the Firestick and some of the kindling gathered by the soldiers to start it up again.<br><br>');
		$(actions).html("<button onclick='rest_camp()'>Go to Sleep</button><br>");
		$(actions).append("<button onclick='campsite2()'>Stay Up</button><br>");
	}
	
	function rest_camp() {
		reset_display();
		$(display_persist).html("<strong>Going to sleep will save the game. Should I sleep now?</strong><br><br>");
		$(actions).html("<button onclick='ending()'>Yes.</button><br>");
		$(actions).append("<button onclick='campsite2()'>Not yet.</button>");
	}
	
	function ending() {
		reset_display();
		$(display_persist).html('The bright flames of the campfire glow in my mind&#39;s eye as I drift to sleep...<br><br>My dreams are filled with strange visions&mdash;<br><br>')
		$(display).html('I see a dozen magnificent horses thundering down a collosal racetrack, as a massive audience cheers...<br><br>');
		$(actions).html('<button onclick="ending_c1()">Continue</button>');
	}
	
	function ending_c1() {
		var previous = $(display).html();
		$(display_last).html(previous);
		if(silver_dagger_cursed && robbed) {
			$(display).html('I see a merchant wearing a conical, straw hat, polishing a silver dagger until it gleams as brightly as the merchant&#39;s grin...<br><br>');
		} else {
			$(display).html('I see a merchant wearing a conical, straw hat, turning down a dark alleyway and knocking on the door of a house marked with the insignia of a dragon...<br><br>');
		}
		$(actions).html('<button onclick="ending_c2()">Continue</button>');
	}
	
	function ending_c2() {
		var previous = $(display).html();
		$(display_last).html(previous);
		$(display).html('I see a young couple standing together on an arched bridge above a lily pond, while a peacock struts in the palace gardens behind them...<br><br>');
		$(actions).html('<button onclick="ending_c3()">Continue</button>');
	}
	
	function ending_c3() {
		var previous = $(display).html();
		$(display_last).html(previous);
		$(display).html('I see an invading army marching against against a small garrison manning an outpost on a hill...<br><br>')
		$(actions).html('<button onclick="ending_c4()">Continue</button>');
	}
	
	function ending_c4() {
		var previous = $(display).html();
		$(display_last).html(previous);
		$(display).html('And...I see an old man standing in a horse paddock, watching expectantly...as a fledgling phoenix takes off for the first time into the air. Spreading her wings to catch the draft, she circles higher and higher up into the clear sky&mdash;');
		if(feather_color == "Red") {
			$(display).append('the red feathers of her head sparking like rubies in the soft light of an auspicious, autumn morning... <strong>The game has saved.</strong><br><br><strong>TO BE CONTINUED.</strong><br><br>');
		} else if (feather_color == "Blue") {
			$(display).html('the blue feathers of her wings sparking like sapphires in the soft light of an auspicious, autumn morning... <strong>The game has saved.</strong><br><br><strong>TO BE CONTINUED.</strong><br><br>');
		} else if (feather_color == "Yellow") {
			$(display).html('the yellow feathers of her neck sparking like gold in the soft light of an auspicious, autumn morning... <strong>The game has saved.</strong><br><br><strong>TO BE CONTINUED.</strong><br><br>');
		} else if (feather_color == "White") {
			$(display).html('the white feathers of her belly sparking like diamonds in the soft light of an auspicious, autumn morning... <strong>The game has saved.</strong><br><br><strong>TO BE CONTINUED.</strong><br><br>');
		} else if (feather_color == "Black") {
			$(display).html('the black feathers of her tail sparking like obsidian in the soft light of an auspicious, autumn morning... <strong>The game has saved.</strong><br><br><strong>TO BE CONTINUED.</strong><br><br>');
		}
		$(actions).html('<button onclick="location.reload()">Main Menu</button>');
		game_finished = 2;
		save_game();
		$(settings).append('<br><button onclick="support()">Support</button><br><div id="contact"><button onclick="contact()">Contact</button></div>');
	}

	function contact() {
		$("#contact").html("&#099;&#111;&#110;&#116;&#097;&#099;&#116;&#064;&#116;&#104;&#101;&#116;&#114;&#097;&#118;&#101;&#108;&#101;&#114;&#115;&#098;&#097;&#108;&#108;&#097;&#100;&#046;&#099;&#111;&#109;");
	}
	
	function support() {
		window.open("https://buy.stripe.com/test_14k4hq35HeyFbCw9AA");
	}
	
	function tax_collector(text) {
		var previous = $(display).html();
		$(display_last).html(previous);
		if (text == 1) {
			$(display).html("You're correct, I say.<br>");
		} else {
			$(display).html("It's customary to introduce yourself first, I say.<br>");
		}
		$(display).append('"I am here on the authority of the County Magistrate," the young man says, "As required under the local civil code, all found troves are subject to a fifty percent tax, to be paid directly to an appointed official without any delay." The young man gestures at his headwear. "I am officially here to collect your payment. Keep in mind that there are severe penalties for noncompliance with a civil servant&#39;s directives."<br><br>');
		$(actions).html("<button onclick='tax_collector2(1)'>Pay Tax</button><br>");
		$(actions).append("<div id='refuse_to_pay'><button onclick='tax_collector2(2)'>Refuse</button></div>");
		$(actions).append("<div id = 'penalties'><button onclick='tax_collector2(4)'>What are the penalties?</button></div>");
		if (seen_notice) {
			$(actions).append("<button onclick='tax_collector2(5)'>Have I seen you before?</button>");
		}
	}

	function tax_collector2(text) {
		var previous = $(display).html();
		$(display_last).html(previous);
		if (text == 1) {
			$(display).html('I hand over 100g to the tax collector. <strong>Lost 100g.</strong><br>');
			money -= 100;
			$("#money").html(money+"g");
			$(display).append('The young man&#39;s eyes light up. "Thank you!" he says with a short bow. He turns around and quickly begins to walk away. A breeze catches his oversized headwear, causing it to fall to the ground.<br><br>Sir, you dropped your hat! I call after him. The young man does not turn back and is soon gone from view...<br>I pick up his headwear.  <strong>Obtained Civil Official Hat!</strong><br><br>');
			addToInventory("civilhat_item e_item","Civil Official Hat <button id='civilhat_button' onclick='equip(1)'>Equip</button>");
			official_cap = 1;
			$(actions).html("<button onclick='hamlet()'>Continue</button>");
		} else if (text == 2) {
			$(display).html('I&#39;m not paying, I say.<br>');
			$(display).append('"You&#39;re making a big mistake," the young man warns. "The County Magistrate is not a forgiving man. He is truly fearsome when it comes to enforcing the law!"<br><br>');
			$("#refuse_to_pay").html("<button onclick='tax_collector2(3)'>I'll take my chances.</button>");
		} else if (text == 3) {
			$(display).html('I&#39;m willing to take my chances, I say.<br>');
			$(display).append('"That is unfortunate," the young man says, "I was hoping you would be reasonable. Now I must teach you a lesson." He rolls up his sleeves and lunges at me!<br><br>');
			$(actions).html("<button onclick='shove()'>Shove Him</button><br>");
			$(actions).append("<button onclick='step_aside()'>Step Aside</button><br>");
			$(display).append("<div id='timebar'></div>");
			time_left = 8;
			if (time_left>0) {
				setTimeout(function () {decrement_timer1();}, 100);
			} 
		} else if (text == 4) {
			$(display).html('What are the penalties, I ask.<br>');
			$(display).append('"50 lashes, followed by imprisonment for up to 2 years, a fine of an additional 10% as penalty tax, and a permanent, criminal record for tax evasion," the tax collector says.<br><br>');
			$("#penalties").remove();
		} else {
			$(display).html('Your profile looks familiar, I say. I feel like I have seen a picture of you somewhere...<br>');
			$(display).append('"N-no way," the young man stammers. "You must be mistaken. I am merely one of many civil servants employed by the County Magistrate. I rarely venture outside of his court. Anyways, I am very busy and have many other delinquents to collect from today, so I will come back for your payment another time." The young man turns around and walks away so quickly that his oversized headwear falls to the ground without him noticing.<br><br>Sir, you dropped your hat! I call after him. The young man does not turn back and is soon gone from view.<br>I pick up his headwear. <strong>Obtained Civil Official Hat!</strong><br><br>');
			addToInventory("civilhat_item e_item","Civil Official Hat <button id='civilhat_button' onclick='equip(1)'>Equip</button>");
			official_cap = 1;
			$(actions).html("<button onclick='hamlet()'>Continue</button>");
		}
	}

	function shove() {
		var previous = $(display).html();
		$(display_last).html(previous);
		peace = -1;
		$(display).html('I give the young man a hard shove. He crumples to the floor.<br>');
		$(display).append('There is a bruise on the young man&#39;s left cheek and his eyes are teary as he gets up. "You&mdash;you&#39;ll regret this!" he says. "My uncle is a wealthy businessman. He&#39;ll make you pay!" The young man runs away, leaving his oversized headwear behind on the ground.<br>I pick up his headwear. <strong>Obtained Civil Official Hat!</strong><br><br>');
		addToInventory("civilhat_item e_item","Civil Official Hat <button onclick='equip(1)'>Equip</button>");
		official_cap = 1;
		met_nephew = 1;
		$(actions).html("<button onclick='hamlet()'>Continue</button>");
	}

	function step_aside() {
		var previous = $(display).html();
		$(display_last).html(previous);
		peace = 1;
		$(display).html('I quickly step aside, causing the young man to lose his balance. He falls to the floor.<br>');
		$(display).append('The young man dusts off himself as he gets up. "You-you&#39;ll regret this!" he says indignantly. "My uncle is a wealthy businessman. He&#39;ll make you pay!" The young man turns and quickly walks away, leaving his oversized headwear behind on the ground.<br>I pick up his headwear. <strong>Obtained Civil Official Hat!</strong><br><br>');
		addToInventory("civilhat_item e_item","Civil Official Hat <button  id='civilhat_button' onclick='equip(1)'>Equip</button>");
		official_cap = 1;
		met_nephew = 1;
		$(actions).html("<button onclick='hamlet()'>Continue</button>");
	}

	function decrement_timer1() {
		if (peace != 0) {
			return;
		}
		if (time_left > 0) {
			time_left -= .1;
			$("#timebar").html('Time left to make choice: <progress value="'+time_left+'" max="8"></progress><br><br>');
			setTimeout(function () {decrement_timer1();}, 100);
		} else {
			var previous = $(display).html();
			$(display_last).html(previous);
			$(display).html('I am too surprised to act. The young man reaches into my pocket and snatches a fistful of coins before running away. <strong>Lost 50g.</strong><br><br>');
			money -= 100;
			$("#money").html(money+"g");
			$(actions).html("<button onclick='hamlet()'>Continue</button>");
		}
	}

	//tailorshop

	function tailorshop() {
		var collapse = updateStamina(-1.5);
		if(collapse){
			return;
		}
		updateTime(.25);
		updateLocation("Tailor Shop");
		reset_display();
		if(time_of_day != 2) {
			if(game_finished) {
				$(display_persist).html("Mr. Chang greets me warmly when I enter Chang's Tailor and Fine Attire Shop.<br>");
				$(display_persist).append('"What an honor to have the <i>yingxiong</i> in my shop! Is your Aunt Lin doing well? Please ask her to come visit me soon... Can I interest you in an article from my collection?"<br><br>');
			} else {
				$(display_persist).html("Upon entering Chang's Tailor and Fine Attire Shop, I am greeted by a well-dressed man with stern features.<br>");
				$(display_persist).append('"Welcome to my humble shop! I am Chang, sartorial supplier of the finest attire west of the Capitol City. Can I interest you in an article from my latest collection?"<br><br>');
			}
			$(actions).html("<div id='wardrobe'><button onclick='wardrobe()'>Show me what you have.</button></div>");
			if(!game_finished) {
				$(actions).append("<button onclick='chang()'>Tell me about Aunt Lin.</button><br>");
			}
			$(actions).append("<button onclick='hamlet()'>Go Back Outside</button>");
			$(artwork).html(chang_art);
		} else {
			$(display_persist).html("A sign outside reads: Chang's Tailor and Fine Attire Shop is closed right now. Come back during the day!<br><br>");
			$(actions).html("<button onclick='hamlet()'>Go Back</button>");
		}
	}

	function wardrobe() {
		var collapse = updateStamina(-1.5);
		if(collapse){
			return;
		}
		updateTime(.25);
		var previous = $(display).html();
		$(display_last).html(previous);
		if (items.length == 0) {
			$(display).html("What are you selling?<br>");
			$(display).append('"I am all out of stock right now," Mr. Chang says, "But rest assured, a new shipment of the finest wears is due to arrive from the Capital City any day now. Come back again soon!"<br><br>');
			$("#wardrobe").remove();
		} else {
			wardrobe_index += 1;
			wardrobe_index %= items.length;
			$(display).html("What are you selling?<br>");
			$(display).append(items[wardrobe_index]+' Only '+costs[wardrobe_index]+'g."<br><br>');
			$("#wardrobe").html("");
			if (money >= costs[wardrobe_index]) {
				$("#wardrobe").append("<button onclick='buy_attire(costs[wardrobe_index])'>I'll take it.</button><br>");
			}
			$("#wardrobe").append("<div id='haggle'><button onclick='haggle()'>Haggle</button></div>");
			$("#wardrobe").append("<button onclick='wardrobe()'>Show me something else.</button><br>");
			$("#wardrobe").append("<button onclick='decline()'>I'm not interested.</button><br>");
		}
	}
	
	function haggle() {
		$("#haggle").html("<input type='text' id='my_haggle' placeholder='"+money+"g'></input> <button onclick='haggle2()'>Make Offer</button>");
	}

	function haggle2() {
		updateTime(.25);
		var previous = $(display).html();
		$(display_last).html(previous);
		var bargain_input = parseInt($("#my_haggle").val(),10) || 0;
		bargain_input = Math.min(bargain_input, costs[wardrobe_index]);
		var bargain = Math.floor(bargain_input);
		var divider = 1.2+wardrobe_index*.4;
		var lowestPrice = Math.floor(costs[wardrobe_index] / divider);
		$(display).html('How about '+bargain+'g?<br>');
		if (bargain <=0 ) {
			$(display).append('"I assume you&#39;re not being serious..." Mr. Chang says.<br><br>');
		} else if (bargain > money) {
			$(display).append('Mr. Chang eyes me suspiciously. "Do you have that much?"<br><br>');
		} else if (bargain >= costs[wardrobe_index]) {
			$(display).append('"You have a deal!" Mr. Chang says, shaking my hand.<br><br>');
			buy_attire(bargain);
		} else if (bargain >= lowestPrice) {
			$(display).append('"It&#39;s worth more, of course," Mr. Chang says, "But all right, you have a deal."<br><br>');
			buy_attire(bargain);
		} else {
			$(display).append('Mr. Chang shakes his head. "I&#39;m afraid that&#39;s not enough," he says.<br><br>');
			$("#wardrobe").html("<input type='text' id='my_haggle' placeholder='"+money+"g'></input> <button onclick='haggle2()'>Make Offer</button><br>");
			$("#wardrobe").append("<button onclick='wardrobe()'>Show me something else.</button><br>");
			$("#wardrobe").append("<button onclick='decline()'>I'm not interested.</button><br>");
		}
	}

	function decline() {
		var previous = $(display).html();
		$(display_last).html(previous);
		$(display).html("I'm not interested in purchasing anything at the moment, I say.<br>");
		$(display).append('Mr. Chang looks disappointed. "Let me know if you change your mind."<br><br>');
		$("#wardrobe").html("");
	}

	function buy_attire(text) {
		var previous = $(display).html();
		$(display_last).html(previous);
		var c = items_cap[wardrobe_index];
		$(display).html('<strong>Purchased '+c+' for '+text+'g!</strong><br><br>');
		if (c == "Silk Fan") {
			addToInventory("silkfan_item e_item","Silk Fan <button id='silkfan_button' onclick='equip(8)'>Equip</button>");
		} else if (c == "Silk Sash"){
			addToInventory("silksash_item e_item","Silk Sash <button id='silksash_button' onclick='equip(3)'>Equip</button>");
		} else {
			addToInventory("silkrobe_item e_item","Silk Robe <button id='silkrobe_button' onclick='equip(4)'>Equip</button>");
		}
		items.splice(wardrobe_index, 1);
		items_cap.splice(wardrobe_index, 1);
		costs.splice(wardrobe_index, 1);
		if(items.length == 0) {
			well_dressed = 1;
		}
		money -= text;
		$("#money").html(money+"g");
		$("#wardrobe").html("<button onclick='wardrobe()'>Show me something else.</button><br>");
	}

	function chang() {
		var collapse = updateStamina(-1.5);
		if(collapse){
			return;
		}
		updateTime(.5);
		var previous = $(display).html();
		$(display_last).html(previous);
		$(display).html('What can you tell me about Aunt Lin?<br>');
		$(display).append("Mr. Chang's face brightens. ");
		$(display).append('"Lin Mei-hua? A most wonderful lady," he says, "And one of my favorite customers. She often visits my shop. Recently, she bought a lovely qipao. It fit her so well that I gave her a great bargain."<br><br>');
		$(actions).html("<button onclick='chang_c1()'>Continue</button>");
	}
	
	function chang_c1() {
		var collapse = updateStamina(-1.5);
		if(collapse){
			return;
		}
		updateTime(.5);
		var previous = $(display).html();
		$(display_last).html(previous);
		$(display).html('"While I haven&#39;t seen her since she last visited my shop, I have heard some of the rumors floating around &mdash; claiming that she has embarked on some kind of treasure hunt. To be honest with you, I am worried for her though I have no right to be... I know Mei-Hua is an intelligent and level-headed woman who is fully capable of taking care of herself. It would probably only amuse her if she heard that old Chang Ge-fei was fretting over her. But still..."<br><br>');
		$(actions).html("<button onclick='chang_c2()'>Continue</button>");
	}
	
	function chang_c2() {
		var collapse = updateStamina(-1.5);
		if(collapse){
			return;
		}
		updateTime(.5);
		var previous = $(display).html();
		$(display_last).html(previous);
		$(display).html('Mr. Chang gives a wistful sigh. "A long time ago, she told me that she wanted to see the Capital City one day. Perhaps that is where she went... If so, I only wish she had come to my shop before she left. I would have given her the best travel outfits I have. And there are also certain things that I would have liked to tell her..."<br><br>');
		$(actions).html("<div id='wardrobe'><button onclick='wardrobe()'>Show me what you have.</button></div>");
		$(actions).append("<button onclick='hamlet()'>Go Back Outside</button>");
		curiosity[1] = 1;
	}

	//blacksmith

	function blacksmith() {
		var collapse = updateStamina(-1.5);
		if(collapse){
			return;
		}
		updateTime(.25);
		updateLocation("Blacksmith");
		reset_display();
		if(anli_friendship && anli_respect && !anli_date) {
			anli_date = 1;
			$(display_persist).html("An-li looks up with a smile when I enter the smithy.<br>");
			$(display_persist).append('"Come with me," he says. "I want to show you something."<br><br>');
			$(actions).html("<button onclick='follow_anli()'>Follow An-li</button><br>")
			$(actions).append("<button onclick='hamlet()'>Go Back Outside</button>");
		} else {
			if (time_of_day == 0) {
				if(game_finished) {
					$(display_persist).html('An-li bows when I enter the smithy. "Welcome," he says in his gentle voice, "How can I help you?"<br><br>');
					$(actions).append("<div id='armory'><button onclick=armory()>Show me what you're selling.</button></div>");
					$(actions).html("<div id='anli_dream'><button onclick=anli_dream()>How are you doing?</button></div>");
				} else {
					$(display_persist).html("The smithy is dimly lit by the glow of the forge. A well-built, unassuming young man wearing a black smock greets me.<br>");
					$(display_persist).append('"Hello, my name is An-li," he says, in a gentle voice. "How can I help you?"<br><br>');
					$(actions).html("<div id='armory'><button onclick=armory()>Show me what you're selling.</button></div>");
				}
				if(inventory_map.get("coal_item") || kindling || iron) {
					$(actions).append("<button onclick=sell_raw_materials()>Sell Raw Materials</button>");
				}
				$(actions).append("<div id='upgrade_gear'></div>");
				if (upgrade_day) {
					$("#upgrade_gear").html("<button onclick=receive_equipment()>Retrieve Upgraded Equipment</button>");
				} else if(iron && (inventory_map.get("bronzesword_item e_item") || inventory_map.get("leathertunic_item e_item") || inventory_map.get("bronzepickaxe_item t_item") || inventory_map.get("bronzeaxe_item t_item"))) {
					$("#upgrade_gear").html("<button onclick=upgrade_equipment()>Upgrade Equipment</button>");
				}
				if(!game_finished) {
					$(actions).append("<div id='anli'><button onclick='anli()'>Tell me about Aunt Lin.</button></div>");
				}
				if(!anli_friendship) {
					$(actions).append("<div id='compliment_anli'><button onclick='compliment_anli()'>Compliment An-li</button></div>");
				}
				if (inventory_map.get("peoniesbouquet_item")) {
					$(actions).append("<div id='gift_anli'><button onclick='gift_anli()'>Give Peonies Bouquet</button></div>");
				}
				if (inventory_map.get("shinyrock_item")) {
					$(actions).append("<div id='give_rock'><button onclick='give_rock()'>Give Shiny Rock</button></div>");
				}
				$(actions).append("<button onclick='hamlet()'>Go Back Outside</button>");
				$(artwork).html(anli_art);
			} else {
				$(display_persist).html("The smithy is only open to customers in the morning.<br><br>");
				$(actions).html("<button onclick='hamlet()'>Go Back</button>");
			}
		}
	}
	
	function sell_raw_materials() {
		var collapse = updateStamina(-1.5);
		if(collapse){
			return;
		}
		updateTime(.25);
		var previous = $(display).html();
		$(display_last).html(previous);
		$(display).html('"What would you like to sell?" An-li asks.<br><br>');
		sell_kindling = 0;
		sell_coal = 0;
		sell_iron = 0;
		total_sale = 0;
		sell_materials();
	}

	function sell_materials() {
		$(actions).html("");
		if(kindling > 0) {
			$(actions).append("<div id='sell_kindling'>Sell Kindling: "+sell_kindling+" <button id='plus_k' onclick='plus_k()'>Increase</button><button id='minus_k' onclick='minus_k()'>Decrease</button></div>");
		}
		if(inventory_map.get("coal_item")) {
			$(actions).append("<div id='sell_coal'>Sell Coal: "+sell_coal+" <button id='plus_l' onclick='plus_l()'>Increase</button><button id='minus_l' onclick='minus_l()'>Decrease</button></div>");
		}
		if(iron > 0) {
			$(actions).append("<div id='sell_iron'>Sell Iron Ores: "+sell_iron+" <button id='plus_i' onclick='plus_i()'>Increase</button><button id='minus_i' onclick='minus_i()'>Decrease</button></div>");
		}
		if(total_sale) {
			$(actions).append("<br><button onclick='sell_all_materials()'>Sell raw materials for: "+total_sale+"g</button><br>");
			$(actions).append("<button onclick='cancel_sell_materials()'>Cancel</button>");
		} else {
			$(actions).append("<br><button onclick='cancel_sell_materials()'>Cancel</button>");
		}
		update_materials_sell_buttons();
	}

	function cancel_sell_materials() {
		$(actions).html("<div id='armory'><button onclick=armory()>Show me what you're selling.</button></div>");
		if(inventory_map.get("coal_item") || kindling || iron) {
			$(actions).append("<button onclick=sell_materials()>Sell Raw Materials</button>");
		}
		$(actions).append("<div id='upgrade_gear'></div>");
		if (upgrade_day) {
			$("#upgrade_gear").html("<button onclick=receive_equipment()>Receive Upgraded Equipment</button>");
		} else if(iron && (inventory_map.get("bronzesword_item e_item") || inventory_map.get("leathertunic_item e_item") || inventory_map.get("bronzepickaxe_item t_item") || inventory_map.get("bronzeaxe_item t_item"))) {
			$("#upgrade_gear").html("<button onclick=upgrade_equipment()>Upgrade Equipment</button>");
		}
		if(!game_finished) {
			$(actions).append("<div id='anli'><button onclick='anli()'>Tell me about Aunt Lin.</button></div>");
		}
		if(!anli_friendship) {
			$(actions).append("<div id='compliment_anli'><button onclick='compliment_anli()'>Compliment An-li</button></div>");
		}
		if (inventory_map.get("peoniesbouquet_item")) {
			$(actions).append("<div id='gift_anli'><button onclick='gift_anli()'>Give Peonies Bouquet</button></div>");
		}
		if (inventory_map.get("shinyrock_item")) {
			$(actions).append("<div id='give_rock'><button onclick='give_rock()'>Give Shiny Rock</button></div>");
		}
		$(actions).append("<button onclick='hamlet()'>Go Back Outside</button>");
	}

	function sell_all_materials() {
		updateTime(1);
		var previous = $(display).html();
		$(display_last).html(previous);
		$(display).html("<strong>Sold raw materials for "+total_sale+"g!</strong><br><br>");
		money += total_sale;
		$("#money").html(money+"g");
		if(sell_kindling) {
			kindling -= sell_kindling;
			if(kindling > 0) {
				inventory_map.set("kindling_item","Kindling ("+kindling+"x)");
				$(".kindling_item").html("Kindling ("+kindling+"x)");
			} else {
				inventory_map.delete("kindling_item");
				$(".kindling_item").remove();
			}
		}
		if(sell_coal) {
			inventory_map.delete("coal_item");
			$(".coal_item").remove();
		}
		if(sell_iron) {
			iron -= sell_iron;
			if(iron > 0) {
				inventory_map.set("iron_item","Iron Ores ("+iron+"x)");
				$(".iron_item").html("Iron Ores ("+iron+"x)");
			} else {
				inventory_map.delete("iron_item");
				$(".iron_item").remove();
			}
		}
		total_sale = 0;
		if(inventory_map.get("coal_item") || kindling || iron) {
			sell_materials();
		} else {
			cancel_sell_materials();
		}
	}

	function plus_k() {
		sell_kindling += 1;
		total_sale += 2;
		sell_materials();
	}

	function minus_k() {
		sell_kindling -= 1;
		total_sale -= 2;
		sell_materials();
	}

	function plus_l() {
		sell_coal += 1;
		total_sale += 4;
		sell_materials();
	}

	function minus_l() {
		sell_coal -= 1;
		total_sale -= 4;
		sell_materials();
	}

	function plus_i() {
		sell_iron += 1;
		total_sale += 8;
		sell_materials();
	}

	function minus_i() {
		sell_iron -= 1;
		total_sale -= 8;
		sell_materials();
	}

	function update_materials_sell_buttons() {
		if(sell_kindling <= 0) {
			$("#minus_k").attr('disabled','disabled');
		} else {
			$("#minus_k").removeAttr('disabled');
		}
		if (sell_kindling >= kindling) {
			$("#plus_k").attr('disabled','disabled');
		} else {
			$("#plus_k").removeAttr('disabled');
		}
		if(sell_coal <= 0) {
			$("#minus_l").attr('disabled','disabled');
		} else {
			$("#minus_l").removeAttr('disabled');
		}
		if (sell_coal >= 1) {
			$("#plus_l").attr('disabled','disabled');
		} else {
			$("#plus_l").removeAttr('disabled');
		}
		if(sell_iron <= 0) {
			$("#minus_i").attr('disabled','disabled');
		} else {
			$("#minus_i").removeAttr('disabled');
		}
		if (sell_iron >= iron) {
			$("#plus_i").attr('disabled','disabled');
		} else {
			$("#plus_i").removeAttr('disabled');
		}
	}

	function anli_dream() {
		var collapse = updateStamina(-1.5);
		if(collapse){
			return;
		}
		updateTime(.25);
		var previous = $(display).html();
		$(display_last).html(previous);
		$(display).html('How are you? I ask An-li.<br>"An-li wipes his forehead. "Physically I am fine, but I wake up every night drenched in sweat... I can&#39;t stop having the same nightmare of being trapped in that desert, slowing sinking into quicksand while the hot sun beats down on me like a hammer..."');
		if ((chose_left_door || dispel_illusion)) {
			$(display).append('<br><br>"But you came and rescued me!" An-li says, bowing deeply, "I will never forget that. You will always be my <i>yingxiong</i>!"<br><br>');
		} else {
			$(display).append('"<br><br>An-Li turns away and buries his face in his hands.<br><br>');
		}
		$("#anli_dream").remove();
	}
	
	function receive_equipment(text) {
		var collapse = updateStamina(-1.5);
		if(collapse){
			return;
		}
		updateTime(.25);
		var previous = $(display).html();
		$(display_last).html(previous);
		if (current_day > (upgrade_day+1)) {
			upgrade_day = 0;
			if (upgrading == 1) {
				$(display).html('"Here is your upgraded pickaxe," An-li says proudly. ');
				$(display).append('<strong>Obtained Steel Pickaxe!</strong><br><br>');
				addToInventory("steelpickaxe_item t_item","Steel Pickaxe");
			} else if (upgrading == 2) {
				$(display).html('"Here is your upgraded axe," An-li says proudly. ');
				$(display).append('<strong>Obtained Steel Axe!</strong><br><br>');
				addToInventory("steelaxe_item t_item","Steel Axe");
			} else if (upgrading == 3) {
				$(display).html('"Here is your upgraded sword," An-li says proudly. ');
				$(display).append('<strong>Obtained Steel Sword!</strong><br><br>');
				addToInventory("steelsword_item e_item","Steel Sword <button  id='steelsword_button' onclick='equip(10)'>Equip</button>");
			} else if (upgrading == 4) {
				$(display).html('"Here is your upgraded armor," An-li says proudly. ');
				$(display).append('<strong>Obtained Chainmail Tunic!</strong><br><br>');
				addToInventory("chainmail_item e_item","Chainmail Tunic <button  id='chainmail_button' onclick='equip(6)'>Equip</button>");
			}
			if(iron && (inventory_map.get("bronzesword_item e_item") || inventory_map.get("leathertunic_item e_item") || inventory_map.get("bronzepickaxe_item t_item") || inventory_map.get("bronzeaxe_item t_item"))) {
				$("#upgrade_gear").html("<button onclick=upgrade_equipment()>Upgrade Equipment</button>");
			} else {
				$("#upgrade_gear").remove();
			}
		} else {
			var d = current_day - upgrade_day;
			if (d == 1)
			{
				$(display).append('"I need more time to upgrade your equipment," An-li says. "Come back again tomorrow.<br><br>');
			} else {
				$(display).append('"I need more time to upgrade your equipment," An-li says. "Come back again in two days.<br><br>');
			}
			$("#upgrade_gear").remove();
		}
	}
	
	function upgrade_equipment() {
		var collapse = updateStamina(-1.5);
		if(collapse){
			return;
		}
		updateTime(.25);
		var previous = $(display).html();
		$(display_last).html(previous);
		$(display).html('Can you upgrade my equipment? I ask.<br>"Certainly!" An-li says. "What would you like to upgrade?"<br><br>');
		$("#upgrade_gear").html("");
		if(inventory_map.get("bronzepickaxe_item t_item")) {
			$("#upgrade_gear").append("<div><button onclick=upgrade_gear(1)>Upgrade Bronze Pickaxe</button></div>");
		}
		if(inventory_map.get("bronzeaxe_item t_item")) {
			$("#upgrade_gear").append("<div><button onclick=upgrade_gear(2)>Upgrade Bronze Axe</button></div>");
		}
		if(inventory_map.get("bronzesword_item e_item")) {
			$("#upgrade_gear").append("<div><button onclick=upgrade_gear(3)>Upgrade Bronze Sword</button></div>");
		}
		if(inventory_map.get("leathertunic_item e_item")) {
			$("#upgrade_gear").append("<div><button onclick=upgrade_gear(4)>Upgrade Leather Tunic</button></div>");
		}
	}

	function upgrade_gear(text) {
		var previous = $(display).html();
		$(display_last).html(previous);
		if(text == 1) {
			$(display).html('<strong>I hand An-li my Bronze Pickaxe and an Iron Ore.</strong> "Please come back in two days to pick up your upgraded tool," An-li says.<br><br>');
			$(".bronzepickaxe_item").remove();
			inventory_map.delete("bronzepickaxe_item t_item");
			upgrading = 1;
		} else if (text == 2) {
			$(display).html('<strong>I hand An-li my Bronze Axe and an Iron Ore.</strong> "Please come back in two days to pick up your upgraded tool," An-li says.<br><br>');
			$(".bronzeaxe_item").remove();
			inventory_map.delete("bronzeaxe_item t_item");
			upgrading = 2;
		} else if (text == 3) {
			$(display).html('An-li says. <strong>I hand An-li my Bronze Sword and an Iron Ore.</strong> "Please come back in two days to pick up your upgraded sword," An-li says.<br><br>');
			unequip(9);
			$(".bronzesword_item").remove();
			inventory_map.delete("bronzesword_item e_item");
			upgrading = 3;
		} else if (text == 4) {
			$(display).html('An-li says. <strong>I hand An-li my Leather Tunic and an Iron Ore.</strong> "Please come back in two days to pick up your upgraded armor," An-li says.<br><br>');
			unequip(5);
			$(".leathertunic_item").remove();
			inventory_map.delete("leathertunic_item e_item");
			upgrading = 4;
		} 
		$("#upgrade_gear").remove();
		upgrade_day = current_day;
		iron -= 1;
		if(iron) {
			inventory_map.set("iron_item","Iron Ore ("+iron+"x)");
			$(".iron_item").html("Iron Ore ("+iron+"x)");
		} else {
			inventory_map.delete("iron_item");
			$(".iron_item").remove();
		}
	}

	function follow_anli(){
		updateTime(1);
		var previous = $(display).html();
		$(display_last).html(previous);
		$(display).html('I follow An-li to his workspace in the back of the smithy. Laid out on a table are various traditional instruments: a pipa, an erhu, and a bamboo flute.<br><br>');
		$(display).append('These are beautiful. Where did you get them?<br>');
		$(display).append('I collected these instruments over many years," An-li says. "They are all antiques."<br><br>');
		$(actions).html("<button onclick='anli_sing()'>Ask for a Song</button>")
	}

	function anli_sing() {
		updateTime(1);
		var previous = $(display).html();
		$(display_last).html(previous);
		$(display).html('Will you sing for me, I ask.<br>');
		$(display).append('Picking up the erhu, An-li starts to sing in a sonorous voice as he plays the instrument. <br><br>');
		$(display).append('<i>In Pleasant Weather Hamlet, the weather can&#39;t be beat!</i><br>');
		$(display).append('<i>People live in happiness, unbothered by rain or sleet.</i><br>');
		$(display).append('<i>Yet despite this pleasant lifestyle, you never felt satified.</i><br>');
		$(display).append('<i>And no matter how hard I tried...I could never make you laugh.</i><br>');
		$(display).append('<i>Since the day you left me, my life has become better by half!</i><br><br>');
		$(actions).html("<button onclick='anli_sing_c1()'>Continue</button>");
		$(artwork).empty();
		$(artwork).html(anlierhu_art);
	}
	
	function anli_sing_c1() {
		updateTime(1);
		var previous = $(display).html();
		$(display_last).html(previous);
		$(display).html('I applaud as An-li finishes and takes a bow.<br>"It&#39;s only a silly ditty," he says, "But I have never performed for another person before. You gave me the confidence to do that. I will always be grateful! Please accept this gift as a sign of my appreciation." <strong>An-li gives me a Bamboo Flute!</strong><br><br>"In the olden days, it was said that the sound of flute music could dispel illusions and ward off demons," An-li says, "Whether or not that is true, I hope that the music from this flute will prompt you to think of me from time to time." <strong>I have earned An-li&#39;s affection!</strong><br><br>');
		addToInventory("bambooflute_item q_item","Bamboo Flute (<i>relic</i>)");
		relic_count += 1;
		anli_date = 2;
		$(actions).html("<button onclick='hamlet()'>Go Back Outside</button>");
	}

	function compliment_anli() {
		if(charm) {
			$("#compliment_anli").html("<button onclick='compliment_anli_c1(1)'>Compliment Hammer</button><br>");
			$("#compliment_anli").append("<button onclick='compliment_anli_c1(2)'>Compliment Hair</button><br>");
			$("#compliment_anli").append("<button onclick='compliment_anli_c1(3)'>Compliment Voice</button>");
		} else {
			var collapse = updateStamina(-1.5);
			if(collapse){
				return;
			}
			updateTime(.25);
			var previous = $(display).html();
		$(display_last).html(previous);
			$(display).html('That smock looks tight on you, I blurt out.<br>');
			$(display).append('An-li rubs his neck in embarassment. "I guess I need to buy a new one," he says. <strong>Better work on my charm...</strong><br><br>');
			$("#compliment_anli").remove();
		}
	}
	
	function compliment_anli_c1(text) {
		var collapse = updateStamina(-1.5);
		if(collapse){
			return;
		}
		updateTime(.25);
		var previous = $(display).html();
		$(display_last).html(previous);
		if(text == 1) {
			$(display).html('It must require a lot of muscle to wield that heavy hammer, I say, making a point to stare at his biceps.<br>');
			$(display).append('An-li shrugs. "Just practice. Anyone can do it." Could he be flexing?<br><br>');
		} else if (text == 2) {
			$(display).html('I like your haircut.<br>');
			$(display).append('An-li pats his head. "Thanks! Did it myself." Seems like he appreciated me noticing.<br><br>');
		} else {
			$(display).html("You have a nice sounding voice. I bet you're a good singer.<br>");
			$(display).append('A sheepish grin slowly forms on An-li&#39;s serious face. "I do enjoy singing," he says. "But it&#39;s not something people know about me."<br><br>');
			$(display).append('Will you sing for me some time?<br>');
			$(display).append('"Sure, I guess that would be okay," he says. ');
			$(display).append("<strong>I have earned An-Li's friendship!</strong><br><br>");
			anli_friendship = 1;
		}
		$("#compliment_anli").remove();
	}

	function gift_anli() {
		var collapse = updateStamina(-1.5);
		if(collapse){
			return;
		}
		updateTime(.25);
		var previous = $(display).html();
		$(display_last).html(previous);
		$(display).html('I offer An-li the Peonies Bouquet.<br>');
		$(display).append('An-li backs away, startled. "Please keep those away from me. I am very allergic," he says with a sneeze.<br><br>');
		$("#gift_anli").remove();
	}
	
	function give_rock() {
		var collapse = updateStamina(-1.5);
		if(collapse){
			return;
		}
		updateTime(.25);
		var previous = $(display).html();
		$(display_last).html(previous);
		$(display).html('I show An-li the Shiny Rock. Can you forge something out of this? I ask.<br>An-li examines the rock. "Interesting!" he says, "I have never seen a rock with this kind of structure before. Where did you find it?"<br>At the base of Crane Cloud Mountains, I say.<br><br>An-li looks impressed. "Wow," he says, "It&#39;s not easy to make it through the woods. Only Master Yang ever ventures out there. You must be quite skillful!" <strong>I have earned An-li&#39;s admiration!</strong><br><br>"Can I borrow the rock?" An-li asks. "I would like to do some research on it."<br><strong>I give An-li the Shiny Rock.</strong><br><br>');
		$("#give_rock").remove();
		anli_respect = 1;
		inventory_map.delete("shinyrock_item");
		$(".shinyrock_item").remove();
		anli_rock = 1;
	}

	function armory() {
		var collapse = updateStamina(-1.5);
		if(collapse){
			return;
		}
		updateTime(.25);
		var previous = $(display).html();
		$(display_last).html(previous);
		if (bronze_sword_available || leather_tunic_available || pickaxe_available || axe_available) {
			$(display).html("What are you selling?<br>");
			$(display).append('"Here is what I have in stock," An-li says. "I can also improve the equipment you buy if you bring me some iron ore."<br><br>');
			$("#armory").html("");
			if (pickaxe_available) {
				$("#armory").append("<div id='pickaxe'><button onclick='shop_store(3,10)'>Buy Bronze Pickaxe (10g)</button></div>");
			}
			if (axe_available) {
				$("#armory").append("<div id='axe'><button onclick='shop_store(4,10)'>Buy Bronze Axe (10g)</button></div>");
			}
			if(bronze_sword_available) {
				$("#armory").append("<div id='bronzeSword'><button onclick='shop_armory(1,10)'>Buy Bronze Sword (10g)</button></div>");
			}
			if (leather_tunic_available) {
				$("#armory").append("<div id='leatherTunic'><button onclick='shop_armory(2,15)'>Buy Leather Tunic (15g)</button></div>");
			}
			$("#armory").append("<br>");
		} else {
			if(inventory_map.get("steelsword_item e_item") && inventory_map.get("chainmail_item e_item") && inventory_map.get("steelpickaxe_item t_item") && inventory_map.get("steelaxe_item t_item")) {
				$(display).html('"I am all out of stock," An-li says.<br><br>');
			} else {
				$(display).html('"I am all out of stock," An-li says. "If you bring me some iron ore, I can improve the equipment you have."<br><br>');
			}
			$("#armory").remove();
		}
	}

	function shop_armory(text,cost) {
		var previous = $(display).html();
		$(display_last).html(previous);
		if((money-cost)>=0) {
			var item;
			if(text == 1) {
				item = "Bronze Sword";
				$(display).html("<strong>Purchased a "+item+".</strong><br><br>");
				addToInventory("bronzesword_item e_item","Bronze Sword <button id='bronzesword_button' onclick='equip(9)'>Equip</button>");
				money -= cost;
				$("#money").html(money+"g");
				$("#bronzeSword").remove();
				bronze_sword_available = 0;
			} else if (text == 2) {
				item = "Leather Tunic";
				$(display).html("<strong>Purchased a "+item+".</strong><br><br>");
				addToInventory("leathertunic_item e_item","Leather Tunic <button id='leathertunic_button' onclick='equip(5)'>Equip</button>");
				money -= cost;
				$("#money").html(money+"g");
				$("#leatherTunic").remove();
				leather_tunic_available = 0;
			}
		} 
		else {
			$(display).html("Not enough money.<br><br>");
		}
	}


	function anli() {
		var collapse = updateStamina(-1.5);
		if(collapse){
			return;
		}
		updateTime(.5);
		var previous = $(display).html();
		$(display_last).html(previous);
		$(display).html('What can you tell me about Aunt Lin?<br>');
		$(display).append('An-li says, "Oh, you must be her relative. I&#39;m sorry, I don&#39;t her very well. The Constable told me she might have gone into the woods on her own. Your aunt has always been kind to me. I genuinely hope she is okay."<br><br>');
		$("#anli").remove();
		curiosity[2] = 1;
	}

	//market

	function market() {
		var collapse = updateStamina(-1.5);
		if(collapse){
			return;
		}
		updateTime(.25);
		updateLocation("Market");
		reset_display();
		var notThirdDay = current_day % 3;
		if (notThirdDay) {
			if (time_of_day == 2) {
				$(display_persist).html("Ming's Market is closed at night.<br><br>");
				$(actions).html("<button onclick='hamlet()'>Go Back</button>");
			} else {
				$(artwork).html(ming_art);
				if (game_finished) {
					$(display_persist).html("Ming's market is tidy and brightly lit with colorful lanterns. Ms. Ming is delighted to see me.<br>");
					$(display_persist).append('"Ah! It&#39;s the <i>yingxiong</i>!" Ms. Ming says, "Welcome! Please look around!"<br><br>');
				} else {
					$(display_persist).html("Ming's market is tidy and brightly lit with colorful lanterns. Ms. Ming, a short, cheerful lady, greets me as I enter.<br>");
					$(display_persist).append('"Welcome, welcome! Please look around," Ms. Ming says, "Everything is half off today!"<br><br>');
				}
				$(actions).html("<div id='store'><button onclick=store()>Show me what you're selling.</button></div>");
				if(inventory_map.get("nightingale_item")) {
					$(actions).append("<button onclick=sell_painting()>Sell Nightingale Painting</button><br>");
				}
				if(inventory_map.get("redmushroom_item f_item")) {
					$(actions).append("<div id='sell_mushroom'><button onclick=sell_mushroom(1)>Sell Red Mushroom</button></div>");
				}
				if(inventory_map.get("whitemushroom_item f_item")) {
					$(actions).append("<div id='sell_mushroom'><button onclick=sell_mushroom(3)>Sell White Mushroom</button></div>");
				}
				if(goji || mountainyam || ginseng) {
					$(actions).append("<button onclick=sell_harvested_crops()>Sell Crops</button><br>");
				}
				if(!game_finished) {
					$(actions).append("<div id='ming'><button onclick='ming()'>Tell me about Aunt Lin.</button></div>");
				}
				$(actions).append("<button onclick='hamlet()'>Go Back Outside</button>");
			}
		} else {
			$(display).html("Ming's Market is closed every third day.<br><br>");
			$(actions).html("<button onclick='hamlet()'>Go Back</button>");
		}
	}
	
	function sell_mushroom(text) {
		var collapse = updateStamina(-1.5);
		if(collapse){
			return;
		}
		updateTime(.25);
		var previous = $(display).html();
		$(display_last).html(previous);
		if(text == 1) {
			$(display).html('Do you want to buy this Red Mushroom? I ask Ms. Ming.<br>Ms. Ming&#39;s eyes light up. "A <i>lingzhi</i> mushroom!" she exclaims. "Where did you find such a rare specimen? I will pay you 20g for it!"');
			$("#sell_mushroom").html("<button onclick=sell_mushroom(2)>Sell Red Mushroom for 20g</button>");
		} else if(text == 2) {
			$(display).html('<strong>I sell the Red Mushroom to Ms. Ming for 20g!</strong><br><br>');
			$(".redmushroom_item").remove();
			inventory_map.delete("redmushroom_item f_item");
			$("#sell_mushroom").remove();
			money += 20;
			$("#money").html(money+"g");
		} else {
			$(display).html('Do you want to buy this White Mushroom? I ask Ms. Ming.<br>Ms. Ming recoils. "Please take that poisonous thing out of my store!" she cries.<br><br>');
			$("#sell_mushroom").remove();
		}
	}

	function sell_harvested_crops() {
		var collapse = updateStamina(-1.5);
		if(collapse){
			return;
		}
		updateTime(.25);
		var previous = $(display).html();
		$(display_last).html(previous);
		$(display).html('"What would you like to sell?" Ms. Ming asks.<br><br>');
		sell_goji = 0;
		sell_mountainyam = 0;
		sell_ginseng = 0;
		total_sale = 0;
		sell_goods();
	}

	function sell_goods() {
		$(actions).html("");
		if(goji > 0) {
			$(actions).append("<div id='sell_goji'>Sell Goji Berry: "+sell_goji+" <button id='plus_s' onclick='plus_s()'>Increase</button><button id='minus_s' onclick='minus_s()'>Decrease</button></div>");
		}
		if(mountainyam > 0) {
			$(actions).append("<div id='sell_mountainyam'>Sell Mountain Yam: "+sell_mountainyam+" <button id='plus_c' onclick='plus_c()'>Increase</button><button id='minus_c' onclick='minus_c()'>Decrease</button></div>");
		}
		if(ginseng > 0) {
			$(actions).append("<div id='sell_ginseng'>Sell Ginseng: "+sell_ginseng+" <button id='plus_g' onclick='plus_g()'>Increase</button><button id='minus_g' onclick='minus_g()'>Decrease</button></div>");
		}
		if (total_sale) {
			$(actions).append("<br><button onclick='sell_all()'>Sell harvested crops for: "+total_sale+"g</button><br>");
			$(actions).append("<button onclick='cancel_sell()'>Cancel</button>");
		} else {
			$(actions).append("<br><button onclick='cancel_sell()'>Cancel</button>");
		}
		update_sell_buttons();
	}

	function cancel_sell() {
		$(actions).html("<div id='store'><button onclick=store()>Show me what you're selling.</button></div>");
		if(inventory_map.get("nightingale_item")) {
			$(actions).append("<button onclick=sell_painting()>Sell Nightingale Painting.</button><br>");
		}
		if(goji || mountainyam || ginseng) {
			$(actions).append("<button onclick=sell_harvested_crops()>Sell Crops</button><br>");
		}
		$(actions).append("<div id='ming'><button onclick='ming()'>Tell me about Aunt Lin.</button></div>");
		$(actions).append("<button onclick='hamlet()'>Go Back Outside</button>");
	}

	function sell_all() {
		updateTime(1);
		var previous = $(display).html();
		$(display_last).html(previous);
		$(display).html("<strong>Sold crops for "+total_sale+"g!</strong><br><br>");
		money += total_sale;
		$("#money").html(money+"g");
		while(sell_goji) {
			sell_goji -= 1;
			eat_food(1,0);
		}
		while(sell_mountainyam) {
			sell_mountainyam -= 1;
			eat_food(2,0);
		}
		while(sell_ginseng) {
			sell_ginseng -= 1;
			eat_food(3,0);
		}
		total_sale = 0;
		if(goji || mountainyam || ginseng) {
			sell_goods();
		} else {
			cancel_sell();
		}
	}

	function plus_s() {
		sell_goji += 1;
		total_sale += 1;
		sell_goods();
	}

	function minus_s() {
		sell_goji -= 1;
		total_sale -= 1;
		sell_goods();
	}

	function plus_c() {
		sell_mountainyam += 1;
		total_sale += 3;
		sell_goods();
	}

	function minus_c() {
		sell_mountainyam -= 1;
		total_sale -= 3;
		sell_goods();
	}

	function plus_g() {
		sell_ginseng += 1;
		total_sale += 9;
		sell_goods();
	}

	function minus_g() {
		sell_ginseng -= 1;
		total_sale -= 9;
		sell_goods();
	}

	function update_sell_buttons() {
		if(sell_goji <= 0) {
			$("#minus_s").attr('disabled','disabled');
		} else {
			$("#minus_s").removeAttr('disabled');
		}
		if (sell_goji >= goji) {
			$("#plus_s").attr('disabled','disabled');
		} else {
			$("#plus_s").removeAttr('disabled');
		}
		if(sell_mountainyam <= 0) {
			$("#minus_c").attr('disabled','disabled');
		} else {
			$("#minus_c").removeAttr('disabled');
		}
		if (sell_mountainyam >= mountainyam) {
			$("#plus_c").attr('disabled','disabled');
		} else {
			$("#plus_c").removeAttr('disabled');
		}
		if(sell_ginseng <= 0) {
			$("#minus_g").attr('disabled','disabled');
		} else {
			$("#minus_g").removeAttr('disabled');
		}
		if (sell_ginseng >= ginseng) {
			$("#plus_g").attr('disabled','disabled');
		} else {
			$("#plus_g").removeAttr('disabled');
		}
	}

	function sell_painting() {
		var collapse = updateStamina(-1.5);
		if(collapse){
			return;
		}
		updateTime(.25);
		var previous = $(display).html();
		$(display_last).html(previous);
		$(display).html("Will you buy this beautiful Nightingale Painting?<br>");
		$(display).append('Ms. Ming examines the painting..."Hmm, good composition, nice use of colors... I will give you 3g for it!"<br><br>');
		$(actions).html("<button onclick=sell_painting2()>It's worth at least 10g!</button><br>");
		$(actions).append("<button onclick=sell_painting3(1)>Deal.</button><br>");
		$(actions).append("<button onclick=donot_sell()>No thanks.</button><br><br>");
	}

	function sell_painting2() {
		var collapse = updateStamina(-1.5);
		if(collapse){
			return;
		}
		updateTime(.25);
		var previous = $(display).html();
		$(display_last).html(previous);
		$(display).html('10g, I say.<br>"6g. Final offer!" Ms. Ming counters.<br><br>');
		$(actions).html("<button onclick=sell_painting3(2)>Deal.</button><br>");
		$(actions).append("<button onclick=donot_sell()>No thanks.</button><br><br>");
	}

	function sell_painting3(text) {
		var collapse = updateStamina(-1.5);
		if(collapse){
			return;
		}
		var previous = $(display).html();
		$(display_last).html(previous);
		if (text == 1) {
			$(display).html("<strong>I sell the Nightingale Painting to Ms. Ming for 3g!</strong><br><br>");
			money += 3;
			$("#money").html(money+"g");
		} else {
			$(display).html("<strong>I sell the Nightingale Painting to Ms. Ming for 6g!</strong><br><br>");
			money += 6;
			$("#money").html(money+"g");
		}
		$(".nightingale_item").remove();
		inventory_map.delete("nightingale_item");
		nightingale_painting_available = 1;
		$(actions).html("<div id='store'><button onclick=store()>Show me what you're selling.</button></div>");
		if(goji || mountainyam || ginseng) {
			$(actions).append("<button onclick=sell_harvested_crops()>Sell Crops</button><br>");
		}
		$(actions).append("<button onclick='ming()'>Tell me about Aunt Lin.</button><br>");
		$(actions).append("<button onclick='hamlet()'>Go Back Outside</button>");
	}

	function donot_sell() {
		var collapse = updateStamina(-1.5);
		if(collapse){
			return;
		}
		updateTime(.25);
		var previous = $(display).html();
		$(display_last).html(previous);
		$(display).html("I think I will hold on to it for a while longer...<br>");
		$(display).append('Ms. Ming shrugs. "That&#39;s fine, dear."<br><br>');
		$(actions).html("<div id='store'><button onclick=store()>Show me what you're selling.</button></div>");
		$(actions).append("<button onclick='ming()'>Tell me about Aunt Lin.</button><br>");
		$(actions).append("<button onclick='hamlet()'>Go Back Outside</button>");
	}

	function store() {
		var collapse = updateStamina(-1.5);
		if(collapse){
			return;
		}
		updateTime(.25);
		var previous = $(display).html();
		$(display_last).html(previous);
		$(display).html("What are you selling?<br>");
		if (check_store()) {
			$(display).append('"I carry many diverse wares," Ms Ming says. "Only the highest quality goods are stocked here. Guaranteed!"<br><br>');
			$("#store").html("");
			if (goji_seed_available) {
				$("#store").append("<div id='s_seed'><button onclick='shop_store(10,1)'>Buy Goji Berry Seed (1g) ("+(goji_seed_supply+1)+" left)</button></div>");
			}
			if (mountainyam_seed_available && mountainyam_seed_unlock && current_day > 1) {
				$("#store").append("<div id='c_seed'><button onclick='shop_store(11,3)'>Buy Mountain Yam Tuber (3g) ("+(mountainyam_seed_supply+1)+" left)</button></div>");
			}
			if (ginseng_seed_available && ginseng_seed_unlock && current_day > 2) {
				$("#store").append("<div id='g_seed'><button onclick='shop_store(12,6)'>Buy Ginseng Root (6g) ("+(ginseng_seed_supply+1)+" left)</button></div>");
			}
			if (baos_available) {
				$("#store").append("<div id='baos'><button onclick='shop_store(1,"+baos_price+")'>Buy Steamed Bun ("+baos_price+"g)</button></div>");
			}
			if (peony_available) {
				$("#store").append("<div id='peony'><button onclick='shop_store(2,5)'>Buy Peonies Bouquet (5g)</button></div>");
			}
			if (lantern_available) {
				$("#store").append("<div id='lantern'><button onclick='shop_store(5,1)'>Buy Lantern (1g)</button></div>");
			}
			if (crane_painting_available) {
				$("#store").append("<div id='painting'><button onclick='shop_store(6,5)'>Buy Crane Painting (5g)</button></div>");
			}
			if (nightingale_painting_available) {
				$("#store").append("<div id='nightingale_painting'><button onclick='shop_store(7,10)'>Buy Nightingale Painting (10g)</button></div>");
			}
			if (blanket_available) {
				$("#store").append("<div id='blanket'><button onclick='shop_store(8,5)'>Buy Cotton Blanket (5g)</button></div>");
			}
			if (sandals_available) {
				$("#store").append("<div id='sandals'><button onclick='shop_store(9,3)'>Buy Straw Sandals (3g)</button></div>");
			}
			$("#store").append("<br>");
		} else {
			$(display).append('"There was a big sale today! A lot of satisfied customers. I am all sold out for now," Ms. Ming says. "Come back again!" <br><br>');
			$("#store").remove();
		}
	}

	function check_store() {
		return goji_seed_available || (mountainyam_seed_available && mountainyam_seed_unlock && current_day > 1) || (ginseng_seed_available && ginseng_seed_unlock && current_day > 2) || baos_available || peony_available || lantern_available || crane_painting_available || nightingale_painting_available || blanket_available || sandals_available;
	}

	function shop_store(text,cost) {
		var previous = $(display).html();
		$(display_last).html(previous);
		if((money-cost)>=0) {
			var item;
			if(text == 1) {
				item = "Steamed Bun";
				baos_available = 0;
				baos = 3;
				$(display).html("<strong>Purchased "+item+".</strong><br><br>");
				addToInventory("steamedbaos_box f_item","Steamed Bun ("+baos+"x) <button class='eat' onclick='eat_food(0,25)'>Eat</button>");
				money -= cost;
				if (baos_price < 18) {
					baos_price += 12;
				}
				$("#money").html(money+"g");
				$("#baos").remove();
			} else if (text == 2) {
				item = "Peonies Bouquet";
				$(display).html("<strong>Purchased a "+item+".</strong><br><br>");
				addToInventory("peoniesbouquet_item","Peonies Bouquet");
				money -= cost;
				$("#money").html(money+"g");
				$("#peony").remove();
				peony_available = 0;
			} else if (text == 3) {
				item = "Bronze Pickaxe";
				$(display).html("<strong>Purchased a "+item+".</strong><br><br>");
				addToInventory("bronzepickaxe_item t_item","Bronze Pickaxe");
				money -= cost;
				$("#money").html(money+"g");
				$("#pickaxe").remove();
				pickaxe_available = 0;
			} else if (text == 4) {
				item = "Bronze Axe";
				$(display).html("<strong>Purchased a "+item+".</strong><br><br>");
				addToInventory("bronzeaxe_item t_item","Bronze Axe");
				money -= cost;
				$("#money").html(money+"g");
				$("#axe").remove();
				axe_available = 0;
			} else if (text == 5) {
				item = "Lantern";
				$(display).html("<strong>Purchased a "+item+".</strong><br><br>");
				addToInventory("lantern_item t_item","Lantern");
				money -= cost;
				$("#money").html(money+"g");
				$("#lantern").remove();
				lantern_available = 0;
			} else if (text == 6) {
				item = "Crane Painting";
				$(display).html("<strong>Purchased the "+item+".</strong><br><br>");
				addToInventory("crane_item","Crane Painting");
				money -= cost;
				$("#money").html(money+"g");
				$("#painting").remove();
				crane_painting_available = 0;
			} else if (text == 7) {
				item = "Nightingale Painting";
				$(display).html("<strong>Purchased the "+item+".</strong><br><br>");
				addToInventory("nightingale_item","Nightingale Painting");
				money -= cost;
				$("#money").html(money+"g");
				$("#nightingale_painting").remove();
				nightingale_painting_available = 0;
			} else if (text == 8) {
				item = "Cotton Blanket";
				$(display).html("<strong>Purchased a "+item+". I will get better rest now!</strong><br><br>");
				addToInventory("cottonblanket_item","Cotton Blanket");
				money -= cost;
				$("#money").html(money+"g");
				$("#blanket").remove();
				blanket_available = 0;
				sleep_quality = 4;
			} else if (text == 9) {
				item = "Straw Sandals";
				$(display).html("<strong>Purchased "+item+". Wearing these will help me walk around with more comfortably!</strong><br><br>");
				addToInventory("strawsandals_item e_item","Straw Sandals <button id='strawsandals_button' onclick='equip(7)'>Equip</button>");
				money -= cost;
				$("#money").html(money+"g");
				$("#sandals").remove();
				sandals_available = 0;
			} else if (text == 10) {
				goji_seed += 1;
				item = "Goji Berry Seed";
				$(display).html("<strong>Purchased "+item+" (takes 2 days to mature).</strong><br><br>");
				if($(".goji_item").length) {
					$(".goji_item").html(item+" ("+goji_seed+"x)");
					inventory_map.set("goji_item","Goji Berry Seed ("+goji_seed+"x)");
				} else {
					addToInventory("goji_item","Goji Berry Seed (1x)");
				}
				money -= cost;
				$("#money").html(money+"g");
				if (goji_seed_supply) {
					goji_seed_supply -= 1;
					$("#s_seed").html("<button onclick='shop_store(10,1)'>Buy Goji Berry Seed (1g) ("+(goji_seed_supply+1)+" left)</button>");
				} else {
					$("#s_seed").remove();
					goji_seed_available = 0;
				}
				mountainyam_seed_unlock = 1;
			} else if (text == 11) {
				mountainyam_seed += 1;
				item = "Mountain Yam Tuber";
				$(display).html("<strong>Purchased "+item+" (takes 3 days to mature).</strong><br><br>");
				if($(".mountainyam_item").length) {
					$(".mountainyam_item").html(item+" ("+mountainyam_seed+"x)");
					inventory_map.set("mountainyam_item","Mountain Yam Tuber ("+mountainyam_seed+"x)");
				} else {
					addToInventory("mountainyam_item","Mountain Yam Tuber (1x)");
				}
				money -= cost;
				$("#money").html(money+"g");
				if (mountainyam_seed_supply) {
					mountainyam_seed_supply -= 1;
					$("#c_seed").html("<div id='c_seed'><button onclick='shop_store(11,3)'>Buy Mountain Yam Tuber (3g) ("+(mountainyam_seed_supply+1)+" left)</button></div>");
				} else {
					$("#c_seed").remove();
					mountainyam_seed_available = 0;
				}
				ginseng_seed_unlock = 1;
			} else if (text == 12) {
				ginseng_seed += 1;
				if (ginseng_seed == 2) {
					ginseng_seed_available = 0;
				}
				item = "Ginseng Root";
				$(display).html("<strong>Purchased "+item+" (takes 4 days to mature).</strong><br><br>");
				if($(".ginseng_item").length) {
					$(".ginseng_item").html(item+" ("+ginseng_seed+"x)");
					inventory_map.set("ginseng_item","Ginseng Root ("+ginseng_seed+"x)");
				} else {
					addToInventory("ginseng_item","Ginseng Root (1x)");
				}
				money -= cost;
				$("#money").html(money+"g");
				if (ginseng_seed_supply) {
					ginseng_seed_supply -= 1;
					$("#g_seed").html("<div id='g_seed'><button onclick='shop_store(12,6)'>Buy Ginseng Root (6g) ("+(ginseng_seed_supply+1)+" left)</button></div>");
				} else {
					$("#g_seed").remove();
					ginseng_seed_available = 0;
				}
			} 
 		} 
		else {
			$(display).html("Not enough money.<br><br>");
		}
		if(!check_store()) {
			$("#store").remove();
		}
	}
	
	function eat_food(food, text) {
		if (food == 0) {
			baos -= 1;
			if (baos) {
				$(".steamedbaos_box").html("Steamed Bun ("+baos+"x) <button class='eat' onclick='eat_food(0,25)'>Eat</button>");
				inventory_map.set("steamedbaos_box f_item","Steamed Bun ("+baos+"x) <button class='eat' onclick='eat_food(0,25)'>Eat</button>");
			} else {
				$(".steamedbaos_box").remove();
				inventory_map.delete("steamedbaos_box f_item");
				baos_available = 1;
			}
		} else if (food == 1) {
			goji -= 1;
			if (goji > 0) {
				$(".goji_box").html("Goji Berry ("+goji+"x) <button class='eat' onclick='eat_food(1,5)'>Eat</button>");
				inventory_map.set("goji_box f_item","Goji Berry ("+goji+"x) <button class='eat' onclick='eat_food(1,5)'>Eat</button>");
			} else {
				$(".goji_box").remove();
				inventory_map.delete("goji_box f_item");
			}
		} else if (food == 2) {
			mountainyam -= 1;
			if (mountainyam) {
				$(".mountainyam_box").html("Mountain Yam ("+mountainyam+"x) <button class='eat' onclick='eat_food(2,15)'>Eat</button>");
				inventory_map.set("mountainyam_box f_item","Mountain Yam ("+mountainyam+"x) <button class='eat' onclick='eat_food(2,15)'>Eat</button>");
			} else {
				$(".mountainyam_box").remove();
				inventory_map.delete("mountainyam_box f_item");
			}
		} else if (food == 3) {
			ginseng -= 1;
			if (ginseng) {
				$(".ginseng_box").html("Ginseng ("+ginseng+"x) <button class='eat' onclick='eat_food(3,50)'>Eat</button>");
				inventory_map.set("ginseng_box f_item","Ginseng ("+ginseng+"x) <button class='eat' onclick='eat_food(3,50)'>Eat</button>");
			} else {
				$(".ginseng_box").remove();
				inventory_map.delete("ginseng_box f_item");
			}
		} else if (food == 4) {
			$(".redmushroom_item").remove();
			inventory_map.delete("redmushroom_item f_item");
			invincible = 30;
			health_color = "green";
			$(".stamina").css("color", health_color);
			$("#hp").html("Healthiness: <strong>9000%+!</strong>");
		} else if (food == 5) {
			$(".whitemushroom_item").remove();
			inventory_map.delete("whitemushroom_item f_item");
			health_max -= 50;
			$("#hp").html("Healthiness: "+health_max+"%");
		} else if (food == 6) {
			scallion_crepes -= 1;
			if (scallion_crepes) {
				$(".scallioncrepes_box").html("Scallion Crepes ("+scallion_crepes+"x) <button class='eat' onclick='eat_food(6,75)'>Eat</button>");
				inventory_map.set("scallioncrepes_box f_item","Scallion Crepes ("+scallion_crepes+"x) <button class='eat' onclick='eat_food(4,75)'>Eat</button>");
			} else {
				$(".scallioncrepes_box").remove();
				inventory_map.delete("scallioncrepes_box f_item");
			}
		}
		updateStamina(text);
	}

	function ming() {
		var collapse = updateStamina(-1.5);
		if(collapse){
			return;
		}
		updateTime(.5);
		var previous = $(display).html();
		$(display_last).html(previous);
		$(display).html('What can you tell me about Aunt Lin?<br>');
		$(display).append('"Aunt Lin? Oh! You are the one she is always bragging to me about!" Ms. Ming says, clapping her hands together. "How wonderful to meet you in person! Did you know that your aunt and I have known each other since we were schoolgirls? Hi-ya, you wouldn&#39;t believe the mischief the two of us got into during our youth. Of course, it was always because of Sister Mei-hua&#39;s zany ideas. She had a knack for getting us into serious trouble, and then &mdash; somehow &mdash; figuring out a way to pull us out of it in the knick of time using her cleverness. You must have heard the stories floating around about her being abducted by spirits, yes? Nothing to worry about, dear. I assure you that your Aunt Lin is completely fine. She&#39;s a true fire goat after all."<br><br>');
		$(actions).html("<button id='ming2' onclick=ming2()>Fire goat?</button>");
		curiosity[3] = 1;
	}

	function ming2() {
		var collapse = updateStamina(-1.5);
		if(collapse){
			return;
		}
		updateTime(.5);
		var previous = $(display).html();
		$(display_last).html(previous);
		$("#ming2").remove();
		$(display).html("Sorry?<br>");
		$(display).append('Ms. Ming looks at me with surprise. "I mean her <i>shengxiao</i>, of course. Your Aunt Lin is a year older than me. My shengxiao is Monkey, so hers is the Goat. And the particular year in which she was born coincided with the Element of Fire. Hence, Fire Goat. I bet you didn&#39;t know that this is a very lucky time for the Fire Goat, eh? With the Vermillion Bird in the south rising to meet the White Tiger of the west, the Heaven is aligned for those associated with the Fire Element. Not only that, but this season is also particularly good for the Goat sign (although not so much for the Monkey sign, heh). Anyways, so long as the constellations maintain their current pattern in the sky, no misfortune will befall your aunt. Trust me dear, I am never wrong about these things. Wherever Mei-hua is right now, she is perfectly safe."<br><br>');
		$(actions).html("<div id='store'><button onclick=store()>Show me what you're selling.</button></div>");
		$(actions).append("<button onclick='hamlet()'>Go Back Outside</button>");
	}

	//herbalist

	function herbalist() {
		var collapse = updateStamina(-1.5);
		if(collapse){
			return;
		}
		updateTime(.25);
		updateLocation("Herbalist Shop");
		reset_display();
		if(game_finished) {
			$(display_persist).html('The herbalist shop is pungent with the smell of fresh herbs. Master Yang greets me cheerfully. "Welcome to my humble shop! Would you like to learn more about your inner character? Allow me to read your palms!"<br><br>');
			if(!inventory_map.get("wolfsbane_item")) {
			$(actions).append("<div id='wolfsbane'><button onclick='bane()'>Do wolves bother you when you travel the woods?</button></div>");
			}
			if(!foraging) {
				$(actions).append("<div id='find_herbs'><button onclick='find_herbs()'>Can you teach me to find herbs?</button></div>");
			}
			if(inventory_map.get("redmushroom_item f_item")) {
				$(actions).append("<div id='investigate_redmushroom'><button onclick='investigate_mushroom(1)'>Is this Red Mushroom edible?</button></div>");
			}
			if(inventory_map.get("whitemushroom_item f_item")) {
				$(actions).append("<div id='investigate_whitemushroom'><button onclick='investigate_mushroom(2)'>Is this White Mushroom edible?</button></div>");
			}
			$(actions).html("<button onclick='show_stats()'>Request Palm Reading</button><br>");
			$(actions).append("<button onclick='hamlet()'>Go Back Outside</button>");
			$(artwork).html(masteryang_art);

		} else {
			$(display_persist).html('The herbalist shop is closed. A sign on the door reads: "Hunting for fresh herbs in the woods... Will return when the time comes!"<br><br>');
			$(actions).html("<button onclick='hamlet()'>Go Back</button>");
		}
	}

	function show_stats(){
		reset_display();
		$(display_persist).html('Master Yang reads my palms...revealing my inner character!<br><br>');
		$(display_persist).append('Bonus Achievements: <br><br>');
		var book_count = 0;
		for (var i = 0; i < books_read.length; i++) {
			if(books_read[i] == 1) {
				book_count += 1;
			}
		}
		var curiosity_count = 0;
		for (var i = 0; i < curiosity.length; i++) {
			if(curiosity[i] == 1) {
				curiosity_count += 1;
			}
		}
		var achievements = 0;
		if(charitable > 0) {
			$(display_persist).append('I have demonstrated benevolence.<br>');
			achievements += 1;
		} else {
			$(display_persist).append('&#9670&#9670&#9670&#9670&#9670&#9670&#9670&#9670&#9670&#9670&#9670&#9670&#9670&#9670<br>');
		}
		if (theft_solved && (honesty > 0) && !accuse_lifen) {
			$(display_persist).append('I have demonstrated righteousness.<br>');
			achievements += 1;
		} else {
			$(display_persist).append('&#9670&#9670&#9670&#9670&#9670&#9670&#9670&#9670&#9670&#9670&#9670&#9670&#9670&#9670<br>');
		}
		if (courtesy > 0) {
			$(display_persist).append('I have demonstrated propriety.<br>');
			achievements += 1;
		} else {
			$(display_persist).append('&#9670&#9670&#9670&#9670&#9670&#9670&#9670&#9670&#9670&#9670&#9670&#9670&#9670&#9670<br>');
		}
		if ((curiosity >= 10) && (book_count == 9) && training && foraging) {
			$(display_persist).append('I have demonstrated wisdom.<br>');
			achievements += 1;
		} else {
			$(display_persist).append('&#9670&#9670&#9670&#9670&#9670&#9670&#9670&#9670&#9670&#9670&#9670&#9670&#9670&#9670<br>');
		}
		if (!debtor && !bankrupt) {
			$(display_persist).append('I have demonstrated trustworthiness.<br>');
			achievements += 1;
		} else {
			$(display_persist).append('&#9670&#9670&#9670&#9670&#9670&#9670&#9670&#9670&#9670&#9670&#9670&#9670&#9670&#9670<br>');
		}
		if (religious > 0) {
			$(display_persist).append('I have demonstrated respect.<br>');
			achievements += 1;
		} else {
			$(display_persist).append('&#9670&#9670&#9670&#9670&#9670&#9670&#9670&#9670&#9670&#9670&#9670&#9670&#9670&#9670<br>');
		}		
		if (!qin_fallen) {
			$(display_persist).append('I have demonstrated loyalty.<br>');
			achievements += 1;
		} else {
			$(display_persist).append('&#9670&#9670&#9670&#9670&#9670&#9670&#9670&#9670&#9670&#9670&#9670&#9670&#9670&#9670<br>');
		}
		if (((anli_date == 2) && (chose_left_door || dispel_illusion)) || ((lifen_date == 2) && (chose_right_door || dispel_illusion))) {
			$(display_persist).append('I have demonstrated love.<br>');
			achievements += 1;
		} else {
			$(display_persist).append('&#9670&#9670&#9670&#9670&#9670&#9670&#9670&#9670&#9670&#9670&#9670&#9670&#9670&#9670<br>');
		}
		if (humility > 0) {
			$(display_persist).append('I have demonstrated humility.<br>');
			achievements += 1;
		} else {
			$(display_persist).append('&#9670&#9670&#9670&#9670&#9670&#9670&#9670&#9670&#9670&#9670&#9670&#9670&#9670&#9670<br>');
		}
		if (discipline > 0) {
			$(display_persist).append('I have demonstrated discipline.<br>');
			achievements += 1;
		} else {
			$(display_persist).append('&#9670&#9670&#9670&#9670&#9670&#9670&#9670&#9670&#9670&#9670&#9670&#9670&#9670&#9670<br>');
		}
		if (greenthumb > 0) {
			$(display_persist).append('I have demonstrated harmony.<br>');
			achievements += 1;
		} else {
			$(display_persist).append('&#9670&#9670&#9670&#9670&#9670&#9670&#9670&#9670&#9670&#9670&#9670&#9670&#9670&#9670<br>');
		}
		if (inventory_map.get("civilhat_item e_item") && (peace >= 0)) {
			$(display_persist).append('I have demonstrated peace.<br>');
			achievements += 1;
		} else {
			$(display_persist).append('&#9670&#9670&#9670&#9670&#9670&#9670&#9670&#9670&#9670&#9670&#9670&#9670&#9670&#9670<br>');
		}
		$(display_persist).append('<br>Summary<br><br>');
		$(display_persist).append('I have demonstrated '+achievements+' out of 12 virtues.<br>');
		$(display_persist).append('I have obtained '+relic_count+' out of 4 relics.<br>');
		$(display_persist).append('I have read '+book_count+' out of 9 books.<br>');
		if(anli_friendship == 1) {
			$(display_persist).append("I have earned An-li's friendship.<br>");
		}
		if (anli_date == 2) {
			$(display_persist).append("I have earned An-li's affection.<br>");
		}
		if(lifen_friendship == 1) {
			$(display_persist).append("I have earned Li-fen's friendship.<br>");
		}
		if (lifen_date == 2) {
			$(display_persist).append("I have earned Li-fen's affection.<br>");
		}
		if(fallen == 1) {
			$(display_persist).append("I fell "+fallen+" time against the demons.<br>");
		} else {
			$(display_persist).append("I fell "+fallen+" times against the demons.<br>");
		}	
		$(display_persist).append("I defeated the Lord of Demons by Day "+demons_defeated_day+".<br><br>");
		$(display_persist).append("<strong>Thank you for playing!</strong><br><br>");
		$(display_persist).append("<img src='chibi.png' style='position:unset;max-width:100%;'></img>");
		$(display_persist).append("<br><br>");
		$(display_persist).append("<i>Story and Game by Lichen</i><br>");
		$(display_persist).append("<i>Art and Music by Jane</i><br>");
		$(display_persist).append("<i>Dedicated to our wonderful girls!<br>");
		$(display_persist).append("<i>Copyright &copy; 2024<br><br>");
		$(display_persist).append("<div id='feedback'><i>The Traveler's Ballad is a passion project. If you want to share feedback or report any bugs, please email us at </i>&#099;&#111;&#110;&#116;&#097;&#099;&#116;&#064;&#116;&#104;&#101;&#116;&#114;&#097;&#118;&#101;&#108;&#101;&#114;&#115;&#098;&#097;&#108;&#108;&#097;&#100;&#046;&#099;&#111;&#109;<i>! If you wish to </i><button onclick='support()'>support us</button><i>, we would be deeply honored!</i><br><br>");
		$(actions).html("<button onclick='hamlet()'>Go Back Outside</button>");
		$(artwork).empty();
	}

	//bookshop

	function bookshop() {
		var collapse = updateStamina(-1.5);
		if(collapse){
			return;
		}
		updateTime(.25);
		updateLocation("Bookstore");
		reset_display();
		if(time_of_day == 1) {
			in_bookshop = 1;
			if(game_finished) {
				$(display_persist).html('Bookkeeper Tan bows gracefully when I enter. "The <i>yingxiong</i> is always welcomed at my humble store," she says. "Please feel free to browse at your leisuire. I am here if you have any questions."<br><br>');
			} else {
				$(display_persist).html('Bookkeeper Tan bows gracefully when I enter. "Welcome, please feel free to browse my current collection of rare scrolls," she says. "I am here if you have any questions."<br><br>');
			}
			$(actions).html('<div id="book1"><button onclick="book1()">Read <i>Contemplations of Philosopher Liu</i></button></div>');
			$(actions).append('<div id="book2"><button onclick="book2()">Read <i>Treatise on Demons</i> by Taoist Xiang</button></div>');
			$(actions).append('<div id="book3"><button onclick="book3()">Read <i>Forestry, Foliage and Flora: A Forager&#39;s Guide to Walking with Mother Nature</i></button></div>');
			$(actions).append('<div id="book4"><button onclick="book4()">Read <i>The Art of Sweet Nothings</i> by Wen Xiao-jie</button></div>');
			$(actions).append('<div id="book5"><button onclick="book5()">Read <i>Rock Smashing Fist!</i></button></div>');
			$(actions).append("<div id='tan'><button onclick='tan()'>Tell me about Aunt Lin.</button></div>");
			if(inventory_map.get("gatewayscroll_item q_item") && !inventory_map.get("portalspell_item q_item")) {
				$(actions).append("<div id='translate_manual'><button onclick='translate_manual()'>Can you translate this scroll?</button></div>");
			}
			$(actions).append("<button onclick='hamlet()'>Go Back Outside</button>");
			$(artwork).html(bookkeeper_art);
		} else {
			$(display_persist).html("The bookstore is closed. It will be open in the afternoon.<br><br>");
			if(time_of_day == 0) {
				$(actions).html("<button onclick='hamlet()'>Go Back</button>");
			} else {
				$(actions).html("<button onclick='hamlet()'>Go Back</button>");
			}
		}
	}

	function book1() {
		var collapse = updateStamina(-1.5);
		if(collapse){
			return;
		}
		updateTime(1);
		var previous = $(display).html();
		$(display_last).html(previous);
		$(display).html('A passage from <i>Contemplations of Philosopher Liu</i> reads: "I have often pondered on the continuous nature of Time. Is it a single stream that flows straight and true, or a winding river that branches off into multiple tributaries? Perhaps it is neither, but a flat, round lake, endlessly encircling itself..." [CPL 1/1]<br><br>');
		$("#book1").remove();
		books_read[0] = 1;
	}
	
	function book2() {
		var collapse = updateStamina(-1.5);
		if(collapse){
			return;
		}
		updateTime(1);
		var previous = $(display).html();
		$(display_last).html(previous);
		$(display).html('A passage from <i>Treatise on Demons</i> reads: "All humans are made equal, but the same is not true of demons. Most demons fall into one of two classes: Lesser or Greater. Ordinary demons, such as the imp-like <i>xiao</i> that one might encounter while hiking up a hill or a mountain, for instance, belongs to the Lesser class. But every so often, an ordinary demon causes sufficient terror that it acquires a <i>name</i> from the people whom it terrorizes. As the demon continues to cause chaos, its name spreads, invoking greater and greater fear in those who hear it and powering the demon until it becomes a legendary monster and ascends to the Greater class. The infamous skeletal demon known as <i>Baigujing</i> for example is a Greater class demon..." [TD 1/3]<br><br>');
		$("#book2").html('<button onclick="book2part2()">Continue Reading <i>Treatise on Demons</i></button>');
	}

	function book2part2() {
		var collapse = updateStamina(-1.5);
		if(collapse){
			return;
		}
		updateTime(1);
		var previous = $(display).html();
		$(display_last).html(previous);
		$(display).html('"Despite the centuries in which we have known about the Lesser and Greater class, it was only recently that we discovered a third, very rare class of demons called the Lords that reign supreme over both the Lesser and Greater demons. In the course of my travels, I have dealt with many Lesser demons as well as several Greater ones. To a Taoist such as myself, neither class presents much a threat. But only once did I encounter a true Lord of Demons, a creature more fearsome than any natural or even mythical being that exists in the Mortal Realm, its power a rival only to that of one of the Nine Elemental Dragons... For two days and two nights straight, we fought, the Lord of Demons and I, neither able to gain the upper hand. Fighting against a Lord of Demons required every ounce of my strengh, skills, and willpower. Eventually, however, I managed to discover the secret to bringing a permanent end to a Lord of Demons..." [TD 2/3]<br><br>');
		$("#book2").html('<button onclick="book2part3()">Finish Reading <i>Treatise on Demons</i></button>');
	}
	
	function book2part3() {
		var collapse = updateStamina(-1.5);
		if(collapse){
			return;
		}
		updateTime(1);
		var previous = $(display).html();
		$(display_last).html(previous);
		if (in_bookshop) {
			$(display).html('The rest of the pages of <i>Treatise on Demons</i> are missing.<br><br>');
		} else {
			$(display).html('"To actually defeat a Lord of Demons&mdash;as opposed to temporarily banishing it from the Mortal Realm&mdash;one must to satisfy three difficult conditions. First: one must have the stamina and skill to best a Lord of Demons in physical combat until it is in its weakest state. Second: one must posssess an artifact of pure silver&mdash;for only silver can truly finish a Lord of Demons. And third: precisely at the moment when the Lord of Demons is at its most vulnerable, one must summon forth all of the yang spirit energy within one&#39;s inner character...channelling all of that energy into the silver artifact before striking the artifact into the heart of the Lord of Demon. The more powerful the yang spirit energy within the artifact, the greater chance of overcoming the immense yin spirit energy of a Lord of Demon. Therefore, it is crucial that one who desires to be a demon slayer first learn to cultivate and refine one&#39;s inner character. To that end, the rest of this chapter will discuss the Twelve Virtues cultivated by the sages. We begin with an examination of the Five Constant Virtues taught by Kongzi: <i>ren</i>, <i>yi</i>, <i>li</i>, <i>zhi</i>, and <i>xin</i>..." [TD 3/3]<br><br>');
			books_read[1] = 1;
		}
		$("#book2").remove();
	}

	function book3() {
		var collapse = updateStamina(-1.5);
		if(collapse){
			return;
		}
		updateTime(.5);
		var previous = $(display).html();
		$(display_last).html(previous);
		$(display).html('<i>Forestry, Foliage and Flora</i> contains detailed illustrations and descriptions of various species of trees and plants.<br><br>');
		$("#book3").html('<button onclick="book3_c1()">Continue Reading <i>Forestry, Foliage and Flora</i></button>');
	}
	
	function book3_c1() {
		var collapse = updateStamina(-1.5);
		if(collapse){
			return;
		}
		updateTime(.5);
		var previous = $(display).html();
		$(display_last).html(previous);
		$(display).html('"Aconite: Also called monkshood due to the resemblance of its hooded petals, this perennial plant showcases stunning flowers that makes it as beautiful as it is deadly." [3F 1/5]<br><br>');
		$("#book3").html('<button onclick="book3_c2()">Continue Reading <i>Forestry, Foliage and Flora</i></button>');
	}
	
	function book3_c2() {
		var collapse = updateStamina(-1.5);
		if(collapse){
			return;
		}
		updateTime(.5);
		var previous = $(display).html();
		$(display_last).html(previous);
		$(display).html('"Ginkgo Tree: A large and tall tree with fan-shaped leaves, the Gingko, also known as the Maidenhair Tree, is a symbol of longevity." [3F 2/5]<br><br>');
		$("#book3").html('<button onclick="book3_c3()">Continue Reading <i>Forestry, Foliage and Flora</i></button>');
	}
	
	function book3_c3() {
		var collapse = updateStamina(-1.5);
		if(collapse){
			return;
		}
		updateTime(.5);
		var previous = $(display).html();
		$(display_last).html(previous);
		$(display).html('"Mugwort: A hardy plant posessing many useful properties. It can be used to add flavor to food or as medicine." [3F 3/5]<br><br>');
		$("#book3").html('<button onclick="book3_c4()">Continue Reading <i>Forestry, Foliage and Flora</i></button>');
	}
	
	function book3_c4() {
		var collapse = updateStamina(-1.5);
		if(collapse){
			return;
		}
		updateTime(.5);
		var previous = $(display).html();
		$(display_last).html(previous);
		$(display).html('"Mulberry Tree: A medium-sized tree with heart-shaped leaves that produces edible fruits. The leaves of white mulberry trees are highly prized as food for silkworms." [3F 4/5]<br><br>');
		$("#book3").html('<button onclick="book3_finish()">Finish Reading <i>Forestry, Foliage and Flora</i></button>');
	}
	
	function book3_finish(){
		var collapse = updateStamina(-1.5);
		if(collapse){
			return;
		}
		updateTime(.5);
		var previous = $(display).html();
		$(display_last).html(previous);
		if(knowledge) {
			$(display).html('"Three Friends of Winter: Often portrayed together by poets and artists, the pine, bamboo, and plum blossom are known as the Three Friends of Winter because of their steadfast resolution to endure even the harshest winters." [3F 5/5]<br><br>');
		} else {
			$(display).html('"Three Friends of Winter: Often portrayed together by poets and artists, the pine, bamboo, and plum blossom are known as the Three Friends of Winter because of their steadfast committment to enduring even the harshest winters together." [3F 5/5] Having read <i>Forestry, Foliage and Flora</i>, I am now able to identify many different species of trees and plants! <strong>I acquired a new Skill!</strong><br><br>');
		}
		$("#book3").remove();
		if(!knowledge) {
			knowledge = 1;
			addSkill("<div id='dendrology_skill' class='passive_skill'>Basic Dendrology (<i>passive</i>)</div>",0);
		}
		books_read[2] = 1;
	}

	function book4() {
		var collapse = updateStamina(-1.5);
		if(collapse){
			return;
		}
		updateTime(1);
		var previous = $(display).html();
		$(display_last).html(previous);
		$(display).html('A passage from <i>Art of Sweet Nothings</i> reads: "Both men and women love a good compliment. A flattering remark is often all it takes to begin a new friendship or even stir up romance. But in order to attract the desired attention, one must ensure to choose a compliment that is meaningful to the person receiving it." [ASN 1/3]<br><br>');
		$("#book4").html('<button onclick="book4_c1()">Continue Reading <i>Art of Sweet Nothings</i></button>');
	}
	
	function book4_c1() {
		var collapse = updateStamina(-1.5);
		if(collapse){
			return;
		}
		updateTime(1);
		var previous = $(display).html();
		$(display_last).html(previous);
		$(display).html('"Remember that the purpose of complimenting someone is not to flatter <i>yourself</i>. There is no need for boastful declarations of your feelings or to lengthy metaphorical comparisons that only prove how enamored you are with your own eloquence and wit... Instead, all that is required to form the perfect praise is astute observation. Only by thoughtfully admiring the honest qualities of the person whom you are interested in, will your compliment serve to validate their deepest thoughts and feelings..." [ASN 2/3]<br><br>');
		$("#book4").html('<button onclick="book4_finish()">Finish Reading <i>Art of Sweet Nothings</i></button>');
	}
	
	function book4_finish() {
		var collapse = updateStamina(-1.5);
		if(collapse){
			return;
		}
		updateTime(1);
		var previous = $(display).html();
		$(display_last).html(previous);
		if(charm) {
			$(display).html('"As a rule of thumb: think of crafting a tasteful compliment as similar to the art of candymaking&mdash;if you make it too sweet, no one will buy it. Like the best candy, the right compliment must be just pleasing enough to create the desire for more." [ASN 3/3]<br><br>');
		} else {
			$(display).html('"As a rule of thumb: think of crafting a tasteful compliment as similar to the art of candymaking&mdash;if you make it too sweet, no one will buy it. Like the best candy, the right compliment must be just pleasing enough to create the desire for more." [ASN 3/3] I have learned Lady Wen&#39;s advice on giving flattering compliments! <strong>I acquired a new Skill!</strong><br><br>');
		}
		$("#book4").remove();
		if(!charm) {
			charm = 1;
			addSkill("<div id='flattery_skill' class='passive_skill'>Basic Flattery (<i>passive</i>)</div>",0);
		}
		books_read[3] = 1;
	}

	function book5() {
		var collapse = updateStamina(-1.5);
		if(collapse){
			return;
		}
		updateTime(.25);
		var previous = $(display).html();
		$(display_last).html(previous);
		$(display).html('<i>Rock Smashing Fist!</i> reads: "Thank you for purchasing this martial arts manual. I, Quan the Mighty, will now teach you the secret art to being able to pulverize rocks with your bare fist in three easy steps!" [SRF 1/5]<br><br>');
		$("#book5").html('<button onclick="book5_c1()">Continue Reading <i>Rock Smashing Fist!</i></button>');
	}
	
	function book5_c1() {
		var collapse = updateStamina(-1.5);
		if(collapse){
			return;
		}
		updateTime(.25);
		var previous = $(display).html();
		$(display_last).html(previous);
		$(display).html('"Step 1. Channel all your <i>qi</i> into your fists." [SRF 2/5]<br><br>');
		$("#book5").html('<button onclick="book5_c2()">Continue Reading <i>Rock Smashing Fist!</i></button>');
	}
	
	function book5_c2() {
		var collapse = updateStamina(-1.5);
		if(collapse){
			return;
		}
		updateTime(.25);
		var previous = $(display).html();
		$(display_last).html(previous);
		$(display).html('"Step 2. Strike at a big rock with all your might." [SRF 3/5]<br><br>');
		$("#book5").html('<button onclick="book5_c3()">Continue Reading <i>Rock Smashing Fist!</i></button>');
	}
	
	function book5_c3() {
		var collapse = updateStamina(-1.5);
		if(collapse){
			return;
		}
		updateTime(.25);
		var previous = $(display).html();
		$(display_last).html(previous);
		$(display).html('"Step 3. Practice. Practice. Practice." [SRF 4/5]<br><br>');
		$("#book5").html('<button onclick="book5_finish()">Finish Reading <i>Rock Smashing Fist!</i></button>');
	}
	
	function book5_finish() {
		var collapse = updateStamina(-1.5);
		if(collapse){
			return;
		}
		updateTime(.25);
		var previous = $(display).html();
		$(display_last).html(previous);
		if(rocksmash) {
			$(display).html('"Appendix: Remember, punching rocks all day may bruise your knuckles. Eat lots of steamed buns to recover before trying again! Keep it up and one day you will become strong enough to smash even the biggest boulder with one punch. Hur-rah!" [SRF 5/5]<br><br>');
		} else {
			$(display).html('"Appendix: Remember, punching rocks all day may bruise your knuckles. Eat lots of steamed buns to recover before trying again! Keep it up and one day you will become strong enough to smash even the biggest boulder with one punch. Hur-rah!" [SRF 5/5] I have learned Quan the Mighty&#39;s technique for smashing rocks with my bare fist! But could it really be that simple? I wonder if I should test it out... <strong>I acquired a new Skill! I can activate this skill in certain locations.</strong><br><br>');
			addSkill("<div id='rocksmash_skill' class='active_skill'>Rock Smash <button id='use_rocksmash' onclick='activate_rocksmash()'>Activate</button></div>",1);
			$("#use_rocksmash").attr('disabled','disabled');
			rocksmash = 1;
		}
		$("#book5").remove();
		books_read[4] = 1;
	}
	
	function activate_rocksmash() {
		rocksmash_active = 1;
		if (current_loc == "Cave of Treasures"){
			if(spider_hp > 0) {
				attack_spider();
			} else {
				mine_cave_rocks();
				$("#use_rocksmash").attr('disabled','disabled');
			}
		} else {
			clear_rocks();
			if (rocks == 0) {
				$("#use_rocksmash").attr('disabled','disabled');
			}
		}
		rocksmash_active = 0;
	}

	function translate_manual() {
		var collapse = updateStamina(-1.5);
		if(collapse){
			return;
		}
		updateTime(.25);
		var previous = $(display).html();
		$(display_last).html(previous);
		$(display).html('I show Bookkeeper Tan the Gateway Scroll. Do you recognize these glyphs? I ask.<br>');
		$(display).append('Bookkeeper Tan examines the scroll closely. "Incredible!" she exclaims. "The language represented by these glyphs is very old and historically precious!"<br>');
		$("#translate_manual").html("<button onclick='translate_manual_c1()'>What do the glyphs mean?</button>");
	}
	
	function translate_manual_c1() {
		var collapse = updateStamina(-1.5);
		if(collapse){
			return;
		}
		updateTime(.25);
		var previous = $(display).html();
		$(display_last).html(previous);
		$(display).html("What do the glyphs indicate?<br>");
		$(display).append('Bookkeeper Tan shakes her head. "Sadly, I don&#39;t understand these symbols at all. I am merely fascinated by their historic significance. Ah! But the local herbalist Master Yang is known to be versed in ancient texts as they often contain exotic herbal recipes. You ought to seek him out. Perhaps he can help you."<br><br>');
		$("#translate_manual").remove();
	}

	function tan() {
		var collapse = updateStamina(-1.5);
		if(collapse){
			return;
		}
		updateTime(.5);
		var previous = $(display).html();
		$(display_last).html(previous);
		$(display).html('What can you tell me about Aunt Lin?<br>');
		$(display).append('Bookkeeper Tan thinks quietly for a moment. "The adventurous lady who owns the farm? Yes, I know her to be an avid reader who visits my shop frequently. If I recall, when she last came in, she had been seeking a rare map that was supposed to mark the location of a hidden treasure chest belonging to a legendary bandit. I helped her search through all the old maps here but none turned out to be the one she was after... Oh! I remember one other thing as well. I believe she had a keen interest in <i>Contemplations by Philosopher Liu</i>."<br><br>');
		$("#tan").remove();
		curiosity[4] = 1;
	}

	//constable

	function constable() {
		var collapse = updateStamina(-1.5);
		if(collapse){
			return;
		}
		updateTime(.25);
		updateLocation("Constable Office");
		reset_display();
		if(game_finished) {
			$(display_persist).html('Constable Long stands and shakes my hand firmly when I enter his office. "It is always a pleasure to serve the <i>yingxiong</i>! It certainly takes a load of my shoulders having you around here to help keep the peace."<br><br>');
			$(actions).html("");
			if(theft_solved) {
				$(actions).append("<div id='arrest_gao'><button onclick='arrest_gao()'>Has Gao Ru-yi been arrested?</button></div>");
				$(actions).append("<button onclick='hamlet()'>Go Back Outside</button>");
			} else {
				$(actions).append("<button onclick='hamlet()'>Go Back</button>");
			}
			$(artwork).html(constable_art);
		} else {
			if(theft_solved) {
				$(display_persist).html('I find Constable Long at his office, eating a bowl of noodles. He welcomes me in.<br><br>');
				$(actions).html("<div id='case_update'><button onclick='case_update()'>Tell me about Aunt Lin's case.</button></div>");
				$(actions).append("<div id='arrest_gao'><button onclick='arrest_gao()'>Has Gao Ru-yi been arrested?</button></div>");
				$(actions).append("<button onclick='hamlet()'>Go Back Outside</button>");
				$(artwork).html(constable_art);
			} else {
				$(display_persist).html('Constable Long is not at his office. <br> There are three drawings posted on the side wall of the building. <br><br> Left: a sketch of a hooded figure, with the character "Thief" above it.<br> Middle: a sketch of Aunt Lin, with the characters "Missing Person" above it. <br> Right: a sketch of a peach tree, with the characters "Stolen Away" above it.<br><br>');
				seen_notice = 1;
				$(actions).html("<button onclick='hamlet()'>Go Back</button>");
				$(artwork).html(bulletin_art);
			}
		}	
	}

	function case_update() {
		var collapse = updateStamina(-1.5);
		if(collapse){
			return;
		}
		updateTime(.5);
		var previous = $(display).html();
		$(display_last).html(previous);
		$(display).html("Do you have any updates regarding Aunt Lin's whereabouts? I ask.<br>");
		$(display).append('Constable Long sets down the noodle bowl and wipes his mustache with the back of his sleeves. "Please excuse me," he says, "I just got back from conducting interviews with all of the residents here in the hamlet, though I am afraid it has been a mostly unproductive exercise. There are, of course, a half-dozen theories floating around, but no one seems to know anything truly genuine or is willing to admit to it... However, I did learn one unusual piece of information. While I was investigating the theft of the Jade Peach Tree at Peach Garden Temple. I met a young initiate there - a rather chatty fellow named Kua - who shared some particularly odd gossip with me. I&#39;m not sure if it holds any relevance to your aunt&#39;s case...but perhaps you would like to hear about it anyways?"<br><br>');
		$("#case_update").html("<button onclick='case_update_c1()'>What sort of gossip?</button>");
	}

	function case_update_c1() {
		var collapse = updateStamina(-1.5);
		if(collapse){
			return;
		}
		updateTime(.5);
		var previous = $(display).html();
		$(display_last).html(previous);
		$(display).html('What did the initiate tell you? I ask.<br>Constable Long stands and begins to pace behind his desk. "According to Kua, the day before the Fan Family reported your aunt to be missing, the Abbot and the senior monks sensed a sudden disturbance of spirit energy that Kua said clearly agitated them and caused them to immediately head into the Great Spirit Hall. Kua claims that the elders stayed within the Great Spirit Hall for two whole days before emerging, seemingly exhausted. He also said that since then, the elders have been returning to the Great Spirit Hall daily.<br><br>');
		$("#case_update").html("<button onclick='case_update_c2()'>Disturbance of spirit energy?</button>");
	}
	
	function case_update_c2() {
		var collapse = updateStamina(-1.5);
		if(collapse){
			return;
		}
		updateTime(.5);
		var previous = $(display).html();
		$(display_last).html(previous);
		$(display).html("Could the disturbance be connected with Aunt Lin's disappearance?<br>");
		$(display).append('Constable Long rubs the back of his neck. "Could be, but like I said, it&#39;s not yet determined at this point. To be honest with you, I am unsure what it even means for spiritual energy to be disturbed. All Kua told me was that he could hear persistent chanting coming from behind the locked doors. I questioned him as much as I could, but he didn&#39;t know what the chanting could be about, as he is only an initiate after all." Constable Long&#39;s mustache twitches in frustration. "Sorry, all this spirit energy stuff is too esoteric for someone like me, but I will continue looking into it."<br><br>');
		$("#case_update").remove();
	}

	function arrest_gao() {
		var collapse = updateStamina(-1.5);
		if(collapse){
			return;
		}
		updateTime(.25);
		var previous = $(display).html();
		$(display_last).html(previous);
		$(display).html('Any luck finidng Gao Ru-yi? I ask.<br>Constable Long shakes his head angrily. "Gao Ru-yi may have gotten away for now...but he cannot elude me forever! Mr. Gao continues to deny any knowledge of his nephew&#39s whereabouts. I find that hard to believe. I have always had my suspicions about the Gao Family, especially concerning the kind of <i>business</i> the uncle is said to deal in..."<br><br>');
		$("#arrest_gao").remove();
	}

	//Song Family Residence

	function elder_song() {
		var collapse = updateStamina(-1.5);
		if(collapse){
			return;
		}
		updateTime(.25);
		updateLocation("Song Residence");
		reset_display();
		if(time_of_day != 2) {
			if(game_finished) {
				$(display_persist).html('Elder Song happily invites me. We chat about this and that while enjoying freshly steeped tea. Time passes pleasantly... "Come again for tea anyime!" he says.<br><br>');
				$(actions).html("<button onclick='hamlet()'>Go Back</button>");
				$(artwork).html(tea_art);
				updateStamina(15);
			} else {
				$(display_persist).html('A servant receives me at the gate and ushers me into a guestroom. "Please wait here," the servant says and takes his leave.<br><br>');
				$(actions).html("<button onclick='elder_song_c1()'>Wait</button><br>");
			}
		} else {
			$(display_persist).html("Elder Song is sleeping... Better not disturb him this late.<br><br>");
			$(actions).html("<button onclick='hamlet()'>Go Back</button>");
		}
	}
	
	function elder_song_c1(){
		var collapse = updateStamina(-1.5);
		if(collapse){
			return;
		}
		updateTime(.5);
		reset_display();
		$(display_persist).html('A while later, Elder Song appears. "Good of you to come," Elder Song. "Please make yourself comfortable. Can I offer you some fresh tea?" <br><br>');
		$(actions).html("<button onclick='tea()'>Yes, thank you.</button><br>");
		$(actions).append("<button onclick='no_tea()'>Tell me about Aunt Lin.</button><br>");
		$(actions).append("<button onclick='hamlet()'>I have to go.</button>");
		$(artwork).html(tea_art);
	}

	function tea() {
		var collapse = updateStamina(-1.5);
		if(collapse){
			return;
		}
		updateTime(.5);
		var previous = $(display).html();
		$(display_last).html(previous);
		$(display).html("Tea sounds nice, I say. Thank you.<br>");
		$(display).append('Elder Song smiles. He rings for tea, which his servant brings after a moment. "This is Whitehair Silver Needle tea," Elder Song explains as the servant pours the tea, "The finest of white teas. Unlike other tea leaves, only the leaf shoots of White Hair Silver Needle are plucked and dried, a tricky and involved process. But the result of that painstaking process is a beautiful tea with an incredibly unique flavor. Sweet, light, and delicate! Please, take a sip!"<br><br>');
		$(actions).html("<div id='tea'><button onclick='drink_tea()')>Drink Tea</button></div>");
		$(actions).append("<div id='smtalk'><button onclick='smalltalk()'>Make Small Talk</button></div>");
		$(actions).append("<div id='ask_song'><button onclick='song()'>Tell me about Aunt Lin.</button></div>");
		$(actions).append("<button onclick='sond_end()'>I have to go.</button>");
		courtesy += 1;
	}
	
	function drink_tea(){
		updateTime(.25);
		var previous = $(display).html();
		$(display_last).html(previous);
		$(display).html('I drink the refreshing tea. <strong>Ahh, I feel a boost of energy!</strong><br><br>');
		updateStamina(15);
		$('#tea').remove();
	}

	function no_tea() {
		var collapse = updateStamina(-1.5);
		if(collapse){
			return;
		}
		updateTime(.25);
		var previous = $(display).html();
		$(display_last).html(previous);
		$(display).html("No, I'm fine.<br>");
		$(display).append('Elder Song frowns slightly. He picks up a bell and rings for tea, which his servant soon brings. He pours a cup for himself. <br><br>');
		$(actions).html("<div id='smtalk'><button onclick='smalltalk()'>Make Small Talk</button></div>");
		$(actions).append("<div id='ask_song'><button onclick='song()'>Tell me about Aunt Lin.</button></div>");
		$(actions).append("<button onclick='sond_end()'>I have to go.</button>");
		courtesy -= 1;
	}

	function smalltalk() {
		var collapse = updateStamina(-1.5);
		if(collapse){
			return;
		}
		updateTime(.25);
		var previous = $(display).html();
		$(display_last).html(previous);
		$(display).html("Nice weather you have here.<br>");
		$(display).append('Elder Song laughs and takes a sip of his tea. "Yes, Heaven has blessed Pleasant Weather Hamlet with springtime all year long." <br><br>');
		$('#smtalk').remove();
		courtesy += 1;
	}

	function song() {
		var collapse = updateStamina(-1.5);
		if(collapse){
			return;
		}
		updateTime(.5);
		var previous = $(display).html();
		$(display_last).html(previous);
		$(display).html("What can you tell me about Aunt Lin?<br>");
		$(display).append('"I gather you have not found her yet?" Elder Song asks. "Very well, where to start? Your Aunt Lin has always been a big personality for our small hamlet. A large koi settled in a small pond. I might even venture to say that your aunt isn&#39;t quite suited to our simple lifestyle here. She has the brilliance of a scholar and the spirit of an adventurer, not a farmsteader. Perhaps our tepid pool has finally become too small to keep her." Elder Song pauses thoughtfully. "Although I suppose that doesn&#39;t explain why she disappeared now, knowing that you were soon to arrive." <br><br>');
		$('#ask_song').html("<div id='enemies'><button onclick='enemies()'>Who are her friends?</button></div><div id='discovery'><button onclick='discovery()'>Who reported her missing?</button></div>");
		curiosity[5] = 1;
	}

	function enemies() {
		var collapse = updateStamina(-1.5);
		if(collapse){
			return;
		}
		updateTime(.5);
		var previous = $(display).html();
		$(display_last).html(previous);
		$(display).html("Did she get along with all the folks around here?<br>");
		$(display).append('"Of course, she is well loved by all... Well, perhaps not by <i>everyone</i>..." Elder Song says. <br><br>');
		$("#enemies").html("<div id='enemies2'><button onclick='enemies2()'>Who didn't she get along with?</button></div>");

	}

	function enemies2() {
		var collapse = updateStamina(-1.5);
		if(collapse){
			return;
		}
		updateTime(.5);
		var previous = $(display).html();
		$(display_last).html(previous);
		$(display).html("Are you referring to someone in particular?<br>");
		$(display).append('"Ahem, well," Elder Song says, clearing his throat. "Far be it for me to know the details of such matters, but I don&#39;t believe Mr. Gao and your Aunt Lin got along very well. It is no secret that the two of them disliked each other. The Gao Family is very rich, and Mr. Gao can be&mdash;well&mdash;a snob. On the other hand, your aunt is one who always speaks her mind, no matter the consequences. Her bark can be sharper than her bite. The two used to squabble like chickens and rabbits." <br><br>');
		$("#enemies2").remove();
	}

	function discovery() {
		var collapse = updateStamina(-1.5);
		if(collapse){
			return;
		}
		updateTime(.5);
		var previous = $(display).html();
		$(display_last).html(previous);
		$(display).html("Who first discovered her absence?<br>");
		$(display).append('"Ah, that would be the Fan Family," Elder Song says. "I believe they are planning to throw a birthday party for the daughter, Li-fen, and had sent your aunt an invitation. They are very close to your aunt. When the Fans did not receive a response, Mr. Fan had a servant call on her farm to make sure she got the letter. This would have been...oh, probably about two days before you arrived. The servant returned, saying he knocked on the door the cottage but no one answered...and something about experiencing a small earthquake while he was on the farm. Hearing this, the Fan Family became worried and asked the Constable to look into the matter. I happened to run into Constable Long as heading to the farm to investigate. When I learned about his purpose, I decided to accompany him and that was how the two of us ended up meeting you." <br><br>');
		$("#discovery").html("<div id='discovery2'><button onclick='discovery2()'>Where do you think she could have gone?</button></div>");
	}

	function discovery2() {
		var collapse = updateStamina(-1.5);
		if(collapse){
			return;
		}
		updateTime(.5);
		var previous = $(display).html();
		$(display_last).html(previous);
		$(display).html("Any idea where Aunt Lin might have gone?<br>");
		$(display).append('"I wish I had a clue to even make a guess," Elder Song says, "But I have neither. All I can say is that the last time we had tea together, she mentioned that she was spending a lot of time down at Bookkeeper Tan&#39;s shop and that she was on the verge of a major breakthrough. She offered to explain it to me, but I was feeling rather tired that day so I merely wished her good luck. In any event, you should visit the bookstore. Perhaps Bookkeeper Tan can help you deduce what your aunt was searching after."<br><br>');
		$("#discovery2").remove();
	}

	function sond_end() {
		var collapse = updateStamina(-1.5);
		if(collapse){
			return;
		}
		updateTime(.25);
		var previous = $(display).html();
		$(display_last).html(previous);
		$(display).html("I should be on my way.<br>");
		$(display).append('Elder Song waves his hand. "I hope you find your aunt soon."<br><br>');
		$(actions).html("<button onclick='hamlet()'>Go Back Outside</button>");
	}


	//Gao Family Residence

	function gao() {
		var collapse = updateStamina(-1.5);
		if(collapse){
			return;
		}
		updateTime(.25);
		updateLocation("Gao Residence");
		reset_display();
		if(gao_appointment) {
			if (game_finished) {
				gao_appointment = 0;
				$(display_persist).html('The Gao Family butler bows deeply when he sees me. He has a beaming smile on his face. "Please come this way. Mr. Gao is always happy to meet with the <i>yingxiong</i>."<br><br>');
				$(actions).html("<button onclick='gao_skip_appointment()'>Follow Butler</button><br>");
				$(actions).append("<button onclick='hamlet()'>Go Back Outside</button>");
				$(artwork).html(butler_art);
			} else if (current_day == gao_appointment) {
				$(display_persist).html('On the day of my appointment, the Gao Family butler brings me to a sumptuous chamber with a large writing desk. "Mr. Gao is currently attending to another matter and will be with you when he is finished," the butler says. "You may wait here."<br><br>');
				$(actions).html("<button onclick='gao_c1()'>Wait</button>");
			} else if (current_day > gao_appointment) {
				$(display_persist).html('After knocking several times at the gate of the Gao Family Residence, I am greeted by a butler with a haughty mien. "Yes?" He asks.<br><br>');
				$(display_persist).append('I am here to see Mr. Gao.<br>');
				$(display_persist).append('The bulter laughs. "You must be joking. You missed your appointment." He closes the gate before I can say another word.<br><br>');
				$(actions).html("<button onclick='hamlet()'>Go Back</button>");
				gao_appointment = 0;
				$(artwork).html(butler_art);
			} else {
				$(display_persist).html('After knocking several times at the gate of the Gao Family Residence, I am greeted by a butler with a haughty mien. "Yes?" He asks.<br><br>');
				$(display_persist).append('I wish to see Mr. Gao.<br>');
				$(display_persist).append('"Your appointment is tomorrow," the butler says. The gate closes.<br><br>');
				$(actions).html("<button onclick='hamlet()'>Go Back</button>");
				$(artwork).html(butler_art);
			}
		} else {
			if(game_finished) {
				$(display_persist).html('The Gao Family butler bows deeply when he sees me. He has a beaming smile on his face. "Please come this way. Mr. Gao is always happy to meet with the <i>yingxiong</i>."<br><br>');
				$(actions).html("<button onclick='gao_skip_appointment()'>Follow Butler</button><br>");
				$(actions).append("<button onclick='hamlet()'>Go Back Outside</button>");
			} else {
				$(display_persist).html("After knocking several times at the gate of the Gao Family Residence, I am greeted by a butler with a haughty mien.<br>");
				$(display_persist).append('"Do you have an appointment?" he queries');
				if (time_of_day == 2) {
					$(display_persist).append(' with a yawn.<br><br>');
				} else {
					$(display_persist).append('.<br><br>');
				} 
				$(actions).html("<button onclick='gao_reject()'>No.</button><br>");
				$(actions).append("<button onclick='appointment()'>Make Appointment</button><br>");
				$(actions).append("<button onclick='hamlet()'>Go Back</button>");
			}
			$(artwork).html(butler_art);
		}
	}
	
	function gao_c1() {
		var collapse = updateStamina(-1.5);
		if(collapse){
			return;
		}
		updateTime(1);
		reset_display();
		$(display_persist).html('Time passes slowly. Eventually, Mr. Gao, a short man with a scholarly look, appears.<br>');
		$(display_persist).append('"I apologize to have kept you waiting," he says in a rich voice. "What sort of business can I help you with today? An investment, or perhaps a loan?" <br><br>');
		$(actions).html("");
		if(met_nephew || theft_solved) {
			if(theft_solved) {
				$(actions).append("<div id='n_gao'><button onclick='n_gao(2)'>Tell me about Gao Ru-yi.</button></div>");
			} else {
				$(actions).append("<div id='n_gao'><button onclick='n_gao(1)'>Do you have a nephew?</button></div>");
			}
		}
		$(actions).append("<div id='shady_business'><button onclick='business()'>Business?</button></div>");
		if(invest_day) {
			$(actions).append("<div id='invest'><button onclick='cashout(1)'>How is my investment doing?</button></div>");
		} else {
			$(actions).append("<div id='invest'><button onclick='invest()'>Invest with Mr. Gao</button></div>");
		}
		if(loan_day) {
				$(actions).append("<div id='loan'><button onclick='repay(1)'>How much is my debt now?</button></div>");
		} else {
			$(actions).append("<div id='loan'><button onclick='loan()'>Borrow from Mr. Gao</button></div>");
		}
		$(actions).append("<div id='erase_bankruptcy'><button id='erase_bankruptcy_button' onclick='erase_bankruptcy()'>Erase Bankruptcy Record (30g)</button></div>");
		$("#erase_bankruptcy").hide();
		if(bankrupt) {
			$("#erase_bankruptcy").show();
			if(money < 30) {
					$("#erase_bankruptcy_button").attr('disabled','disabled');
			}
		}
		$(actions).append("<div id='mrgao'><button onclick='mrgao()'>Tell me about Aunt Lin.</button></div>");
		$(actions).append("<button onclick='hamlet()'>Go Back Outside</button>");
		$(artwork).html(gao_art);	
		gao_appointment = 0;
	}

	function gao_skip_appointment() {
		var collapse = updateStamina(-1.5);
		if(collapse){
			return;
		}
		updateTime(.25);
		reset_display();
		$(display_persist).append('Mr. Gao appears as soon as the servant leads me inside. "Great work defeating the demons," Mr Gao says, "Business is booming again! How may I serve you today?" <br><br>');
		$(actions).html("");
		if(met_nephew || theft_solved) {
			if(theft_solved) {
				$(actions).append("<div id='n_gao'><button onclick='n_gao(2)'>Tell me about Gao Ru-yi.</button></div>");
			} else {
				$(actions).append("<div id='n_gao'><button onclick='n_gao(1)'>Do you have a nephew?</button></div>");
			}
		}
		$(actions).append("<button onclick='business()'>Business?</button><br>");
		if(invest_day) {
			$(actions).append("<div id='invest'><button onclick='cashout(1)'>How is my investment doing?</button></div>");
		} else {
			$(actions).append("<div id='invest'><button onclick='invest()'>Invest with Mr. Gao</button></div>");
		}
		if(loan_day) {
			$(actions).append("<div id='loan'><button onclick='repay(1)'>How much is my debt now?</button></div>");
		} else {
			$(actions).append("<div id='loan'><button onclick='loan()'>Borrow from Mr. Gao</button></div>");
		}
		if (bankrupt){
			$(actions).append("<div id='erase_bankruptcy'><button id='erase_bankruptcy_button' onclick='erase_bankruptcy()'>Erase Bankruptcy Record (30g)</button></div>");
			if(money < 30) {
				$("#erase_bankruptcy_button").attr('disabled','disabled');
			}
		}
		$(actions).append("<button onclick='hamlet()'>Go Back Outside</button>");
		$(artwork).html(gao_art);	
	}
	
	function erase_bankruptcy() {
		var collapse = updateStamina(-1.5);
		if(collapse){
			return;
		}
		updateTime(.25);
		var previous = $(display).html();
		$(display_last).html(previous);
		$(display).html('<strong>I hand Mr. Gao 30g.</strong> Can you erase my bankruptcy record? I ask.<br>Mr. Gao quickly pockets my money. "Certainly, certainly..." he says, making a note in his ledger. <strong>My bankruptcy record has been erased!</strong><br><br>');
		money -= 30;
		$("#money").html(money+'g');
		bankrupt = 0;
	}

	function business() {
		var collapse = updateStamina(-1.5);
		if(collapse){
			return;
		}
		updateTime(.25);
		var previous = $(display).html();
		$(display_last).html(previous);
		$(display).html('What sort of business do you do?<br>');
		$(display).append('"Oh all sorts," Mr. Gao says vaguely, "I help to finance different ventures that offer high returns in exchange for the leverage and...professional discretion that I provide. Of course, the details are more complicated than a layperson like yourself would need to understand."<br><br>');
		$("#shady_business").remove();
	}

	function invest() {
		var collapse = updateStamina(-1.5);
		if(collapse){
			return;
		}
		updateTime(.25);
		var previous = $(display).html();
		$(display_last).html(previous);
		if(bankrupt) {
			$(display).html('Mr. Gao shakes his head sadly, "I cannot invest for you."<br><br>');
			$("#invest").remove();
		} else {
			$(display).html('Tell me about investing.<br>');
			$(display).append('"For a 5g investment, I can guarantee you a 40% return every 3 days," Mr. Gao says confidently.<br><br>');
			$("#invest").html("<button id ='invest' onclick='invest2()'>Invest 5g</button>");
		}
	}

	function invest2() {
		var collapse = updateStamina(-1.5);
		if(collapse){
			return;
		}
		updateTime(.25);
		var previous = $(display).html();
		$(display_last).html(previous);
		if(money >= 5) {
			$(display).html('<strong>I invest 5g with Mr. Gao.</strong><br><br>');
			money -= 5;
			$("#money").html(money+"g");
			invest_day = current_day+3;
		}
		else {
			$(display).html('"Pity, you do not have enough funds," Mr. Gao says.<br><br>');
		}
		$("#invest").remove();
	}

	function cashout(text) {
		var collapse = updateStamina(-1.5);
		if(collapse){
			return;
		}
		updateTime(.25);
		var previous = $(display).html();
		$(display_last).html(previous);
		var profit = 7 + 2*(Math.floor((current_day-invest_day)/3));
		if(text == 1) {
			if(current_day >= invest_day) {
				$(display).html('"How much has my investment earned? I ask Mr. Gao.<br>Your investment has already grown to '+profit+'g, thanks to my wise business decisions," Mr. Gao says smugly.<br><br>');
				$("#invest").html("<button onclick='cashout(2)'>Cashout Investment</button>");
			} else {
				$(display).html('How much has my investment earned? I ask Mr. Gao.<br>Mr. Gao shakes his head. "Nothing yet...but I expect it to start turning a profit in '+24*(invest_day - current_day)+' hours..."<br><br>');
				$("#invest").remove();
			}
		} else {
			money += profit;
			$("#money").html(money+"g");
			invest_day = 0;
			$("#invest").remove();
			$(display).html('I cash out on my investment. <strong>Received '+profit+'g from Mr. Gao!</strong><br><br>');
			if (money > 30) {
				$("#erase_bankruptcy_button").removeAttr('disabled');
			}
		}
	}

	function loan() {
		var collapse = updateStamina(-1.5);
		if(collapse){
			return;
		}
		updateTime(.25);
		var previous = $(display).html();
		$(display_last).html(previous);
		if(bankrupt) {
			$(display).html('Mr. Gao shakes his head sadly, "I cannot loan you any more money."<br><br>');
			$("#loan").remove();
		} else {
			$(display).html('Tell me about lending.<br>');
			$(display).append('"I can loan you 10g at the low interest rate of 10% for each day the loan is outstanding," Mr. Gao says. "You can pay me back at any time."<br><br>');
			$("#loan").html("<button id='loan' onclick='loan2()'>Borrow 10g</button>");
		}
	}

	function loan2() {
		var collapse = updateStamina(-1.5);
		if(collapse){
			return;
		}
		updateTime(.25);
		var previous = $(display).html();
		$(display_last).html(previous);
		$(display).html('<strong>I borrow 10g from Mr. Gao.</strong><br><br>');
		money += 10;
		$("#money").html(money+"g");
		loan_day = current_day;
		$("#loan").remove();
		debtor = 1;
	}

	function repay(text) {
		var collapse = updateStamina(-1.5);
		if(collapse){
			return;
		}
		updateTime(.25);
		var previous = $(display).html();
		$(display_last).html(previous);
		var debt = 10 + (current_day - loan_day);
		if(text == 1) {
			$(display).html('How much do I currently owe you, I ask Mr. Gao.<br>"Your current debt is '+debt+'g," Mr. Gao says.<br><br>');
			$("#loan").html("<button onclick='repay(2)'>Repay Loan</button>");
		} else {
			if ((money - debt) >= 0){
				money -= debt;
				$("#money").html(money+"g");
				loan_day = 0;
				$(display).html('I repay the loan. <strong>Paid Mr. Gao '+debt+'g.</strong><br><br>');
				$("#loan").remove();
				debtor = 0;
			} else {
				$(display).html('"Hm, seems like you have insufficient capital at this time to fully repay your loan," Mr. Gao says. "I&#39;m afraid I cannot accept partial repayment...unless you are insolvent."<br><br>');
				$("#loan").html("<button onclick='bankruptcy()'>Declare Bankruptcy</button>");
			}
		}
	}

	function bankruptcy() {
		var collapse = updateStamina(-1.5);
		if(collapse){
			return;
		}
		updateTime(.25);
		var previous = $(display).html();
		$(display).html('Mr. Gao gives me a serious look. "Are you certain you wish to declare bankruptcy? Think carefully. I cannot conduct any future business with people who are so careless as to default on their debt. I will also have to inform my business associates in the Capitol City regarding your financial history..."<br><br>');
		$("#loan").html("<button onclick='bankruptcy2()'>Proceed with Bankruptcy</button>");
	}

	function bankruptcy2() {
		var collapse = updateStamina(-1.5);
		if(collapse){
			return;
		}
		updateTime(.25);
		var previous = $(display).html();
		$(display_last).html(previous);
		$(display).html('"Very well then," Mr. Gao says, "I have made a record in my ledger of your bankruptcy. Your debt is now resolved. Please be more careful with your money in the future. Good luck."<br><br>');
		$("#money").html(money+"g");
		loan_day = 0;
		$(display).append('<strong>I pay Mr. Gao '+money+'g and become bankrupt!</strong><br><br>');
		money = 0;
		$("#money").html(money+"g");
		$("#loan").remove();
		debtor = 0;
		bankrupt = 1;
		$("#erase_bankruptcy").show();
	}

	function n_gao(text) {
		var collapse = updateStamina(-1.5);
		if(collapse){
			return;
		}
		updateTime(.25);
		var previous = $(display).html();
		$(display_last).html(previous);
		if(text == 1) {
			$(display).html('I met a local tax collector who claimed he had a wealthy businessman as an uncle... I say.<br>');
			$(display).append('Mr. Gao frowns. "Hmm...a tax collector?" he mutters. Then he scowls and pounds his fist angrily on the table. "You must have met my nephew Gao Ru-yi! He is not a real tax collector... He&#39;s a con artist and a delinquent!"<br><br>');
			$("#n_gao").remove();	
		} else {
			$(display).html('I have some questions to ask about your nephew Gao Ru-yi, I say.<br>');
			$(display).append('Mr. Gao seems taken aback for a moment. Then he signs heavily. "Yes, yes, of course. If you are asking about Gao Ru-yi, there must have a good reason. Despite what he may have done, I urge you not to judge him too quickly..."<br><br>');
			$("#n_gao").html("<div id='n_gao2'><button onclick='n_gao2()'>Where is he?</button></div>");
			$("#n_gao").append("<div id='n_gao3'><button onclick='n_gao3()'>How can you defend him?</button></div>");
		}
	}

	function n_gao2() {
		var collapse = updateStamina(-1.5);
		if(collapse){
			return;
		}
		updateTime(.25);
		var previous = $(display).html();
		$(display_last).html(previous);
		$(display).html('Do you know where I can find him? I ask.<br>');
		$(display).append('Mr. Gao shakes his head. "If he doesn&#39;t want to be found, it is unlikely that you will be able to. Even I have been unsuccessful in making contact with him."<br><br>');
		$("#n_gao2").remove();
	}

	function n_gao3() {
		var collapse = updateStamina(-1.5);
		if(collapse){
			return;
		}
		updateTime(.5);
		var previous = $(display).html();
		$(display_last).html(previous);
		$(display).html('He stole from the Peach Garden Temple, I say.<br>');
		$(display).append('Mr. Gao&#39;s eyes widen. "I see," he says solemnly, "That is a serious crime. Yes, well of course I am aware of my nephew&#39;s reputation and what the folks around here all whisper about him behind my back. Listen, Ru-yi may be a scoundrel, but you have to understand, I remember how he was as a precocious child&mdash;so inquisitive and full of potential. It is a great misfortune that he was born with such unlucky birth numbers. Not long after he turned one, his father was killed in a horse-riding accident. His mother&mdash;my late sister, consumed by her sorrow, began to dote on her only son, giving into his every whim, until two years ago when she passed from grief..."<br><br>');
		$("#n_gao3").html('<button onclick="n_gao3_c1()">Sorry for your loss.</button>');
	}
	
	function n_gao3_c1() {
		var collapse = updateStamina(-1.5);
		if(collapse){
			return;
		}
		updateTime(.5);
		var previous = $(display).html();
		$(display_last).html(previous);
		$(display).html('My condolences, I say.<br>Mr. Gao nods briefly and continues. "My nephew was already seventeen when I became his guardian. He was no longer the cheerful, bright-eyed boy he had been before his father passed. Certainly his cleverness was still evident, but he had also become arrogant and deceitful. Once he moved in with me, the two of us argued constantly. About a year ago, Ru-yi decided to move out and find a place of his own. He was eighteen so I let him go out of my own selfishness because I didn&#39;t want to keep fighting with him anymore."<br><br>');
		$("#n_gao3").html('<button onclick="n_gao3_finish()">Have you tried contacting Ru-yi?</button>');
	}
	
	function n_gao3_finish() {
		var collapse = updateStamina(-1.5);
		if(collapse){
			return;
		}
		updateTime(.5);
		var previous = $(display).html();
		$(display_last).html(previous);
		$(display).html('Any word from your nephew since he left? I ask.<br>Mr. Gao&#39s shoulder slumps. "No," he says, "I have not received any word from Ru-yi since the day he left home, not even a single letter. I only hear about him from the complaints I get regarding all the trouble he causes, but what am I to do? I even tried sending men to find Ru-yi and bring him back but somehow he manages to evade them all." Mr. Gao voice tightens. "The truth is, talking about my nephew is not easy for me. His poor behavior shames the Gao family name and tarnishes my reputation, but it is also a reflection of my own failure. Do I regret the way I allowed our relationship to come to an end? Yes. The delightful child Ru-yi used is still a part of my memories, yet now any remembrance of the boy my nephew only serves to make me disappointed in the sort of man he has since become."<br><br>');
		$("#n_gao3").remove();
	}

	function mrgao() {
		var collapse = updateStamina(-1.5);
		if(collapse){
			return;
		}
		updateTime(.5);
		var previous = $(display).html();
		$(display_last).html(previous);
		$(display).html('What can you tell me about Aunt Lin?<br>');
		$(display).append('Mr. Gao sighs. "Perhaps you have heard by now that she and I did not get along. Well, that much is true. But I have no ill will towards her. In some ways, I admire your aunt&#39s firebrand attitude. Despite our disagreements, I have come to respect her. Her recent disappearance is truly unexpected, but I promise you, I have nothing to do with it."<br><br>');
		$("#mrgao").remove();
		curiosity[6] = 1;
	}

	function gao_reject() {
		var collapse = updateStamina(-1.5);
		if(collapse){
			return;
		}
		updateTime(.25);
		var previous = $(display).html();
		$(display_last).html(previous);
		$(display).html("No, I don't.<br>");
		$(display).append("The butler closes the gate in my face.<br><br>");
		$(actions).html("<button onclick='hamlet()'>Go Back</button>");		
	}

	function appointment() {
		var collapse = updateStamina(-1.5);
		if(collapse){
			return;
		}
		updateTime(.25);
		var previous = $(display).html();
		$(display_last).html(previous);
		$(display).html("I would like to make an appointment.<br>");
		$(display).append('"Very well," the butler says. "Mr. Gao will meet with you tomorrow. Come back then." The gate shuts.<br><br>');
		$(actions).html("<button onclick='hamlet()'>Go Back</button>");	
		gao_appointment = current_day+1;
	}

	//Fan Family Residence

	function fan() {
		if (time_of_day == 2) {
			var collapse = updateStamina(-1.5);
			if(collapse){
				return;
			}
			updateTime(.25);
			updateLocation("Fan Residence");
			reset_display();
			$(display_persist).html('The Fan Family is sleeping... Better not disturb them this late.<br><br>');
			$(actions).html("<button onclick='hamlet()'>Go Back</button>");
		} else if(lifen_friendship && lifen_nightingale && lifen_respect && !lifen_date) {
			reset_display();
			lifen_date = 1;
			$(display_persist).html('Li-fen greets me at the gate of the Fan Family Residence. "Come with me," she says in excitement. "I want to show you something."<br><br>');
			$(actions).html("<button onclick='follow_lifen()'>Follow Li-fen</button><br>")
			$(actions).append("<button onclick='hamlet()'>Go Back Outside</button>");
		} else if(game_finished) {
			var collapse = updateStamina(-1.5);
			if(collapse){
				return;
			}
			updateTime(.25);
			updateLocation("Fan Residence");
			fan_residence();
		} else if(!party_day) {
			var collapse = updateStamina(-1.5);
			if(collapse){
				return;
			}
			updateTime(.25);
			updateLocation("Fan Residence");
			reset_display();
			party_day = current_day + 2;
			$(display_persist).html('At the gate of the Fan Family Residence, servants rush about unloading heavy crates from several wagons. A fast-moving ox cart nearly runs me over. The driver shouts at me to get out of the way!<br><br>');
			$(actions).html("<button onclick='fan_c1()'>Continue</button>");
			$(artwork).html(fanentrance_art);
		} else if(current_day < party_day) {
			var collapse = updateStamina(-1.5);
			if(collapse){
				return;
			}
			updateTime(.25);
			updateLocation("Fan Residence");
			reset_display();
			var daysUntilParty = party_day - current_day;
			var days_text = "2 days ";
			if (daysUntilParty == 1) {
				days_text = "1 day ";
			}
			$(display_persist).html('At the gate of the Fan Family Residence, servants rush about unloading heavy crates from several wagons.<br><br>"Hello again!" the attendant calls to me, while continuing to direct the servants. "We look forward to seeing you at the celebration of Ms. Li-fen '+days_text+'from now. Please be sure to stop by in the afternoon!"<br><br>');
			$(actions).html("<button onclick='hamlet()'>Go Back</button>");
			$(artwork).html(fanentrance_art);
		} else if (current_day == party_day) {
			if (time_of_day == 0) {
				var collapse = updateStamina(-1.5);
				if(collapse){
					return;
				}
				updateTime(.25);
				updateLocation("Fan Residence");
				reset_display();
				$(display_persist).html("Li-fen's birthday party is this afternoon. I should bring a gift.<br><br>");
				$(actions).html("<button onclick='hamlet()'>Go Back</button>");
				$(artwork).html(fanentrance_art);
			} else if (time_of_day == 1) {
				updateLocation("Fan Residence");
				reset_display();
				$(display_persist).html('Outside the Fan Family Residence, many guests have already gathered, bearing extravagant-looking gifts&mdash;porcelain vases, bolts of silk, and ornate jewelry boxes. A servant quickly ushers us all into the main hall, where steaming plates of duck, seafood, and fresh vegetables have been laid out, along with copious quantities of rice wine. As the guests feast, Mr. and Mrs. Fan, along with their daughter Li-fen, make the rounds, greeting each guest individually.<br><br>');
				$(actions).html("<button onclick='birthday_c1()'>Continue</button>");
				$(artwork).html(birthday_art);
				updateTime(2);
			} 
		} else {
			var collapse = updateStamina(-1.5);
			if(collapse){
				return;
			}
			updateTime(.25);
			updateLocation("Fan Residence");
			fan_residence();
		}

	}
	
	function fan_c1() {
		var collapse = updateStamina(-1.5);
		if(collapse){
			return;
		}
		updateTime(.25);
		var previous = $(display).html();
		$(display_last).html(previous);
		var daysUntilParty = party_day - current_day;
		var days_text = "2 days ";
		if (daysUntilParty == 1) {
			days_text = "1 day ";
		}
		$(display).html('The attendant responsible for directing the servants rushes forward. "Many humble apologies, we are very busy preparing for the birthday celebration of Ms. Li-fen," he says. "You are welcome to attend the party! It is open to everyone in the hamlet and will be held in the afternoon '+days_text+'from now. Please be sure to stop by!"<br><br>');
		$(actions).html("<button onclick='hamlet()'>Go Back</button>");
	}
	
	function birthday_c1() {
		updateTime(2);
		var previous = $(display).html();
		$(display_last).html(previous);
		$(display).html('I observe the Fan Family as I eat the delicious meal. Mr. Fan is a gregarious man with a full-bellied laugh that is easily heard even through the noisy chatter of the large dining room. Mrs. Fan, a tall, refined woman with a reserved smile, keeps a ready hand on husband&#39;s arm, to be able to calm him down. Their daughter Li-fen leads the way around the room, happily greeting the guests. Despite her poise and graceful manners, every now and then, she throws her head back, laughing at a remark or a joke from one of the guests with the same dynamic energy as her father. The sound of Li-fen&#39;s infectious laugh echoes across the room and adds to the joyful atmosphere.<br><br>');
		$(actions).html("<button onclick='birthday_c2()'>Continue</button>");
	}
	
	function birthday_c2() {
		updateTime(1);
		var previous = $(display).html();
		$(display_last).html(previous);
		$(display).html('I stand as the Fan Family approaches. We bow to one another. "Hello and welcome!" Mr. Fan says in a booming voice, grasping my hand. "I hear you are Lin Mei-hua&#39;s relative! It is a pleasure to meet you! We have been told many great things about you from your aunt." "Indeed," Mrs. Fan says, in a courteous voice, "Jiang, the head of our staff, informed us that you came to our residence previously, while preparations for the celebration had been underway. I apologize that we weren&#39;t able to receive you then."<br><br>');
		if (!inventory_map.get("nightingale_item") && !inventory_map.get("crane_item")) {
			$(actions).html("<button onclick='birthday_c3()'>Continue</button>");
		} else {
			$(display).append('No apologies necessary, I say.<br><br>');
			$(actions).html('');
			if (inventory_map.get("crane_item")) {
				$(actions).append("<button id='birthdayGift' onclick='birthday_gift(2)'>Give Li-fen the Crane Painting</button><br>");
			}
			if (inventory_map.get("nightingale_item")) {
				$(actions).append("<button id='birthdayGift' onclick='birthday_gift(1)'>Give Li-fen the Nightingale Painting</button>");
			}
		}
	}
	
	function birthday_gift(text) {
		updateTime(1);
		var previous = $(display).html();
		$(display_last).html(previous);
		if(text == 1) {
			$(display).html('<strong>I give Li-fen the Nightingale Painting.</strong> Happy Birthday!<br>');
			$(".nightingale_item").remove();
			inventory_map.delete("nightingale_item");
			$(display).append('Li-fen lights up. "Oh! This is Auntie Lin&#39;s painting that she promised to give me! Thank you so much for bringing it to me. I absolutely love it. Look how alive the nightingale appears. It&#39;s truly exquisite." Li-fen bows deeply, then hugs me.<br>It&#39;s no problem, I say, slightly embarrassed by her show of appreciation. <strong>I have earned Li-fen&#39;s gratitude!</strong><br><br>');
			$(display).append('Li-fen and her parents move on, called away by a group of guests. Eventually, the party ends.<br><br>');
			$("#birthdayGift").remove();
			$(actions).html("<button onclick='birthday_end()'>Continue</button>");
			lifen_nightingale = 1;
			study_painting = 1;
		} else {
			$(display).html('<strong>I give Li-fen the Crane Painting.</strong> Happy Birthday! I say.<br>');
			$(".crane_item").remove();
			inventory_map.delete("crane_item");
			$(display).append('Li-fen graciously accepts it. "What a pretty painting," she says. "Thank you!" For some reason, she seems slightly let down. Perhaps she was expecting something else...<br><br>');
			$(display).append('Li-fen and her parents move on, called away by a group of guests. Eventually, the party ends.<br><br>');
			$("#birthdayGift").remove();
			$(actions).html("<button onclick='birthday_end()'>Continue</button>");
			study_painting = 2;
		}
		courtesy += 1;
	}
	
	function birthday_c3() {
		updateTime(1);
		var previous = $(display).html();
		$(display_last).html(previous);
		$(display).html('Actually, I am the one who should apologize, I say, bowing deeply. For enjoying your delicious food without bringing a suitable gift.<br><br>');
		$(display).append('"Nonsense," Mrs. Fan says, "A gift will not be necessary. Besides, Li-fen has received too many presents already, wouldn&#39;t you say, darling?" Mr. Fan laughs heartily. "Of course, my dear! My wonderful wife is always right!" he says, bringing a smile to his wife&#39;s face. Li-fen shakes her head, then laughs along with her parents. She smiles at me, as if sharing a secret. "Please excuse my embarrassing folks," she says. "I hope you enjoy the party."<br><br>');
		$(display).append('The three of them move on, called away by other guests. Eventually, the party ends.<br><br>');
		$(actions).html("<button onclick='birthday_end()'>Continue</button>");
		courtesy -= 1;
	}
	
	function birthday_end() {
		updateStamina(50);
		var previous = $(display).html();
		$(display_last).html(previous);
		$(display).html('<strong>Wow I ate so much tasty food at the Fan&#39s celebration, I feel full of energy!</strong><br><br>');
		$(actions).html("<button onclick='hamlet()'>Go Back Outside</button>");
	}

	function follow_lifen() {
		updateTime(2);
		var previous = $(display).html();
		$(display_last).html(previous);
		$(display).html('I follow Li-fen.<br>');
		$(display).append('She leads me to a pavilion in the Fan Family Garden. Her dog, Lulu lies in a basket, surrounded by six squealing newborn puppies.<br>');
		$(display).append('"Aren&#39;t they just adorable!" Li-fen says.<br><br>');
		$(display).append('We sit under the pavilion and play with the puppies under Lulu&#39;s watchful gaze. At one point, Li-fen briefly leans her head against my shoulder. Time passes idly by as we watch the pups lazily squirm around.<br><br>');
		$(actions).html("<button onclick='follow_lifen_c1()'>Continue</button>");
		$(artwork).html(puppies_art);
	}
	
	function follow_lifen_c1() {
		updateTime(1);
		var previous = $(display).html();
		$(display_last).html(previous);
		$(display).html('"Thank you for visiting me," Li-fen says. "Here, I want you to have this." <strong>Li-fen unclasps her necklace with the Amber Amulet and hands it to me.</strong><br><br>"My great-aunt once told me that the amulet was crafted by a shaman and possesses magical properties that protect the wearer against unnatural danger. I hope it keeps you safe while you look for your aunt...and perhaps it will remind you of me while you wear it." <strong>I have earned Li-fen&#39;s affection!</strong><br><br>');
	 	addToInventory("amberamulet_item e_item q_item","Amber Amulet (<i>relic</i>) <button id='amberamulet_button' onclick='equip(2)'>Equip</button>");
		relic_count += 1;
		lifen_date = 2;
		$(actions).html("<button onclick='hamlet()'>Return to Pleasant Weather Hamlet</button>");
	}

	function fan_residence() {
		reset_display();
		if(game_finished) {
			$(display_persist).html('A servant leads me onto the Fan Family estate, bowing the whole time. "Please let me know if there is anything you need. Mr. Fan has made it clear that the <i>yingxiong</i> of Pleasant Weather Hamlet is a most honored guest."<br><br>');
		} else {
			$(display_persist).html('The Fan residence is on a large and well-maintained estate. A servant leads me into the main courtyard. "As a relative of Lin Mei-hua&#39;s, you are our special guest. Mr. Fan has instructed that you may visit the grounds as you please."<br><br>');
		}
		$(actions).html("<button onclick='sparring_ground()'>Visit Sparring Grounds</button><br>");
		$(actions).append("<button onclick='study()'>Visit Li-fen's Study</button><br>");
		$(actions).append("<button onclick='library()'>Visit Library</button><br>");
		$(actions).append("<button onclick='garden()'>Visit Gardens</button><br>");
		$(actions).append("<button onclick='hamlet()'>Go Back Outside</button>");
		if (lifen_location == 1) {
			lifen_location = 0;
		} else {
			lifen_location = 1;
		}
	}

	function sparring_ground() {
		var collapse = updateStamina(-1.5);
		if(collapse){
			return;
		}
		updateTime(.25);
		reset_display();
		if(!sparred_with_lifen) {
			if(lifen_location == 1) { //Li-fen in sparring ground
				$(display_persist).html('I enter the sparring ground and find Li-fen practicing with a spear. Her form and technique are excellent. She has clearly been instructed by a Master.<br><br>');
				$(display_persist).append('Li-fen soon notice me watching and stops her exercise. She salutes me. "Hey there! How about a friendly sparring match?"<br><br>');
				$(actions).html("<button onclick='accept_match()'>Sure!</button><br>");
				$(actions).append("<button onclick='decline_match()'>No thanks.</button><br><br>");
			} else { //Mr. Fan in sparring ground
				if(game_finished) {
					$(display_persist).html('In the sparring grounds, I find Mr. Fan practicing with a spear. His form and techniques demonstrate a deep mastery of the weapon.<br><br>As soon as Mr. Fan notices me, he immediately stops practicing. He turns toward me and bows deeply. "It is an honor to have you visit our residence," he says. "I am eternally grateful to you for bringing Li-fen back to us. Please count on the Fan Family if you ever need anything!"<br><br>');
					$(actions).html("<button onclick='accept_lessons()'>How about some lessons on dueling?</button>");
					$(actions).append("<button onclick='study()'>Visit Li-fen's Study</button><br>");
					$(actions).append("<button onclick='library()'>Visit Library</button><br>");
					$(actions).append("<button onclick='garden()'>Visit Gardens</button><br>");
					$(actions).append("<button onclick='hamlet()'>Return to Pleasant Weather Hamlet</button>");
				} else if(!training) {
					$(display_persist).html('I enter the sparring ground and find Mr. Fan practicing with a spear. His form and techniques demonstrate a deep mastery of the weapon.<br><br>');
					$(actions).html("<button onclick='mrfan_c1()'>Continue</button>");
				} else {
					$(display_persist).html('Mr. Fan is practicing in the sparring ground. What a masterful display of technique! It is thrilling to watch.<br><br>');
					$(actions).html("<button onclick='study()'>Visit Li-fen's Study</button><br>");
					$(actions).append("<button onclick='library()'>Visit Library</button><br>");
					$(actions).append("<button onclick='garden()'>Visit Gardens</button><br>");
					$(actions).append("<button onclick='hamlet()'>Return to Pleasant Weather Hamlet</button>");
				}
			}
		} else {
			$(display_persist).html('The sparring ground is empty.<br><br>');
			$(actions).html("<button onclick='study()'>Visit Li-fen's Study</button><br>");
			$(actions).append("<button onclick='library()'>Visit Library</button><br>");
			$(actions).append("<button onclick='garden()'>Visit Gardens</button><br>");
			$(actions).append("<button onclick='hamlet()'>Return to Pleasant Weather Hamlet</button>");
		}
		$(artwork).empty();
	}
	
	function mrfan_c1() {
		var collapse = updateStamina(-1.5);
		if(collapse){
			return;
		}
		updateTime(.25);
		var previous = $(display).html();
		$(display_last).html(previous);
		$(display).html('Mr. Fan quickly notices me. "Fan Family Rule Number 1," he says. "Anyone who comes to the sparring ground must participate in a friendly match. Come, show me what you got!"<br><br>');
		$(actions).html("<button onclick='mrfan_c2()'>Spar with Mr. Fan</button>");
	}
	
	function mrfan_c2() {
		var collapse = updateStamina(-1.5);
		if(collapse){
			return;
		}
		updateTime(1);
		var previous = $(display).html();
		$(display_last).html(previous);
		$(display).html('Hesitantly, I step into the ring. We bow to begin the match. As expected, Mr. Fan easily bests me, despite my efforts. "Well fought!" Mr. Fan says, "You have the makings of a champ. Under the right tutelage that is. How about a few lessons on dueling?"<br><br>');
		$(actions).html("<button onclick='accept_lessons()'>Kneel</button><br>")
		$(actions).append("<button onclick='reject_lessons()'>No, I'm fine.</button>")
	}

	function accept_lessons() {
		var collapse = updateStamina(-1.5);
		if(collapse){
			return;
		}
		updateTime(.25);
		var previous = $(display).html();
		$(display_last).html(previous);
		if(game_finished) {
			$(display).html('Can you instruct me on dueling? I would be humbled to learn from you, I say.<br>');
			$(display).append('"Nothing would make me happier than to teach the <i>yinxiong</i>!" Mr. Fan declares."<br><br>');
		} else {
			$(display).html('I would be humbled to learn from you, I say, kneeling. Please accept me as a disciple.<br>');
			$(display).append('"Of course!" Mr. Fan says, hurriedly pulling me up. "There is no need to kneel."<br><br>');
		}
		$(actions).html("<button onclick='accept_lessons_c1()'>Continue</button>");
	}
	
	function accept_lessons_c1() {
		var collapse = updateStamina(-1.5);
		if(collapse){
			return;
		}
		updateTime(1);
		var previous = $(display).html();
		$(display_last).html(previous);
		$(display).html('"Now," he says, "The key to dueling is knowing when to press the offensive and when to stay on the defensive. There is a certain flow to battle, much like a dance. As you and your opponent trade blows, the energy between you two will start to shift, often imperceptibly. Whoever is able to pick up on that energy, even if they are the weaker combatant, will often be able to influence the outcome of the fight. If the energy is not in your favor, stay guarded! When you sense your opponent losing their resolve, that is the time to strike!"<br><br>');
		$(actions).html("<button onclick='accept_lessons_c2()'>Continue</button>");
	}
	
	function accept_lessons_c2() {
		var collapse = updateStamina(-1.5);
		if(collapse){
			return;
		}
		updateTime(1);
		var previous = $(display).html();
		$(display_last).html(previous);
		$(display).html('Mr. Fan chuckles. "Also, it helps to never start a fight in the first place with someone who seems stronger than you, unless of course honor demands it! In that case, you better win!" Mr. Fan proceeds to teach me a few moves with the spear. He watches me practice them until he is satisfied. "You make an excellent disciple!" he says with a big smile. I have been trained by Mr. Fan! <strong>I acquired a new Skill!</strong><br><br>');
		$(actions).html("<button onclick='study()'>Visit Li-fen's Study</button><br>");
		$(actions).append("<button onclick='library()'>Visit Library</button><br>");
		$(actions).append("<button onclick='garden()'>Visit Gardens</button><br>");
		$(actions).append("<button onclick='hamlet()'>Return to Pleasant Weather Hamlet</button>");
		humility = 1;
		training = 1;
		addSkill("<div id='dueling_skill' class='passive_skill'>Basic Dueling (<i>passive</i>)</div>",0);
	}

	function reject_lessons() {
		var collapse = updateStamina(-1.5);
		if(collapse){
			return;
		}
		updateTime(.25);
		var previous = $(display).html();
		$(display_last).html(previous);
		$(display).html("I can get better on my own.<br>");
		$(display).append('"Suit yourself," Mr. Fan says with a shrug. He hoists the spear and resumes his practice.<br><br>');
		$(actions).html("<button onclick='study()'>Visit Li-fen's Study</button><br>");
		$(actions).append("<button onclick='library()'>Visit Library</button><br>");
		$(actions).append("<button onclick='garden()'>Visit Gardens</button><br>");
		$(actions).append("<button onclick='hamlet()'>Return to Pleasant Weather Hamlet</button>");
	}

	function accept_match() {
		var collapse = updateStamina(-1.5);
		if(collapse){
			return;
		}
		updateTime(.25);
		var previous = $(display).html();
		$(display_last).html(previous);
		$(display).html("I'll take you on, I say confidently.<br>");
		$(display).append('I pick up a spear and join Li-fen in the center of the sparring ground. We bow and begin the match.<br><br>');
		unequip(0);
		$("#silkfan_button").attr('disabled','disabled');
		$("#woodenstaff_button").attr('disabled','disabled');
		$("#bronzesword_button").attr('disabled','disabled');
		$("#steelsword_button").attr('disabled','disabled');
		$("#silverdagger_button").attr('disabled','disabled');
		$("#e_hand").html("Training Spear");
		$(actions).html("<button onclick='accept_match_c1()'>Continue</button>");
		$(artwork).html(lifen_art);
	}
	
	function accept_match_c1() {
		if(training) {
			reset_display();
			lifen_energy = 5;
			change_music("fight.mp3");
			updateStamina(100);
			$(display_persist).html("<div id='lifen_hp'>Li-fen<br><progress value='"+lifen_energy+"' max='5'></progress></div><br>");
			$(display_persist).append('Li-fen and I face off, slowly circling each other....<br><br>');
			$(actions).html("<button onclick='press_offense()'>Strike First</button><br>");
			$(actions).append("<button onclick='press_defense()'>Taunt</button><br><br>");
			$(actions).append("<button onclick='concede()'>Concede Match</button><br>");
		} else {
			var collapse = updateStamina(-20);
			if(collapse){
				return;
			}
			updateTime(1);
			var previous = $(display).html();
			$(display_last).html(previous);
			$(display).html('Within a few bouts, I am knocked to the ground. Li-fen helps me up. "I got lucky," she says, bowing. "It was fun sparring with you though! I am always ready for a rematch whenever you are."<br><br>');
			$(actions).html("<button onclick='study()'>Visit Li-fen's Study</button><br>");
			$(actions).append("<button onclick='library()'>Visit Library</button><br>");
			$(actions).append("<button onclick='garden()'>Visit Gardens</button><br>");
			$(actions).append("<button onclick='hamlet()'>Return to Pleasant Weather Hamlet</button>");
			$("#e_hand").html("");
			$("#silkfan_button").removeAttr('disabled');
			$("#woodenstaff_button").removeAttr('disabled');
			$("#bronzesword_button").removeAttr('disabled');
			$("#steelsword_button").removeAttr('disabled');
			$("#silverdagger_button").removeAttr('disabled');
		}
	}

	function press_offense() {
		var previous = $(display).html();
		$(display_last).html(previous);
		$(display).html('I take an offensive stance and attack!<br><br>');
		var offense = Math.random();
		if (offense > match_balance) {
			if(lifen_energy > 2) {
				$(display).append("Li-fen parries my blow. Her step falters mometarily.<br><br>");
				$(actions).html("<button onclick='continue_press_offense(1)'>Continue Pressure</button><br>");
				$(actions).append("<button onclick='press_defense()'>Switch to Defense</button><br><br>");
				$(actions).append("<button onclick='concede()'>Concede Match</button><br>");
			} else {
				$(display).append("Li-fen parries my blow. Sweat glistens on her forehead.<br><br>");
				$(actions).html("<button onclick='continue_press_offense(2)'>Continue Pressure</button><br>");
				$(actions).append("<button onclick='press_defense()'>Switch to Defense</button><br><br>");
				$(actions).append("<button onclick='concede()'>Concede Match</button><br>");
			}
		} else {
			$(display).append("Li-fen parries my blow and forces me on the defensive.<br><br>");
			$(actions).html("<button onclick='parry()'>Parry</button><br>");
			$(actions).append("<button onclick='dodge()'>Dodge</button><br><br>");
			$(actions).append("<button onclick='concede()'>Concede Match</button><br>");
		}
		stamina_check();
		updateStamina(-3);
	}

	function continue_press_offense(text) {
		var previous = $(display).html();
		$(display_last).html(previous);
		if (lifen_energy > 1) {
			lifen_energy -= 1;
			if (text == 1) { //Li-fen feints
				$("#lifen_hp").html("Li-fen<br><progress value='"+lifen_energy+"' max='5'></progress>");
				$(display).html("I press the offensive. Li-fen expends energy dodging! But she recovers and fights with renewed vigor!<br><br>");
				$(actions).html("<button onclick='press_offense()'>Continue Attacking</button><br>");
					$(actions).append("<button onclick='press_defense()'>Switch to Defense</button><br><br>");
					$(actions).append("<button onclick='concede()'>Concede Match</button>");
				match_balance += 0.1;
			} else { //Li-fen is tired
				$("#lifen_hp").html("Li-fen<br><progress value='"+lifen_energy+"' max='5'></progress>");
				$(display).html("I press the offensive. Li-fen appears tired. Her movements are slower, but she manages to parry my blow.<br><br>");
				$(actions).html("<button onclick='press_offense()'>Continue Attacking</button><br>");
				$(actions).append("<button onclick='press_defense()'>Switch to Defense</button><br><br>");
				$(actions).append("<button onclick='concede()'>Concede Match</button>");
			}
			stamina_check();
			updateStamina(-5);
		} else { //win against Li-fen
			change_music("village.mp3");
			$(display).html('"Okay! I concede," Li-fen yells. She looks exhausted. Wiping the sweat from her forehead, she smiles and bows. "You fight with the determination of a wolf and the patience of a turtle. You win this one."<br>');
			$(display).append('It was a well fought match, and you are gracious in defeat, I tell her, bowing in the return. ');
			$(display).append("<strong>I have earned Li-fen's respect!</strong><br><br>");
			$(actions).html("<button onclick='study()'>Visit Li-fen's Study</button><br>");
			$(actions).append("<button onclick='library()'>Visit Library</button><br>");
			$(actions).append("<button onclick='garden()'>Visit Gardens</button><br>");
			$(actions).append("<button onclick='hamlet()'>Return to Pleasant Weather Hamlet</button>");
			$("#e_hand").html("");
			$("#silkfan_button").removeAttr('disabled');
			$("#woodenstaff_button").removeAttr('disabled');
			$("#bronzesword_button").removeAttr('disabled');
			$("#steelsword_button").removeAttr('disabled');
			$("#silverdagger_button").removeAttr('disabled');
			updateStamina(100);
			updateTime(2);
			sparred_with_lifen = 1;	
			lifen_respect = 1;
		}
	}

	function concede() {
		var previous = $(display).html();
		$(display_last).html(previous);
		change_music("village.mp3");
		lifen_energy = 5;
		$("#lifen_hp").html("Li-fen<br><progress value='"+lifen_energy+"' max='5'></progress>");
		$(display).html('Wait, I concede! I shout, putting down my spear.<br>Li-fen bows. "Good match, it was an honor to spar with you. Let&#39;s spar again soon!"<br><br>');
		$(actions).html("<button onclick='study()'>Visit Li-fen's Study</button><br>");
		$(actions).append("<button onclick='library()'>Visit Library</button><br>");
		$(actions).append("<button onclick='garden()'>Visit Gardens</button><br>");
		$(actions).append("<button onclick='hamlet()'>Return to Pleasant Weather Hamlet</button>");
		$("#e_hand").html("");
		$("#silkfan_button").removeAttr('disabled');
		$("#woodenstaff_button").removeAttr('disabled');
		$("#bronzesword_button").removeAttr('disabled');
		$("#steelsword_button").removeAttr('disabled');
		$("#silverdagger_button").removeAttr('disabled');
	}

	function press_defense() {
		var previous = $(display).html();
		$(display_last).html(previous);
		$(display).html('I take a defensive stance. Show me what you got! I shout.<br>Li-fen attacks!<br><br>');
		$(actions).html("<button onclick='parry()'>Parry</button><br>");
		$(actions).append("<button onclick='dodge()'>Dodge</button><br><br>");
		$(actions).append("<button onclick='concede()'>Concede Match</button>");
	}

	function parry() {
		var previous = $(display).html();
		$(display_last).html(previous);
		$(display).html("I successfully parry Li-fen's blow.<br><br>");
		$(actions).html("<button onclick='press_offense()'>Switch to Offense</button><br>");
		$(actions).append("<button onclick='press_defense()'>Remain on Guard</button><br><br>");
		$(actions).append("<button onclick='concede()'>Concede Match</button>");
		match_balance -= 0.05;
		stamina_check();
		updateStamina(-3);
	}

	function dodge() {
		var previous = $(display).html();
		$(display_last).html(previous);
		var defense = Math.random();
		if (defense > match_balance) {
			$(display).html("I successfully dodge Li-fen's blow.<br><br>");
			match_balance -= 0.1;
		} else {
			$(display).html("Li-fen's spear grazes my clothes, but I manage to dodge the blow.<br><br>");
			match_balance -= 0.05;
		}
		stamina_check();
		updateStamina(-3);
		$(actions).html("<button onclick='press_offense()'>Switch to Offense</button><br>");
		$(actions).append("<button onclick='press_defense()'>Stay on Defense</button><br><br>");
		$(actions).append("<button onclick='concede()'>Concede Match</button>");
	}

	function stamina_check() {
		var currentStamina = $(".stamina").val();
		if (currentStamina < 10) {
			var previous = $(display).html();
			$(display_last).html(previous);
			$(display).html('Li-fen stops the match. "Hey, are you okay? You look out of breath. How about we call this one a draw. Go home and rest. We can have a rematch another day!"<br><br>');
			$(actions).html("<button onclick='return_to_farm()'>Continue</button>");
			$("#e_hand").html("");
			$("#silkfan_button").removeAttr('disabled');
			$("#woodenstaff_button").removeAttr('disabled');
			$("#bronzesword_button").removeAttr('disabled');
			$("#steelsword_button").removeAttr('disabled');
			$("#silverdagger_button").removeAttr('disabled');
		}
	}

	function decline_match() {
		var collapse = updateStamina(-1.5);
		if(collapse){
			return;
		}
		updateTime(.25);
		var previous = $(display).html();
		$(display_last).html(previous);
		$(display).html("I'm no match for you, I say politely.<br>");
		$(display).append('"Scared?" Li-fen taunts me.<br><br>');
		$(actions).html("<button onclick='decline_match2()'>Yep, I'm chicken.</button><br>");
		$(actions).append("<button onclick='accept_match()'>Nope, let's go!</button>");
	}

	function decline_match2() {
		var collapse = updateStamina(-1.5);
		if(collapse){
			return;
		}
		updateTime(.25);
		var previous = $(display).html();
		$(display_last).html(previous);
		$(display).html("Yes, I admit it.<br>");
		$(display).append('"That&#39;s okay," Li-fen says. "We can spar when you feel ready." She returns to her practice.<br><br>');
		$(actions).html("<button onclick='study()'>Visit Li-fen's Study</button><br>");
		$(actions).append("<button onclick='library()'>Visit Library</button><br>");
		$(actions).append("<button onclick='garden()'>Visit Gardens</button><br>");
		$(actions).append("<button onclick='hamlet()'>Return to Pleasant Weather Hamlet</button>");
		humility = 1;		
	}
	
	function study() {
		var collapse = updateStamina(-1.5);
		if(collapse){
			return;
		}
		updateTime(.25);
		reset_display();
		$(display_persist).html('A wood carving hanging over the closed door reads: "Private Study: Keep out!" The door to the study is closed. It would be rude to enter uninvited.<br><br>');
		$(actions).html("<button onclick='study2()'>Enter Li-fen's Study</button><br>");
		$(actions).append("<button onclick='library()'>Visit Library</button><br>");
		$(actions).append("<button onclick='garden()'>Visit Gardens</button><br>");
		$(actions).append("<button onclick='hamlet()'>Return to Pleasant Weather Hamlet</button>");
		$(artwork).empty();
	}

	function study2() {
		var collapse = updateStamina(-1.5);
		if(collapse){
			return;
		}
		updateTime(.25);
		reset_display();
		$(display_persist).html("Li-fen's study is charming and tidy. There is a small desk in one corner. ");
		if(study_painting == 1) {
			$(display_persist).append('A painting of a nightingale hangs on the wall.<br><br>');
		} else if (study_painting == 2) {
			$(display_persist).append('A painting of a crane hangs on the wall.<br><br>');
		} else {
			$(display_persist).append('The walls are unadorned.<br><br>');
		}
		$(actions).html("<div id='study_desk'><button onclick='inspect_desk()'>Inspect Desk</button></div><br>");
		$(actions).append("<button onclick='sparring_ground()'>Visit Sparring Grounds</button><br>");
		$(actions).append("<button onclick='library()'>Visit Library</button><br>");
		$(actions).append("<button onclick='garden()'>Visit Gardens</button><br>");
		$(actions).append("<button onclick='hamlet()'>Return to Pleasant Weather Hamlet</button>");
		$(artwork).empty();
	}

	function inspect_desk() {
		var collapse = updateStamina(-1.5);
		if(collapse){
			return;
		}
		updateTime(.25);
		var previous = $(display).html();
		$(display_last).html(previous);
		$("#study_desk").remove();
		if (sculpture_available) {
			$(display).html('On the desk is a calligraphy brush, an ink pot and a blank parchment. On top of the parchment sits a beautifully carved sculpture of a dimunitive peach tree, made entirely of jade.<br><br>');
			seen_sculpture = 1;
			if (take_sculpture && sculpture_available) {
				$(actions).html("<div id='retrieve_sculpture'><button onclick='retrieve_sculpture()'>Take Jade Peach Tree Sculpture</button></div>");
				$(actions).append("<button onclick='study()'>Done Inspecting</button>");
			} else if (seen_notice) {
				$(display).append("<strong>The sculpture seems familiar...</strong><br><br>");
			}
		} else {
			$(display).html('On the desk is a calligraphy brush, an ink pot and a blank parchment.<br><br>');
		}
	}

	function retrieve_sculpture() {
		var collapse = updateStamina(-1.5);
		if(collapse){
			return;
		}
		updateTime(.25);
		var previous = $(display).html();
		$(display_last).html(previous);
		relic_count += 1;
		sculpture_available = 0;
		addToInventory("jadesculpture_item q_item","Jade Peach Tree (<i>relic</i>)");
		$(display).html('<strong>I take the Jade Peach Tree sculpture.</strong><br><br>');
		$("#retrieve_sculpture").remove();
	}

	function library() {
		var collapse = updateStamina(-1.5);
		if(collapse){
			return;
		}
		updateTime(.25);
		reset_display();
		$(display_persist).html('The library is magnificent, filled with interesting books for all ages.<br><br>');
		$(actions).html('<div id="book1"><button onclick="book1()">Read <i>Contemplations of Philosopher Liu</i></button></div>');
		$(actions).append('<div id="book_poems"><button onclick="book_poems()">Read <i>Collection of Tang Dynasty Poetry: Volume II</i></button></div>');
		$(actions).append('<div id="book2"><button onclick="book2()">Read <i>Treatise on Demons</i> by Taoist Xiang</button></div>');
		$(actions).append('<div id="book_6"><button onclick="book_spirits()">Read <i>Treatise on Spirits</i> by Taoist Xiang</button></div>');
		$(actions).append('<div id="book3"><button onclick="book3()">Read <i>Forestry, Foliage and Flora: A Forager&#39;s Guide to Walking with Mother Nature</i></button></div>');
		$(actions).append('<div id="book_dogs"><button onclick="book_dogs()">Read <i>Running with Wild Dogs: A Memoir by Da Lang</i></button></div>');
		$(actions).append('<div id="book_children"><button onclick="book_children()">Read <i>Collection of Folktales for Children: Stories to Inspire Proper Upbringing</i></button></div><br>');
		$(actions).append("<button onclick='sparring_ground()'>Visit Sparring Grounds</button><br>");
		$(actions).append("<button onclick='study()'>Visit Li-fen's Study</button><br>");
		$(actions).append("<button onclick='garden()'>Visit Gardens</button><br>");
		$(actions).append("<button onclick='hamlet()'>Return to Pleasant Weather Hamlet</button>");
		$(artwork).empty();
	}

	function book_spirits() {
		var collapse = updateStamina(-1.5);
		if(collapse){
			return;
		}
		updateTime(1);
		var previous = $(display).html();
		$(display_last).html(previous);
		$(display).html('A passage from <i>Treatise on Spirits</i> reads: "While spirits are commonly thought to possess a geographical feature at a particular location, such as a &#39;mystical&#39; river or a &#39;haunted&#39; mountain, in actuality, spirits in the Mortal Realm generally take the form of animals. Thus, a river spirit might embody as its phyiscal aspect the form of a carp, and a mountain spirit might turn itself into a ram. Unlike demons, which must serve as agents of chaos and discord, spirits, like people, are equally capable of benevolence, malevolence, as well as neutrality." [TS 1/4]<br><br>');
		$("#book_6").html('<button onclick="book_spirits_c1()">Continue Reading <i>Treatise on Spirits</i></button>');
	}
	
	function book_spirits_c1() {
		var collapse = updateStamina(-1.5);
		if(collapse){
			return;
		}
		updateTime(1);
		var previous = $(display).html();
		$(display_last).html(previous);
		$(display).html('"Unfortunately, in the past, most spirits were misidentified as demons and hunted by shamans and monks. Many legends grew out of such unnecessary conflict between spirits and humans. The most famous of these legends tell of the persecution of the white water snake spirit Bai Suzhen by the monk Fahai." [TS 2/4]<br><br>');
		$("#book_6").html('<button onclick="book_spirits_c2()">Continue Reading <i>Treatise on Spirits</i></button>');
	}
	
	function book_spirits_c2() {
		var collapse = updateStamina(-1.5);
		if(collapse){
			return;
		}
		updateTime(1);
		var previous = $(display).html();
		$(display_last).html(previous);
		$(display).html('"Bai Suzhen was a neutral spirit that fell in love with the human scholar Xu. The monk Fahai, mistakenly believing Bai to be a demon intending to eat Xu, presumptuously crashed Bai and Xu&#39;s wedding and proceeded to play a magical flute. The melody of the flute dispelled the illusion Bai Suzhen had cast around herself, forcing her to shed her human form and return to her animal aspect as a gigantic white serpent, which horrified Xu..." [TS 3/4]<br><br>');
		$("#book_6").html('<button onclick="book_spirits_finish()">Finish Reading <i>Treatise on Spirits</i></button>');
	}
	
	function book_spirits_finish() {
		var collapse = updateStamina(-1.5);
		if(collapse){
			return;
		}
		updateTime(1);
		var previous = $(display).html();
		$(display_last).html(previous);
		$(display).html('"The age-old story of the conflict between Bai and FaHai has since become a lesson regarding the errors of our old beliefs. Yet despite the many treatises (including this one) that have been written to help distinguish the difference between spirits and demons, the difficulty continues to remain...and is not one that is easy to rectify. For, much like spirits, demons also have the ability to take on both animal and human forms, which they readily do so simply for the pleasure of being able deceive and further the strife between humans and spirits..." [TS 4/4]<br><br>');
		$("#book_6").remove();
		books_read[5] = 1;
	}

	function book_dogs() {
		var collapse = updateStamina(-1.5);
		if(collapse){
			return;
		}
		updateTime(1);
		var previous = $(display).html();
		$(display_last).html(previous);
		$(display).html('A passage from <i>Running with Wild Dogs</i> reads: "During those years when I lived on the streets, I befriended many wild dogs. Like me, they too had been rejected by society, and so it was easy for us to understand one other. They taught me a number of valuable lessons, too." [RWD 1/4]<br><br>');
		$("#book_dogs").html('<button onclick="book_dogs_c1()">Continue Reading <i>Running with Wild Dogs</i></button>');
	}
	
	function book_dogs_c1() {
		var collapse = updateStamina(-1.5);
		if(collapse){
			return;
		}
		updateTime(1);
		var previous = $(display).html();
		$(display_last).html(previous);
		$(display).html('"For example, I learned that while a street pup might bark at you fiercely, it does so because it has not yet made up its mind about you. Approach it slowly with an appropriate treat in hand, and the pup may permit you the chance to gain its trust." [RWD 2/4]<br><br>');
		$("#book_dogs").html('<button onclick="book_dogs_c2()">Continue Reading <i>Running with Wild Dogs</i></button>');
	}
	
	function book_dogs_c2() {
		var collapse = updateStamina(-1.5);
		if(collapse){
			return;
		}
		updateTime(1);
		var previous = $(display).html();
		$(display_last).html(previous);
		$(display).html('"However, a fully grown dog who has spent most of its adult life on the mean streets no longer bothers to bark. Never assume it is safe to approach such an animal simply because it is silent. Instead, make sure to keep a respectful distance, while still showing it that you are unafraid, and it may eventually permit you safe passage..." [RWD 3/4]<br><br>');
		$("#book_dogs").html('<button onclick="book_dogs_finish()">Finish Reading <i>Running with Wild Dogs</i></button>');
	}
	
	function book_dogs_finish() {
		var collapse = updateStamina(-1.5);
		if(collapse){
			return;
		}
		updateTime(1);
		var previous = $(display).html();
		$(display_last).html(previous);
		$(display).html('"Years later, afer I was accepted back into society by my own kind for helping to foil the assassination of the Crown Prince, these lessons helped served to save my life on more than one occassion, while I served as a member of the Imperial Guard..." [RWD 4/4]<br><br>');
		$("#book_dogs").remove();
		books_read[6] = 1;
	}

	function book_poems() {
		var collapse = updateStamina(-1.5);
		if(collapse){
			return;
		}
		updateTime(.5);
		var previous = $(display).html();
		$(display_last).html(previous);
		$(display).html('A poem from Volume II of <i>Collection of Tang Dynasty Poetry</i> reads:<br>"Moonlight brightens the foot of my bed.<br>Appearing like hoar-frost...<br>When I raise my head, I see the ethereal glow of the moon. <br>Lowering my head, I think wistfully of home..." [CTDP II 1/1] <br><br>');
		$("#book_poems").remove();
		books_read[7] = 1;
	}

	function book_children() {
		var collapse = updateStamina(-1.5);
		if(collapse){
			return;
		}
		updateTime(1);
		var previous = $(display).html();
		$(display_last).html(previous);
		$(display).html('A story from <i>Collection of Folktales for Children</i> reads: "... One of the three blind men reached out and grabbed the trunk of the elephant. He exclaimed, "Why an elephant is merely a kind of snake!" His companion, feeling the tusk of the elephant, disagreed. "No way, friend, the elephant is smooth and hard like a spear," he insisted. The third then laid his hand upon the leg of the elephant. "Both of you are wrong!" he declared, with a laugh, "An elephant is clearly a strong and sturdy oak tree! ..." [CFC 1/1]<br><br>');
		$("#book_children").remove();
		books_read[8] = 1;
	}

	function garden() {
		var collapse = updateStamina(-1.5);
		if(collapse){
			return;
		}
		updateTime(.25);
		reset_display();
		if(lifen_location == 0) {
			$(display_persist).html('I find Li-fen reading a book of poetry under a pavilion in the Fan Family Gardens. A small dog sniffs around the pavilion structure.<br><br>');
			if(game_finished) {
				$(actions).html("<div id='lifen_dream'><button onclick='lifen_dream()'>How are you doing?</button></div>");
				$(actions).append("<div id='lulu'><button onclick='lulu()'>Call to Dog</button></div>");
			} else {
				$(actions).html("<div id='lulu'><button onclick='lulu()'>Call to Dog</button></div>");
			}
			if(!lifen_friendship) {
				$(actions).append("<div id='compliment_lifen'><button onclick='compliment_lifen(0)'>Compliment Li-fen</button></div>");
			}
			if (inventory_map.get("peoniesbouquet_item")) {
					$(actions).append("<div id='gift_lifen_peony'><button onclick='gift_lifen(1)'>Give Peonies Bouquet</button></div>");
				} 
			if (inventory_map.get("nightingale_item")) {
				$(actions).append("<div id='gift_lifen_nightingale'><button onclick='gift_lifen(2)'>Give Nightingale Painting</button></div>");
			}
			if (!take_sculpture && seen_sculpture && seen_notice) {
				$(actions).append("<button onclick='ask_sculpture()'>Ask about Sculpture</button><br>");
				$(actions).append("<button onclick='accuse()'>Accuse Li-fen of Theft</button><br>");
			}
			if(!game_finished) {
				$(actions).append("<div id='chat_with_lifen'><button onclick='chat_with_lifen()'>Tell me about Aunt Lin.</button></div>");
			}
			$(artwork).html(lifen2_art);
		} else {
			if(game_finished) {
				$(display_persist).html('In the Fan Family Garden, I find Mrs. Fan by the lotus pond, feeding the turtles. She smiles warmly when she sees me.<br><br>');
				$(display_persist).append('"Thank you for defeating the demons and bringing my daughter back," Mrs. Fan says. She bows. "The <i>yingxiong</i> is always welcome here.<br><br>');
			} else {
				$(display_persist).html('In the Fan Family Garden, I find Mrs. Fan by the lotus pond, feeding the turtles. She greets me politely when I approach.<br><br>');
			}
			$(actions).html("<div id='mrsfan_thanks'><button onclick='mrsfan_thanks()'>You have a beautiful residence.</button></div>");
			if(!game_finished) {
				$(actions).append("<div id='mrsfan'><button onclick='mrsfan()'>Tell me about Aunt Lin.</button></div>");
			}
			if(!fed_turtle) {
				$(actions).append("<div id='feed_turtles'><button onclick='feed_turtles()'>Feed Turtles</button></div>");
			}
			$(artwork).html(fan_art);
		}
		$(actions).append("<br><button onclick='sparring_ground()'>Visit Sparring Grounds</button><br>");
		$(actions).append("<button onclick='study()'>Visit Li-fen's Study</button><br>");
		$(actions).append("<button onclick='library()'>Visit Library</button><br>");
		$(actions).append("<button onclick='hamlet()'>Return to Pleasant Weather Hamlet</button>");
	}

	function lifen_dream() {
		var collapse = updateStamina(-1.5);
		if(collapse){
			return;
		}
		updateTime(.25);
		var previous = $(display).html();
		$(display_last).html(previous);
		$(display).html('How are you getting along? I ask Li-fen.<br>"Better..." she says, "I still get nightmares of being lost in a wintry field...the biting cold chilling me to the bone... Li-fen shivers and wraps her arms around herself."');
		if (chose_right_door || dispel_illusion) {
			$(display).append('<br><br>Then she looks at me and smiles warmly. "But in those nightmares, you always come to save me," Li-fen says. "You are my <i>yingxiong</i>!"<br><br>');
		} else {
			$(display).append('<br><br>Li-fen remains silent, staring off into the distance.<br><br>');
		}
		$("#lifen_dream").remove();
	}

	function lulu() {
		var collapse = updateStamina(-1.5);
		if(collapse){
			return;
		}
		updateTime(.25);
		var previous = $(display).html();
		$(display_last).html(previous);
		$(display).html("Cute puppy, I say.<br>");
		$(display).append('Li-fen whistles. "Lulu, come girl." Lulu scampers over, wagging her tail, and promptly flops onto her back. I scratch her belly, which elicits an appreciative whine.<br><br>');
		$("#lulu").remove();
	}

	function chat_with_lifen() {
		var collapse = updateStamina(-1.5);
		if(collapse){
			return;
		}
		updateTime(.5);
		var previous = $(display).html();
		$(display_last).html(previous);
		$(display).html("What can you tell me about Aunt Lin.<br>");
		$(display).append('"Auntie Lin is one of my favorite persons," Li-fen says. "She comes to visit all of the time. We would take long walks together and talk about our favorite poets. I really hope she comes back from her trip soon!"<br><br>');
		$("#chat_with_lifen").remove();
		curiosity[7] = 1;
	}

	function compliment_lifen() {
		if(charm) {
			$("#compliment_lifen").html("<button onclick='compliment_lifen_c1(2)'>Compliment Hair</button><br>");
			$("#compliment_lifen").append("<button onclick='compliment_lifen_c1(3)'>Compliment Necklace</button><br>");
			$("#compliment_lifen").append("<button onclick='compliment_lifen_c1(1)'>Compliment Voice</button>")
		} else {
			var collapse = updateStamina(-1.5);
			if(collapse){
				return;
			}
			updateTime(.25);
			var previous = $(display).html();
			$(display_last).html(previous);
			$(display).html('For a rich girl, you seem to have been raised well, I say.<br>');
			$(display).append('Li-fen gives me a confused look. "Thanks? I have been very privileged." <strong>Better work on my charm...</strong><br><br>');
			$("#compliment_lifen").remove();
		}
	}
	
	function compliment_lifen_c1(text) {
		var collapse = updateStamina(-1.5);
		if(collapse){
			return;
		}
		updateTime(.25);
		var previous = $(display).html();
		$(display_last).html(previous);
		if(text == 1) {
				$(display).html("You have a lovely voice. I bet you're a good singer.<br>");
				$(display).append('Li-fen laughs merrily. She sings a few notes. She is not a good singer!<br><br>');
		} else if (text == 2) {
			$(display).html('I like your hair.<br>');
			$(display).append('Li-fen touches her long hair. "Thanks! I brush it every day." Seems like she appreciated me noticing.<br><br>');
		} else {
			$(display).html("That's a beautiful necklace you're wearing.<br>");
			$(display).append('Li-fen blushes. She touches the necklace, inlaid with an amber amulet, around her collar. "My grandma gave this to me when I was a young girl." Li-fen says. She looks up at me, her eyes slightly moist. "You have a perceptive eye," she says.<br><br>');
			$(display).append("The dog at Li-fen's feet barks suddenly.<br>");
			$(display).append('Li-fen laughs, her face happy again. "Come visit me again, won&#39;t you?"<br>');
			$(display).append("<strong>I have earned Li-fen's friendship!</strong><br><br>");
			lifen_friendship = 1;
		}
		$("#compliment_lifen").remove();
	}

	function gift_lifen(text) {
		var collapse = updateStamina(-1.5);
		if(collapse){
			return;
		}
		updateTime(.25);
		var previous = $(display).html();
		$(display_last).html(previous);
		if(text == 1) {
			$(display).html('<strong>I give Li-fen the Peonies Bouquet.</strong><br>');
			$(display).append('Li-fen accepts. "Thanks! It smells great!" she says. "My mother will love these!"<br><br>');
			$("#gift_lifen_peony").remove();
			$(".peoniesbouquet_item").remove();
			inventory_map.delete("peoniesbouquet_item");
			peony_available = 1;
		} else {
			$(display).html('I believe Aunt Lin wanted you to have this, I say. <strong>I give Li-fen the Nightingale Painting.</strong><br>');
			$(display).append('Li-fen&#39;s face lights up. "Oh! Thank you so much for bringing it to me. Look how alive the nightingale appears. It&#39;s truly exquisite." Li-fen bows deeply, then hugs me.<br>It&#39;s no problem, I say, slightly embarrassed by her show of appreciation. <strong>I have earned Li-fen&#39;s gratitude!</strong><br><br>');
			$("#gift_lifen_nightingale").remove();
			$(".nightingale_item").remove();
			inventory_map.delete("nightingale_item");
			study_painting = 1;
			lifen_nightingale = 1;
		}
	}

	function accuse() {
		var collapse = updateStamina(-1.5);
		if(collapse){
			return;
		}
		updateTime(.25);
		var previous = $(display).html();
		$(display_last).html(previous);
		accuse_lifen = 1;
		$(display).html("Aha, I figured it out! That Jade Peach Tree sculpture was stolen! You must be the thief! I say, pointing a finger a Li-fen.<br>");
		$(display).append('Li-fen stands up angrily. "How dare you!" she shouts. "That sculpture was given to me as a gift!"<br><br>');
		$(actions).html("<button onclick='interrogate()'>Who gave it to you?</button>");
	}

	function ask_sculpture() {
		var collapse = updateStamina(-1.5);
		if(collapse){
			return;
		}
		updateTime(.25);
		var previous = $(display).html();
		$(display_last).html(previous);
		$(display).html("That Jade Peach Tree sculpture in your study. Where is it from?<br>");
		$(display).append('Li-fen looks up from her book in suprise. "Oh... you went into my private study?" she asks. "Didn&#39;t you see the sign over the door?"<br><br>');
		$(actions).html("<button onclick='answer_lifen(1)'>No...</button><br>");
		$(actions).append("<button onclick='answer_lifen(2)'>Yes.</button><br>");
		$(actions).append("<button onclick='accuse()'>Accuse Li-fen of Theft</button><br>");
		$(actions).append("<button onclick='end_conversation_lifen()'>End Conversation</button>");
	}
	
	function answer_lifen(text) {
		var collapse = updateStamina(-1.5);
		if(collapse){
			return;
		}
		updateTime(.25);
		var previous = $(display).html();
		$(display_last).html(previous);
		if(text == 1) {
			$(display).html('"No, the door was open," I lie.<br>Li-fen gives me a disbelieving look. "I see..." she says.<br><br>');
			honesty = 0;
		} else {
			$(display).html('"Yes, but I ignored it," I say.<br>Li-fen folds her arms. "Hmph, I see." she says, giving me an annoyed look.<br><br>');
			courtesy -= 1;
		}
		$(actions).html("<button onclick='ask_sculpture_c1()'>Where is the sculpture from?</button><br>");
		$(actions).append("<button onclick='accuse()'>Accuse Li-fen of Theft</button><br>");
		$(actions).append("<button onclick='end_conversation_lifen()'>End Conversation</button>");
	}
	
	function ask_sculpture_c1() {
		var collapse = updateStamina(-1.5);
		if(collapse){
			return;
		}
		updateTime(.25);
		var previous = $(display).html();
		$(display_last).html(previous);
		$(display).html('Where is the sculpture from, I ask again.<br>"It was given to me..." Li-fen says. She glances nervously at the ground.<br><br>');
		$(actions).html("<button onclick='interrogate()'>Continue Interrogation</button><br>");
		$(actions).append("<button onclick='accuse()'>Accuse Li-fen of Theft</button><br>");
		$(actions).append("<button onclick='end_conversation_lifen()'>End Conversation</button>");
	}
	
	function end_conversation_lifen() {
		if(game_finished) {
			$(actions).html("<div id='lifen_dream'><button onclick='lifen_dream()'>How are you doing?</button></div>");
			$(actions).append("<div id='lulu'><button onclick='lulu()'>Call to Dog</button></div>");
		} else {
			$(actions).html("<div id='lulu'><button onclick='lulu()'>Call to Dog</button></div>");
		}
		if(!lifen_friendship) {
			$(actions).append("<div id='compliment_lifen'><button onclick='compliment_lifen(0)'>Compliment Li-fen</button></div>");
		}
		if (inventory_map.get("peoniesbouquet_item")) {
			$(actions).append("<div id='gift_lifen_peony'><button onclick='gift_lifen(1)'>Give Peonies Bouquet</button></div>");
		} 
		if (inventory_map.get("nightingale_item")) {
			$(actions).append("<div id='gift_lifen_nightingale'><button onclick='gift_lifen(2)'>Give Nightingale Painting</button></div>");
		}
		if (!take_sculpture && seen_sculpture && seen_notice) {
			$(actions).append("<button onclick='ask_sculpture()'>Ask about Sculpture</button><br>");
			$(actions).append("<button onclick='accuse()'>Accuse Li-fen of Theft</button><br>");
		}
		if(!game_finished) {
			$(actions).append("<div id='chat_with_lifen'><button onclick='chat_with_lifen()'>Tell me about Aunt Lin.</button></div>");
		}
	}

	function interrogate() {
		var collapse = updateStamina(-1.5);
		if(collapse){
			return;
		}
		updateTime(.25);
		var previous = $(display).html();
		$(display_last).html(previous);
		$(display).html("Who gave it to you?<br>");
		$(display).append('"Gao Ru-yi, the nephew of Mr. Gao. He gave it to me during last year&#39;s Double Seventh Festival when he invited me to watch the annual fireworks show held outside Ms. Ming&#39;s Market... My mother was the one who insisted that I go, even though I didn&#39;t know him that well... When he presented me with the sculpture, he told me it was a family heirloom and asked me to accept it as a sign of his friendship. I thought I might offend him if I turned down his gesture. But when I accepted the gift, the knave kissed me on my cheek without asking!" Li-fen blushes. "Since we were out in public, people started whispering after seeing him do that..." she says in an embarrassed voice.<br><br>');
		$(actions).html("<button onclick='interrogate_c1()'>Continue</button>");
	}
	
	function interrogate_c1() {
		updateTime(.25);
		var previous = $(display).html();
		$(display_last).html(previous);
		if (accuse_lifen) {
			updateTime(.25);
			$(display).html('Li-fen&#39;s voice becomes angry again. "I was so upset that I immediately left with my maid Yun who was chaperoning us... The next day, I realized I still had the sculpture so I asked Yun to go to the Gao Family Residence to return it... But that Gao butler was rude to Yun and wouldn&#39;t even open the gate. Instead he shouted from the other side that Mr. Gao wasn&#39;t seeing anyone that day. When she shouted back that she was looking for Gao Ru-yi, the butler yelled angrily that Ru-yi had ran away from home the night prior.<br><br>Since I couldn&#39;t give the sculpture back, I asked Yun to put it in my study, thinking that Ru-yi would eventually return to his uncle&#39;s place and I would return it then. Given the Gao Family&#39;s status, I honestly believed Ru-yi when he said the sculpture was a family piece. You must think me naive, but like I said, at the time, I didn&#39;t know Ru-yi well...and he didn&#39;t have the bad reputation that he does now. I promise you that both Yun and I had no idea that the sculpture was stolen My parents are patrons of the Temple. They might have realized where the sculpture came from if they saw it, but they know that I like to keep my study private so they never go in there anymore." Li-fen looks me clearly in the eye as she speaks.<br><br>');
			$(actions).html("<button onclick='accuse_c1(1)'>Apologize</button>");
			$(actions).html("<button onclick='accuse_c1(2)'>Offer to Return Sculpure</button>");
		} else {
			$(display).html('I am sorry to tell you that the sculpture has been stolen from the Peach Garden Temple.<br>');
			$(display).append('Li-fen gasps. "Heaven, I had no idea," she says. "That rogue Gao Ru-yi! How awful of him! Listen, could you please do me a favor and take it back to Peach Garden Temple? This could cause a lot of embarrassment for my family otherwise..."<br>');
			$(display).append('Happy to help, I say.<br><br>');
			$(actions).html("<button onclick='study2()'>Go to Li-fen's Study</button>");
			take_sculpture = 1;
		}	
	}
	
	function accuse_c1(text) {
		updateTime(.25);
		var previous = $(display).html();
		$(display_last).html(previous);
		if(text) {
			$(display).html('I kneel in front of Li-fen. Sorry for wrongly accusing you, I say.<br>');
			$(display).append('"Li-fen quickly pulls me up. "I&#39;m sure it was an honest mistake. I forgive you! Listen, as a favor to me, could you please take the sculpture back to the Peach Garden Temple? This could cause a lot of embarrassment for my family otherwise..."<br>');
			courtesy += 1;
		} else {
			$(display).html('"Listen," Li-fen says, "Whether or not you believe me, could you please take the sculpture back to the Peach Garden Temple? This could cause a lot of embarrassment for my family otherwise..."<br>');
		}
		$(display).append('Happy to help, I say.<br><br>');
		$(actions).html("<button onclick='study2()'>Go to Li-fen's Study</button>");
		take_sculpture = 1;	
	}

	function mrsfan_thanks() {
		var collapse = updateStamina(-1.5);
		if(collapse){
			return;
		}
		updateTime(.25);
		var previous = $(display).html();
		$(display_last).html(previous);
		$(display).html("It is lovely here, I say.<br>");
		$(display).append('Mrs. Fan gives me a pleased smile. "I am glad you appreciate it."<br><br>');
		$("#mrsfan_thanks").remove();
		courtesy += 1;
	}

	function feed_turtles() {
		var collapse = updateStamina(-1.5);
		if(collapse){
			return;
		}
		updateTime(.25);
		var previous = $(display).html();
		$(display_last).html(previous);
		$(display).html("May I feed the turtles? I ask.<br>");
		$(display).append('Mrs. Fan nods. "Certainly. Here take these." <strong>Mrs. Fan hands me a few goji berries!</strong> "Some call these wolfberries, but my turtles seem to love them," she says.<br><br>I offer a goji berry to a turtle. It slowly opens its toothless mouth and leisurely gobbles it up.<br><br>');
		$("#feed_turtles").remove();
		fed_turtle = 1;
		goji += 3;
		if($(".goji_box").length) {
			$(".goji_box").html("Goji Berry ("+goji+"x) <button class='eat' onclick='eat_food(1,5)'>Eat</button>");
			inventory_map.set("goji_box f_item","Goji Berry ("+goji+"x) <button class='eat' onclick='eat_food(1,5)'>Eat</button>");
		} else {
			addToInventory("goji_box f_item","Goji Berry ("+goji+"x) <button class='eat' onclick='eat_food(1,5)'>Eat</button>");
		}
	}

	function mrsfan() {
		var collapse = updateStamina(-1.5);
		if(collapse){
			return;
		}
		updateTime(.5);
		var previous = $(display).html();
		$(display_last).html(previous);
		$(display).html("What can you tell me about Aunt Lin?<br>");
		$(display).append('Mrs. Fan takes a break from feeding the turtles. "Our family has always been close with your aunt. She oftens come by for visits. We love having her here, and my daughter especially adores her. That&#39;s why after my husband sent Mei-hua an invitation to Fen-fen&#39;s party, he found it strange that there was no response. So a few days later, we decided to send a servant to her farm to see how she was doing. He informed us that when he arrived, he thought he had heard noises inside the cottage. However, no one answered the door when he knocked. A moment later, there was a loud rumbling sound that shook the ground beneath his feet. He called out then, hoping that whoever was in the cottage was okay, but still no one answered the door. Eventually, he returned to give us the news. As soon as we heard, we immediately went to inform Constable Long." Mrs. Fan seems genuinely troubled. "I hope Big Sister Mei-hua is well," she says, "Wherever she may be."<br><br>');
		$("#mrsfan").remove();
		curiosity[8] = 1;
	}

	//Peach Garden Temple

	function temple() {
		var collapse = updateStamina(-1.5);
		if(collapse){
			return;
		}
		updateTime(.25);
		reset_display();
		updateLocation("Peach Garden Temple");
		tour_in_session = 0;
		if ((time_of_day == 0) && !game_finished) {
			$(display_persist).html('A disciple at the entrance stops me. "Welcome. The monks meditate in the morning, so the Temple is closed to the general public right now. Please come back in the afternoon."<br><br>');
			$(actions).html("<button onclick='hamlet()'>Go Back</button>");
		} else if (time_of_day == 2) {
			$(display_persist).html('The Temple is closed at night.<br><br>');
			$(actions).html("<button onclick='hamlet()'>Go Back</button>");
		} else {
			if (game_finished) {
				$(display_persist).html('A disciple at the Temple bows as I approach. "The monks of Peach Garden Temple are forever grateful to the <i>yingxiong</i>," he says.<br><br>');
				$(actions).html("<button onclick='altar()'>Visit Altar</button><br>");
				$(actions).append("<button onclick='peach_garden()'>Visit Sacred Peach Garden</button><br>");
				$(actions).append("<button onclick='hamlet()'>Go Back Outside</button>");
			} else if (completed_tour) {
				$(display_persist).html('The public lobby of the Temple is small and hushed.<br><br>');
				$(actions).html("<button onclick='altar()'>Visit Altar</button><br>");
				$(actions).append("<button onclick='peach_garden()'>Visit Sacred Peach Garden</button><br>");
				$(actions).append("<button onclick='hamlet()'>Go Back Outside</button>");
			} else {
				$(display_persist).html('The public lobby of the Temple is small and hushed. A monk named Qin welcomes me and asks me if I would like a tour.<br><br>');
				$(actions).html("<button onclick='temple_tour()'>Take Tour</button><br>");
				$(actions).append("<button onclick='temple_offering()'>Wander Alone</button><br>");
				$(actions).append("<div id='chat_with_qin'><button onclick='chat_with_qin()'>Tell me about Aunt Lin.</button></div>");
				$(actions).append("<button onclick='hamlet()'>Go Back Outside</button>");
				$(artwork).html(monkqin_art);
			}
		}
	}

	function chat_with_qin() {
		var collapse = updateStamina(-1.5);
		if(collapse){
			return;
		}
		updateTime(.5);
		var previous = $(display).html();
		$(display_last).html(previous);
		$(display).html('What can you tell me about Aunt Lin?<br>');
		$(display).append('Monk Qin reflects for a moment. "Ah, I see. Ms. Lin is your aunt? I have seen her come by the Peach Garden Temple often, bringing donations of fruits and vegetables from her farm, but have never approached or spoken to her myself. I hope she is well."<br><br>');
		$("#chat_with_qin").remove();
		curiosity[9] = 1;
	}

	function temple_tour() {
		reset_display();
		tour_in_session = 1;
		$(display_persist).html("I would like to take the tour.<br>");
		$(display_persist).append('Monk Qin bows. "Please follow me," he says. "If you no longer wish to continue the tour, just let me know."<br><br>');
		$(display).append('Monk Qin takes me to the altar. "Would you like to make an offering?"<br><br>');
		$(actions).html("<button onclick='altar()'>Yes.</button><br>");
		$(actions).append("<button onclick='temple_tour2()'>Not right now.</button><br>");
		$(actions).append("<button onclick='hamlet()'>End Tour</button>");
	}

	function temple_tour2() {
		var previous = $(display).html();
		$(display_last).html(previous);
		$(artwork).html('');
		$(display).html('Monk Qin bows. "Please follow me," he says.<br><br>');
		$(display).append('I follow Monk Qin up a flight of stairs to a balcony overlooking the altar. Monk Qin leads me around the balcony and through a door that leads into a long hallway with a series of rooms on each side. "These are the monk&#39;s private quarters," Monk Qin says. Inside an open room, I see a monk studying at his desk. Noticing us, he gets up and bows before politely closing his door.<br><br>');
		$(actions).html("<button onclick='temple_tour3()'>Continue Tour</button><br>");
		$(actions).append("<button onclick='hamlet()'>End Tour</button>");
	}

	function temple_tour3() {
		var previous = $(display).html();
		$(display_last).html(previous);
		$(display).html('We continue past the monk quarters and down a flight of stairs into a large open area. Monk Qin tells me that we are now in the Inner Sanctum of the Peach Garden Temple, a holy place. "The small chambers here in the Inner Sanctum are used for deep meditation," Monk Qin says.<br><br>');
		$(actions).html("<button onclick='temple_tour3_c1()'>Continue</button><br>");
		$(actions).append("<button onclick='hamlet()'>End Tour</button>");
	}
	
	function temple_tour3_c1() {
		var previous = $(display).html();
		$(display_last).html(previous);
		$(display).html('After touring a few of the meditation rooms, we arrive at a much larger chamber. An imposing set of large, oak doors guards the entrance to the big chamber. A sign above the doors read: "Great Spirit Hall." Despite the thick doors, a muffled but persistent chant can be heard coming from within...<br><br>');
		$(actions).html("<div id='inquire_room'><button onclick='inquire_room()'>Tell me about the Great Spirit Hall.</button></div>");
		$(actions).append("<button onclick='hamlet()'>End Tour</button>");
	}

	function inquire_room() {
		var previous = $(display).html();
		$(display_last).html(previous);
		$(display).html('What is the Great Spirit Hall used for? I inquire of Monk Qin.<br>');
		$(display).append('"The Great Spirit Hall has one main purpose," Monk Qin says, "And that is to house two large portals: one that connects to the Spirit Realm and the other... to the Demon Realm. As for the origin of these two portals and why they are kept here in the Great Spirit Hall by the monks of the Peach Garden Temple, I unfortunately cannot share that information with you since you are not a disciple. However, all of the monks here are tasked with the vital responsibility of making sure that these portals remain sealed, both to and from the Mortal Realm. Failure to maintain this responsibility would be disastrous and could damage the very fabric of our world."<br><br> As he says this, the chanting from within the Great Spirit Hall grows louder. "Come," Monk Qin says, with an uneasy glance at the heavy doors. "We should move on." <br><br>');
		$(actions).html("<button onclick='temple_tour4()'>Continue Tour</button><br>");
		$(actions).append("<button onclick='hamlet()'>End Tour</button>");
	}

	function temple_tour4() {
		var previous = $(display).html();
		$(display_last).html(previous);
		$(display).html('"This will be the last part of our tour," Monk Qin says. From the Inner Sanctum, he takes me through a door that leads outside&mdash;into a small garden. In the center of the garden stands a large and very old peach tree. Strangely, despite the age of the peach tree, only a few peaches hang from its branches. A man stands by the peach tree. As we get closer, I see that the man is Constable Long!<br><br>');
		$(actions).html("<div id='end_tour'><button onclick='end_tour()'>Conclude Tour</button></div>");
		$(artwork).html(peachtree_art);
	}
	
	function end_tour() {
		var previous = $(display).html();
		$(display_last).html(previous);
		$(display).html('I bow to Monk Qin. Thank you for the tour.<br>');
		$(display).append('Monk Qin returns the bow. "It was my pleasure. Now that I have brought you into the Sacred Peach Garden, I will let the groundskeeper know that you are allowed to come back to the Sacred Peach Garden on your own."<br><br>');
		tour_in_session = 0;
		completed_tour = 1;
		$(actions).html("<div id='long'><button onclick='constablelong()'>Talk to Constable Long</button></div>");
		$(actions).append("<div id='qin'><button onclick='qin()'>Talk to Monk Qin</button></div>");
		$(actions).append("<button onclick='altar()'>Visit Altar</button><br><button onclick='hamlet()'>Go Back Outside</button>");
		$("#end_tour").remove();
	}

	function constablelong() {
		var collapse = updateStamina(-1.5);
		if(collapse){
			return;
		}
		updateTime(.25);
		var previous = $(display).html();
		$(display_last).html(previous);
		$(display).html('"Greetings, Constable Long," Monk Qin says. We bow to him.<br>');
		$(display).append('Constable Long bows in return. "Greetings, gentlemen," he says.<br><br>');
		$("#long").html("<button onclick='constablelong_c1()'>Ask about Aunt Lin</button>");
	}
	
	function constablelong_c1() {
		var collapse = updateStamina(-1.5);
		if(collapse){
			return;
		}
		updateTime(.5);
		var previous = $(display).html();
		$(display_last).html(previous);
		$(display).html('Have you find more information regarding Aunt Lin? I ask Constable Long.<br>');
		$(display).append('Constable Long assures me, "I am still diligently investigating Lin Mei-hua&#39;s case. I have been searching through the woods and have not found any signs of her... However, the forest is deeper than it appears, and there are still parts I have not covered. Oh, there is one more thing I should mention," Constable Long says. "During my most recent search, I came across several sets of fresh tracks&mdash;three to be precise&mdash;that look to have been made by animals of the same kind. One of these animals, however, is clearly much larger than the other two. I haven&#39;t been able to determine what kind of creatures made the tracks, but if you intend to go into the woods, it would be good idea to equip yourself with a weapon of some kind. Sorry, but that is is all the update I have to share."<br><br>');
		$("#long").remove();
	}

	function qin() {
		var collapse = updateStamina(-1.5);
		if(collapse){
			return;
		}
		updateTime(.25);
		var previous = $(display).html();
		$(display_last).html(previous);
		$(display).html('"Welcome to the Sacred Peach Garden," Monk Qin says. "This Sacred Peach Tree has been growing here for generations now, tended after by hundreds of monks. Would you like to hear the story behind it?<br><br>');
		$("#qin").html("<div id='peachtree'><button onclick='peachtree()'>Tell me about the Sacred Peach Tree.</button></div>");
		if(inventory_map.get("jadesculpture_item q_item") && !sculpture_broken) {
			$("#qin").append("<div id='return_sculpture'><button onclick='return_sculpture()'>Return Jade Peach Tree Sculpture</button></div>");
		}
		$(artwork).html(peachtree_art);
	}

	function return_sculpture() {
		var collapse = updateStamina(-1.5);
		if(collapse){
			return;
		}
		updateTime(.25);
		var previous = $(display).html();
		$(display_last).html(previous);
		$(".jadesculpture_item").remove();
		inventory_map.delete("jadesculpture_item q_item");
		if(game_finished){
			$(display).html('<strong>I hand over the Jade Peach Tree sculpture to Monk Qin.</strong> "The stolen Jade Peach Tree!" Monk Qin exclaims. "How is it that you come to possess it?"<br><br>');
			$(display).append('I found it in the Fan Family study, I say. But it was Gao Ru-yi who gave it to Li-fen as a gift, claiming it to be a family heirloom. She and her family did not know that the sculpture was stolen and should not be blamed. Gao Ru-yi is the Temple Thief.<br>');
			$(display).append('Monk Qin nods. "That Gao Ru-yi has always been up to no good," he says. "I will let Constable Long know that the case has been solved and Gao Ru-yi was the culprit all along."<br><br>');
		} else {
			$(display).html('<strong>I hand over the Jade Peach Tree sculpture to Monk Qin.</strong> "The stolen Jade Peach Tree!" Monk Qin exclaims. "How is it that you come to possess it?" Constable Long gives me a stern look.<br><br>');
			$(display).append('I found it in the Fan Family study, I say. But it was Gao Ru-yi who gave it to Li-fen as a gift, claiming it to be a family heirloom. She and her family did not know that the sculpture was stolen and should not be blamed. Gao Ru-yi is the Temple Thief.<br>');
			$(display).append('"That Gao Ru-yi has always been up to no good," Constable Long says. "I will teach him a lesson! Just as soon as I manage to catch him... Please excuse me." He bows to us and leaves the Sacred Peach Garden.<br><br>');
		}
		$(actions).html("<button onclick='return_sculpture_c1()'>Continue</button>");
	}
	
	function return_sculpture_c1() {
		var previous = $(display).html();
		$(display_last).html(previous);
		$(display).html('"Thank you for returning our most valued relic," Monk Qin says to me. "I will not forget the great service you have done for us."<br>');
		if (!peach) {
			peach = 1;
			$(display).append('Suddenly, a peach falls from the Sacred Peach Tree. I reach out and catch it. Monk Qin takes a step back as I offer the peach toward him. He looks at me with wonder. "The Sacred Peach Tree rewards only those who are worthy. I cannot take the peach from you. It is granted to you alone," he says, bowing deeply to me.<br><br>"Eating a peach from the Sacred Peach Tree will fill you with vast energy and greatly increase your overall health," Monk Qin says. "For this reason, it is known as one the Three Magic Fruits of this world. According to legend, out of the Three Magic Fruits, the Sacred Peach is the sweetest one!" <strong>Obtained Sacred Peach!</strong><br>');
			$("#ask_peach").remove();
			addToInventory("sacredpeach_item f_item","Sacred Peach (1x) <button class='eat' onclick='eat_peach()'>Eat</button>");
		}
		$(display).append('<br>');
		theft_solved = 1;
		$("#long").remove();
		if($("#qin").length) {
			$("#qin").remove();
		}
		if(tour_in_session) {
			$(actions).html("<div id='end_tour'><button onclick='end_tour()'>End Tour</button></div>");
		} else {
			$(actions).html("<button onclick='altar()'>Visit Altar</button><br>");
			$(actions).append("<button onclick='hamlet()'>Go Back Outside</button>");
		}
	}

	function eat_peach() {
		total_health = 200;
		health_max += 100;
		$("#progress_bar").html('<progress class="stamina" value="'+health_max+'" max="200"></progress><div id="hp">Healthiness: '+health_max+'%</div>');
		health_color = "orange";
		$(".stamina").css("color", health_color);
		$(".sacredpeach_item").remove();
		inventory_map.delete("sacredpeach_item f_item");
	}

	function peachtree() {
		var collapse = updateStamina(-1.5);
		if(collapse){
			return;
		}
		updateTime(1);
		var previous = $(display).html();
		$(display_last).html(previous);
		$(display).html('Tell me the story of the Sacred Peach Tree.<br>');
		$(display).append('Monk Qin bows. "Long ago, a holy man named Shen was persecuted by a gang of bandits. Although he was skilled in martial arts, he simply couldn&#39;t fight all of the bandits together. So he did what any reasonable person would do. He fled. After days of running, Shen was near exhaustion when he stumbled upon this place. At the time, there was nothing else here but a small peach tree with a single peach growing from it. &quot;How strange,&quot; Shen remarked. &quot;To find a small peach tree growing here, in the middle of nowhere.&quot; Tired and hungry, Shen eagerly picked the peach and ate it in a few bites."<br><br>Monk Qin continues, "Suddenly, the gang of bandits appeared, twenty men strong. But having eaten the peach from the peach tree, Shen defeated every single one of them. The leader of the bandits, a young man named Jin, knelt in front of Shen and begged for mercy. In exchange for his freedom, Jin committed his men to follow Shen as Shen&#39;s disciples and dedicate themselves to tending to the peach tree for the rest of their lives. Jin&#39;s men, having witnessed the magic of the peach tree, willingly agreed. Shen declared that the peach tree was sacred, and he and his disciples founded the Peach Garden Temple. Over time, Shen and Jin became like brothers. But Jin himself never intended to become a monk. Instead, to Shen&#39;s dismay, Jin set out to become an outlaw of the <i>jianghu</i>, though before he left, he made a promise to Shen that so long as he was alive, Jin would ensure that the Peach Garden Temple and its surrounding area remained safe from other bandits and thugs. As Jin grew in notoriety, word of his protection spread and prompted ordinary people seeking a stable life to settle here as well, eventually establishing Pleasant Weather Hamlet."<br><br>');
		if (theft_solved) {
			$(display).append('What an incredible story, I tell Monk Qin.<br>"It is indeed," he replies.<br><br>');
			$("#peachtree").html("<div id='ask_peach'><button onclick='ask_peach()'>Can I have a peach?</button></div>");
		}
		else {
			$("#peachtree").html("<div id='peachtree2'><button onclick='peachtree_c1()'>Wonderful story!</button></div><div id='ask_peach'><button onclick='ask_peach()'>Can I have a peach?</button></div>");
		}
	}
	
	function peachtree_c1() {
		var collapse = updateStamina(-1.5);
		if(collapse){
			return;
		}
		updateTime(.25);
		var previous = $(display).html();
		$(display_last).html(previous);
		$(display).html('What an incredible story, I tell Monk Qin.<br>"It is indeed," he replies.<br><br>"Speaking of the Sacred Peach Tree," Constable Long says to Monk Qin, "I have developed a new theory regarding the identity of the Temple Thief..."<br><br>');
		$("#peachtree2").html("<button onclick='peachtree_c2()'>Temple Thief?</button>");
	}
	
	function peachtree_c2() {
		var collapse = updateStamina(-1.5);
		if(collapse){
			return;
		}
		updateTime(.25);
		var previous = $(display).html();
		$(display_last).html(previous);
		$(display).html('Who is the Temple Thief? I ask."<br>"The Temple Thief has stolen a valuable relic of ours," Monk Qin explains. "A jade sculpture in the form of the Sacred Peach Tree. But so far, no one has been able to figure out who that person is."<br><br>Constable Long nods. "Yes, and that is why I have developed this new theory... You see, I believe that the Temple Thief might not have been a person at all...but instead a Spirit, likely a mischievous Monkey Spirit."<br>Monk Qin contemplates for a moment. "Hmm, the monks did say that whoever they saw appeared to be young and agile... Perhaps it truly was a Monkey Spirit...but what reason would a Spirit have to go after the sculpture?"<br><br>');
		seen_notice = 1;
		$("#peachtree2").remove();
	}

	function ask_peach() {
		var collapse = updateStamina(-1.5);
		if(collapse){
			return;
		}
		updateTime(.25);
		var previous = $(display).html();
		$(display_last).html(previous);
		$(display).html('Can I have a peach?<br>');
		$(display).append('Monk Qin bows. "I am sorry, we are forbidden from picking peaches from the Sacred Peach Tree. It can takes decades for even a single peach to grow...<br><br>');
		$("#ask_peach").remove();
	}

	function temple_offering() {
		var collapse = updateStamina(-1.5);
		if(collapse){
			return;
		}
		updateTime(.25);
		var previous = $(display).html();
		$(display_last).html(previous);
		$(display).html("I respecfully decline Monk Qin's tour, choosing to wander the Temple alone.<br><br>");
		$(actions).html("<button onclick='altar()'>Visit Altar</button><br>");
		$(actions).append("<button onclick='peach_garden()'>Visit Sacred Peach Garden</button><br>");
		$(actions).append("<button onclick='hamlet()'>Go Back Outside</button>");
	}

	function altar() {
		var collapse = updateStamina(-1.5);
		if(collapse){
			return;
		}
		updateTime(.25);
		reset_display();
		$(display_persist).html("The altar is at the back of the Temple. A nearby monk has incense sticks for sale.<br><br>");
		$(actions).html('');
		if (tour_in_session) {
			$(actions).append("<button onclick='temple_tour2()'>Continue Temple Tour</button><br>");
		}
		if(inventory_map.get("incense_item")) {
			$(actions).append("<div id='buy_incense'><button onclick='incense_offering()'>Offer Incense</div>");
		} else {
			$(actions).append("<div id='buy_incense'><button onclick='buy_incense()'>Buy Incense Sticks (1g)</button></div>");
		}
		$(actions).append("<div id='show_respect'><button onclick='worship()'>Worship</div>");
		$(actions).append("<button onclick='peach_garden()'>Visit Sacred Peach Garden</button><br>");
		$(actions).append("<button onclick='hamlet()'>Go Back Outside</button>");
		$(artwork).html(incense_art);
	}

	function incense_offering() {
		var collapse = updateStamina(-1.5);
		if(collapse){
			return;
		}
		updateTime(.25);
		var previous = $(display).html();
		$(display_last).html(previous);
		$(display).html("<strong>I burn some incense as an offering for Aunt Lin&#39;s safety.</strong><br><br>");
		$(".incense_item").remove();
		inventory_map.delete("incense_item");
		$("#buy_incense").html("<button onclick='buy_incense()'>Buy Incense Sticks (1g)</button><br>");
		religious = 1;
		updateTime(.5);
	}

	function buy_incense() {
		var collapse = updateStamina(-1.5);
		if(collapse){
			return;
		}
		updateTime(.25);
		var previous = $(display).html();
		$(display_last).html(previous);
		if (money >= 1) {
			$(display).html("<strong>I purchase incense sticks for 1g.</strong><br><br>");
			money -= 1;
			$("#money").html(money+"g");
		} else {
			$(display).html("I'm out of money, but the monk hands me a few incense sticks at no charge.<br><strong>Obtained Incense Sticks!</strong><br><br>");
		}
		addToInventory("incense_item","Incense Sticks");
		$("#buy_incense").html("<button onclick='incense_offering()'>Offer Incense</button><br>");
	}

	function worship() {
		updateTime(.5);
		updateStamina(25);
		var previous = $(display).html();
		$(display_last).html(previous);
		$(display).html("I kneel and worship quietly. <strong>I feel a sense of peace that restores my energy.</strong><br><br>");
		$(actions).html("<button onclick='altar()'>Continue</button>");
		$(artwork).empty();
		$("#show_respect").remove();
		religious = 1;
	}

	function peach_garden() {
		var collapse = updateStamina(-1.5);
		if(collapse){
			return;
		}
		updateTime(.25);
		reset_display();
		if (game_finished) {
			$(display_persist).html("I find Monk Qin resting under the Sacred Peach Tree.<br><br>");
			$(display_persist).append('"Hello, my friend," Monk Qin, says, rising to greet me. "How are you today?"');
			if(qin_fallen) {
				$(display_persist).append('"Monk Qin moves with a limp, ever since he collapsed in our fight against the Lord of Demons...<br><br>');
			} else {
				$(display_persist).append('<br><br>');
			}
			$(actions).html("<div id='peachtree'><button onclick='peachtree()'>Tell me about the Sacred Peach Tree.</button></div>");
			$(actions).append("<div id='inspect_tree'><button onclick='inspect_tree()'>Inspect Peach Tree</button></div>");
			if(inventory_map.get("jadesculpture_item q_item") && !sculpture_broken) {
				$(actions).append("<div id='return_sculpture'><button onclick='return_sculpture()'>Return Jade Peach Tree Sculpture</button></div>");
			}
			$(actions).append("<button onclick='altar()'>Visit Altar</button><br>");
			$(actions).append("<button onclick='hamlet()'>Leave Peach Garden Temple</button>");
			$(artwork).html(peachtree_art);
		} else if(completed_tour) {
			if (theft_solved) {
				$(display_persist).html("I enter the Sacred Peach Garden. There is no one in the garden right now.<br><br>");
				$(actions).html("<div id='inspect_tree'><button onclick='inspect_tree()'>Inspect Peach Tree</button></div>");
				$(actions).append("<button onclick='altar()'>Visit Altar</button><br>");
				$(actions).append("<button onclick='hamlet()'>Leave Peach Garden Temple</button>");
			} else {
				$(display_persist).html("I enter the Sacred Peach Garden. Constable Long and Monk Qin are having a conversation under the Sacred Peach Tree.<br><br>");
				$(actions).html("<div id='qin'><button onclick='qin()'>Talk to Monk Qin</button></div>");
				$(actions).append("<div id='long'><button onclick='constablelong_c1()'>Talk to Constable Long</button></div>");
				$(actions).append("<button onclick='altar()'>Visit Altar</button><br>");
				$(actions).append("<button onclick='hamlet()'>Leave Peach Garden Temple</button>");
			}
			$(artwork).html(peachtree_art);
		} else {
			$(display_persist).html('A monk standing by the door to the Sacred Peach Garden stops me. "Due to recent events, the garden is only accessible via private tours right now. Sorry for the inconvenience."<br><br>');
			$(actions).html("<button onclick='altar()'>Visit Altar</button><br>");
			$(actions).append("<button onclick='hamlet()'>Leave Peach Garden Temple</button>");
			$(artwork).empty();
		}
	}

	function inspect_tree() {
		var collapse = updateStamina(-1.5);
		if(collapse){
			return;
		}
		updateTime(.25);
		var previous = $(display).html();
		$(display_last).html(previous);
		$(display).html("I look up at the Sacred Peach Tree. A few pink peaches hang from its upper branches, out of reach.<br><br>");
		$("#inspect_tree").remove();
	}

	//Howling Woods

	function woods() {
		var collapse = updateStamina(-1.5);
		if(collapse){
			return;
		}
		updateTime(.25);
		updateLocation("Howling Woods");
		change_music("forest.mp3");
		reset_display();
		if((time_of_day == 2) && !inventory_map.get("lantern_item t_item")) {
			$(display_persist).html("The Howling Woods is dark and frightening at night! Better bring some light.<br><br>");
			$(actions).html("<button onclick='hamlet()'>Go Back to Hamlet</button>");
		} else {
			if(knowledge) {
				$(display_persist).html('Having read "Forestry, Foliage and Flora: A Guide to Understanding Mother Nature," I confidently make my way into the Howling Woods, no longer fearful of getting lost. <br><br>');
				$(actions).html("<button onclick='wolfwoods()'>Head into Woods</button><br>");
				$(actions).append("<button onclick='hamlet()'>Go Back to Hamlet</button>");
			} else {
				if (time_of_day == 2) {
					$(display_persist).html('Just south of Peaceful Weather Hamlet, the "Howling" Woods is calm and serene. Owls hoot, and mice scamper. The light of my lantern illuminates the mossy foliage around me. There is a clear trail that leads deeper into woods. In spite of the Constable&#39;s warning, the forest seems quite safe.<br><br>');
				} else {
					$(display_persist).html('Just south of Peaceful Weather Hamlet, the "Howling" Woods is calm and serene. Birds chirps, and squirrels scamper. The sun shines brightly on the green foliage around me. There is a clear trail that leads deeper into woods. In spite of the Constable&#39;s warning, the forest seems quite safe.<br><br>');
				}
				$(actions).html("<button onclick='woods2()'>Head into Howling Woods</button><br>");
				$(actions).append("<button onclick='hamlet()'>Go Back to Hamlet</button>");
			}
		}
	}

	//Lost Woods

	function woods2() {
		var collapse = updateStamina(-1.5);
		if(collapse){
			return;
		}
		updateTime(1);
		var previous = $(display).html();
		$(display_last).html(previous);
		$(display).html('Past the edge of the Howling Woods, I hear larger critters rustling in the bushes. The trees are denser here. Beneath my feet, the trail is overgrown.<br><br>');
		$(actions).html("<button onclick='woods3()'>Continue Forward</button><br>");
		if(lost) {
			$(actions).append("<button onclick='woods4()'>Go Back</button>");
		} else {
			$(actions).append("<button onclick='woods()'>Go Back</button>");
		}
	}

	function woods3() {
		var collapse = updateStamina(-5);
		if(collapse){
			return;
		}
		updateTime(1);
		var previous = $(display).html();
		$(display_last).html(previous);
		$(display).html('Deep in the Howling Woods, wind rushes overhead, shaking the branches and casting strange shadows... The forest canopy hides the sky. Ahead of me, the trail leads to a cluster of trees that block the way forward...<br><br>');
		$(actions).html("<button onclick='woods4(1)'>Go Right</button><br>");
		$(actions).append("<button onclick='woods4(2)'>Go Left</button><br>");
		$(actions).append("<button onclick='woods2()'>Go Back</button>"); 
	}

	function woods4(text) {
		var collapse = updateStamina(-5);
		if(collapse){
			return;
		}
		updateTime(1);
		var previous = $(display).html();
		$(display_last).html(previous);
		if(text == 1) {
			$(display).html("I head right, ");
		} else {
			$(display).html("I head left, ");
		}
		$(display).append("slowly making my way around the cluster of trees, confident that the next one I pass will reveal a path that goes deeper into the woods.<br><br>");
		$(actions).html("<button onclick='woods5()'>Continue Forward</button><br>");
		$(actions).append("<button onclick='woods3()'>Go Back</button>")
	}
	
	function woods5() {
		var collapse = updateStamina(-5);
		if(collapse){
			return;
		}
		updateTime(1);
		var previous = $(display).html();
		$(display_last).html(previous);
		$(display).html("I have lost my sense of direction. The trees all look alike. Haven&#39;t I come this way already?<br><br>");
		$(actions).html("<button onclick='woods6()'>Continue Forward</button><br>");
		$(actions).append("<button onclick='woods6()'>Go Back</button>")
	}
	
	function woods6() {
		var collapse = updateStamina(-5);
		if(collapse){
			return;
		}
		updateTime(1);
		var previous = $(display).html();
		$(display_last).html(previous);
		$(display).html("I am seriously lost...<br><br>");
		$(actions).html("<button onclick='woods7()'>Go Back</button><br>");
	}
	
	function woods7() {
		var collapse = updateStamina(-5);
		if(collapse){
			return;
		}
		updateTime(1);
		var previous = $(display).html();
		$(display_last).html(previous);
		$(display).html("I stumble around the forest aimlessly... Am I doomed to remain in these woods forever?<br><br>");
		$(actions).html("<button onclick='woods8()'>Go Back</button><br>");
	}
	
	function woods8() {
		var collapse = updateStamina(-5);
		if(collapse){
			return;
		}
		updateTime(1);
		var previous = $(display).html();
		$(display_last).html(previous);
		$(display).html('Somehow, I manage to find my way back to spot in front of the cluster of trees where the trail first ended. Should I try again? This time, I am sure I sure won&#39;t get lost!<br><br>');
		$(actions).html("<button onclick='woods4(1)'>Go Right</button><br>");
		$(actions).append("<button onclick='woods4(2)'>Go Left</button><br>");
		$(actions).append("<button onclick='woods2()'>Go Back</button>");
	}

	//Wolf Woods

	function wolfwoods() {
		var collapse = updateStamina(-1.5);
		if(collapse){
			return;
		}
		updateTime(.25);
		var previous = $(display).html();
		$(display_last).html(previous);
		$(display).html('I enter a clearing and freeze. In front of me stands a wolf pup!<br><br>');
		$(actions).html("<button onclick='attack(1)'>Attack</button><br>");
		$(actions).append("<button onclick='approach(1)'>Approach</button><br>");
		$(actions).append("<button onclick='standground(1)'>Stand my Ground</button><br>");
		$(actions).append("<button onclick='backaway(1)'>Back Away</button><br>");
	}

	function attack(text) {
		var collapse = updateStamina(-1.5);
		if(collapse){
			return;
		}
		updateTime(.25);
		var previous = $(display).html();
		$(display_last).html(previous);
		animalaffinity = 0;
		if(text == 1) {
			$(display).html('I run towards the wolf pup to attack! Frightened, the pup quickly runs away.<br><br>');
			$(actions).html("<button onclick='wolfwoods2()'>Continue onward.</button><br>");
		} else {
			$(display).html('I run towards the grown wolf to attack! The wolf snarls at me, its jaws opened wide. Startled, I fall backwards. The wolf growls once more, before turning around and loping off.<br><br>');
			$(actions).html("<button onclick='wolfwoods3()'>Continue Onward</button><br>");
		}
		animalaffinity = 0; 
		$(actions).append("<button onclick='hamlet()'>Go Back to Hamlet</button>");
	}

	function approach(text) {
		var collapse = updateStamina(-1.5);
		if(collapse){
			return;
		}
		updateTime(.25);
		var previous = $(display).html();
		$(display_last).html(previous);
		if(text == 1) {
			if ((goji > 0) || (mountainyam  > 0) || (ginseng  > 0) || (baos  > 0)) {
				$(display).html('I slowly approach the wolf pup. It watches me intently but remains still.<br><br>');
				$(actions).html("");
				if(goji > 0) {
					$(actions).append("<button onclick='offer_food(1)'>Offer Goji Berry</button><br>")
				}
				if(mountainyam > 0) {
					$(actions).append("<button onclick='offer_food(2)'>Offer Mountain Yam</button><br>")
				}
				if(ginseng > 0) {
					$(actions).append("<button onclick='offer_food(3)'>Offer Ginseng</button><br>")
				}
				if(baos > 0) {
					$(actions).append("<button onclick='offer_food(0)'>Offer Steamed Bun</button><br>")
				}
				$(actions).append("<button onclick='do_nothing()'>Do Nothing</button><br>")
			} else {
				$(display).html('I slowly approach the wolf pup. It watches me intently, but remains still... I reach a hand out, but the wolf pup yips and scampers off.<br><br>');
				$(actions).html("<button onclick='wolfwoods2()'>Continue Onward</button><br>");
			}
		} else {
			$(display).html('I approach the grown wolf. It growls at me, baring its teeth. I freeze. The wolf gives me a satified look, before turning around and loping off into the trees...<br><br>');
			$(actions).html("<button onclick='wolfwoods3()'>Continue Onward</button><br>");
			animalaffinity = 0;
		}
		$(actions).append("<button onclick='hamlet()'>Go Back to Hamlet</button>");	
	}

	function offer_food(text) {
		var collapse = updateStamina(-1.5);
		if(collapse){
			return;
		}
		updateTime(.25);
		var previous = $(display).html();
		$(display_last).html(previous);
		if(text == 1) {
			$(display).html('<strong>I place a Goji Berry in my palm and offer it to the wolf pup.</strong> The wolf pup sniffs at the Goji Berry... It snatches the berry up in a quick bite, giving my hand a lick before scampering off.<br><br>');
			animalaffinity += 1;
		}else if(text == 2) {
			$(display).append('<strong>I place a Mountain Yam in my palm and offer it to the wolf pup.</strong> The wolf pup sniffs at the Mountain Yam... It turns its head away and scampers off.<br><br>');
			animalaffinity = 0;
		}else if(text == 3) {
			$(display).append('<strong>I place a Ginseng in my palm and offer it to the wolf pup.</strong> The wolf pup sniffs at the Ginseng... It turns its head away and scampers off.<br><br>');
			animalaffinity = 0;
		}else if(text == 0) {
			$(display).append('<strong>I place a Steamed Bun in my palm and offer it to the wolf pup.</strong> The wolf pup sniffs at the Steamed Bun... It turns its head away and scampers off.<br><br>');
			animalaffinity = 0;
		}
		eat_food(text,0);
		$(actions).html("<button onclick='wolfwoods2()'>Continue Onward</button><br>");
	}

	function do_nothing() {
		updateTime(.25);
		var previous = $(display).html();
		$(display_last).html(previous);
		$(display).html('I stand still. The wolf pup gives me an uncertain yip and scampers off.<br><br>');
		$(actions).html("<button onclick='wolfwoods2()'>Continue Onward</button><br>");
		animalaffinity = 0;
	}

	function standground (text) {
		updateTime(.25);
		var previous = $(display).html();
		$(display_last).html(previous);
		if(text == 1) {
			$(display).html('I stand my ground. The wolf pup tilts its head slightly to one side giving me a quizzical look. Eventually, it scampers off.<br><br>');
			$(actions).html("<button onclick='wolfwoods2()'>Continue Onward</button><br>");
			animalaffinity = 0;
		} else {
			$(display).html('I stand my ground. The grown wolf and I stare off for a long time. Suddenly, it lowers its head, before turning around and loping off into the bushes.<br><br>');
			$(actions).html("<button onclick='wolfwoods3()'>Continue Onward</button><br>");
			animalaffinity += 1;
		}
		$(actions).append("<button onclick='hamlet()'>Go Back to Hamlet</button>");
	}

	function backaway (text) {
		var collapse = updateStamina(-1.5);
		if(collapse){
			return;
		}
		updateTime(.25);
		var previous = $(display).html();
		$(display_last).html(previous);
		if(text == 1) {
			$(display).html('I slowly back away. The wolf pup tilts its head slightly to one side giving me a quizzical look. Eventually, it scampers off.<br><br>');
			$(actions).html("<button onclick='wolfwoods2()'>Continue Onward</button><br>");
		} else {
			$(display).html('I slowly back away. The grown wolf watches me. Having made its point, it turns around silently and lopes off into the bushes.<br><br>');
			$(actions).html("<button onclick='wolfwoods3()'>Continue Onward</button><br>");
		}
		animalaffinity = 0;
		$(actions).append("<button onclick='hamlet()'>Go Back to Hamlet</button>");
	}

	function wolfwoods2() {
		var collapse = updateStamina(-1.5);
		if(collapse){
			return;
		}
		updateTime(.25);
		var previous = $(display).html();
		$(display_last).html(previous);
		$(display).html('I continue onward. At another clearing, I find myself confronted by a full-grown wolf!<br><br>');
		$(actions).html("<button onclick='attack(2)'>Attack</button><br>");
		$(actions).append("<button onclick='approach(2)'>Approach</button><br>");
		$(actions).append("<button onclick='standground(2)'>Stand my Ground</button><br>");
		$(actions).append("<button onclick='backaway(2)'>Back Away</button>");
		$(artwork).html(wolf_art);
	}

	function wolfwoods3() {
		var collapse = updateStamina(-1.5);
		if(collapse){
			return;
		}
		updateTime(.25);
		var previous = $(display).html();
		$(display_last).html(previous);
		$(display).html('Shaken by my encounter with the two wolves, I cross into a third clearing. I look up to see the large, glistening snout of a massive Mother Wolf, nearly the size of a large bear. Her yellow eyes stares deeply into mine, judging me for my actions towards her kin... The Mother Wolf slowly opens her mouth...<br><br>');
		$(actions).html("<button onclick='judgment()'>Stand Judgement</button><br>");
		$(actions).append("<button onclick='hamlet()'>Run!</button><br>");
		$(artwork).html(mamawolf_art);
	}

	function judgment() {
		var collapse = updateStamina(-1.5);
		if(collapse){
			return;
		}
		updateTime(.25);
		var previous = $(display).html();
		$(display_last).html(previous);
		if(animalaffinity >= 2) {
			$(display).html('...and slobbers me with her tongue. Her cubs appear from behind her. In unison, the wolves raise their heads and begin to howl. Once they finish, they disappear off into the woods, leaving me marveling at the haunting beauty of the primal wolfsong I just heard...<br><br>');
			$(actions).html("<button onclick='waterfall_base()'>Continue Onward</button><br>");
		} else {
			$(display).html('...and bares her sharp fangs. She lowers her hind legs, clearly about to attack! <br><br>');
			$(actions).html("<button onclick='hamlet()'>Run!!</button><br>");
		}
	}

	//Master Yang

	function waterfall_base() {
		var collapse = updateStamina(-1.5);
		if(collapse){
			return;
		}
		updateTime(.5);
		updateLocation("Crane Cloud Mountains");
		change_music("cottage.mp3");
		reset_display();
		$("#use_forage").removeAttr('disabled');
		$("#use_rocksmash").attr('disabled','disabled');
		if(game_finished) {
			$(display_persist).html('Howling Woods leads straight to a waterfall at the foot of Crane Cloud Mountains. Behind the waterfall, there is a cave...<br><br>');
			$(actions).html("<button onclick='treasure_cave()'>Enter Cave</button><br>");	
			$(actions).append("<button onclick='hamlet()'>Return to Peaceful Weather Hamlet</button>");
			$(artwork).html("");
		} else {
			$(display_persist).html('Howling Woods leads straight to a waterfall at the foot of Crane Cloud Mountains. A man wearing a traditional robe picks herbs by the waterfall.<br><br>');
			$(actions).html("<div id='master_yang'><button onclick='master_yang()'>Approach Master Yang</button></div>");
			if(waterfall) {
				$(actions).append("<button onclick='treasure_cave()'>Enter Cave of Treasures</button><br>");
			}
			$(actions).append("<button onclick='hamlet()'>Return to Peaceful Weather Hamlet</button>");
			$(artwork).html(waterfall_art);
		}
	}

	function master_yang() {
		var collapse = updateStamina(-1.5);
		if(collapse){
			return;
		}
		updateTime(.25);
		var previous = $(display).html();
		$(display_last).html(previous);
		if(talked_to_yang) {
			$(display).html('Master Yang is busy foraging for herbs...<br><br>');
			$("#master_yang").remove();
			return;
		}
		if(waterfall) {
			if (time_of_day == 2) {
				$(display).html('"Hello!" Master Yang hails me as I approach. "Have you come to catch a night time glimpse of the elusive moonflower?"<br><br>');
			} else {
				$(display).html('"Hello!" Master Yang hails me as I approach. "Nice day to gather some herbs, don&#39;t you think?"<br><br>');
			}
			$(actions).html('');
		} else {
			$(display).html('"Hello!" Master Yang hails me as I approach. "Quite a rare sight to see another adventurer make it through the woods. Are you perhaps seeking the Cave of Treasures?"<br><br>');
			$(actions).html("<div id='cave'><button onclick='yang_cave()'>Cave of Treasures?</button></div>");
		}
		if(!inventory_map.get("wolfsbane_item")) {
			$(actions).append("<div id='wolfsbane'><button onclick='bane()'>Were you troubled by wolves?</button></div>");
		}
		if(!foraging) {
			$(actions).append("<div id='find_herbs'><button onclick='find_herbs()'>How to do I find herbs?</button></div>");
		}
		if(inventory_map.get("redmushroom_item f_item")) {
			$(actions).append("<div id='investigate_redmushroom'><button onclick='investigate_mushroom(1)'>Is this Red Mushroom edible?</button></div>");
		}
		if(inventory_map.get("whitemushroom_item f_item")) {
			$(actions).append("<div id='investigate_whitemushroom'><button onclick='investigate_mushroom(2)'>Is this White Mushroom edible?</button></div>");
		}
		if(inventory_map.get("gatewayscroll_item q_item") && !inventory_map.get("portalspell_item q_item")) {
			$(actions).append("<div id='translated_manual'><button onclick='yang_manual()'>Can you translate this scroll?</button></div>");
		}
		$(actions).append("<div id='yang'><button onclick='yang()'>Tell me about Aunt Lin.</button></div>");
		$(actions).append("<button onclick='end_conversation_yang()'>End Conversation</button>");
		talked_to_yang = 1;
	}
	
	function end_conversation_yang() {
		$(actions).html("<div id='master_yang'><button onclick='master_yang()'>Approach Master Yang</button></div>");
		if (waterfall) {
			$(actions).append("<button onclick='treasure_cave()'>Enter Cave of Treasures</button><br>");
		}
		$(actions).append("<button onclick='hamlet()'>Return to Peaceful Weather Hamlet</button>");
		$("#use_forage").removeAttr('disabled');
	}

	function yang_cave() {
		var collapse = updateStamina(-1.5);
		if(collapse){
			return;
		}
		updateTime(.25);
		var previous = $(display).html();
		$(display_last).html(previous);
		$(display).html('A treasure cave? I ask.<br>"Not just <i>any</i> treasure cave, but The Cave of Treasures!" Master Yang explains. "It is just behind this waterfall. Legend has it that the cave used to be the lair of Bandit Chief Jin, one of the seven mighty Bandit Chiefs. Jin feared nothing under Heaven, except for spiders... As legend has it, his greed was so immense that when Jin finally passed from old age, his spirit could not bear to let go of his treasure. Instead of ascending to Heaven for judgment, Jin&#39;s spirit floated into the cave. Because of his defiance, the Heavenly Emperor punished him by turning the cave into a nest of huge spiders that lay eggs everywhere! Haw-haw, isn&#39;t that ironic?"<br><br>');
		waterfall = 1;
		$("#cave").html("<button onclick='treasure_cave()'>Enter Cave of Treasures</button><br>");
	}

	function find_herbs() {
		var collapse = updateStamina(-1.5);
		if(collapse){
			return;
		}
		updateTime(.25);
		var previous = $(display).html();
		$(display_last).html(previous);
		$(display).html('Can you teach me to forage? I ask.<br>');
		$(display).append('"Foraging is easy," Master Yang says. "Just look closely at the ground and dig around, haw-haw! Of course, the real challenge for us herbalists is in knowing whether a particular herb can be used to alleviate indigestion or will cause a week-long stomachache. Now that is precious knowledge! However, such an education is a lifelong journey, and you seem like you have more pressing matters to attend to at the moment. Master Yang taught me the basics to foraging! <strong>I acquired a new Skill! I can activate this skill in certain locations.</strong>"<br><br>');
		$("#find_herbs").remove();
		foraging = 1;
		addSkill("<div id='forage_skill' class='active_skill'>Forage <button id='use_forage' onclick='activate_forage()'>Activate</button></div>",1);
		$("#use_forage").removeAttr('disabled');
	}
	
	function activate_forage() {
		if(current_loc == "Soldier Camp") {
			var previous = $(display).html();
			$(display_last).html(previous);
			if(money == 0) {
				$(display).html("I search around the campsite... I find a coin on the ground! <strong>Obtained 1g!</strong><br><br>");
				money += 1;
				$("#money").html(money+'g');
			} else {
				$(display).html("I search around the campsite... Just a bunch of dirt.<br><br>");
			}
			$(actions).html("<button onclick='campsite2()'>Continue</button>");
		} else {
			var collapse = updateStamina(-5);
			if(collapse){
				return;
			}
			updateTime(1);
			var previous = $(display).html();
			$(display_last).html(previous);
			if (time_of_day == 2) {
				$(display).html('I take out my lantern and search among a cluster of tree stumps near the waterfall...');
			} else {
				$(display).html('I search among a cluster of tree stumps near the waterfall...');
			}
			if (!inventory_map.get("shinyrock_item") && !anli_respect) {
				$(display).append('Something shiny flashes in the grass. I pick it up. <strong>Obtained Shiny Rock!</strong> I wonder if it can be forged...<br><br>');
				addToInventory("shinyrock_item","Shiny Rock");
			} else if (!safe_mushroom && (time_of_day == 2)) {
				$(display).append(' I find a wild mushroom with a soft red cap! <strong>Obtained Red Mushroom!</strong> I wonder if it is edible.<br><br>');
				addToInventory("redmushroom_item f_item","Red Mushroom (1x) <button class='eat' onclick='eat_food(4,0)'>Eat</button>");
				safe_mushroom = 1;
			} else if (!poisonous_mushroom){
				$(display).append(' I find a wild mushroom with a smooth white cap! <strong>Obtained White Mushroom!</strong> I wonder if it is edible.<br><br>');
				addToInventory("whitemushroom_item f_item","White Mushroom (1x) <button class='eat' onclick='eat_food(5,-75)'>Eat</button>");
				poisonous_mushroom = 1;
			} else {
				if (time_of_day == 2) {
					$(display).append(' I spot bright moonflower growing behind a stump. Enchanting!<br><br>');
				} else {
					$(display).append(' Just a couple of wildflowers around here.<br><br>');
				}
			}
			if(game_finished) {
				$(actions).html("<button onclick='treasure_cave()'>Enter Cave</button><br>");	
				$(actions).append("<button onclick='hamlet()'>Return to Peaceful Weather Hamlet</button>");
			}else {
				$(actions).html("<button id='master_yang' onclick='master_yang()'>Approach Master Yang</button><br>");
				if (waterfall) {
					$(actions).append("<button onclick='treasure_cave()'>Enter Cave of Treasures</button><br>");
				}
				$(actions).append("<button onclick='hamlet()'>Return to Peaceful Weather Hamlet</button>");
			}
		}
	}
	
	function investigate_mushroom(text) {
		var collapse = updateStamina(-1.5);
		if(collapse){
			return;
		}
		updateTime(.25);
		var previous = $(display).html();
		$(display_last).html(previous);
		if(text == 1) {
			$(display).html('I show Master Yang the Red Mushroom. Safe to eat? I ask.<br>');
			$(display).append('Master Yang&#39;s eyes grow wide. "That is a <i>lingzhi</i> mushroom!" he says, "Also called the Mushroom of Immortality. To think that you managed to find one after just learning the basics of foraging, you must be a natural!"<br><br>');
			$("#investigate_redmushroom").html("<button onclick='lingzhi()'>Mushroom of Immortality?</button>");
		} else if (text == 2) {
			$(display).html('I show Master Yang the White Mushroom. Safe to eat? I ask.<br>');
			$(display).append('Master Yang give the mushroom a strong sniff. "Definitely..." he says, "Definitely...deadly."<br><br>');
			$("#investigate_whitemushroom").remove();
		}
	}
	
	function lingzhi() {
		var collapse = updateStamina(-1.5);
		if(collapse){
			return;
		}
		updateTime(.25);
		var previous = $(display).html();
		$(display_last).html(previous);
		$(display).html('Is there something special about it? I ask.<br>');
		$(display).append('Master Yang nods. "It is an extremely rare mushroom," he says. "So rare that I have only seen it myself in mycological texts translated from ancient herbalist writings. It is written that eating a <i>lingzhi</i> mushroom will make a person immortal for a short period of time, although I believe the original word that the ancient writers used was &#39;invincible&#39;. Can you imagine experiencing that kind of power? Well, I suppose you don&#39;t have to imagine it...you can simply eat the mushroom and find out, haw-haw!"<br><br>');
		$("#investigate_redmushroom").remove();
	}

	function bane() {
		var collapse = updateStamina(-1.5);
		if(collapse){
			return;
		}
		updateTime(.25);
		var previous = $(display).html();
		$(display_last).html(previous);
		$(display).html('Have you encountered wolves when travelling through the woods?<br>');
		$(display).append('"None at all," Master Yang says. "That&#39;s because I always carry monkshood when traveling through the woods. It&#39;s other name is wolfsbane. Here, keep this satchel on you and you won&#39;t have any wolf-sized problems either. Mind you be careful with the contents of the bag, though...monkshood is very poisonous!" <strong>Obtained Wolfsbane from Master Yang!</strong><br><br>');
		addToInventory("wolfsbane_item","Wolfsbane");
		$("#wolfsbane").remove();
	}

	function yang_manual() {
		var collapse = updateStamina(-1.5);
		if(collapse){
			return;
		}
		updateTime(.25);
		var previous = $(display).html();
		$(display_last).html(previous);
		$(display).html('I show Master Yang the Gateway Scroll. Do you understand what these glyphs mean? I ask.<br>Master Yang looks at me in shock. "This&mdash;this describes a gateway through time! Essentially, a Time Portal!" Master Yang takes out a blank parchment and scribbles wildly on it with some tree bark. "Here," he says, handing me the parchment. "I have translated the incantation needed to activate the gateway. According to your scroll however, the spell alone isn&#39;t enough. You will also need to find an object that carries enough spirit energy to act as a power source. A relic of some kind should do..." <strong>Obtained Portal Spell from Master Yang!</strong><br><br>');
		addToInventory("portalspell_item q_item","Portal Spell");
		$("#translated_manual").html("<button onclick='yang_manual_c1()'>Time portal?</button>");
	}
	
	function yang_manual_c1() {
		var collapse = updateStamina(-1.5);
		if(collapse){
			return;
		}
		updateTime(.25);
		var previous = $(display).html();
		$(display_last).html(previous);
		$(display).html('A magic spell that creates a Time Portal? Is that a real thing?<br>');
		$(display).append('Master Yang shrugs. "You know, I&#39;m not really sure. I never tried the spell myself obviously." He scrutinizes me with a serious expression. "You&#39;re not thinking of actually activating the gateway and going through it, are you? Well, if you do, try your best to pick to a nice destination... According to the scroll, once you enter the Time Portal, you won&#39;t be able to return through it again until the moment dictated by fate. And don&#39;t ask me what that means either! Just remember that you may not be able to come back easily if you end up somewhere unpleasant! And for Heaven sake, do be careful! Traveling through a Time Portal can have terrible consequences. One misstep and the fragile fabric of our entire universe may be irreparably destroyed! At least, that would be my guess." Saying this, Master Yang cheerfully returns to picking herbs.<br><br>');
		$("#translated_manual").remove();
	}

	function yang() {
		var collapse = updateStamina(-1.5);
		if(collapse){
			return;
		}
		updateTime(.25);
		var previous = $(display).html();
		$(display_last).html(previous);
		$(display).html('What can you tell me about Aunt Lin?<br>');
		$(display).append('Master Yang thinks for a moment. "Your Aunt Lin has excellent mental functions and a good balance of yin and yang energies... She once complained to me of stomach cramps so I prescribed her fragrant angelica root."<br><br>');
		$("#yang").html("<button onclick='yang_c1()'>Have you seen Aunt Lin?</button>");
	}
	
	function yang_c1() {
		var collapse = updateStamina(-1.5);
		if(collapse){
			return;
		}
		updateTime(.5);
		var previous = $(display).html();
		$(display_last).html(previous);
		$(display).html('Has my aunt passed through? I ask. She&#39;s been missing.<br>');
		$(display).append('"Hmm, missing aunt, you say? I&#39;m sorry, I have been living in the woods for so long that I haven&#39;t been up to date on all the goings-on in the hamlet," Master Yang says. "But I can tell you that I have been out here a while now, and haven&#39;t seen anyone come by. Except now you, of course, haw-haw."<br><br>');
		$("#yang").remove();
		curiosity[10] = 1;
	}

	//Cave of Treasures

	function treasure_cave() {
		$("#use_forage").attr('disabled','disabled');
		var collapse = updateStamina(-1.5);
		if(collapse){
			return;
		}
		updateTime(.25);
		updateLocation("Cave of Treasures");
		change_music("cave.mp3");
		reset_display();
		if(inventory_map.get("lantern_item t_item")) {
			$(display_persist).html('I pass through the waterfall and enter the Cave of Treasures. I light the lantern. The chittering noises fade.<br><br>');
			$(actions).html("<button onclick='treasure_cave2()'>Proceed Deeper into Cave</button><br>");
			$(actions).append("<button onclick='waterfall_base()'>Leave Cave</button>");
		} else {
			$(display_persist).html('I pass through the waterfall and enter the Cave of Treasures. The cave is pitch black. All I hear are chittering noises. Better return with some light.<br><br>');
			$(actions).html("<button onclick='waterfall_base()'>Leave Cave</button>");
		}
		$(artwork).empty();
		spider_count = 3;
	}

	function treasure_cave2() {
		var collapse = updateStamina(-1.5);
		if(collapse){
			return;
		}
		updateTime(.25);
		var previous = $(display).html();
		$(display_last).html(previous);
		if (spider_count) {
			$(display).html('I proceed deeper into the Cave of Treasures. A dank and foul odor assails me, but there are no spiders around. The path is blocked by a pile of large rocks.<br><br>');
			$(actions).html("<button onclick='mine_cave_rocks()'>Mine Cave Rocks</button><br>");
			$(actions).append("<button onclick='waterfall_base()'>Leave Cave</button>");
			$(artwork).empty();
			$("#use_rocksmash").removeAttr('disabled');
			updateStamina(-2);
		} else {
			$(display).html("I proceed deeper into the Cave of Treasures...and discover a hidden grotto! In front of me lies a treasure chest!<br><br>");
			$(actions).html("<button onclick='treasure_chest()'>Open Treasure Chest</button><br>");
			$(actions).append("<button onclick='waterfall_base()'>Leave Cave</button>");
			$(artwork).html(treasure_art);
			$("#use_rocksmash").attr('disabled','disabled');
		}
	}

	function mine_cave_rocks() {
		if (rocksmash_active) {
			var collapse = updateStamina(-20);
			if(collapse){
				return;
			}
			updateTime(.5);
			var previous = $(display).html();
			$(display_last).html(previous);
			$(display).html("I smash the rocks with my fist!<br><br>");
			$(display).append("A huge spider crawls out of the rubble!<br><br>");
			$(actions).html("<button onclick='spider_fight()'>Fight Spider</button>");
			$(artwork).html(spider_art);
			return;
		}
		else if(inventory_map.get("bronzepickaxe_item t_item") || inventory_map.get("steelpickaxe_item t_item")) {
			var collapse;
			var iron_threshold;
			if(inventory_map.get("bronzepickaxe_item t_item")){
				collapse = updateStamina(-30);
				iron_threshold = .8;
			} else {
				collapse = updateStamina(-10);
				iron_threshold = .5;
			}
			if(collapse){
				return;
			}
			updateTime(1);
			var previous = $(display).html();
			$(display_last).html(previous);
			$(display).html("I mine the rocks with my pickaxe. ");
			var ironChance = Math.random();
			if(ironChance >= iron_threshold) {
				iron += 1;
				$(display).append("<strong>I uncover iron ore while mining the rocks!</strong><br><br>");
				if ($(".iron_item").length) {
					$(".iron_item").html("Iron ore ("+iron+"x)");
					inventory_map.set("iron_item","Iron ore ("+iron+"x)");
				} else {
					addToInventory("iron_item","Iron ore (1x)");
				}
			} else {
				$(display).append("No luck finding anything...<br><br>");
			}
			$(actions).html("<button onclick='mine_cave_rocks_c1()'>Continue</button>");
		} else {
			var collapse = updateStamina(-1.5);
			if(collapse){
				return;
			}
			updateTime(.25);
			var previous = $(display).html();
			$(display_last).html(previous);
			$(display).html("I am unable to mine the rocks without a pickaxe. Better come back another time.<br><br>");
			$(actions).html("<button onclick='waterfall_base()'>Leave Cave</button>");
		}
	}
	
	function mine_cave_rocks_c1() {
		var previous = $(display).html();
		$(display_last).html(previous);
		$(display).html("A huge spider crawls out of the rubble!<br><br>");
		$(actions).html("<button onclick='spider_fight()'>Fight Spider</button>");
		$(artwork).html(spider_art);
	}

	function spider_fight() {
		change_music("fight.mp3");
		reset_display();
		spider_count -= 1;
		spider_hp = 2;
		$("#use_rocksmash").removeAttr('disabled');
		$(display_persist).html("<div id='spider_bar'>Spider<br><progress value='2' max='2'></progress></div><br>");
		$(display).html("The spider makes a series of clicking noises as it advances towards me...<br><br>");
		if (bronze_sword || steel_sword || (silver_dagger) || wooden_staff) {
			$(actions).html("<button onclick='attack_spider()'>Attack</button><br>");
			$(actions).append("<button onclick='scare()'>Yell</button><br>");
		} else {
			$(actions).html("<div id='yell'><button onclick='scare()'>Yell</button></div>");
		}
		$(actions).append("<button onclick='run_spider()'>Run</button>");
	}
	
	function run_spider() {
		var run_chance = Math.random();
		var run_outcome;
		if (straw_sandals) {
			run_outcome = .5;
		} else {
			run_outcome = .25;
		}
		var collapse;
		if (run_chance < run_outcome) {
			if (leather_tunic) {
				collapse = updateStamina(-10);
			} else if (chainmail) {
				collapse = updateStamina(-1.5);
			} else {
				collapse = updateStamina(-20);
			}
			if(collapse){
				return;
			}
			updateTime(.5);
			var previous = $(display).html();
			$(display_last).html(previous);
			$(display).html("I attempt to escape, but the spider skitters rapidly in front of me, blocking the way out. <strong>The spider bites me!</strong><br><br>");
		} else {
			collapse = updateStamina(-1);
			if(collapse){
				return;
			}
			updateTime(.25);
			var previous = $(display).html();
			$(display_last).html(previous);
			$(display).html("I dash past the spider and hightail it out of the cave.<br><br>");
			$(actions).html("<button onclick='waterfall_base()'>Continue</button>");
		}
	}

	function attack_spider() {
		var venom = Math.random();
		var venom_distance;
		var currentSword;
		if(rocksmash_active) {
			spider_hp -= .5;
			venom_distance = .4
			currentSword = "bare fist";
		} else if (steel_sword) {
			spider_hp = 0;
			venom_distance = .6;
			currentSword = "steel sword";
		} else if (bronze_sword) {
			spider_hp -= 1;
			venom_distance = .6
			currentSword = "bronze sword";
		} else if (silver_dagger) {
			spider_hp -= .75;
			venom_distance = .4
			currentSword = "silver dagger";
		}	else if (wooden_staff) {
			spider_hp -= .5;
			venom_distance = .4
			currentSword = "wooden staff";
		}
		if (spider_hp > 0) {
			var collapse;
			if (leather_tunic) {
				collapse = updateStamina(-10);
			} else if (chainmail) {
				collapse = updateStamina(-1.5);
			} else {
				collapse = updateStamina(-20);
			}
			if(collapse){
				return;
			}
			updateTime(.5);
			var previous = $(display).html();
			$(display_last).html(previous);
			$("#spider_bar").html("Spider<br><progress value='"+spider_hp+"' max='2'></progress>");
			$(display).html("I attack the spider with my "+currentSword+"! <strong>The spider bites me!</strong> ");
			if(venom > venom_distance) {
				$(display).append("I start to feel disoriented...<br><br>");
				$(actions).html("<button onclick='disoriented()'>???</button><br>");
			} else {
				$(display).append("<br><br>");
				$(actions).html("");
				if(!rocksmash_active){
					$(actions).append("<button onclick='attack_spider()'>Attack</button><br>");
				}
				$(actions).append("<div id='yell'><button onclick='scare()'>Yell</button></div>");
				$(actions).append("<button onclick='run_spider()'>Run</button>");
			}
		} else {
			var collapse = updateStamina(-1.5);
			if(collapse){
				return;
			}
			updateTime(.25);
			var previous = $(display).html();
			$(display_last).html(previous);
			$("#spider_bar").html("Spider<br><progress value='0' max='2'></progress>");
			$(display).html("I attack the spider with my "+currentSword+"! The spider dies.<br><br>");
			$(actions).html("<button onclick='treasure_cave2()'>Proceed Deeper into Cave</button><br>");
			$(actions).append("<button onclick='waterfall_base()'>Leave Cave</button>");
			$("#use_rocksmash").attr('disabled','disabled');
		}
	}

	function disoriented() {
		var collapse = updateStamina(-10);
		if(collapse){
			return;
		}
		var confused = Math.random();
		if (bronze_sword || steel_sword || (silver_dagger) || wooden_staff) {
			if(confused > .5) {
				attack_spider();
			} else if(confused > .2) {
				scare();
			} else {
				run_spider();
			}
		} else {
			if(confused > .5) {
				scare();
			} else {
				run_spider();
			}
		}
	}

	function scare() {
		var fright = Math.random();
		var venom = Math.random();
		if (fright > .75) {
			var collapse = updateStamina(-1.5);
			if(collapse){
				return;
			}
			updateTime(.5);
			var previous = $(display).html();
			$(display_last).html(previous);
			$(display).html("I shout loudly, hoping to scare the spider... <strong>It works! The spider scurries away.</strong><br><br>");
			$(actions).html("<button onclick='treasure_cave2()'>Proceed Deeper into Cave</button><br>");
			$(actions).append("<button onclick='waterfall_base()'>Leave Cave</button>");
		} else {
			var collapse;
			if (leather_tunic) {
				collapse = updateStamina(-10);
			} else if (chainmail) {
				collapse = updateStamina(-1.5);
			} else {
				collapse = updateStamina(-20);
			}
			if(collapse){
				return;
			}
			updateTime(.25);
			var previous = $(display).html();
			$(display_last).html(previous);
			$(display).html("I shout loudly, hoping to scare the spider... <strong>The spider ignores my shouts and bites me!</strong> ");
			if(venom > .5) {
				$(display).append("I start to feel disoriented...<br><br>");
				$(actions).html("<button onclick='disoriented()'>???</button><br>");
			} else {
				$(display).append("<br><br>");
				if (bronze_sword || steel_sword || silver_dagger || wooden_staff) {
					$(display).append("<br><br>");
					$(actions).html("<button onclick='attack_spider()'>Attack</button><br>");
					$(actions).append("<button onclick='scare()'>Yell</button><br>");
					$(actions).append("<button onclick='run_spider()'>Run</button>");
				} else {
					$(display).append("<br><br>");
					$(actions).html("<div id='yell'><button onclick='scare()'>Yell</button></div>");
					$(actions).append("<button onclick='run_spider()'>Run</button>");
				}
			}
		}
	}

	function treasure_chest() {
		var collapse = updateStamina(-1);
		if(collapse){
			return;
		}
		updateTime(.25);
		var previous = $(display).html();
		$(display_last).html(previous);
		if(treasure) {
			if(waterfall) {
				$(display).html("I carefully open the treasure chest. A faint dust cloud floats upwards and out of the cave, followed by a soft noise, almost like a grateful whisper&mdash;<i>xiexie...</i> Could that have really been the spirit of Bandit Chief Jin?<br><br>The treasure chest is filled with coins. On top of the piles of coins lies a dagger made of silver. <strong>Obtained 200g! Obtained Silver Dagger!</strong><br><br>");
			} else {
				$(display).html("I carefully open the treasure chest. A faint dust cloud floats upwards and out of the cave, followed by a soft noise, almost like a grateful whisper&mdash;<i>xiexie...</i> How strange! On top of the piles of coins lies a dagger made of silver. <strong>Obtained 200g! Obtained Silver Dagger!</strong><br><br>");
			}
			money += 200;
			$("#money").html(money+"g");
			addToInventory("silverdagger_item e_item q_item","Silver Dagger (<i>relic</i>) <button  id='silverdagger_button' onclick='equip(11)'>Equip</button>");
			relic_count += 1;
			treasure = 0;
			taxes = 1;
		} else {
			$(display).html("The treasure chest is empty.<br><br>");
		}
		$(actions).html("<button onclick='waterfall_base()'>Leave Cave</button>");
	}

</script>
</html>
